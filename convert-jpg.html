<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JPG Converter - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column}

/* NAV */
nav{background:#fff;padding:13px 24px;display:flex;align-items:center;border-bottom:1px solid #e0ece5;box-shadow:0 1px 3px rgba(0,0,0,.03);position:sticky;top:0;z-index:100}
.nav-t{font-weight:700;font-size:1.08rem;color:#1d9c73}
.nav-s{color:#aaa;font-size:.76rem;margin-left:8px;font-weight:500}
.nav-r{margin-left:auto;display:flex;gap:8px}
.nb{padding:8px 18px;border:none;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nb.sec{background:#f0f5f2;color:#555}
.nb.sec:hover{background:#e0ece5}
.nb.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;box-shadow:0 2px 8px rgba(29,156,115,.2)}
.nb.pri:hover{box-shadow:0 4px 14px rgba(29,156,115,.3);transform:translateY(-1px)}
.nb.red{color:#e74c3c;background:#fdf2f2}
.nb.red:hover{background:#fce4e4}

/* UPLOAD */
.upload-area{display:flex;flex-direction:column;align-items:center;padding:44px 20px 36px;background:linear-gradient(180deg,#e8f6ef 0%,#f5f7fa 100%)}
.upload-area.mini{padding:16px 20px}
.upload-area h1{font-size:1.75rem;font-weight:800;color:#222;margin-bottom:8px;text-align:center}
.upload-area h1 span{color:#1d9c73}
.upload-area>p{color:#888;font-size:.92rem;margin-bottom:26px;text-align:center;max-width:530px;line-height:1.5}
.upload-area.mini h1,.upload-area.mini>p,.upload-area.mini .dir-switch{display:none}

/* DIRECTION */
.dir-switch{display:flex;gap:0;margin-bottom:24px;background:#fff;border-radius:12px;border:1.5px solid #d4ede2;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.dir-btn{padding:14px 28px;border:none;background:#fff;cursor:pointer;font-size:.88rem;font-weight:700;color:#888;transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap}
.dir-btn:first-child{border-right:1.5px solid #d4ede2}
.dir-btn:hover{color:#1d9c73;background:#f0faf5}
.dir-btn.active{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff}

#dropZone{width:100%;max-width:600px;padding:48px 28px;border:2.5px dashed #b8dfc9;border-radius:16px;background:#fff;text-align:center;cursor:pointer;transition:all .25s}
#dropZone:hover,#dropZone.dragover{border-color:#1d9c73;background:#f0faf5;transform:translateY(-2px);box-shadow:0 8px 25px rgba(29,156,115,.07)}
.upload-area.mini #dropZone{padding:16px 20px;max-width:100%}
.dz-icon{font-size:3rem;margin-bottom:10px;opacity:.5}
.dz-text{font-size:1rem;color:#666;font-weight:500;margin-bottom:3px}
.dz-hint{font-size:.82rem;color:#bbb;margin-bottom:16px}
.dz-btn{display:inline-block;padding:12px 34px;background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;border:none;border-radius:30px;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.22)}
.dz-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.3)}
.dz-fmt{font-size:.72rem;color:#ccc;margin-top:14px}
.upload-area.mini .dz-icon,.upload-area.mini .dz-hint,.upload-area.mini .dz-fmt{display:none}
.upload-area.mini .dz-text{margin-bottom:0}
.upload-area.mini .dz-btn{padding:8px 20px;font-size:.82rem}
#fileInput{display:none}

/* SETTINGS */
.stw{display:none;max-width:820px;width:100%;margin:0 auto;padding:0 20px}
.stw.show{display:block}
.stc{background:#fff;border-radius:14px;border:1px solid #e0ece5;padding:20px 24px;margin-top:16px;box-shadow:0 1px 4px rgba(0,0,0,.02)}
.stt{font-size:.88rem;font-weight:700;color:#333;margin-bottom:14px;display:flex;align-items:center;gap:6px}

.fml{font-size:.8rem;font-weight:600;color:#888;margin-bottom:8px}
.fmg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.fmb{padding:12px 20px;border:2px solid #e0ece5;border-radius:10px;background:#fff;cursor:pointer;text-align:center;transition:all .15s;min-width:80px}
.fmb:hover{border-color:#1d9c73}
.fmb.active{border-color:#1d9c73;background:#eef9f3}
.fmb .fn{font-size:.85rem;font-weight:700;color:#333}
.fmb .fd{font-size:.65rem;color:#aaa;margin-top:2px}

.qr{display:none;flex-direction:column;gap:6px;margin-bottom:12px}
.qr.show{display:flex}
.sll{display:flex;justify-content:space-between;font-size:.8rem;color:#666}
.sll span:last-child{color:#1d9c73;font-weight:700;min-width:40px;text-align:right}
input[type="range"]{-webkit-appearance:none;width:100%;height:5px;border-radius:3px;background:#d4ede2;outline:none;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#1d9c73;cursor:pointer;border:3px solid #fff;box-shadow:0 1px 5px rgba(0,0,0,.18)}

.bgr{display:none;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.bgr.show{display:flex}
.bgr label{font-size:.8rem;font-weight:600;color:#666}
input[type="color"]{width:36px;height:30px;border:1.5px solid #d4ede2;border-radius:6px;cursor:pointer;background:#fff;padding:2px}
.bgp{display:flex;gap:5px}
.bgd{width:26px;height:26px;border-radius:6px;cursor:pointer;border:2.5px solid #e0ece5;transition:all .12s}
.bgd:hover{border-color:#1d9c73;transform:scale(1.1)}
.bgd.active{border-color:#1d9c73;box-shadow:0 0 0 2px rgba(29,156,115,.2)}

/* FILES */
.fw{display:none;max-width:820px;width:100%;margin:0 auto;padding:16px 20px 0}
.fw.show{display:block}
.fh{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.fh h3{font-size:.95rem;font-weight:700;color:#333}
.fc{font-size:.78rem;color:#999;font-weight:500}

.fl{display:flex;flex-direction:column;gap:8px}
.fi{background:#fff;border-radius:12px;border:1px solid #e0ece5;padding:14px 16px;display:flex;align-items:center;gap:12px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.02)}
.fi:hover{box-shadow:0 2px 10px rgba(0,0,0,.04)}
.ft{width:50px;height:50px;border-radius:8px;background:#f0f5f2;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.ft img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.finfo{flex:1;min-width:0}
.fname{font-size:.84rem;font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fmeta{font-size:.73rem;color:#aaa;margin-top:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.fcv{display:flex;align-items:center;gap:5px;font-size:.75rem}
.ftag{padding:3px 9px;border-radius:5px;font-weight:700;font-size:.68rem;text-transform:uppercase}
.ftag.jpg{background:#fff3e0;color:#e67e22}
.ftag.png{background:#e8f5e9;color:#27ae60}
.ftag.webp{background:#e3f2fd;color:#2196f3}
.ftag.gif{background:#fce4ec;color:#e91e63}
.ftag.bmp{background:#f3e5f5;color:#9c27b0}
.ftag.ico{background:#e0f7fa;color:#00bcd4}
.farr{color:#ccc;font-weight:700;font-size:.8rem}
.fsz{font-size:.72rem;color:#999}

.fstat{flex-shrink:0;display:flex;align-items:center;gap:6px}
.bdg{padding:5px 12px;border-radius:16px;font-size:.72rem;font-weight:600;display:inline-flex;align-items:center;gap:4px}
.bdg.w{background:#f0f5f2;color:#999}
.bdg.p{background:#fff8e1;color:#e67e22}
.bdg.d{background:#e8f8f0;color:#1d9c73}
.bdg.e{background:#fde8e8;color:#e74c3c}
.msp{width:13px;height:13px;border:2px solid #b8dfc9;border-top-color:#1d9c73;border-radius:50%;animation:sp .6s linear infinite;display:inline-block}
@keyframes sp{to{transform:rotate(360deg)}}
.fdl{padding:6px 14px;border:none;border-radius:8px;background:#1d9c73;color:#fff;font-size:.76rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap}
.fdl:hover{background:#27ae60;transform:translateY(-1px)}
.frm{width:28px;height:28px;border:none;border-radius:6px;background:#f0f5f2;color:#bbb;cursor:pointer;font-size:.8rem;display:flex;align-items:center;justify-content:center;transition:all .12s}
.frm:hover{background:#fde8e8;color:#e74c3c}
.fprog{width:100%;height:4px;background:#e0ece5;border-radius:2px;margin-top:6px;overflow:hidden}
.fprog .bar{height:100%;background:linear-gradient(90deg,#1d9c73,#27ae60);border-radius:2px;transition:width .3s;width:0}

/* SUMMARY */
.sw{display:none;max-width:820px;width:100%;margin:16px auto 0;padding:0 20px}
.sw.show{display:block}
.sum{background:#fff;border-radius:14px;border:1px solid #e0ece5;padding:20px 24px;box-shadow:0 1px 4px rgba(0,0,0,.02);display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.si{text-align:center;flex:1;min-width:90px}
.sv{font-size:1.3rem;font-weight:800;color:#1d9c73}
.sl{font-size:.72rem;color:#999;font-weight:500;margin-top:2px}
.ss{width:1px;height:36px;background:#e0ece5;flex-shrink:0}

/* ACTIONS */
.ab{display:none;max-width:820px;width:100%;margin:0 auto;padding:16px 20px 40px;justify-content:center;gap:10px;flex-wrap:wrap}
.ab.show{display:flex}
.abtn{padding:13px 32px;border:none;border-radius:10px;font-size:.92rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.abtn.cv{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;box-shadow:0 4px 16px rgba(29,156,115,.22)}
.abtn.cv:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(29,156,115,.32)}
.abtn.cv:disabled{opacity:.5;cursor:default;transform:none}
.abtn.da{background:#fff;color:#1d9c73;border:2px solid #1d9c73}
.abtn.da:hover{background:#eef9f3}
.abtn .bsp{width:16px;height:16px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite}
.addm{padding:13px 24px;border:2px dashed #b8dfc9;border-radius:10px;background:#fff;color:#999;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .15s}
.addm:hover{border-color:#1d9c73;color:#1d9c73;background:#f0faf5}

/* TOAST */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#fff;color:#333;padding:12px 22px;border-radius:10px;font-size:.85rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);z-index:300;transition:transform .3s;border-left:4px solid #1d9c73}
.toast.err{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

footer{margin-top:auto;text-align:center;padding:16px;color:#bbb;font-size:.74rem;border-top:1px solid #e0ece5;background:#fff}
footer span{color:#1d9c73;font-weight:600}

@media(max-width:768px){
  .upload-area{padding:30px 16px 24px}
  .upload-area h1{font-size:1.35rem}
  #dropZone{padding:34px 20px}
  .nb span.txt{display:none}
  .nb{padding:8px 12px}
  .nav-s{display:none}
  .fi{padding:10px 12px;gap:10px}
  .ft{width:42px;height:42px}
  .sum{gap:12px;padding:16px}
  .ss{display:none}
  .dir-btn{padding:10px 16px;font-size:.8rem}
  .fmb{padding:10px 14px;min-width:65px}
}
@media(max-width:480px){
  .upload-area h1{font-size:1.12rem}
  #dropZone{padding:26px 14px}
  .dz-icon{font-size:2.2rem}
  .dir-btn{padding:9px 12px;font-size:.74rem}
  .fmb{min-width:55px}
  .fmb .fn{font-size:.78rem}
  .fmb .fd{display:none}
  .stc{padding:14px 16px}
  .abtn{padding:11px 22px;font-size:.85rem}
  .fcv{flex-wrap:wrap;gap:3px}
}
</style>
</head>
<body>

<nav>
  <span class="nav-t">JPG Converter</span>
  <span class="nav-s">Free Online Tool</span>
  <div class="nav-r" id="navBtns" style="display:none">
    <button class="nb red" onclick="clearAll()">‚úï <span class="txt">Clear</span></button>
    <button class="nb sec" onclick="document.getElementById('fileInput').click()">+ <span class="txt">Add</span></button>
  </div>
</nav>

<div class="upload-area" id="uploadArea">
  <h1>Convert <span>JPG</span> Images</h1>
  <p>Convert JPG to PNG, WEBP, BMP or convert any image to JPG. Fast, free and works in your browser.</p>

  <div class="dir-switch">
    <button class="dir-btn active" onclick="setDir('from',this)">Convert FROM JPG</button>
    <button class="dir-btn" onclick="setDir('to',this)">Convert TO JPG</button>
  </div>

  <div id="dropZone">
    <div class="dz-icon">üìÅ</div>
    <div class="dz-text" id="dzText">Drag & drop JPG images here</div>
    <div class="dz-hint">or</div>
    <button class="dz-btn" onclick="document.getElementById('fileInput').click()">Select Images</button>
    <div class="dz-fmt" id="dzFmt">JPG, JPEG files ‚Äî Up to 50MB each</div>
  </div>
  <input type="file" id="fileInput" accept="image/*" multiple>
</div>

<!-- SETTINGS -->
<div class="stw" id="stw">
  <div class="stc">
    <div class="stt">‚öô Output Settings</div>
    <div class="fml" id="fmtLabel">Convert JPG to:</div>
    <div class="fmg" id="fmtGrid"></div>

    <div class="qr" id="qRow">
      <div class="sll"><span>Quality</span><span id="qVal">92%</span></div>
      <input type="range" min="10" max="100" value="92" id="qSlider" oninput="document.getElementById('qVal').textContent=this.value+'%'">
    </div>

    <div class="bgr" id="bgRow">
      <label>Background:</label>
      <input type="color" id="bgColor" value="#ffffff">
      <div class="bgp">
        <div class="bgd active" style="background:#fff" onclick="setBg('#ffffff',this)"></div>
        <div class="bgd" style="background:#000" onclick="setBg('#000000',this)"></div>
        <div class="bgd" style="background:#f0f0f0" onclick="setBg('#f0f0f0',this)"></div>
        <div class="bgd" style="background:#e74c3c" onclick="setBg('#e74c3c',this)"></div>
        <div class="bgd" style="background:#3498db" onclick="setBg('#3498db',this)"></div>
        <div class="bgd" style="background:#2ecc71" onclick="setBg('#2ecc71',this)"></div>
      </div>
    </div>
  </div>
</div>

<!-- FILES -->
<div class="fw" id="fw">
  <div class="fh"><div><h3>Images</h3><span class="fc" id="fileCount">0 images</span></div></div>
  <div class="fl" id="fileList"></div>
</div>

<!-- SUMMARY -->
<div class="sw" id="sw">
  <div class="sum">
    <div class="si"><div class="sv" id="sumTotal">0</div><div class="sl">Total</div></div>
    <div class="ss"></div>
    <div class="si"><div class="sv" id="sumDone">0</div><div class="sl">Converted</div></div>
    <div class="ss"></div>
    <div class="si"><div class="sv" id="sumFrom">JPG</div><div class="sl">From</div></div>
    <div class="ss"></div>
    <div class="si"><div class="sv" id="sumTo">PNG</div><div class="sl">To</div></div>
  </div>
</div>

<!-- ACTIONS -->
<div class="ab" id="ab">
  <button class="addm" onclick="document.getElementById('fileInput').click()">+ Add More</button>
  <button class="abtn cv" id="cvBtn" onclick="convertAll()">Convert All</button>
  <button class="abtn da" id="daBtn" onclick="downloadAll()" style="display:none">‚§ì Download All</button>
</div>

<footer><span>JPG Converter</span> ‚Äî 100% free and private. Images never leave your browser.</footer>
<div class="toast" id="toast"></div>

<script>
let files=[],dir='from',tgtFmt='png',isWorking=false;

const FROM_FMTS=[
  {id:'png',name:'PNG',desc:'Lossless'},
  {id:'webp',name:'WEBP',desc:'Modern'},
  {id:'gif',name:'GIF',desc:'Animated'},
  {id:'bmp',name:'BMP',desc:'Bitmap'},
];

document.addEventListener('DOMContentLoaded',()=>{
  const fi=document.getElementById('fileInput'),dz=document.getElementById('dropZone');
  fi.addEventListener('change',e=>{handleFiles(e.target.files);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items;if(!items)return;
    const a=[];for(let i of items)if(i.type.startsWith('image/'))a.push(i.getAsFile());
    if(a.length){e.preventDefault();handleFiles(a)}
  });
  buildFmts();
});

function setDir(d,btn){
  dir=d;
  document.querySelectorAll('.dir-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(d==='from'){
    document.getElementById('dzText').textContent='Drag & drop JPG images here';
    document.getElementById('dzFmt').textContent='JPG, JPEG files ‚Äî Up to 50MB each';
    tgtFmt='png';
  }else{
    document.getElementById('dzText').textContent='Drag & drop images here (PNG, WEBP, GIF, BMP)';
    document.getElementById('dzFmt').textContent='PNG, WEBP, GIF, BMP ‚Äî Up to 50MB each';
    tgtFmt='jpeg';
  }
  buildFmts();
}

function buildFmts(){
  const g=document.getElementById('fmtGrid');g.innerHTML='';
  if(dir==='to'){
    tgtFmt='jpeg';
    const d=document.createElement('div');d.className='fmb active';
    d.innerHTML='<div class="fn">JPG</div><div class="fd">Compressed</div>';
    g.appendChild(d);
    document.getElementById('fmtLabel').textContent='Output format:';
    document.getElementById('qRow').classList.add('show');
    document.getElementById('bgRow').classList.add('show');
  }else{
    document.getElementById('fmtLabel').textContent='Convert JPG to:';
    FROM_FMTS.forEach((f,i)=>{
      const d=document.createElement('div');
      d.className='fmb'+(i===0?' active':'');
      d.innerHTML=`<div class="fn">${f.name}</div><div class="fd">${f.desc}</div>`;
      d.onclick=()=>{
        document.querySelectorAll('.fmb').forEach(b=>b.classList.remove('active'));
        d.classList.add('active');tgtFmt=f.id;updQVis();
      };
      g.appendChild(d);
    });
    tgtFmt='png';updQVis();
  }
}

function updQVis(){
  document.getElementById('qRow').classList.toggle('show',tgtFmt==='jpeg'||tgtFmt==='webp');
  document.getElementById('bgRow').classList.toggle('show',tgtFmt==='jpeg');
}

function setBg(c,dot){
  document.getElementById('bgColor').value=c;
  document.querySelectorAll('.bgd').forEach(d=>d.classList.remove('active'));
  if(dot)dot.classList.add('active');
}

function handleFiles(fl){
  let added=0;
  for(let f of fl){
    if(!f.type.startsWith('image/'))continue;
    if(f.size>50*1024*1024){toast(f.name+' too large',true);continue}
    const isJpg=f.type==='image/jpeg'||f.name.toLowerCase().match(/\.jpe?g$/);
    if(dir==='from'&&!isJpg){toast(f.name+' is not JPG',true);continue}
    if(dir==='to'&&isJpg){toast(f.name+' is already JPG',true);continue}

    const url=URL.createObjectURL(f);
    files.push({file:f,name:f.name,size:f.size,type:f.type,thumbUrl:url,status:'waiting',outBlob:null,outUrl:null,outSize:0,outExt:'',w:0,h:0});
    added++;
    const idx=files.length-1;
    const img=new Image();
    img.onload=()=>{files[idx].w=img.naturalWidth;files[idx].h=img.naturalHeight;render()};
    img.src=url;
  }
  if(added>0){toast('‚úì '+added+' image'+(added>1?'s':'')+' added');showUI();render()}
}

function showUI(){
  document.getElementById('uploadArea').classList.add('mini');
  ['stw','fw','ab'].forEach(id=>document.getElementById(id).classList.add('show'));
  document.getElementById('navBtns').style.display='flex';
  const allDone=files.length>0&&files.every(f=>f.status==='done');
  document.getElementById('daBtn').style.display=allDone?'inline-flex':'none';
  document.getElementById('cvBtn').style.display=allDone?'none':'inline-flex';
}

function ext(type){
  if(type.includes('jpeg'))return'jpg';if(type.includes('png'))return'png';
  if(type.includes('webp'))return'webp';if(type.includes('gif'))return'gif';
  if(type.includes('bmp'))return'bmp';return'img';
}

function render(){
  const list=document.getElementById('fileList');list.innerHTML='';
  document.getElementById('fileCount').textContent=files.length+' image'+(files.length!==1?'s':'');
  const outName=tgtFmt==='jpeg'?'jpg':tgtFmt;

  files.forEach((f,i)=>{
    const item=document.createElement('div');item.className='fi';
    const fe=ext(f.type);
    const te=f.outExt||outName;
    let st='',sz='';

    if(f.status==='waiting'){
      st='<span class="bdg w">Waiting</span>';
    }else if(f.status==='converting'){
      st='<span class="bdg p"><span class="msp"></span> Converting</span>';
    }else if(f.status==='done'){
      st=`<span class="bdg d">‚úì Done</span><button class="fdl" onclick="dlOne(${i})">‚§ì ${te.toUpperCase()}</button>`;
      sz=`<span class="fsz">${fmtSz(f.size)} ‚Üí ${fmtSz(f.outSize)}</span>`;
    }else{
      st='<span class="bdg e">‚úï Error</span>';
    }

    item.innerHTML=`
      <div class="ft"><img src="${f.thumbUrl}" alt=""></div>
      <div class="finfo">
        <div class="fname">${esc(f.name)}</div>
        <div class="fmeta">
          <div class="fcv">
            <span class="ftag ${fe}">${fe.toUpperCase()}</span>
            <span class="farr">‚Üí</span>
            <span class="ftag ${te}">${te.toUpperCase()}</span>
          </div>
          ${f.w?`<span>${f.w}√ó${f.h}</span>`:''}
          ${sz}
        </div>
        ${f.status==='converting'?'<div class="fprog"><div class="bar" style="width:60%"></div></div>':''}
      </div>
      <div class="fstat">${st}<button class="frm" onclick="rmFile(${i})">‚úï</button></div>
    `;
    list.appendChild(item);
  });
  updSum();
}

function updSum(){
  const done=files.filter(f=>f.status==='done');
  if(!done.length){document.getElementById('sw').classList.remove('show');return}
  document.getElementById('sw').classList.add('show');
  document.getElementById('sumTotal').textContent=files.length;
  document.getElementById('sumDone').textContent=done.length;
  document.getElementById('sumFrom').textContent=dir==='from'?'JPG':files.length?ext(files[0].type).toUpperCase():'‚Äî';
  document.getElementById('sumTo').textContent=tgtFmt==='jpeg'?'JPG':tgtFmt.toUpperCase();
}

function rmFile(i){
  if(files[i].thumbUrl)URL.revokeObjectURL(files[i].thumbUrl);
  if(files[i].outUrl)URL.revokeObjectURL(files[i].outUrl);
  files.splice(i,1);
  if(!files.length){clearAll();return}
  render();showUI();
}

async function convertAll(){
  if(isWorking||!files.length)return;
  isWorking=true;
  const btn=document.getElementById('cvBtn');
  btn.disabled=true;btn.innerHTML='<span class="bsp"></span> Converting...';

  const q=(parseInt(document.getElementById('qSlider').value)||92)/100;
  const bg=document.getElementById('bgColor').value;

  for(let i=0;i<files.length;i++){
    if(files[i].status==='done')continue;
    files[i].status='converting';render();

    try{
      const r=await cvt(files[i],q,bg);
      files[i].outBlob=r.blob;
      files[i].outUrl=URL.createObjectURL(r.blob);
      files[i].outSize=r.blob.size;
      files[i].outExt=r.ext;
      files[i].status='done';
    }catch(e){
      console.error(e);files[i].status='error';
    }
    render();
  }

  isWorking=false;btn.disabled=false;btn.innerHTML='Convert All';
  const allDone=files.every(f=>f.status==='done');
  if(allDone){
    toast('‚úì All images converted!');
    document.getElementById('daBtn').style.display='inline-flex';
    document.getElementById('cvBtn').style.display='none';
  }else{
    toast('Some conversions failed',true);
    document.getElementById('daBtn').style.display='inline-flex';
  }
}

function cvt(fo,quality,bg){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>{
      const w=img.naturalWidth,h=img.naturalHeight;
      const c=document.createElement('canvas');c.width=w;c.height=h;
      const x=c.getContext('2d');

      if(tgtFmt==='jpeg'||tgtFmt==='bmp'){
        x.fillStyle=bg||'#ffffff';x.fillRect(0,0,w,h);
      }
      x.imageSmoothingEnabled=true;x.imageSmoothingQuality='high';
      x.drawImage(img,0,0);

      let mime,ext;
      switch(tgtFmt){
        case'png':mime='image/png';ext='png';break;
        case'jpeg':mime='image/jpeg';ext='jpg';break;
        case'webp':mime='image/webp';ext='webp';break;
        case'gif':mime='image/gif';ext='gif';break;
        case'bmp':mime='image/bmp';ext='bmp';break;
        default:mime='image/png';ext='png';
      }

      const needsQ=mime==='image/jpeg'||mime==='image/webp';
      c.toBlob(blob=>{
        if(!blob)rej('Failed');
        else res({blob,ext});
      },mime,needsQ?quality:undefined);
    };
    img.onerror=()=>rej('Load failed');
    img.src=URL.createObjectURL(fo.file);
  });
}

function dlOne(i){
  const f=files[i];if(!f.outBlob)return;
  const a=document.createElement('a');
  a.href=f.outUrl||URL.createObjectURL(f.outBlob);
  a.download=f.name.replace(/\.[^.]+$/,'')+'.'+f.outExt;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function downloadAll(){
  const done=files.filter(f=>f.status==='done');
  if(!done.length)return;
  if(done.length===1){dlOne(files.indexOf(done[0]));return}
  done.forEach((f,i)=>setTimeout(()=>dlOne(files.indexOf(f)),i*400));
  toast('‚§ì Downloading '+done.length+' images...');
}

function clearAll(){
  files.forEach(f=>{if(f.thumbUrl)URL.revokeObjectURL(f.thumbUrl);if(f.outUrl)URL.revokeObjectURL(f.outUrl)});
  files=[];
  document.getElementById('fileList').innerHTML='';
  document.getElementById('uploadArea').classList.remove('mini');
  ['stw','fw','ab','sw'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById('navBtns').style.display='none';
  document.getElementById('daBtn').style.display='none';
  document.getElementById('cvBtn').style.display='inline-flex';
  document.getElementById('cvBtn').innerHTML='Convert All';
  toast('Cleared');
}

function fmtSz(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(2)+' MB'}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toast(m,e){const t=document.getElementById('toast');t.textContent=m;t.className='toast'+(e?' err':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}
</script>
</body>
</html>
