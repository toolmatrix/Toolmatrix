<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Crop Image - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column;
  overflow-x:hidden
}

/* NAV */
nav{
  background:#fff;padding:13px 24px;display:flex;align-items:center;
  border-bottom:1px solid #e8ecf0;box-shadow:0 1px 3px rgba(0,0,0,.04);
  position:sticky;top:0;z-index:100
}
.nav-title{font-weight:700;font-size:1.08rem;color:#1d9c73}
.nav-sub{color:#aaa;font-size:.76rem;margin-left:8px;font-weight:500}
.nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.nb{
  padding:8px 18px;border:none;border-radius:8px;font-size:.82rem;
  font-weight:600;cursor:pointer;transition:all .15s;display:flex;
  align-items:center;gap:5px;white-space:nowrap
}
.nb.sec{background:#f0f2f5;color:#666}
.nb.sec:hover{background:#e4e6e9}
.nb.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  box-shadow:0 2px 8px rgba(29,156,115,.2)}
.nb.pri:hover{box-shadow:0 4px 14px rgba(29,156,115,.3);transform:translateY(-1px)}
.nb.rst{color:#e74c3c;background:#fdf2f2}
.nb.rst:hover{background:#fce4e4}

/* UPLOAD SCREEN */
#uploadScreen{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:40px 20px;
  background:linear-gradient(180deg,#eefaf4 0%,#f5f7fa 100%)
}
#uploadScreen.hidden{display:none}
.u-title{font-size:1.8rem;font-weight:800;color:#222;margin-bottom:8px;text-align:center}
.u-title span{color:#1d9c73}
.u-desc{color:#888;font-size:.92rem;margin-bottom:28px;text-align:center;max-width:460px;line-height:1.5}

#dropZone{
  width:100%;max-width:580px;padding:48px 28px;border:2.5px dashed #c8e6c9;
  border-radius:16px;background:#fff;text-align:center;cursor:pointer;
  transition:all .25s
}
#dropZone:hover,#dropZone.dragover{
  border-color:#1d9c73;background:#f7fdf9;transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(29,156,115,.08)
}
.dz-icon{font-size:3rem;margin-bottom:10px;opacity:.55}
.dz-text{font-size:1rem;color:#666;font-weight:500;margin-bottom:4px}
.dz-hint{font-size:.82rem;color:#bbb;margin-bottom:16px}
.dz-btn{
  display:inline-block;padding:12px 34px;
  background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  border:none;border-radius:30px;font-size:.95rem;font-weight:700;
  cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.25)
}
.dz-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.3)}
.dz-fmt{font-size:.72rem;color:#ccc;margin-top:14px}
#fileInput{display:none}

/* EDITOR */
#editorScreen{display:none;flex:1;flex-direction:column;overflow:hidden}
#editorScreen.active{display:flex}

/* TOOLBAR */
.toolbar{
  background:#fff;border-bottom:1px solid #e8ecf0;padding:10px 16px;
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  box-shadow:0 1px 3px rgba(0,0,0,.03)
}
.tool-label{font-size:.8rem;font-weight:600;color:#888;margin-right:2px;white-space:nowrap}
.ratio-group{display:flex;gap:4px;flex-wrap:wrap}
.rbtn{
  padding:6px 14px;border:1.5px solid #e0e3e7;border-radius:8px;
  background:#fff;color:#555;font-size:.78rem;font-weight:600;
  cursor:pointer;transition:all .15s;white-space:nowrap
}
.rbtn:hover{border-color:#1d9c73;color:#1d9c73}
.rbtn.active{background:#eef9f3;border-color:#1d9c73;color:#1d9c73}
.tool-sep{width:1px;height:28px;background:#e8ecf0;margin:0 4px;flex-shrink:0}
.dim-group{display:flex;align-items:center;gap:5px}
.dinp{
  width:70px;padding:6px 8px;border:1.5px solid #e0e3e7;border-radius:6px;
  font-size:.8rem;text-align:center;color:#333;background:#fafafa;font-weight:600
}
.dinp:focus{outline:none;border-color:#1d9c73;background:#fff}
.dx{color:#bbb;font-weight:700;font-size:.85rem}
.dpx{font-size:.72rem;color:#bbb;margin-left:2px}

/* CANVAS AREA */
#canvasArea{
  flex:1;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;background:#e8ecf0;
  background-image:
    linear-gradient(45deg,#dfe3e8 25%,transparent 25%),
    linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#dfe3e8 75%),
    linear-gradient(-45deg,transparent 75%,#dfe3e8 75%);
  background-size:16px 16px;
  background-position:0 0,0 8px,8px -8px,-8px 0
}
#imgWrap{position:relative;display:inline-block;user-select:none;box-shadow:0 4px 30px rgba(0,0,0,.1);background:#fff}
#imgWrap img{display:block;max-width:none}

/* CROP OVERLAY */
#cropOv{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;cursor:crosshair}
.shade{position:absolute;background:rgba(0,0,0,.5);pointer-events:none;transition:none}
#sT{top:0;left:0;right:0}
#sB{bottom:0;left:0;right:0}
#sL{left:0}
#sR{right:0}

#cropBox{
  position:absolute;border:2px solid #fff;cursor:move;z-index:12;
  box-shadow:0 0 0 1px rgba(0,0,0,.12),inset 0 0 0 1px rgba(255,255,255,.15)
}
/* Grid */
.grid-line{position:absolute;background:rgba(255,255,255,.3);pointer-events:none}
.grid-line.h{left:0;right:0;height:1px}
.grid-line.v{top:0;bottom:0;width:1px}
.grid-line.h.g1{top:33.333%}
.grid-line.h.g2{top:66.666%}
.grid-line.v.g1{left:33.333%}
.grid-line.v.g2{left:66.666%}

/* Handles */
.hd{
  position:absolute;width:12px;height:12px;background:#fff;
  border:2px solid #1d9c73;z-index:14;border-radius:2px;
  box-shadow:0 1px 3px rgba(0,0,0,.25)
}
.hd.tl{top:-6px;left:-6px;cursor:nw-resize}
.hd.tr{top:-6px;right:-6px;cursor:ne-resize}
.hd.bl{bottom:-6px;left:-6px;cursor:sw-resize}
.hd.br{bottom:-6px;right:-6px;cursor:se-resize}
.hd.tm{top:-6px;left:50%;transform:translateX(-50%);cursor:n-resize}
.hd.bm{bottom:-6px;left:50%;transform:translateX(-50%);cursor:s-resize}
.hd.ml{left:-6px;top:50%;transform:translateY(-50%);cursor:w-resize}
.hd.mr{right:-6px;top:50%;transform:translateY(-50%);cursor:e-resize}

/* Edge bars for visual */
.edge{position:absolute;background:rgba(255,255,255,.6);pointer-events:none}
.edge.et{top:0;left:20%;right:20%;height:2px}
.edge.eb{bottom:0;left:20%;right:20%;height:2px}
.edge.el{left:0;top:20%;bottom:20%;width:2px}
.edge.er{right:0;top:20%;bottom:20%;width:2px}

#sizeLabel{
  position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.72);color:#fff;padding:3px 12px;border-radius:5px;
  font-size:.73rem;font-weight:600;white-space:nowrap;pointer-events:none;z-index:15
}

/* Zoom */
.zbar{
  position:absolute;bottom:14px;right:14px;display:flex;gap:3px;
  background:#fff;border-radius:10px;padding:4px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);border:1px solid #e5e7eb;z-index:20
}
.zb{
  width:32px;height:32px;border:none;border-radius:6px;background:#f5f5f5;
  color:#555;cursor:pointer;font-size:.85rem;display:flex;align-items:center;
  justify-content:center;transition:all .12s
}
.zb:hover{background:#1d9c73;color:#fff}
.zi{display:flex;align-items:center;padding:0 8px;font-size:.76rem;color:#888;font-weight:700}

.img-info{
  position:absolute;bottom:14px;left:14px;background:#fff;padding:5px 12px;
  border-radius:8px;font-size:.73rem;color:#888;box-shadow:0 2px 8px rgba(0,0,0,.06);
  border:1px solid #e5e7eb;font-weight:600;z-index:20
}

/* MODAL */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;
  align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(3px)
}
.modal-bg.active{display:flex}
.modal{
  background:#fff;border-radius:16px;padding:28px;width:min(92vw,400px);
  box-shadow:0 10px 40px rgba(0,0,0,.12)
}
.modal-title{font-size:1.15rem;font-weight:700;color:#333;margin-bottom:6px}
.modal-desc{font-size:.82rem;color:#999;margin-bottom:18px}
.fmt-list{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
.fopt{
  padding:12px 14px;border:2px solid #eee;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;gap:12px;transition:all .12s
}
.fopt:hover{border-color:#1d9c73}
.fopt.sel{border-color:#1d9c73;background:#eef9f3}
.fopt .fi{font-size:1.3rem}
.fopt .fn{font-weight:600;font-size:.88rem}
.fopt .fd{font-size:.7rem;color:#aaa}
.q-sec{margin-bottom:18px}
.q-sec .ql{display:flex;justify-content:space-between;font-size:.8rem;color:#666;margin-bottom:5px}
.q-sec .ql span:last-child{color:#1d9c73;font-weight:700}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:#e0e0e0;outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:#1d9c73;cursor:pointer;border:3px solid #fff;
  box-shadow:0 1px 4px rgba(0,0,0,.2)
}
.modal-acts{display:flex;gap:10px}
.modal-acts .nb{flex:1;justify-content:center;padding:11px}

/* TOAST */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#fff;color:#333;padding:12px 22px;border-radius:10px;
  font-size:.85rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);
  z-index:300;transition:transform .3s;border-left:4px solid #1d9c73
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* LOADING */
.lov{
  position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;
  align-items:center;justify-content:center;z-index:400;flex-direction:column;gap:12px
}
.lov.active{display:flex}
.spin{width:40px;height:40px;border:4px solid #e0e0e0;border-top-color:#1d9c73;border-radius:50%;animation:sp .65s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.lov-t{color:#888;font-size:.88rem;font-weight:500}

/* FOOTER */
footer{
  text-align:center;padding:16px;color:#bbb;font-size:.74rem;
  border-top:1px solid #eef0f3;background:#fff
}
footer span{color:#1d9c73;font-weight:600}

/* RESPONSIVE */
@media(max-width:768px){
  .toolbar{padding:8px 10px;gap:5px}
  .rbtn{padding:5px 10px;font-size:.72rem}
  .tool-sep{display:none}
  .dim-group{width:100%;justify-content:center;margin-top:2px}
  .u-title{font-size:1.45rem}
  #dropZone{padding:34px 20px}
  .nb span.txt{display:none}
  .nb{padding:8px 12px}
  .nav-sub{display:none}
}
@media(max-width:480px){
  .u-title{font-size:1.2rem}
  .dz-icon{font-size:2.4rem}
  .rbtn{padding:4px 8px;font-size:.68rem}
  .dinp{width:56px;font-size:.75rem;padding:5px 4px}
  #dropZone{padding:28px 16px}
  .hd{width:16px;height:16px;border-width:2.5px}
  .hd.tl{top:-8px;left:-8px}.hd.tr{top:-8px;right:-8px}
  .hd.bl{bottom:-8px;left:-8px}.hd.br{bottom:-8px;right:-8px}
  .hd.tm{top:-8px}.hd.bm{bottom:-8px}.hd.ml{left:-8px}.hd.mr{right:-8px}
  .modal{padding:20px;width:min(95vw,380px)}
}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <span class="nav-title">Crop Image</span>
  <span class="nav-sub">Free Online Tool</span>
  <div class="nav-right" id="navBtns" style="display:none">
    <button class="nb rst" onclick="resetCrop()">‚Ü∫ <span class="txt">Reset</span></button>
    <button class="nb sec" onclick="newImage()">+ <span class="txt">New</span></button>
    <button class="nb pri" onclick="openModal()">‚§ì <span class="txt">Crop & Download</span></button>
  </div>
</nav>

<!-- UPLOAD -->
<div id="uploadScreen">
  <div class="u-title">Crop <span>Image</span> Online</div>
  <div class="u-desc">Free online image cropper. Select your area, choose aspect ratio, and download instantly.</div>
  <div id="dropZone">
    <div class="dz-icon">üìÅ</div>
    <div class="dz-text">Drag & drop your image here</div>
    <div class="dz-hint">or</div>
    <button class="dz-btn" onclick="document.getElementById('fileInput').click()">Select Image</button>
    <div class="dz-fmt">JPG, PNG, WEBP, GIF, BMP, SVG</div>
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- EDITOR -->
<div id="editorScreen">
  <div class="toolbar">
    <span class="tool-label">Ratio:</span>
    <div class="ratio-group">
      <button class="rbtn active" data-r="free" onclick="setRatio(this)">Free</button>
      <button class="rbtn" data-r="1" onclick="setRatio(this)">1:1</button>
      <button class="rbtn" data-r="1.3333" onclick="setRatio(this)">4:3</button>
      <button class="rbtn" data-r="0.75" onclick="setRatio(this)">3:4</button>
      <button class="rbtn" data-r="1.7778" onclick="setRatio(this)">16:9</button>
      <button class="rbtn" data-r="0.5625" onclick="setRatio(this)">9:16</button>
      <button class="rbtn" data-r="1.5" onclick="setRatio(this)">3:2</button>
      <button class="rbtn" data-r="0.6667" onclick="setRatio(this)">2:3</button>
    </div>
    <div class="tool-sep"></div>
    <div class="dim-group">
      <input type="number" class="dinp" id="cropW" placeholder="W" oninput="dimInput('w')">
      <span class="dx">√ó</span>
      <input type="number" class="dinp" id="cropH" placeholder="H" oninput="dimInput('h')">
      <span class="dpx">px</span>
    </div>
  </div>

  <div id="canvasArea">
    <div id="imgWrap">
      <img id="theImg" src="" alt="">
      <div id="cropOv">
        <div class="shade" id="sT"></div>
        <div class="shade" id="sB"></div>
        <div class="shade" id="sL"></div>
        <div class="shade" id="sR"></div>
        <div id="cropBox">
          <div class="grid-line h g1"></div>
          <div class="grid-line h g2"></div>
          <div class="grid-line v g1"></div>
          <div class="grid-line v g2"></div>
          <div class="edge et"></div>
          <div class="edge eb"></div>
          <div class="edge el"></div>
          <div class="edge er"></div>
          <div class="hd tl" data-h="tl"></div>
          <div class="hd tr" data-h="tr"></div>
          <div class="hd bl" data-h="bl"></div>
          <div class="hd br" data-h="br"></div>
          <div class="hd tm" data-h="tm"></div>
          <div class="hd bm" data-h="bm"></div>
          <div class="hd ml" data-h="ml"></div>
          <div class="hd mr" data-h="mr"></div>
          <div id="sizeLabel">0 √ó 0</div>
        </div>
      </div>
    </div>
    <div class="zbar">
      <button class="zb" onclick="doZoom(-10)">‚àí</button>
      <div class="zi" id="zLbl">100%</div>
      <button class="zb" onclick="doZoom(10)">+</button>
      <button class="zb" onclick="fitZoom()">‚ä°</button>
    </div>
    <div class="img-info" id="imgInfo">-- √ó --</div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="dlModal">
  <div class="modal">
    <div class="modal-title">Crop & Download</div>
    <div class="modal-desc">Choose output format and quality</div>
    <div class="fmt-list">
      <div class="fopt sel" onclick="selFmt(this,'png')">
        <span class="fi">üñº</span>
        <div><div class="fn">PNG</div><div class="fd">Lossless, supports transparency</div></div>
      </div>
      <div class="fopt" onclick="selFmt(this,'jpeg')">
        <span class="fi">üì∑</span>
        <div><div class="fn">JPG</div><div class="fd">Smaller file, best for photos</div></div>
      </div>
      <div class="fopt" onclick="selFmt(this,'webp')">
        <span class="fi">üåê</span>
        <div><div class="fn">WEBP</div><div class="fd">Modern, great compression</div></div>
      </div>
    </div>
    <div class="q-sec" id="qSec" style="display:none">
      <div class="ql"><span>Quality</span><span id="qVal">92%</span></div>
      <input type="range" min="10" max="100" value="92" id="qSlider" oninput="document.getElementById('qVal').textContent=this.value+'%'">
    </div>
    <div class="modal-acts">
      <button class="nb sec" onclick="closeModal()">Cancel</button>
      <button class="nb pri" onclick="doCrop()">‚úÇ Crop & Download</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="lov" id="loading"><div class="spin"></div><div class="lov-t">Processing...</div></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FOOTER -->
<footer><span>Crop Image</span> ‚Äî 100% free. Your images never leave your browser.</footer>

<script>
let img=null,imgW=0,imgH=0,zoom=100,dispW=0,dispH=0;
let ratio=null,selFormat='png';
let crop={x:0,y:0,w:0,h:0};
let dragging=null,ds={mx:0,my:0,cx:0,cy:0,cw:0,ch:0};
const MIN=10;

document.addEventListener('DOMContentLoaded',()=>{
  const fi=document.getElementById('fileInput');
  const dz=document.getElementById('dropZone');

  fi.addEventListener('change',e=>{if(e.target.files[0])loadImg(e.target.files[0]);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});

  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])loadImg(e.dataTransfer.files[0])});

  const ov=document.getElementById('cropOv');
  ov.addEventListener('mousedown',onDown);
  window.addEventListener('mousemove',onMove);
  window.addEventListener('mouseup',onUp);
  ov.addEventListener('touchstart',e=>{e.preventDefault();onDown(tm(e))},{passive:false});
  window.addEventListener('touchmove',e=>{if(dragging){e.preventDefault();onMove(tm(e))}},{passive:false});
  window.addEventListener('touchend',()=>onUp(),{passive:true});

  document.getElementById('dlModal').addEventListener('click',e=>{if(e.target.id==='dlModal')closeModal()});
  window.addEventListener('resize',()=>{if(img)fitZoom()});
});

function tm(e){const t=e.touches[0]||e.changedTouches[0];return{clientX:t.clientX,clientY:t.clientY,target:e.target}}

function loadImg(file){
  if(!file.type.startsWith('image/')){toast('Please select an image');return}
  showLoad();
  const r=new FileReader();
  r.onload=e=>{
    const i=new Image();
    i.onload=()=>{
      img=i;imgW=i.naturalWidth;imgH=i.naturalHeight;
      document.getElementById('theImg').src=e.target.result;
      document.getElementById('uploadScreen').classList.add('hidden');
      document.getElementById('editorScreen').classList.add('active');
      document.getElementById('navBtns').style.display='flex';
      document.getElementById('imgInfo').textContent=imgW+' √ó '+imgH+' px';
      const p=.1;
      crop.x=Math.round(imgW*p);crop.y=Math.round(imgH*p);
      crop.w=Math.round(imgW*(1-2*p));crop.h=Math.round(imgH*(1-2*p));
      setTimeout(()=>{fitZoom();updateUI();hideLoad();toast('‚úì Drag corners to adjust crop area')},80);
    };
    i.src=e.target.result;
  };
  r.readAsDataURL(file);
}

// ZOOM
function doZoom(d){zoom=Math.max(10,Math.min(400,zoom+d));applyZ();updateUI()}
function fitZoom(){
  const a=document.getElementById('canvasArea');
  zoom=Math.round(Math.min((a.clientWidth-40)/imgW,(a.clientHeight-40)/imgH)*100);
  zoom=Math.max(10,Math.min(400,zoom));applyZ();updateUI();
}
function applyZ(){
  const s=zoom/100;dispW=Math.round(imgW*s);dispH=Math.round(imgH*s);
  const w=document.getElementById('imgWrap');
  w.style.width=dispW+'px';w.style.height=dispH+'px';
  const im=document.getElementById('theImg');
  im.style.width=dispW+'px';im.style.height=dispH+'px';
  document.getElementById('zLbl').textContent=zoom+'%';
}

// RATIO
function setRatio(btn){
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const r=btn.dataset.r;
  ratio=r==='free'?null:parseFloat(r);
  if(ratio){
    let nw=crop.w,nh=Math.round(nw/ratio);
    if(crop.y+nh>imgH){nh=imgH-crop.y;nw=Math.round(nh*ratio)}
    if(crop.x+nw>imgW){nw=imgW-crop.x;nh=Math.round(nw/ratio)}
    if(crop.y+nh>imgH)nh=imgH-crop.y;
    crop.w=Math.max(MIN,nw);crop.h=Math.max(MIN,nh);
    clamp();updateUI();
  }
}

// DIM INPUT
function dimInput(which){
  let w=parseInt(document.getElementById('cropW').value)||MIN;
  let h=parseInt(document.getElementById('cropH').value)||MIN;
  if(ratio){if(which==='w')h=Math.round(w/ratio);else w=Math.round(h*ratio)}
  w=Math.max(MIN,Math.min(w,imgW));h=Math.max(MIN,Math.min(h,imgH));
  crop.w=w;crop.h=h;
  if(crop.x+crop.w>imgW)crop.x=imgW-crop.w;
  if(crop.y+crop.h>imgH)crop.y=imgH-crop.h;
  crop.x=Math.max(0,crop.x);crop.y=Math.max(0,crop.y);
  updateUI();
}

// POINTER
function onDown(e){
  const t=e.target;
  if(t.classList.contains('hd')){dragging=t.dataset.h}
  else if(t.id==='cropBox'||t.closest('#cropBox')){dragging='move'}
  else{
    const rect=document.getElementById('cropOv').getBoundingClientRect();
    const s=zoom/100;
    const ix=Math.round((e.clientX-rect.left)/s);
    const iy=Math.round((e.clientY-rect.top)/s);
    crop.x=Math.max(0,Math.min(ix,imgW-MIN));
    crop.y=Math.max(0,Math.min(iy,imgH-MIN));
    crop.w=MIN;crop.h=MIN;
    dragging='br';
  }
  ds={mx:e.clientX,my:e.clientY,cx:crop.x,cy:crop.y,cw:crop.w,ch:crop.h};
}

function onMove(e){
  if(!dragging)return;
  const s=zoom/100;
  const dx=(e.clientX-ds.mx)/s;
  const dy=(e.clientY-ds.my)/s;
  if(dragging==='move'){
    crop.x=Math.max(0,Math.min(Math.round(ds.cx+dx),imgW-crop.w));
    crop.y=Math.max(0,Math.min(Math.round(ds.cy+dy),imgH-crop.h));
  }else{
    resize(dragging,dx,dy);
  }
  updateUI();
}

function onUp(){dragging=null}

function resize(h,dx,dy){
  let{cx,cy,cw,ch}=ds;
  let x=cx,y=cy,w=cw,ht=ch;
  const right=h.includes('r'),left=h.includes('l');
  const top=h==='tl'||h==='tr'||h==='tm';
  const bottom=h==='bl'||h==='br'||h==='bm';

  if(right)w=cw+dx;
  if(left){x=cx+dx;w=cw-dx}
  if(bottom)ht=ch+dy;
  if(top){y=cy+dy;ht=ch-dy}

  if(w<MIN){if(left)x=cx+cw-MIN;w=MIN}
  if(ht<MIN){if(top)y=cy+ch-MIN;ht=MIN}

  if(ratio){
    if(h==='ml'||h==='mr'){ht=Math.round(w/ratio)}
    else if(h==='tm'||h==='bm'){w=Math.round(ht*ratio)}
    else{const nh=Math.round(w/ratio);if(top)y=cy+ch-nh;ht=nh}
  }

  x=Math.max(0,Math.round(x));y=Math.max(0,Math.round(y));
  w=Math.round(w);ht=Math.round(ht);
  if(x+w>imgW)w=imgW-x;
  if(y+ht>imgH)ht=imgH-y;
  crop.x=x;crop.y=y;crop.w=Math.max(MIN,w);crop.h=Math.max(MIN,ht);
}

function clamp(){
  crop.x=Math.max(0,Math.min(crop.x,imgW-crop.w));
  crop.y=Math.max(0,Math.min(crop.y,imgH-crop.h));
}

// UPDATE UI
function updateUI(){
  const s=zoom/100;
  const bx=crop.x*s,by=crop.y*s,bw=crop.w*s,bh=crop.h*s;

  const box=document.getElementById('cropBox');
  box.style.left=bx+'px';box.style.top=by+'px';
  box.style.width=bw+'px';box.style.height=bh+'px';

  document.getElementById('sT').style.height=by+'px';
  const sB=document.getElementById('sB');
  sB.style.height=(dispH-by-bh)+'px';
  const sL=document.getElementById('sL');
  sL.style.top=by+'px';sL.style.width=bx+'px';sL.style.height=bh+'px';
  const sR=document.getElementById('sR');
  sR.style.top=by+'px';sR.style.width=(dispW-bx-bw)+'px';sR.style.height=bh+'px';

  document.getElementById('sizeLabel').textContent=crop.w+' √ó '+crop.h;
  document.getElementById('cropW').value=crop.w;
  document.getElementById('cropH').value=crop.h;
}

// RESET
function resetCrop(){
  if(!img)return;
  ratio=null;
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.rbtn[data-r="free"]').classList.add('active');
  const p=.1;
  crop.x=Math.round(imgW*p);crop.y=Math.round(imgH*p);
  crop.w=Math.round(imgW*(1-2*p));crop.h=Math.round(imgH*(1-2*p));
  updateUI();toast('‚Ü∫ Reset');
}

function newImage(){
  document.getElementById('editorScreen').classList.remove('active');
  document.getElementById('uploadScreen').classList.remove('hidden');
  document.getElementById('navBtns').style.display='none';
  img=null;ratio=null;
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.rbtn[data-r="free"]').classList.add('active');
}

// MODAL
function openModal(){document.getElementById('dlModal').classList.add('active')}
function closeModal(){document.getElementById('dlModal').classList.remove('active')}
function selFmt(el,f){
  document.querySelectorAll('.fopt').forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');selFormat=f;
  document.getElementById('qSec').style.display=(f==='jpeg'||f==='webp')?'block':'none';
}

function doCrop(){
  if(!img)return;
  showLoad();closeModal();
  setTimeout(()=>{
    const cv=document.createElement('canvas');
    cv.width=crop.w;cv.height=crop.h;
    const cx=cv.getContext('2d');
    cx.drawImage(img,crop.x,crop.y,crop.w,crop.h,0,0,crop.w,crop.h);
    let mime='image/png',ext='png';
    if(selFormat==='jpeg'){mime='image/jpeg';ext='jpg'}
    if(selFormat==='webp'){mime='image/webp';ext='webp'}
    const q=parseInt(document.getElementById('qSlider').value)/100;
    const url=selFormat==='png'?cv.toDataURL(mime):cv.toDataURL(mime,q);
    const a=document.createElement('a');
    a.href=url;a.download='cropped.'+ext;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    hideLoad();toast('‚úì Image cropped & downloaded!');
  },80);
}

// UTILS
function showLoad(){document.getElementById('loading').classList.add('active')}
function hideLoad(){document.getElementById('loading').classList.remove('active')}
function toast(m){
  const t=document.getElementById('toast');
  t.textContent=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
