<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Crop Image - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column;
  overflow-x:hidden
}

/* NAV */
nav{
  background:#fff;padding:12px 24px;display:flex;align-items:center;
  border-bottom:1px solid #e8ecf0;box-shadow:0 1px 3px rgba(0,0,0,.04);
  position:sticky;top:0;z-index:100
}
.nav-logo{
  width:36px;height:36px;background:linear-gradient(135deg,#1d9c73,#27ae60);
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:900;font-size:.85rem;margin-right:10px;flex-shrink:0
}
.nav-title{font-weight:700;font-size:1.05rem;color:#1d9c73}
.nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.nav-btn{
  padding:8px 18px;border:none;border-radius:8px;font-size:.82rem;
  font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px
}
.nav-btn.sec{background:#f0f2f5;color:#666}
.nav-btn.sec:hover{background:#e4e6e9}
.nav-btn.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  box-shadow:0 2px 8px rgba(29,156,115,.2)}
.nav-btn.pri:hover{box-shadow:0 4px 14px rgba(29,156,115,.3);transform:translateY(-1px)}
.nav-btn.rst{color:#e74c3c;background:#fdf2f2}
.nav-btn.rst:hover{background:#fce4e4}

/* ===== UPLOAD SCREEN ===== */
#uploadScreen{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:40px 20px;
  background:linear-gradient(180deg,#f0faf5 0%,#f5f7fa 100%)
}
#uploadScreen.hidden{display:none}
.u-icon{
  width:72px;height:72px;background:linear-gradient(135deg,#1d9c73,#27ae60);
  border-radius:18px;display:flex;align-items:center;justify-content:center;
  font-size:2rem;margin-bottom:20px;box-shadow:0 8px 28px rgba(29,156,115,.2)
}
.u-title{font-size:2rem;font-weight:800;color:#222;margin-bottom:8px;text-align:center}
.u-title span{color:#1d9c73}
.u-desc{color:#888;font-size:.95rem;margin-bottom:30px;text-align:center;max-width:460px;line-height:1.5}

#dropZone{
  width:100%;max-width:580px;padding:48px 28px;border:2.5px dashed #c8e6c9;
  border-radius:16px;background:#fff;text-align:center;cursor:pointer;
  transition:all .25s
}
#dropZone:hover,#dropZone.dragover{
  border-color:#1d9c73;background:#f7fdf9;transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(29,156,115,.08)
}
.dz-icon{font-size:3rem;margin-bottom:10px;opacity:.55}
.dz-text{font-size:1rem;color:#666;font-weight:500;margin-bottom:4px}
.dz-hint{font-size:.82rem;color:#bbb;margin-bottom:16px}
.dz-btn{
  display:inline-block;padding:12px 34px;
  background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  border:none;border-radius:30px;font-size:.95rem;font-weight:700;
  cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.25)
}
.dz-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.3)}
.dz-fmt{font-size:.73rem;color:#ccc;margin-top:14px}
#fileInput{display:none}

/* ===== EDITOR ===== */
#editorScreen{display:none;flex:1;flex-direction:column;overflow:hidden}
#editorScreen.active{display:flex}

/* TOOLBAR */
.toolbar{
  background:#fff;border-bottom:1px solid #e8ecf0;padding:10px 16px;
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  box-shadow:0 1px 3px rgba(0,0,0,.03)
}
.tool-label{font-size:.8rem;font-weight:600;color:#888;margin-right:4px;white-space:nowrap}
.ratio-group{display:flex;gap:4px;flex-wrap:wrap}
.ratio-btn{
  padding:6px 14px;border:1.5px solid #e0e3e7;border-radius:8px;
  background:#fff;color:#555;font-size:.78rem;font-weight:600;
  cursor:pointer;transition:all .15s;white-space:nowrap
}
.ratio-btn:hover{border-color:#1d9c73;color:#1d9c73}
.ratio-btn.active{background:#eef9f3;border-color:#1d9c73;color:#1d9c73}

.tool-sep{width:1px;height:28px;background:#e8ecf0;margin:0 6px;flex-shrink:0}

.dim-group{display:flex;align-items:center;gap:5px}
.dim-inp{
  width:68px;padding:6px 8px;border:1.5px solid #e0e3e7;border-radius:6px;
  font-size:.8rem;text-align:center;color:#333;background:#fafafa;font-weight:600
}
.dim-inp:focus{outline:none;border-color:#1d9c73;background:#fff}
.dim-x{color:#bbb;font-weight:700;font-size:.85rem}

/* CANVAS AREA */
#canvasArea{
  flex:1;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  background:#e8ecf0;
  background-image:
    linear-gradient(45deg,#dfe3e8 25%,transparent 25%),
    linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#dfe3e8 75%),
    linear-gradient(-45deg,transparent 75%,#dfe3e8 75%);
  background-size:16px 16px;
  background-position:0 0,0 8px,8px -8px,-8px 0
}

#imgContainer{
  position:relative;display:inline-block;user-select:none;
  box-shadow:0 4px 30px rgba(0,0,0,.1)
}
#imgContainer img{display:block;max-width:none}

/* CROP OVERLAY */
#cropOverlay{
  position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;cursor:crosshair
}
/* Dark overlay regions */
.shade{position:absolute;background:rgba(0,0,0,.55);pointer-events:none}
#shadeT{top:0;left:0;right:0}
#shadeB{bottom:0;left:0;right:0}
#shadeL{left:0}
#shadeR{right:0}

/* Crop box */
#cropBox{
  position:absolute;border:2px solid #fff;cursor:move;z-index:12;
  box-shadow:0 0 0 1px rgba(0,0,0,.15),inset 0 0 0 1px rgba(255,255,255,.2)
}
/* Grid */
#cropBox::before{
  content:'';position:absolute;inset:0;
  background:
    linear-gradient(to right,rgba(255,255,255,.25) 1px,transparent 1px),
    linear-gradient(to bottom,rgba(255,255,255,.25) 1px,transparent 1px);
  background-size:33.333% 33.333%;pointer-events:none
}

/* Handles */
.handle{
  position:absolute;width:12px;height:12px;background:#fff;
  border:2px solid #1d9c73;z-index:14;border-radius:2px;
  box-shadow:0 1px 3px rgba(0,0,0,.3)
}
.handle.tl{top:-6px;left:-6px;cursor:nw-resize}
.handle.tr{top:-6px;right:-6px;cursor:ne-resize}
.handle.bl{bottom:-6px;left:-6px;cursor:sw-resize}
.handle.br{bottom:-6px;right:-6px;cursor:se-resize}
.handle.tm{top:-6px;left:50%;transform:translateX(-50%);cursor:n-resize}
.handle.bm{bottom:-6px;left:50%;transform:translateX(-50%);cursor:s-resize}
.handle.ml{left:-6px;top:50%;transform:translateY(-50%);cursor:w-resize}
.handle.mr{right:-6px;top:50%;transform:translateY(-50%);cursor:e-resize}

/* Size label */
#sizeLabel{
  position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.7);color:#fff;padding:3px 10px;border-radius:4px;
  font-size:.72rem;font-weight:600;white-space:nowrap;pointer-events:none;z-index:15
}

/* Zoom controls */
.zoom-bar{
  position:absolute;bottom:14px;right:14px;display:flex;gap:3px;
  background:#fff;border-radius:10px;padding:4px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);border:1px solid #e5e7eb;z-index:20
}
.z-btn{
  width:32px;height:32px;border:none;border-radius:6px;background:#f5f5f5;
  color:#555;cursor:pointer;font-size:.85rem;display:flex;align-items:center;
  justify-content:center;transition:all .12s
}
.z-btn:hover{background:#1d9c73;color:#fff}
.z-info{display:flex;align-items:center;padding:0 8px;font-size:.75rem;color:#888;font-weight:700}

/* Image info */
.img-info{
  position:absolute;bottom:14px;left:14px;background:#fff;padding:5px 12px;
  border-radius:8px;font-size:.73rem;color:#888;box-shadow:0 2px 8px rgba(0,0,0,.06);
  border:1px solid #e5e7eb;font-weight:600;z-index:20
}

/* ===== DOWNLOAD MODAL ===== */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;
  align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(3px)
}
.modal-bg.active{display:flex}
.modal{
  background:#fff;border-radius:16px;padding:28px;width:min(92vw,400px);
  box-shadow:0 10px 40px rgba(0,0,0,.12)
}
.modal-title{font-size:1.15rem;font-weight:700;color:#333;margin-bottom:6px}
.modal-desc{font-size:.82rem;color:#999;margin-bottom:18px}
.fmt-list{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
.fmt-opt{
  padding:12px 14px;border:2px solid #eee;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;gap:12px;transition:all .12s
}
.fmt-opt:hover{border-color:#1d9c73}
.fmt-opt.sel{border-color:#1d9c73;background:#f0faf5}
.fmt-opt .ficon{font-size:1.3rem}
.fmt-opt .fname{font-weight:600;font-size:.88rem}
.fmt-opt .fdesc{font-size:.7rem;color:#aaa}
.q-sec{margin-bottom:18px}
.q-sec .sl{display:flex;justify-content:space-between;font-size:.8rem;color:#666;margin-bottom:5px}
.q-sec .sl span:last-child{color:#1d9c73;font-weight:700}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:#e0e0e0;outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:#1d9c73;cursor:pointer;border:3px solid #fff;
  box-shadow:0 1px 4px rgba(0,0,0,.2)
}
.modal-acts{display:flex;gap:10px}
.modal-acts .nav-btn{flex:1;justify-content:center;padding:11px}

/* TOAST */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#fff;color:#333;padding:12px 22px;border-radius:10px;
  font-size:.85rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);
  z-index:300;transition:transform .3s;border-left:4px solid #1d9c73
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* LOADING */
.lov{
  position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;
  align-items:center;justify-content:center;z-index:400;flex-direction:column;gap:12px
}
.lov.active{display:flex}
.spin{
  width:40px;height:40px;border:4px solid #e0e0e0;border-top-color:#1d9c73;
  border-radius:50%;animation:sp .65s linear infinite
}
@keyframes sp{to{transform:rotate(360deg)}}
.lov-t{color:#888;font-size:.88rem;font-weight:500}

/* FOOTER */
footer{
  text-align:center;padding:18px;color:#bbb;font-size:.76rem;
  border-top:1px solid #eef0f3;background:#fff
}
footer span{color:#1d9c73;font-weight:600}

/* RESPONSIVE */
@media(max-width:768px){
  .toolbar{padding:8px 10px;gap:5px}
  .ratio-btn{padding:5px 10px;font-size:.72rem}
  .tool-sep{display:none}
  .dim-group{width:100%;justify-content:center;margin-top:2px}
  .u-title{font-size:1.5rem}
  #dropZone{padding:34px 20px}
  .nav-btn span{display:none}
  .nav-btn{padding:8px 12px}
}
@media(max-width:480px){
  .u-icon{width:56px;height:56px;font-size:1.6rem;border-radius:14px}
  .u-title{font-size:1.3rem}
  .dz-icon{font-size:2.4rem}
  .ratio-btn{padding:4px 8px;font-size:.68rem}
  .dim-inp{width:56px;font-size:.75rem;padding:5px 4px}
  .handle{width:16px;height:16px}
  .handle.tl{top:-8px;left:-8px}
  .handle.tr{top:-8px;right:-8px}
  .handle.bl{bottom:-8px;left:-8px}
  .handle.br{bottom:-8px;right:-8px}
  .handle.tm{top:-8px}
  .handle.bm{bottom:-8px}
  .handle.ml{left:-8px}
  .handle.mr{right:-8px}
}
</style>
</head>
<body>

<!-- NAV -->
<nav id="navBar">
  <div class="nav-logo">‚úÇ</div>
  <span class="nav-title">Crop Image</span>
  <div class="nav-right" id="navBtns" style="display:none">
    <button class="nav-btn rst" onclick="resetCrop()">‚Ü∫ <span>Reset</span></button>
    <button class="nav-btn sec" onclick="newImage()">+ <span>New</span></button>
    <button class="nav-btn pri" onclick="openModal()">‚§ì <span>Crop & Download</span></button>
  </div>
</nav>

<!-- UPLOAD SCREEN -->
<div id="uploadScreen">
  <div class="u-icon">‚úÇ</div>
  <div class="u-title">Crop <span>Image</span> Online</div>
  <div class="u-desc">Crop JPG, PNG or WEBP images online for free. Select your area and download instantly.</div>
  <div id="dropZone">
    <div class="dz-icon">üìÅ</div>
    <div class="dz-text">Drag & drop your image here</div>
    <div class="dz-hint">or</div>
    <button class="dz-btn" onclick="document.getElementById('fileInput').click()">Select Image</button>
    <div class="dz-fmt">JPG, PNG, WEBP, GIF, BMP, SVG</div>
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- EDITOR -->
<div id="editorScreen">
  <!-- TOOLBAR -->
  <div class="toolbar">
    <span class="tool-label">Ratio:</span>
    <div class="ratio-group" id="ratioGroup">
      <button class="ratio-btn active" data-r="free" onclick="setRatio(this)">Free</button>
      <button class="ratio-btn" data-r="1" onclick="setRatio(this)">1:1</button>
      <button class="ratio-btn" data-r="1.3333" onclick="setRatio(this)">4:3</button>
      <button class="ratio-btn" data-r="0.75" onclick="setRatio(this)">3:4</button>
      <button class="ratio-btn" data-r="1.7778" onclick="setRatio(this)">16:9</button>
      <button class="ratio-btn" data-r="0.5625" onclick="setRatio(this)">9:16</button>
      <button class="ratio-btn" data-r="1.5" onclick="setRatio(this)">3:2</button>
      <button class="ratio-btn" data-r="0.6667" onclick="setRatio(this)">2:3</button>
    </div>
    <div class="tool-sep"></div>
    <div class="dim-group">
      <input type="number" class="dim-inp" id="cropW" placeholder="W" oninput="dimChanged('w')">
      <span class="dim-x">√ó</span>
      <input type="number" class="dim-inp" id="cropH" placeholder="H" oninput="dimChanged('h')">
      <span style="font-size:.72rem;color:#bbb;margin-left:2px">px</span>
    </div>
  </div>

  <!-- CANVAS AREA -->
  <div id="canvasArea">
    <div id="imgContainer">
      <img id="theImage" src="" alt="">
      <div id="cropOverlay">
        <!-- Shade regions -->
        <div class="shade" id="shadeT"></div>
        <div class="shade" id="shadeB"></div>
        <div class="shade" id="shadeL"></div>
        <div class="shade" id="shadeR"></div>
        <!-- Crop box -->
        <div id="cropBox">
          <div class="handle tl" data-h="tl"></div>
          <div class="handle tr" data-h="tr"></div>
          <div class="handle bl" data-h="bl"></div>
          <div class="handle br" data-h="br"></div>
          <div class="handle tm" data-h="tm"></div>
          <div class="handle bm" data-h="bm"></div>
          <div class="handle ml" data-h="ml"></div>
          <div class="handle mr" data-h="mr"></div>
          <div id="sizeLabel">0 √ó 0</div>
        </div>
      </div>
    </div>
    <div class="zoom-bar">
      <button class="z-btn" onclick="doZoom(-10)">‚àí</button>
      <div class="z-info" id="zoomLbl">100%</div>
      <button class="z-btn" onclick="doZoom(10)">+</button>
      <button class="z-btn" onclick="fitZoom()">‚ä°</button>
    </div>
    <div class="img-info" id="imgInfo">-- √ó --</div>
  </div>
</div>

<!-- DOWNLOAD MODAL -->
<div class="modal-bg" id="dlModal">
  <div class="modal">
    <div class="modal-title">Crop & Download</div>
    <div class="modal-desc">Choose output format</div>
    <div class="fmt-list">
      <div class="fmt-opt sel" onclick="selFmt(this,'png')">
        <span class="ficon">üñº</span>
        <div><div class="fname">PNG</div><div class="fdesc">Lossless, supports transparency</div></div>
      </div>
      <div class="fmt-opt" onclick="selFmt(this,'jpeg')">
        <span class="ficon">üì∑</span>
        <div><div class="fname">JPG</div><div class="fdesc">Smaller file, best for photos</div></div>
      </div>
      <div class="fmt-opt" onclick="selFmt(this,'webp')">
        <span class="ficon">üåê</span>
        <div><div class="fname">WEBP</div><div class="fdesc">Modern, great compression</div></div>
      </div>
    </div>
    <div class="q-sec" id="qSec" style="display:none">
      <div class="sl"><span>Quality</span><span id="qVal">92%</span></div>
      <input type="range" min="10" max="100" value="92" id="qSlider" oninput="document.getElementById('qVal').textContent=this.value+'%'">
    </div>
    <div class="modal-acts">
      <button class="nav-btn sec" onclick="closeModal()">Cancel</button>
      <button class="nav-btn pri" onclick="cropAndDownload()">‚úÇ Crop & Download</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="lov" id="loading"><div class="spin"></div><div class="lov-t">Processing...</div></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FOOTER -->
<footer>
  <span>Crop Image</span> ‚Äî 100% free. Your images never leave your browser.
</footer>

<script>
// ===== STATE =====
let img = null;
let imgW = 0, imgH = 0;
let zoom = 100;
let dispW = 0, dispH = 0;
let ratio = null; // null = free
let selFormat = 'png';

// Crop box in image coordinates (pixels)
let crop = { x: 0, y: 0, w: 0, h: 0 };

// Drag state
let dragging = null; // 'move' | handle name
let dragStart = { mx: 0, my: 0, cx: 0, cy: 0, cw: 0, ch: 0 };

const MIN_SIZE = 10;

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  const fi = document.getElementById('fileInput');
  const dz = document.getElementById('dropZone');

  fi.addEventListener('change', e => {
    if (e.target.files[0]) loadImage(e.target.files[0]);
    fi.value = '';
  });

  dz.addEventListener('click', e => {
    if (e.target.tagName !== 'BUTTON') fi.click();
  });

  ['dragenter','dragover'].forEach(ev =>
    dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('dragover'); })
  );
  ['dragleave','drop'].forEach(ev =>
    dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('dragover'); })
  );
  dz.addEventListener('drop', e => {
    if (e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]);
  });

  // Pointer events on overlay
  const ov = document.getElementById('cropOverlay');
  ov.addEventListener('mousedown', onDown);
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
  ov.addEventListener('touchstart', e => { e.preventDefault(); onDown(toMouse(e)); }, { passive: false });
  window.addEventListener('touchmove', e => { if (dragging) { e.preventDefault(); onMove(toMouse(e)); } }, { passive: false });
  window.addEventListener('touchend', e => { onUp(); }, { passive: true });

  // Modal outside click
  document.getElementById('dlModal').addEventListener('click', e => {
    if (e.target.id === 'dlModal') closeModal();
  });

  window.addEventListener('resize', () => {
    if (img) { fitZoom(); }
  });
});

function toMouse(e) {
  const t = e.touches[0] || e.changedTouches[0];
  return { clientX: t.clientX, clientY: t.clientY, target: e.target };
}

// ===== LOAD IMAGE =====
function loadImage(file) {
  if (!file.type.startsWith('image/')) {
    toast('Please select an image file'); return;
  }
  showLoad();
  const reader = new FileReader();
  reader.onload = e => {
    const i = new Image();
    i.onload = () => {
      img = i;
      imgW = i.naturalWidth;
      imgH = i.naturalHeight;

      document.getElementById('theImage').src = e.target.result;
      document.getElementById('uploadScreen').classList.add('hidden');
      document.getElementById('editorScreen').classList.add('active');
      document.getElementById('navBtns').style.display = 'flex';
      document.getElementById('imgInfo').textContent = imgW + ' √ó ' + imgH + ' px';

      // Default crop = full image with 10% padding
      const pad = 0.1;
      crop.x = Math.round(imgW * pad);
      crop.y = Math.round(imgH * pad);
      crop.w = Math.round(imgW * (1 - 2 * pad));
      crop.h = Math.round(imgH * (1 - 2 * pad));

      setTimeout(() => {
        fitZoom();
        updateUI();
        hideLoad();
        toast('‚úì Image loaded ‚Äî drag the crop area');
      }, 100);
    };
    i.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ===== ZOOM =====
function doZoom(d) {
  zoom = Math.max(10, Math.min(400, zoom + d));
  applyZoom();
  updateUI();
}

function fitZoom() {
  const area = document.getElementById('canvasArea');
  const maxW = area.clientWidth - 40;
  const maxH = area.clientHeight - 40;
  zoom = Math.round(Math.min(maxW / imgW, maxH / imgH) * 100);
  zoom = Math.max(10, Math.min(400, zoom));
  applyZoom();
}

function applyZoom() {
  const s = zoom / 100;
  dispW = Math.round(imgW * s);
  dispH = Math.round(imgH * s);
  const container = document.getElementById('imgContainer');
  container.style.width = dispW + 'px';
  container.style.height = dispH + 'px';
  const theImg = document.getElementById('theImage');
  theImg.style.width = dispW + 'px';
  theImg.style.height = dispH + 'px';
  document.getElementById('zoomLbl').textContent = zoom + '%';
}

// ===== RATIO =====
function setRatio(btn) {
  document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const r = btn.dataset.r;
  ratio = r === 'free' ? null : parseFloat(r);

  if (ratio) {
    // Adjust crop to match ratio
    let newW = crop.w;
    let newH = Math.round(newW / ratio);
    if (newH > imgH) {
      newH = imgH - crop.y;
      newW = Math.round(newH * ratio);
    }
    if (crop.x + newW > imgW) newW = imgW - crop.x;
    newH = Math.round(newW / ratio);
    if (crop.y + newH > imgH) {
      newH = imgH - crop.y;
      newW = Math.round(newH * ratio);
    }
    crop.w = Math.max(MIN_SIZE, newW);
    crop.h = Math.max(MIN_SIZE, newH);
    clampCrop();
    updateUI();
  }
}

// ===== DIM INPUTS =====
function dimChanged(which) {
  let w = parseInt(document.getElementById('cropW').value) || MIN_SIZE;
  let h = parseInt(document.getElementById('cropH').value) || MIN_SIZE;

  if (ratio) {
    if (which === 'w') h = Math.round(w / ratio);
    else w = Math.round(h * ratio);
  }

  w = Math.max(MIN_SIZE, Math.min(w, imgW));
  h = Math.max(MIN_SIZE, Math.min(h, imgH));

  crop.w = w;
  crop.h = h;
  // Center if out of bounds
  if (crop.x + crop.w > imgW) crop.x = imgW - crop.w;
  if (crop.y + crop.h > imgH) crop.y = imgH - crop.h;
  crop.x = Math.max(0, crop.x);
  crop.y = Math.max(0, crop.y);
  updateUI();
}

// ===== POINTER HANDLERS =====
function onDown(e) {
  const target = e.target;
  const rect = document.getElementById('cropOverlay').getBoundingClientRect();
  const mx = e.clientX;
  const my = e.clientY;

  // Check if handle
  if (target.classList.contains('handle')) {
    dragging = target.dataset.h;
  } else if (target.id === 'cropBox' || target.closest('#cropBox')) {
    dragging = 'move';
  } else {
    // Start new crop from click position
    const s = zoom / 100;
    const ix = Math.round((mx - rect.left) / s);
    const iy = Math.round((my - rect.top) / s);
    crop.x = Math.max(0, Math.min(ix, imgW - MIN_SIZE));
    crop.y = Math.max(0, Math.min(iy, imgH - MIN_SIZE));
    crop.w = MIN_SIZE;
    crop.h = MIN_SIZE;
    dragging = 'br';
  }

  dragStart = {
    mx, my,
    cx: crop.x, cy: crop.y,
    cw: crop.w, ch: crop.h
  };
}

function onMove(e) {
  if (!dragging) return;

  const s = zoom / 100;
  const dx = (e.clientX - dragStart.mx) / s;
  const dy = (e.clientY - dragStart.my) / s;

  if (dragging === 'move') {
    crop.x = Math.round(dragStart.cx + dx);
    crop.y = Math.round(dragStart.cy + dy);
    crop.x = Math.max(0, Math.min(crop.x, imgW - crop.w));
    crop.y = Math.max(0, Math.min(crop.y, imgH - crop.h));
  } else {
    resizeCrop(dragging, dx, dy);
  }

  updateUI();
}

function onUp() {
  dragging = null;
}

function resizeCrop(handle, dx, dy) {
  let { cx, cy, cw, ch } = dragStart;
  let x = cx, y = cy, w = cw, h = ch;

  const right = handle.includes('r');
  const left = handle.includes('l');
  const top = handle === 'tl' || handle === 'tr' || handle === 'tm';
  const bottom = handle === 'bl' || handle === 'br' || handle === 'bm';

  if (right) w = cw + dx;
  if (left) { x = cx + dx; w = cw - dx; }
  if (bottom) h = ch + dy;
  if (top) { y = cy + dy; h = ch - dy; }

  // Enforce minimum
  if (w < MIN_SIZE) { if (left) x = cx + cw - MIN_SIZE; w = MIN_SIZE; }
  if (h < MIN_SIZE) { if (top) y = cy + ch - MIN_SIZE; h = MIN_SIZE; }

  // Enforce ratio
  if (ratio) {
    if (handle === 'ml' || handle === 'mr') {
      h = Math.round(w / ratio);
    } else if (handle === 'tm' || handle === 'bm') {
      w = Math.round(h * ratio);
    } else {
      // Corner: use larger dimension
      const newH = Math.round(w / ratio);
      if (top) y = cy + ch - newH;
      h = newH;
    }
  }

  // Clamp
  x = Math.max(0, Math.round(x));
  y = Math.max(0, Math.round(y));
  w = Math.round(w);
  h = Math.round(h);
  if (x + w > imgW) w = imgW - x;
  if (y + h > imgH) h = imgH - y;
  w = Math.max(MIN_SIZE, w);
  h = Math.max(MIN_SIZE, h);

  crop.x = x; crop.y = y; crop.w = w; crop.h = h;
}

function clampCrop() {
  crop.x = Math.max(0, Math.min(crop.x, imgW - crop.w));
  crop.y = Math.max(0, Math.min(crop.y, imgH - crop.h));
  crop.w = Math.max(MIN_SIZE, Math.min(crop.w, imgW - crop.x));
  crop.h = Math.max(MIN_SIZE, Math.min(crop.h, imgH - crop.y));
}

// ===== UPDATE UI =====
function updateUI() {
  const s = zoom / 100;
  const bx = crop.x * s;
  const by = crop.y * s;
  const bw = crop.w * s;
  const bh = crop.h * s;

  // Crop box
  const box = document.getElementById('cropBox');
  box.style.left = bx + 'px';
  box.style.top = by + 'px';
  box.style.width = bw + 'px';
  box.style.height = bh + 'px';

  // Shades
  document.getElementById('shadeT').style.height = by + 'px';
  document.getElementById('shadeB').style.cssText = `bottom:0;left:0;right:0;height:${dispH - by - bh}px`;
  document.getElementById('shadeL').style.cssText = `left:0;top:${by}px;width:${bx}px;height:${bh}px`;
  document.getElementById('shadeR').style.cssText = `right:0;top:${by}px;width:${dispW - bx - bw}px;height:${bh}px`;

  // Size label
  document.getElementById('sizeLabel').textContent = crop.w + ' √ó ' + crop.h;

  // Dim inputs
  document.getElementById('cropW').value = crop.w;
  document.getElementById('cropH').value = crop.h;
}

// ===== RESET =====
function resetCrop() {
  if (!img) return;
  ratio = null;
  document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.ratio-btn[data-r="free"]').classList.add('active');
  const pad = 0.1;
  crop.x = Math.round(imgW * pad);
  crop.y = Math.round(imgH * pad);
  crop.w = Math.round(imgW * (1 - 2 * pad));
  crop.h = Math.round(imgH * (1 - 2 * pad));
  updateUI();
  toast('‚Ü∫ Crop area reset');
}

function newImage() {
  document.getElementById('editorScreen').classList.remove('active');
  document.getElementById('uploadScreen').classList.remove('hidden');
  document.getElementById('navBtns').style.display = 'none';
  img = null;
  ratio = null;
  document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.ratio-btn[data-r="free"]').classList.add('active');
}

// ===== DOWNLOAD =====
function openModal() {
  document.getElementById('dlModal').classList.add('active');
}
function closeModal() {
  document.getElementById('dlModal').classList.remove('active');
}

function selFmt(el, fmt) {
  document.querySelectorAll('.fmt-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
  selFormat = fmt;
  document.getElementById('qSec').style.display = (fmt === 'jpeg' || fmt === 'webp') ? 'block' : 'none';
}

function cropAndDownload() {
  if (!img) return;
  showLoad();
  closeModal();

  setTimeout(() => {
    const canvas = document.createElement('canvas');
    canvas.width = crop.w;
    canvas.height = crop.h;
    const ctx = canvas.getContext('2d');

    // Draw cropped region
    ctx.drawImage(img, crop.x, crop.y, crop.w, crop.h, 0, 0, crop.w, crop.h);

    let mime = 'image/png', ext = 'png';
    if (selFormat === 'jpeg') { mime = 'image/jpeg'; ext = 'jpg'; }
    if (selFormat === 'webp') { mime = 'image/webp'; ext = 'webp'; }

    const q = parseInt(document.getElementById('qSlider').value) / 100;
    const url = selFormat === 'png' ? canvas.toDataURL(mime) : canvas.toDataURL(mime, q);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'cropped-image.' + ext;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    hideLoad();
    toast('‚úì Image cropped & downloaded!');
  }, 100);
}

// ===== UTILS =====
function showLoad() { document.getElementById('loading').classList.add('active'); }
function hideLoad() { document.getElementById('loading').classList.remove('active'); }
function toast(m) {
  const t = document.getElementById('toast');
  t.textContent = m;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
