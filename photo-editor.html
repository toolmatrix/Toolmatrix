<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üì∏ Photo Editor Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f1a;--surface:#1a1a2e;--surface2:#16213e;--primary:#e94560;
  --primary-hover:#ff6b81;--accent:#0f3460;--text:#eee;--text2:#aaa;
  --success:#00d2d3;--warning:#feca57;--radius:12px;--shadow:0 8px 32px rgba(0,0,0,.4)
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}

/* UPLOAD SCREEN */
#uploadScreen{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:100;
  background:linear-gradient(135deg,#0f0f1a 0%,#1a1a2e 50%,#16213e 100%)
}
#uploadScreen.hidden{display:none}
.upload-logo{font-size:3rem;margin-bottom:1rem;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.upload-title{font-size:2.2rem;font-weight:800;margin-bottom:.5rem;
  background:linear-gradient(135deg,var(--primary),var(--success));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.upload-subtitle{color:var(--text2);margin-bottom:2rem;font-size:1rem;text-align:center;padding:0 1rem}
#dropZone{
  width:min(90vw,550px);height:280px;border:3px dashed var(--primary);
  border-radius:var(--radius);display:flex;flex-direction:column;
  align-items:center;justify-content:center;cursor:pointer;
  transition:all .3s;background:rgba(233,69,96,.05);position:relative
}
#dropZone:hover,#dropZone.dragover{
  border-color:var(--success);background:rgba(0,210,211,.08);transform:scale(1.02)
}
#dropZone .drop-icon{font-size:4rem;margin-bottom:1rem}
#dropZone .drop-text{font-size:1.1rem;color:var(--text2);text-align:center;padding:0 1rem}
#dropZone .drop-btn{
  margin-top:1rem;padding:.7rem 2rem;background:var(--primary);color:#fff;
  border:none;border-radius:30px;font-size:1rem;cursor:pointer;
  font-weight:600;transition:all .3s
}
#dropZone .drop-btn:hover{background:var(--primary-hover);transform:scale(1.05)}
.supported{color:var(--text2);font-size:.8rem;margin-top:1rem}
#fileInput{display:none}

/* EDITOR */
#editor{display:none;width:100%;height:100%;flex-direction:column}
#editor.active{display:flex}

/* TOP BAR */
#topBar{
  height:56px;min-height:56px;background:var(--surface);display:flex;
  align-items:center;padding:0 12px;gap:8px;border-bottom:1px solid rgba(255,255,255,.06);
  z-index:50
}
#topBar .logo{font-weight:800;font-size:1.1rem;margin-right:auto;
  display:flex;align-items:center;gap:6px;white-space:nowrap}
#topBar .logo span{
  background:linear-gradient(135deg,var(--primary),var(--success));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.top-btn{
  padding:6px 14px;border:none;border-radius:8px;cursor:pointer;
  font-size:.85rem;font-weight:600;transition:all .2s;display:flex;
  align-items:center;gap:5px;white-space:nowrap
}
.top-btn.undo-redo{background:var(--surface2);color:var(--text)}
.top-btn.undo-redo:hover{background:var(--accent)}
.top-btn.undo-redo:disabled{opacity:.3;cursor:default}
.top-btn.reset{background:var(--surface2);color:var(--warning)}
.top-btn.reset:hover{background:rgba(254,202,87,.15)}
.top-btn.new{background:var(--surface2);color:var(--success)}
.top-btn.new:hover{background:rgba(0,210,211,.15)}
.top-btn.download{background:var(--primary);color:#fff}
.top-btn.download:hover{background:var(--primary-hover);transform:scale(1.03)}

/* MAIN AREA */
#mainArea{display:flex;flex:1;overflow:hidden}

/* SIDEBAR */
#sidebar{
  width:280px;min-width:280px;background:var(--surface);overflow-y:auto;
  border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column
}
.tool-tabs{
  display:flex;overflow-x:auto;border-bottom:1px solid rgba(255,255,255,.08);
  min-height:46px;background:var(--surface2)
}
.tool-tab{
  flex:1;min-width:60px;padding:10px 6px;border:none;background:none;
  color:var(--text2);cursor:pointer;font-size:.7rem;display:flex;
  flex-direction:column;align-items:center;gap:3px;transition:all .2s;
  white-space:nowrap;border-bottom:2px solid transparent
}
.tool-tab:hover{color:var(--text);background:rgba(255,255,255,.03)}
.tool-tab.active{color:var(--primary);border-bottom-color:var(--primary);background:rgba(233,69,96,.08)}
.tool-tab .tab-icon{font-size:1.2rem}

.tool-panel{display:none;padding:16px;flex-direction:column;gap:14px;flex:1}
.tool-panel.active{display:flex}
.panel-title{font-size:.9rem;font-weight:700;color:var(--text);margin-bottom:4px}
.panel-desc{font-size:.75rem;color:var(--text2);margin-bottom:8px}

/* SLIDER CONTROL */
.slider-group{display:flex;flex-direction:column;gap:4px}
.slider-label{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text2)}
.slider-label span:last-child{color:var(--primary);font-weight:600}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:6px;border-radius:3px;
  background:var(--surface2);outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:var(--primary);cursor:pointer;border:2px solid #fff;
  box-shadow:0 2px 6px rgba(0,0,0,.3)
}

/* FILTER PRESETS */
.filter-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.filter-preset{
  padding:8px 4px;border:2px solid var(--surface2);border-radius:8px;
  background:var(--surface2);color:var(--text);cursor:pointer;
  font-size:.72rem;text-align:center;transition:all .2s;font-weight:500
}
.filter-preset:hover{border-color:var(--primary);background:rgba(233,69,96,.1)}
.filter-preset.active{border-color:var(--primary);background:rgba(233,69,96,.15)}
.filter-preset .preview{
  width:100%;aspect-ratio:1;border-radius:4px;margin-bottom:4px;
  background-size:cover;background-position:center
}

/* ACTION BUTTONS IN PANELS */
.panel-btn{
  padding:10px;border:none;border-radius:8px;cursor:pointer;
  font-size:.85rem;font-weight:600;transition:all .2s;display:flex;
  align-items:center;justify-content:center;gap:6px
}
.panel-btn.primary{background:var(--primary);color:#fff}
.panel-btn.primary:hover{background:var(--primary-hover)}
.panel-btn.secondary{background:var(--surface2);color:var(--text)}
.panel-btn.secondary:hover{background:var(--accent)}

.btn-row{display:flex;gap:8px}
.btn-row .panel-btn{flex:1}

/* ROTATE BUTTONS */
.rotate-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* TEXT TOOL */
.text-input{
  width:100%;padding:10px;border:1px solid rgba(255,255,255,.1);
  border-radius:8px;background:var(--surface2);color:var(--text);
  font-size:.9rem;resize:vertical;min-height:60px;font-family:inherit
}
.text-input:focus{outline:none;border-color:var(--primary)}
.color-row{display:flex;align-items:center;gap:8px}
.color-row label{font-size:.8rem;color:var(--text2);min-width:50px}
input[type="color"]{
  width:40px;height:32px;border:none;border-radius:6px;cursor:pointer;
  background:none;padding:0
}
select{
  width:100%;padding:8px 10px;border:1px solid rgba(255,255,255,.1);
  border-radius:8px;background:var(--surface2);color:var(--text);font-size:.85rem;
  cursor:pointer
}
select:focus{outline:none;border-color:var(--primary)}

/* DRAW TOOL */
.size-preview{
  width:100%;height:40px;display:flex;align-items:center;justify-content:center;
  background:var(--surface2);border-radius:8px
}
.size-dot{background:var(--text);border-radius:50%}

/* RESIZE INPUTS */
.resize-row{display:flex;gap:8px;align-items:center}
.resize-input{
  flex:1;padding:8px 10px;border:1px solid rgba(255,255,255,.1);
  border-radius:8px;background:var(--surface2);color:var(--text);
  font-size:.9rem;text-align:center
}
.resize-input:focus{outline:none;border-color:var(--primary)}
.resize-x{color:var(--text2);font-weight:700;font-size:1.1rem}
.lock-btn{
  width:36px;height:36px;border:1px solid rgba(255,255,255,.1);
  border-radius:8px;background:var(--surface2);color:var(--text);
  cursor:pointer;font-size:1rem;display:flex;align-items:center;
  justify-content:center;transition:all .2s
}
.lock-btn.locked{color:var(--primary);border-color:var(--primary)}

/* CANVAS AREA */
#canvasArea{
  flex:1;display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;background:#0a0a15;
  background-image:radial-gradient(circle at 50% 50%,rgba(233,69,96,.03) 0%,transparent 70%)
}
#canvasContainer{
  position:relative;display:inline-block;
  box-shadow:0 4px 40px rgba(0,0,0,.5)
}
#mainCanvas{display:block;max-width:100%;max-height:100%}
#overlayCanvas{
  position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair
}
.zoom-controls{
  position:absolute;bottom:16px;right:16px;display:flex;gap:6px;
  background:var(--surface);border-radius:10px;padding:4px;
  box-shadow:var(--shadow)
}
.zoom-btn{
  width:36px;height:36px;border:none;border-radius:8px;
  background:var(--surface2);color:var(--text);cursor:pointer;
  font-size:1rem;display:flex;align-items:center;justify-content:center;
  transition:all .2s
}
.zoom-btn:hover{background:var(--primary);color:#fff}
.zoom-info{
  display:flex;align-items:center;padding:0 8px;font-size:.8rem;
  color:var(--text2);font-weight:600
}
.img-info{
  position:absolute;bottom:16px;left:16px;background:var(--surface);
  padding:6px 14px;border-radius:8px;font-size:.75rem;color:var(--text2);
  box-shadow:var(--shadow)
}

/* CROP OVERLAY */
#cropOverlay{
  position:absolute;top:0;left:0;width:100%;height:100%;
  display:none;cursor:crosshair;z-index:10
}
#cropOverlay.active{display:block}
.crop-selection{
  position:absolute;border:2px dashed var(--success);
  background:rgba(0,210,211,.1);z-index:11
}
.crop-handle{
  position:absolute;width:12px;height:12px;background:var(--success);
  border:2px solid #fff;border-radius:2px;z-index:12
}

/* DOWNLOAD MODAL */
#downloadModal{
  position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;
  align-items:center;justify-content:center;z-index:200;
  backdrop-filter:blur(8px)
}
#downloadModal.active{display:flex}
.modal-content{
  background:var(--surface);border-radius:16px;padding:32px;
  width:min(90vw,420px);box-shadow:var(--shadow)
}
.modal-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
.modal-desc{font-size:.85rem;color:var(--text2);margin-bottom:20px}
.format-options{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.format-opt{
  padding:14px;border:2px solid var(--surface2);border-radius:10px;
  cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s
}
.format-opt:hover{border-color:var(--primary)}
.format-opt.selected{border-color:var(--primary);background:rgba(233,69,96,.1)}
.format-opt .fmt-icon{font-size:1.5rem}
.format-opt .fmt-name{font-weight:600;font-size:.95rem}
.format-opt .fmt-desc{font-size:.75rem;color:var(--text2)}
.quality-section{margin-bottom:20px}
.modal-actions{display:flex;gap:10px}
.modal-actions .panel-btn{flex:1;padding:12px}

/* TOAST */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);
  background:var(--surface);color:var(--text);padding:12px 24px;
  border-radius:10px;font-size:.9rem;font-weight:500;box-shadow:var(--shadow);
  z-index:300;transition:transform .3s ease;display:flex;align-items:center;gap:8px;
  border-left:4px solid var(--success)
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* MOBILE BOTTOM TABS */
#mobileTabBar{display:none}

/* RESPONSIVE */
@media(max-width:900px){
  #sidebar{
    position:fixed;bottom:0;left:0;right:0;width:100%;min-width:unset;
    height:auto;max-height:55vh;z-index:60;border-right:none;
    border-top:1px solid rgba(255,255,255,.1);
    border-radius:20px 20px 0 0;
    transform:translateY(calc(100% - 52px));transition:transform .3s ease
  }
  #sidebar.expanded{transform:translateY(0)}
  .tool-tabs{
    position:sticky;top:0;z-index:5;background:var(--surface);
    border-radius:20px 20px 0 0
  }
  .tool-tabs::before{
    content:'';position:absolute;top:8px;left:50%;transform:translateX(-50%);
    width:40px;height:4px;background:rgba(255,255,255,.2);border-radius:2px
  }
  #mainArea{flex-direction:column}
  .upload-title{font-size:1.6rem}
  #dropZone{height:220px}
  .top-btn span.btn-text{display:none}
  #topBar{padding:0 8px;gap:4px}
  .top-btn{padding:6px 10px}
}
@media(max-width:480px){
  .upload-title{font-size:1.3rem}
  .upload-logo{font-size:2.2rem}
  #dropZone{width:92vw;height:200px}
  #dropZone .drop-icon{font-size:3rem}
  .filter-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  .top-btn{padding:5px 8px;font-size:.78rem}
  .tool-tab{padding:8px 4px;font-size:.65rem}
  .tool-tab .tab-icon{font-size:1rem}
  .modal-content{padding:20px}
}

/* LOADING */
.loading-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;
  align-items:center;justify-content:center;z-index:500;flex-direction:column;gap:16px
}
.loading-overlay.active{display:flex}
.spinner{
  width:50px;height:50px;border:4px solid var(--surface2);
  border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:var(--text2);font-size:.9rem}
</style>
</head>
<body>

<!-- UPLOAD SCREEN -->
<div id="uploadScreen">
  <div class="upload-logo">üì∏</div>
  <div class="upload-title">Photo Editor Pro</div>
  <div class="upload-subtitle">Professional photo editing tool ‚Äî Free & Fast</div>
  <div id="dropZone">
    <div class="drop-icon">üñºÔ∏è</div>
    <div class="drop-text">Drag & drop your image here</div>
    <button class="drop-btn" onclick="document.getElementById('fileInput').click()">üìÅ Choose Image</button>
  </div>
  <div class="supported">Supports: JPG, PNG, WEBP, GIF, BMP, SVG</div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- EDITOR -->
<div id="editor">
  <!-- TOP BAR -->
  <div id="topBar">
    <div class="logo">üì∏ <span>PhotoEditor</span></div>
    <button class="top-btn undo-redo" id="undoBtn" disabled onclick="undo()" title="Undo">‚Ü©Ô∏è <span class="btn-text">Undo</span></button>
    <button class="top-btn undo-redo" id="redoBtn" disabled onclick="redo()" title="Redo">‚Ü™Ô∏è <span class="btn-text">Redo</span></button>
    <button class="top-btn reset" onclick="resetAll()" title="Reset">üîÑ <span class="btn-text">Reset</span></button>
    <button class="top-btn new" onclick="newImage()" title="New Image">‚ûï <span class="btn-text">New</span></button>
    <button class="top-btn download" onclick="openDownload()" title="Download">üíæ <span class="btn-text">Download</span></button>
  </div>

  <!-- MAIN -->
  <div id="mainArea">
    <!-- SIDEBAR -->
    <div id="sidebar" id="sidebar">
      <div class="tool-tabs" id="toolTabs">
        <button class="tool-tab active" data-panel="adjust" onclick="switchTab(this)">
          <span class="tab-icon">üé®</span>Adjust
        </button>
        <button class="tool-tab" data-panel="filters" onclick="switchTab(this)">
          <span class="tab-icon">‚ú®</span>Filters
        </button>
        <button class="tool-tab" data-panel="crop" onclick="switchTab(this)">
          <span class="tab-icon">‚úÇÔ∏è</span>Crop
        </button>
        <button class="tool-tab" data-panel="rotate" onclick="switchTab(this)">
          <span class="tab-icon">üîÑ</span>Rotate
        </button>
        <button class="tool-tab" data-panel="resize" onclick="switchTab(this)">
          <span class="tab-icon">üìê</span>Resize
        </button>
        <button class="tool-tab" data-panel="text" onclick="switchTab(this)">
          <span class="tab-icon">üî§</span>Text
        </button>
        <button class="tool-tab" data-panel="draw" onclick="switchTab(this)">
          <span class="tab-icon">üñåÔ∏è</span>Draw
        </button>
      </div>

      <!-- ADJUST PANEL -->
      <div class="tool-panel active" id="panel-adjust">
        <div class="panel-title">üé® Adjustments</div>
        <div class="slider-group">
          <div class="slider-label"><span>Brightness</span><span id="brightnessVal">100%</span></div>
          <input type="range" min="0" max="200" value="100" id="brightness" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Contrast</span><span id="contrastVal">100%</span></div>
          <input type="range" min="0" max="200" value="100" id="contrast" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Saturation</span><span id="saturationVal">100%</span></div>
          <input type="range" min="0" max="200" value="100" id="saturation" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Hue Rotate</span><span id="hueVal">0¬∞</span></div>
          <input type="range" min="0" max="360" value="0" id="hue" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Blur</span><span id="blurVal">0px</span></div>
          <input type="range" min="0" max="20" value="0" step="0.5" id="blur" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Opacity</span><span id="opacityVal">100%</span></div>
          <input type="range" min="10" max="100" value="100" id="opacity" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Grayscale</span><span id="grayscaleVal">0%</span></div>
          <input type="range" min="0" max="100" value="0" id="grayscale" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Sepia</span><span id="sepiaVal">0%</span></div>
          <input type="range" min="0" max="100" value="0" id="sepia" oninput="updateAdjust()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Invert</span><span id="invertVal">0%</span></div>
          <input type="range" min="0" max="100" value="0" id="invert" oninput="updateAdjust()">
        </div>
        <button class="panel-btn primary" onclick="applyAdjustments()">‚úÖ Apply Adjustments</button>
        <button class="panel-btn secondary" onclick="resetAdjustments()">üîÑ Reset Sliders</button>
      </div>

      <!-- FILTERS PANEL -->
      <div class="tool-panel" id="panel-filters">
        <div class="panel-title">‚ú® Filter Presets</div>
        <div class="panel-desc">Click a filter to preview, then apply</div>
        <div class="filter-grid" id="filterGrid"></div>
        <button class="panel-btn primary" onclick="applyFilter()">‚úÖ Apply Filter</button>
        <button class="panel-btn secondary" onclick="removeFilter()">üîÑ Remove Filter</button>
      </div>

      <!-- CROP PANEL -->
      <div class="tool-panel" id="panel-crop">
        <div class="panel-title">‚úÇÔ∏è Crop Image</div>
        <div class="panel-desc">Click and drag on the image to select crop area</div>
        <div class="slider-group">
          <div class="slider-label"><span>Aspect Ratio</span></div>
          <select id="aspectRatio" onchange="updateAspectRatio()">
            <option value="free">Free</option>
            <option value="1:1">1:1 Square</option>
            <option value="4:3">4:3</option>
            <option value="3:4">3:4</option>
            <option value="16:9">16:9 Widescreen</option>
            <option value="9:16">9:16 Portrait</option>
            <option value="3:2">3:2</option>
            <option value="2:3">2:3</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="panel-btn primary" onclick="applyCrop()">‚úÖ Crop</button>
          <button class="panel-btn secondary" onclick="cancelCrop()">‚ùå Cancel</button>
        </div>
      </div>

      <!-- ROTATE PANEL -->
      <div class="tool-panel" id="panel-rotate">
        <div class="panel-title">üîÑ Rotate & Flip</div>
        <div class="rotate-grid">
          <button class="panel-btn secondary" onclick="rotateImage(-90)">‚Ü∫ Left 90¬∞</button>
          <button class="panel-btn secondary" onclick="rotateImage(90)">‚Üª Right 90¬∞</button>
          <button class="panel-btn secondary" onclick="flipImage('h')">‚ÜîÔ∏è Flip H</button>
          <button class="panel-btn secondary" onclick="flipImage('v')">‚ÜïÔ∏è Flip V</button>
        </div>
        <div class="slider-group" style="margin-top:10px">
          <div class="slider-label"><span>Free Rotate</span><span id="freeRotateVal">0¬∞</span></div>
          <input type="range" min="-180" max="180" value="0" id="freeRotate" oninput="freeRotateImage()">
        </div>
        <button class="panel-btn primary" onclick="applyFreeRotate()">‚úÖ Apply Rotation</button>
      </div>

      <!-- RESIZE PANEL -->
      <div class="tool-panel" id="panel-resize">
        <div class="panel-title">üìê Resize Image</div>
        <div class="panel-desc">Enter new dimensions</div>
        <div class="resize-row">
          <input type="number" class="resize-input" id="resizeW" placeholder="Width" oninput="resizeChanged('w')">
          <span class="resize-x">√ó</span>
          <input type="number" class="resize-input" id="resizeH" placeholder="Height" oninput="resizeChanged('h')">
          <button class="lock-btn locked" id="lockAspect" onclick="toggleLock()" title="Lock Aspect Ratio">üîó</button>
        </div>
        <div style="font-size:.75rem;color:var(--text2);text-align:center" id="origSize">Original: -- √ó --</div>
        <div class="btn-row" style="margin-top:6px">
          <button class="panel-btn secondary" onclick="setResizePercent(25)">25%</button>
          <button class="panel-btn secondary" onclick="setResizePercent(50)">50%</button>
          <button class="panel-btn secondary" onclick="setResizePercent(75)">75%</button>
          <button class="panel-btn secondary" onclick="setResizePercent(150)">150%</button>
        </div>
        <button class="panel-btn primary" onclick="applyResize()">‚úÖ Resize</button>
      </div>

      <!-- TEXT PANEL -->
      <div class="tool-panel" id="panel-text">
        <div class="panel-title">üî§ Add Text</div>
        <textarea class="text-input" id="textInput" placeholder="Type your text here..."></textarea>
        <div class="slider-group">
          <div class="slider-label"><span>Font Size</span><span id="fontSizeVal">32px</span></div>
          <input type="range" min="8" max="200" value="32" id="fontSize" oninput="document.getElementById('fontSizeVal').textContent=this.value+'px'">
        </div>
        <select id="fontFamily">
          <option value="Arial">Arial</option>
          <option value="Georgia">Georgia</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Verdana">Verdana</option>
          <option value="Impact">Impact</option>
          <option value="Comic Sans MS">Comic Sans MS</option>
          <option value="Trebuchet MS">Trebuchet MS</option>
        </select>
        <div class="color-row">
          <label>Color:</label>
          <input type="color" id="textColor" value="#ffffff">
          <label>Stroke:</label>
          <input type="color" id="strokeColor" value="#000000">
        </div>
        <div class="btn-row">
          <button class="panel-btn secondary" id="boldBtn" onclick="toggleBold()"><b>B</b></button>
          <button class="panel-btn secondary" id="italicBtn" onclick="toggleItalic()"><i>I</i></button>
          <button class="panel-btn secondary" onclick="toggleStroke()">Stroke</button>
        </div>
        <div class="panel-desc">Click on the image where you want to place the text</div>
        <button class="panel-btn primary" id="placeTextBtn" onclick="enableTextPlace()">üìç Place Text on Image</button>
      </div>

      <!-- DRAW PANEL -->
      <div class="tool-panel" id="panel-draw">
        <div class="panel-title">üñåÔ∏è Drawing Tool</div>
        <div class="btn-row">
          <button class="panel-btn secondary active" id="penBtn" onclick="setDrawTool('pen')">‚úèÔ∏è Pen</button>
          <button class="panel-btn secondary" id="eraserBtn" onclick="setDrawTool('eraser')">üßπ Eraser</button>
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Brush Size</span><span id="brushSizeVal">4px</span></div>
          <input type="range" min="1" max="50" value="4" id="brushSize" oninput="updateBrushSize()">
        </div>
        <div class="color-row">
          <label>Color:</label>
          <input type="color" id="drawColor" value="#ff0000">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>Opacity</span><span id="drawOpacityVal">100%</span></div>
          <input type="range" min="10" max="100" value="100" id="drawOpacity" oninput="document.getElementById('drawOpacityVal').textContent=this.value+'%'">
        </div>
        <div class="btn-row">
          <button class="panel-btn primary" onclick="applyDrawing()">‚úÖ Apply</button>
          <button class="panel-btn secondary" onclick="clearDrawing()">üóëÔ∏è Clear</button>
        </div>
      </div>
    </div>

    <!-- CANVAS AREA -->
    <div id="canvasArea">
      <div id="canvasContainer">
        <canvas id="mainCanvas"></canvas>
        <canvas id="overlayCanvas"></canvas>
        <div id="cropOverlay"></div>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomCanvas(-10)">‚ûñ</button>
        <div class="zoom-info" id="zoomInfo">100%</div>
        <button class="zoom-btn" onclick="zoomCanvas(10)">‚ûï</button>
        <button class="zoom-btn" onclick="zoomFit()">‚ä°</button>
      </div>
      <div class="img-info" id="imgInfo">-- √ó --</div>
    </div>
  </div>
</div>

<!-- DOWNLOAD MODAL -->
<div id="downloadModal">
  <div class="modal-content">
    <div class="modal-title">üíæ Download Image</div>
    <div class="modal-desc">Choose format and quality</div>
    <div class="format-options">
      <div class="format-opt selected" onclick="selectFormat(this,'png')">
        <span class="fmt-icon">üñºÔ∏è</span>
        <div><div class="fmt-name">PNG</div><div class="fmt-desc">Lossless, transparent background</div></div>
      </div>
      <div class="format-opt" onclick="selectFormat(this,'jpeg')">
        <span class="fmt-icon">üì∑</span>
        <div><div class="fmt-name">JPEG</div><div class="fmt-desc">Compressed, smaller file size</div></div>
      </div>
      <div class="format-opt" onclick="selectFormat(this,'webp')">
        <span class="fmt-icon">üåê</span>
        <div><div class="fmt-name">WEBP</div><div class="fmt-desc">Modern format, best compression</div></div>
      </div>
    </div>
    <div class="quality-section" id="qualitySection" style="display:none">
      <div class="slider-group">
        <div class="slider-label"><span>Quality</span><span id="qualityVal">92%</span></div>
        <input type="range" min="10" max="100" value="92" id="quality" oninput="document.getElementById('qualityVal').textContent=this.value+'%'">
      </div>
    </div>
    <div class="modal-actions">
      <button class="panel-btn secondary" onclick="closeDownload()">Cancel</button>
      <button class="panel-btn primary" onclick="downloadImage()">üíæ Download</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Processing...</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let originalImage = null;
let currentImage = null;
let canvas, ctx, overlay, octx;
let history = [], historyIndex = -1;
let zoom = 100;
let currentTool = 'adjust';
let isDrawing = false;
let drawTool = 'pen';
let isCropping = false;
let cropStart = null, cropEnd = null;
let textPlacing = false;
let isBold = false, isItalic = false, hasStroke = false;
let lockAspect = true;
let selectedFormat = 'png';
let selectedFilter = null;
let aspectRatio = null;

// FILTER PRESETS
const FILTERS = [
  {name:'Normal',filter:'none'},
  {name:'Vivid',filter:'saturate(1.5) contrast(1.1)'},
  {name:'Warm',filter:'sepia(0.3) saturate(1.4) brightness(1.05)'},
  {name:'Cool',filter:'saturate(0.8) hue-rotate(20deg) brightness(1.05)'},
  {name:'B&W',filter:'grayscale(1)'},
  {name:'Vintage',filter:'sepia(0.6) contrast(1.1) brightness(0.9)'},
  {name:'Drama',filter:'contrast(1.5) saturate(1.3) brightness(0.95)'},
  {name:'Fade',filter:'contrast(0.8) brightness(1.1) saturate(0.7)'},
  {name:'Noir',filter:'grayscale(1) contrast(1.4) brightness(0.9)'},
  {name:'Pop',filter:'saturate(1.8) contrast(1.2)'},
  {name:'Muted',filter:'saturate(0.5) brightness(1.05)'},
  {name:'Sunset',filter:'sepia(0.2) saturate(1.5) hue-rotate(-10deg)'},
  {name:'Ocean',filter:'hue-rotate(180deg) saturate(0.8)'},
  {name:'Forest',filter:'hue-rotate(90deg) saturate(0.7) brightness(0.95)'},
  {name:'Purple',filter:'hue-rotate(270deg) saturate(1.2)'},
  {name:'Invert',filter:'invert(1)'},
  {name:'Bright',filter:'brightness(1.4)'},
  {name:'Shadow',filter:'brightness(0.6) contrast(1.3)'},
];

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  canvas = document.getElementById('mainCanvas');
  ctx = canvas.getContext('2d');
  overlay = document.getElementById('overlayCanvas');
  octx = overlay.getContext('2d');

  // Build filter grid
  const grid = document.getElementById('filterGrid');
  FILTERS.forEach((f, i) => {
    const div = document.createElement('div');
    div.className = 'filter-preset';
    div.innerHTML = `<div class="preview" id="fprev${i}"></div>${f.name}`;
    div.onclick = () => selectFilterPreset(i, div);
    grid.appendChild(div);
  });

  // File input
  document.getElementById('fileInput').addEventListener('change', e => {
    if(e.target.files[0]) loadImage(e.target.files[0]);
  });

  // Drag & drop
  const dz = document.getElementById('dropZone');
  ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => {
    e.preventDefault(); dz.classList.add('dragover');
  }));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {
    e.preventDefault(); dz.classList.remove('dragover');
  }));
  dz.addEventListener('drop', e => {
    if(e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]);
  });
  dz.addEventListener('click', e => {
    if(e.target.tagName !== 'BUTTON') document.getElementById('fileInput').click();
  });

  // Overlay events
  overlay.addEventListener('mousedown', onPointerDown);
  overlay.addEventListener('mousemove', onPointerMove);
  overlay.addEventListener('mouseup', onPointerUp);
  overlay.addEventListener('mouseleave', onPointerUp);
  overlay.addEventListener('touchstart', e => { e.preventDefault(); onPointerDown(getTouchEvent(e)); }, {passive:false});
  overlay.addEventListener('touchmove', e => { e.preventDefault(); onPointerMove(getTouchEvent(e)); }, {passive:false});
  overlay.addEventListener('touchend', e => { e.preventDefault(); onPointerUp(getTouchEvent(e)); }, {passive:false});

  // Sidebar swipe on mobile
  const sidebar = document.getElementById('sidebar');
  let touchY = 0;
  sidebar.addEventListener('touchstart', e => { touchY = e.touches[0].clientY; });
  sidebar.addEventListener('touchmove', e => {
    const dy = e.touches[0].clientY - touchY;
    if(dy < -30) sidebar.classList.add('expanded');
    if(dy > 30) sidebar.classList.remove('expanded');
  });

  // Click outside modal
  document.getElementById('downloadModal').addEventListener('click', e => {
    if(e.target.id === 'downloadModal') closeDownload();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
    if(e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
    if(e.ctrlKey && e.key === 's') { e.preventDefault(); openDownload(); }
  });
});

function getTouchEvent(e) {
  const t = e.changedTouches[0] || e.touches[0];
  return { clientX: t.clientX, clientY: t.clientY, target: e.target };
}

// ===== LOAD IMAGE =====
function loadImage(file) {
  showLoading();
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      originalImage = img;
      currentImage = img;
      initCanvas(img);
      document.getElementById('uploadScreen').classList.add('hidden');
      document.getElementById('editor').classList.add('active');
      saveHistory();
      hideLoading();
      updateImageInfo();
      updateResizeInputs();
      updateFilterPreviews();
      showToast('‚úÖ Image loaded successfully!');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function initCanvas(img) {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0);
  overlay.width = img.width;
  overlay.height = img.height;
  octx.clearRect(0, 0, overlay.width, overlay.height);
  zoomFit();
}

// ===== HISTORY =====
function saveHistory() {
  historyIndex++;
  history = history.slice(0, historyIndex);
  history.push(canvas.toDataURL());
  if(history.length > 30) { history.shift(); historyIndex--; }
  updateHistoryBtns();
}

function undo() {
  if(historyIndex <= 0) return;
  historyIndex--;
  restoreHistory();
}

function redo() {
  if(historyIndex >= history.length - 1) return;
  historyIndex++;
  restoreHistory();
}

function restoreHistory() {
  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
    overlay.width = img.width;
    overlay.height = img.height;
    octx.clearRect(0, 0, overlay.width, overlay.height);
    updateHistoryBtns();
    updateImageInfo();
    updateResizeInputs();
  };
  img.src = history[historyIndex];
}

function updateHistoryBtns() {
  document.getElementById('undoBtn').disabled = historyIndex <= 0;
  document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
}

// ===== ZOOM =====
function zoomCanvas(delta) {
  zoom = Math.max(10, Math.min(500, zoom + delta));
  applyZoom();
}

function zoomFit() {
  const area = document.getElementById('canvasArea');
  const maxW = area.clientWidth - 40;
  const maxH = area.clientHeight - 40;
  const scaleW = maxW / canvas.width;
  const scaleH = maxH / canvas.height;
  zoom = Math.round(Math.min(scaleW, scaleH) * 100);
  zoom = Math.max(10, Math.min(500, zoom));
  applyZoom();
}

function applyZoom() {
  const container = document.getElementById('canvasContainer');
  const scale = zoom / 100;
  container.style.transform = `scale(${scale})`;
  container.style.transformOrigin = 'center center';
  document.getElementById('zoomInfo').textContent = zoom + '%';
}

// ===== TABS =====
function switchTab(btn) {
  document.querySelectorAll('.tool-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  const panel = document.getElementById('panel-' + btn.dataset.panel);
  if(panel) panel.classList.add('active');
  currentTool = btn.dataset.panel;

  // Cancel crop if switching away
  if(currentTool !== 'crop') cancelCrop();

  // Toggle drawing
  overlay.style.pointerEvents = (currentTool === 'draw' || currentTool === 'text' || currentTool === 'crop') ? 'auto' : 'none';

  // Expand sidebar on mobile
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.add('expanded');

  // Reset canvas filter preview
  if(currentTool !== 'adjust' && currentTool !== 'filters') {
    canvas.style.filter = 'none';
    canvas.style.opacity = '1';
  }
}

// ===== ADJUSTMENTS =====
function updateAdjust() {
  const b = document.getElementById('brightness').value;
  const c = document.getElementById('contrast').value;
  const s = document.getElementById('saturation').value;
  const h = document.getElementById('hue').value;
  const bl = document.getElementById('blur').value;
  const o = document.getElementById('opacity').value;
  const g = document.getElementById('grayscale').value;
  const sp = document.getElementById('sepia').value;
  const inv = document.getElementById('invert').value;

  document.getElementById('brightnessVal').textContent = b + '%';
  document.getElementById('contrastVal').textContent = c + '%';
  document.getElementById('saturationVal').textContent = s + '%';
  document.getElementById('hueVal').textContent = h + '¬∞';
  document.getElementById('blurVal').textContent = bl + 'px';
  document.getElementById('opacityVal').textContent = o + '%';
  document.getElementById('grayscaleVal').textContent = g + '%';
  document.getElementById('sepiaVal').textContent = sp + '%';
  document.getElementById('invertVal').textContent = inv + '%';

  canvas.style.filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%) hue-rotate(${h}deg) blur(${bl}px) grayscale(${g}%) sepia(${sp}%) invert(${inv}%)`;
  canvas.style.opacity = o / 100;
}

function applyAdjustments() {
  showLoading();
  setTimeout(() => {
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = canvas.width;
    tmpCanvas.height = canvas.height;
    const tmpCtx = tmpCanvas.getContext('2d');
    tmpCtx.filter = canvas.style.filter || 'none';
    tmpCtx.globalAlpha = parseFloat(canvas.style.opacity) || 1;
    tmpCtx.drawImage(canvas, 0, 0);

    canvas.width = tmpCanvas.width;
    canvas.height = tmpCanvas.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(tmpCanvas, 0, 0);
    canvas.style.filter = 'none';
    canvas.style.opacity = '1';

    resetAdjustments();
    saveHistory();
    hideLoading();
    showToast('‚úÖ Adjustments applied!');
  }, 100);
}

function resetAdjustments() {
  document.getElementById('brightness').value = 100;
  document.getElementById('contrast').value = 100;
  document.getElementById('saturation').value = 100;
  document.getElementById('hue').value = 0;
  document.getElementById('blur').value = 0;
  document.getElementById('opacity').value = 100;
  document.getElementById('grayscale').value = 0;
  document.getElementById('sepia').value = 0;
  document.getElementById('invert').value = 0;
  canvas.style.filter = 'none';
  canvas.style.opacity = '1';
  updateAdjust();
}

// ===== FILTERS =====
function updateFilterPreviews() {
  // Generate small previews
  FILTERS.forEach((f, i) => {
    const prev = document.getElementById('fprev' + i);
    if(prev) {
      const small = document.createElement('canvas');
      small.width = 60; small.height = 60;
      const sctx = small.getContext('2d');
      sctx.filter = f.filter === 'none' ? 'none' : f.filter;
      sctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 60, 60);
      prev.style.backgroundImage = `url(${small.toDataURL()})`;
    }
  });
}

function selectFilterPreset(index, el) {
  document.querySelectorAll('.filter-preset').forEach(f => f.classList.remove('active'));
  el.classList.add('active');
  selectedFilter = FILTERS[index];
  canvas.style.filter = selectedFilter.filter;
}

function applyFilter() {
  if(!selectedFilter || selectedFilter.filter === 'none') {
    canvas.style.filter = 'none';
    return;
  }
  showLoading();
  setTimeout(() => {
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width;
    tmp.height = canvas.height;
    const tctx = tmp.getContext('2d');
    tctx.filter = selectedFilter.filter;
    tctx.drawImage(canvas, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(tmp, 0, 0);
    canvas.style.filter = 'none';
    selectedFilter = null;
    document.querySelectorAll('.filter-preset').forEach(f => f.classList.remove('active'));
    saveHistory();
    updateFilterPreviews();
    hideLoading();
    showToast('‚úÖ Filter applied!');
  }, 100);
}

function removeFilter() {
  canvas.style.filter = 'none';
  selectedFilter = null;
  document.querySelectorAll('.filter-preset').forEach(f => f.classList.remove('active'));
}

// ===== CROP =====
function updateAspectRatio() {
  const val = document.getElementById('aspectRatio').value;
  if(val === 'free') { aspectRatio = null; return; }
  const parts = val.split(':');
  aspectRatio = parseFloat(parts[0]) / parseFloat(parts[1]);
}

function startCrop(x, y) {
  isCropping = true;
  cropStart = { x, y };
  cropEnd = { x, y };
}

function updateCrop(x, y) {
  if(!isCropping) return;
  cropEnd = { x, y };
  if(aspectRatio) {
    const w = cropEnd.x - cropStart.x;
    cropEnd.y = cropStart.y + w / aspectRatio;
  }
  drawCropOverlay();
}

function drawCropOverlay() {
  octx.clearRect(0, 0, overlay.width, overlay.height);
  if(!cropStart || !cropEnd) return;

  let x = Math.min(cropStart.x, cropEnd.x);
  let y = Math.min(cropStart.y, cropEnd.y);
  let w = Math.abs(cropEnd.x - cropStart.x);
  let h = Math.abs(cropEnd.y - cropStart.y);

  // Dim outside
  octx.fillStyle = 'rgba(0,0,0,0.6)';
  octx.fillRect(0, 0, overlay.width, overlay.height);

  // Clear inside
  octx.clearRect(x, y, w, h);

  // Border
  octx.strokeStyle = '#00d2d3';
  octx.lineWidth = 2;
  octx.setLineDash([6, 4]);
  octx.strokeRect(x, y, w, h);
  octx.setLineDash([]);

  // Grid lines (rule of thirds)
  octx.strokeStyle = 'rgba(255,255,255,0.3)';
  octx.lineWidth = 1;
  octx.beginPath();
  octx.moveTo(x + w/3, y); octx.lineTo(x + w/3, y + h);
  octx.moveTo(x + 2*w/3, y); octx.lineTo(x + 2*w/3, y + h);
  octx.moveTo(x, y + h/3); octx.lineTo(x + w, y + h/3);
  octx.moveTo(x, y + 2*h/3); octx.lineTo(x + w, y + 2*h/3);
  octx.stroke();

  // Size text
  octx.fillStyle = '#00d2d3';
  octx.font = '14px sans-serif';
  octx.fillText(`${Math.round(w)} √ó ${Math.round(h)}`, x + 5, y - 8);
}

function applyCrop() {
  if(!cropStart || !cropEnd) { showToast('‚ö†Ô∏è Select an area first!'); return; }

  let x = Math.min(cropStart.x, cropEnd.x);
  let y = Math.min(cropStart.y, cropEnd.y);
  let w = Math.abs(cropEnd.x - cropStart.x);
  let h = Math.abs(cropEnd.y - cropStart.y);

  if(w < 5 || h < 5) { showToast('‚ö†Ô∏è Area too small!'); return; }

  showLoading();
  setTimeout(() => {
    const imgData = ctx.getImageData(x, y, w, h);
    canvas.width = w;
    canvas.height = h;
    ctx.putImageData(imgData, 0, 0);
    overlay.width = w;
    overlay.height = h;
    octx.clearRect(0, 0, w, h);
    cropStart = cropEnd = null;
    isCropping = false;
    saveHistory();
    zoomFit();
    updateImageInfo();
    updateResizeInputs();
    hideLoading();
    showToast('‚úÖ Image cropped!');
  }, 100);
}

function cancelCrop() {
  isCropping = false;
  cropStart = cropEnd = null;
  octx.clearRect(0, 0, overlay.width, overlay.height);
}

// ===== ROTATE & FLIP =====
function rotateImage(deg) {
  showLoading();
  setTimeout(() => {
    const tmp = document.createElement('canvas');
    const tctx = tmp.getContext('2d');
    if(Math.abs(deg) === 90) {
      tmp.width = canvas.height;
      tmp.height = canvas.width;
    } else {
      tmp.width = canvas.width;
      tmp.height = canvas.height;
    }
    tctx.translate(tmp.width / 2, tmp.height / 2);
    tctx.rotate(deg * Math.PI / 180);
    tctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
    canvas.width = tmp.width;
    canvas.height = tmp.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(tmp, 0, 0);
    overlay.width = canvas.width;
    overlay.height = canvas.height;
    saveHistory();
    zoomFit();
    updateImageInfo();
    updateResizeInputs();
    hideLoading();
    showToast('‚úÖ Rotated ' + deg + '¬∞');
  }, 100);
}

function flipImage(dir) {
  showLoading();
  setTimeout(() => {
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width;
    tmp.height = canvas.height;
    const tctx = tmp.getContext('2d');
    if(dir === 'h') {
      tctx.translate(canvas.width, 0);
      tctx.scale(-1, 1);
    } else {
      tctx.translate(0, canvas.height);
      tctx.scale(1, -1);
    }
    tctx.drawImage(canvas, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(tmp, 0, 0);
    saveHistory();
    hideLoading();
    showToast('‚úÖ Flipped ' + (dir === 'h' ? 'Horizontally' : 'Vertically'));
  }, 100);
}

function freeRotateImage() {
  const val = document.getElementById('freeRotate').value;
  document.getElementById('freeRotateVal').textContent = val + '¬∞';
  // Preview using CSS transform
  canvas.style.transform = `rotate(${val}deg)`;
}

function applyFreeRotate() {
  const deg = parseInt(document.getElementById('freeRotate').value);
  if(deg === 0) return;
  canvas.style.transform = '';

  showLoading();
  setTimeout(() => {
    const rad = deg * Math.PI / 180;
    const sin = Math.abs(Math.sin(rad));
    const cos = Math.abs(Math.cos(rad));
    const newW = Math.ceil(canvas.width * cos + canvas.height * sin);
    const newH = Math.ceil(canvas.width * sin + canvas.height * cos);

    const tmp = document.createElement('canvas');
    tmp.width = newW;
    tmp.height = newH;
    const tctx = tmp.getContext('2d');
    tctx.translate(newW / 2, newH / 2);
    tctx.rotate(rad);
    tctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);

    canvas.width = newW;
    canvas.height = newH;
    ctx.clearRect(0, 0, newW, newH);
    ctx.drawImage(tmp, 0, 0);
    overlay.width = newW;
    overlay.height = newH;

    document.getElementById('freeRotate').value = 0;
    document.getElementById('freeRotateVal').textContent = '0¬∞';
    saveHistory();
    zoomFit();
    updateImageInfo();
    updateResizeInputs();
    hideLoading();
    showToast('‚úÖ Rotation applied!');
  }, 100);
}

// ===== RESIZE =====
function updateResizeInputs() {
  document.getElementById('resizeW').value = canvas.width;
  document.getElementById('resizeH').value = canvas.height;
  document.getElementById('origSize').textContent = `Original: ${canvas.width} √ó ${canvas.height}`;
}

function resizeChanged(dim) {
  if(!lockAspect) return;
  const ratio = canvas.width / canvas.height;
  if(dim === 'w') {
    const w = parseInt(document.getElementById('resizeW').value) || 1;
    document.getElementById('resizeH').value = Math.round(w / ratio);
  } else {
    const h = parseInt(document.getElementById('resizeH').value) || 1;
    document.getElementById('resizeW').value = Math.round(h * ratio);
  }
}

function toggleLock() {
  lockAspect = !lockAspect;
  const btn = document.getElementById('lockAspect');
  btn.classList.toggle('locked');
  btn.textContent = lockAspect ? 'üîó' : 'üîì';
}

function setResizePercent(pct) {
  const w = Math.round(canvas.width * pct / 100);
  const h = Math.round(canvas.height * pct / 100);
  document.getElementById('resizeW').value = w;
  document.getElementById('resizeH').value = h;
}

function applyResize() {
  const w = parseInt(document.getElementById('resizeW').value);
  const h = parseInt(document.getElementById('resizeH').value);
  if(!w || !h || w < 1 || h < 1) { showToast('‚ö†Ô∏è Invalid dimensions!'); return; }
  if(w > 10000 || h > 10000) { showToast('‚ö†Ô∏è Max 10000px!'); return; }

  showLoading();
  setTimeout(() => {
    const tmp = document.createElement('canvas');
    tmp.width = w;
    tmp.height = h;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(canvas, 0, 0, w, h);
    canvas.width = w;
    canvas.height = h;
    ctx.clearRect(0, 0, w, h);
    ctx.drawImage(tmp, 0, 0);
    overlay.width = w;
    overlay.height = h;
    saveHistory();
    zoomFit();
    updateImageInfo();
    updateResizeInputs();
    hideLoading();
    showToast(`‚úÖ Resized to ${w} √ó ${h}`);
  }, 100);
}

// ===== TEXT TOOL =====
function toggleBold() { isBold = !isBold; document.getElementById('boldBtn').classList.toggle('active'); }
function toggleItalic() { isItalic = !isItalic; document.getElementById('italicBtn').classList.toggle('active'); }
function toggleStroke() { hasStroke = !hasStroke; }

function enableTextPlace() {
  const text = document.getElementById('textInput').value.trim();
  if(!text) { showToast('‚ö†Ô∏è Enter text first!'); return; }
  textPlacing = true;
  overlay.style.cursor = 'text';
  overlay.style.pointerEvents = 'auto';
  showToast('üìç Click on image to place text');
}

function placeText(x, y) {
  const text = document.getElementById('textInput').value.trim();
  if(!text) return;

  const size = document.getElementById('fontSize').value;
  const font = document.getElementById('fontFamily').value;
  const color = document.getElementById('textColor').value;
  const stroke = document.getElementById('strokeColor').value;

  let fontStr = '';
  if(isItalic) fontStr += 'italic ';
  if(isBold) fontStr += 'bold ';
  fontStr += size + 'px ' + font;

  ctx.font = fontStr;
  ctx.textBaseline = 'top';

  const lines = text.split('\n');
  lines.forEach((line, i) => {
    const ly = y + i * size * 1.2;
    if(hasStroke) {
      ctx.strokeStyle = stroke;
      ctx.lineWidth = Math.max(2, size / 10);
      ctx.strokeText(line, x, ly);
    }
    ctx.fillStyle = color;
    ctx.fillText(line, x, ly);
  });

  textPlacing = false;
  overlay.style.cursor = 'crosshair';
  saveHistory();
  showToast('‚úÖ Text added!');
}

// ===== DRAW TOOL =====
function setDrawTool(tool) {
  drawTool = tool;
  document.getElementById('penBtn').classList.toggle('active', tool === 'pen');
  document.getElementById('eraserBtn').classList.toggle('active', tool === 'eraser');
}

function updateBrushSize() {
  const s = document.getElementById('brushSize').value;
  document.getElementById('brushSizeVal').textContent = s + 'px';
}

function applyDrawing() {
  ctx.drawImage(overlay, 0, 0);
  octx.clearRect(0, 0, overlay.width, overlay.height);
  saveHistory();
  showToast('‚úÖ Drawing applied!');
}

function clearDrawing() {
  octx.clearRect(0, 0, overlay.width, overlay.height);
  showToast('üóëÔ∏è Drawing cleared');
}

// ===== POINTER EVENTS =====
function getCanvasPos(e) {
  const rect = overlay.getBoundingClientRect();
  const scaleX = overlay.width / rect.width;
  const scaleY = overlay.height / rect.height;
  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

function onPointerDown(e) {
  const pos = getCanvasPos(e);

  if(currentTool === 'crop') {
    startCrop(pos.x, pos.y);
    return;
  }

  if(currentTool === 'text' && textPlacing) {
    placeText(pos.x, pos.y);
    return;
  }

  if(currentTool === 'draw') {
    isDrawing = true;
    const size = document.getElementById('brushSize').value;
    const color = document.getElementById('drawColor').value;
    const opacity = document.getElementById('drawOpacity').value / 100;

    octx.lineCap = 'round';
    octx.lineJoin = 'round';
    octx.lineWidth = size;
    octx.globalAlpha = opacity;

    if(drawTool === 'eraser') {
      octx.globalCompositeOperation = 'destination-out';
      octx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      octx.globalCompositeOperation = 'source-over';
      octx.strokeStyle = color;
    }

    octx.beginPath();
    octx.moveTo(pos.x, pos.y);
  }
}

function onPointerMove(e) {
  const pos = getCanvasPos(e);

  if(currentTool === 'crop' && isCropping) {
    updateCrop(pos.x, pos.y);
    return;
  }

  if(currentTool === 'draw' && isDrawing) {
    octx.lineTo(pos.x, pos.y);
    octx.stroke();
  }
}

function onPointerUp(e) {
  if(currentTool === 'crop') {
    isCropping = false;
    return;
  }

  if(currentTool === 'draw') {
    isDrawing = false;
    octx.globalAlpha = 1;
    octx.globalCompositeOperation = 'source-over';
  }
}

// ===== RESET =====
function resetAll() {
  if(!originalImage) return;
  initCanvas(originalImage);
  resetAdjustments();
  cancelCrop();
  history = [];
  historyIndex = -1;
  saveHistory();
  showToast('üîÑ Reset to original!');
}

function newImage() {
  document.getElementById('editor').classList.remove('active');
  document.getElementById('uploadScreen').classList.remove('hidden');
  history = [];
  historyIndex = -1;
  originalImage = null;
  document.getElementById('fileInput').value = '';
  resetAdjustments();
}

// ===== DOWNLOAD =====
function openDownload() {
  document.getElementById('downloadModal').classList.add('active');
}

function closeDownload() {
  document.getElementById('downloadModal').classList.remove('active');
}

function selectFormat(el, fmt) {
  document.querySelectorAll('.format-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedFormat = fmt;
  document.getElementById('qualitySection').style.display = (fmt === 'jpeg' || fmt === 'webp') ? 'block' : 'none';
}

function downloadImage() {
  showLoading();
  setTimeout(() => {
    const quality = parseInt(document.getElementById('quality').value) / 100;
    let mimeType = 'image/png';
    let ext = 'png';
    if(selectedFormat === 'jpeg') { mimeType = 'image/jpeg'; ext = 'jpg'; }
    if(selectedFormat === 'webp') { mimeType = 'image/webp'; ext = 'webp'; }

    // Create final canvas with overlay merged
    const final = document.createElement('canvas');
    final.width = canvas.width;
    final.height = canvas.height;
    const fctx = final.getContext('2d');
    fctx.drawImage(canvas, 0, 0);
    fctx.drawImage(overlay, 0, 0);

    const dataUrl = selectedFormat === 'png' ? final.toDataURL(mimeType) : final.toDataURL(mimeType, quality);
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `edited-image.${ext}`;
    a.click();
    closeDownload();
    hideLoading();
    showToast('üíæ Image downloaded!');
  }, 100);
}

// ===== UTILS =====
function updateImageInfo() {
  document.getElementById('imgInfo').textContent = `${canvas.width} √ó ${canvas.height} px`;
}

function showLoading() { document.getElementById('loading').classList.add('active'); }
function hideLoading() { document.getElementById('loading').classList.remove('active'); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
