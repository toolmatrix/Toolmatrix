<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free Online Photo Editor - Edit photos with crop, resize, rotate, flip, 20+ filters, brightness, contrast, saturation, text overlay, drawing tools. No signup needed!">
    <meta name="keywords" content="photo editor, online photo editor, free photo editor, image editor, edit photos online, crop image, resize image, photo filters, picture editor, image editing tool">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Free Online Photo Editor - Professional Image Editing Tool">
    <meta property="og:description" content="Edit photos online free. Crop, resize, rotate, filters, text, draw & more. No signup required!">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="canonical" href="https://yourdomain.com/photo-editor">
    <title>Free Online Photo Editor - Crop, Resize, Filters, Text | Edit Photos Free</title>

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Free Online Photo Editor",
        "description": "Professional photo editing tool with crop, resize, rotate, filters, text and drawing tools.",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "All",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"}
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {"@type": "Question", "name": "How to edit photos online for free?", "acceptedAnswer": {"@type": "Answer", "text": "Upload your photo, use editing tools like crop, resize, filters, brightness, contrast and text, then download your edited image. No signup needed."}},
            {"@type": "Question", "name": "Is this photo editor free?", "acceptedAnswer": {"@type": "Answer", "text": "Yes, 100% free. No watermarks, no signup, no hidden charges. All features available at no cost."}},
            {"@type": "Question", "name": "Are my photos safe?", "acceptedAnswer": {"@type": "Answer", "text": "Yes. All editing happens in your browser. Photos are never uploaded to any server."}}
        ]
    }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        :root {
            --bg: #0f0f13;
            --surface: #1a1a24;
            --surface2: #242435;
            --border: #2e2e42;
            --primary: #6c5ce7;
            --primary-h: #5a4bd1;
            --green: #00b894;
            --red: #e74c3c;
            --yellow: #fdcb6e;
            --cyan: #00cec9;
            --text: #f0f0f0;
            --text2: #9999aa;
            --text3: #666677;
            --radius: 10px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* NAVBAR */
        .nav {
            background: rgba(26,26,36,0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            font-size: 1.1rem;
        }

        .nav-logo {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, var(--primary), var(--cyan));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 15px;
        }

        .nav-brand span { color: var(--primary); }

        .nav-btns { display: flex; gap: 8px; flex-wrap: wrap; }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            color: #fff;
        }

        .btn:active { transform: scale(0.96); }
        .btn-dark { background: var(--surface2); border: 1px solid var(--border); }
        .btn-dark:hover { background: #2f2f44; }
        .btn-blue { background: var(--primary); }
        .btn-blue:hover { background: var(--primary-h); }
        .btn-green { background: var(--green); }
        .btn-green:hover { background: #00a383; }
        .btn-red { background: var(--red); }
        .btn-red:hover { background: #c0392b; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* MAIN LAYOUT */
        .app {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 300px;
            min-width: 300px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .tab {
            padding: 12px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text2);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            text-align: center;
            flex: 1;
            min-width: 0;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: inherit;
        }

        .tab i { font-size: 14px; }
        .tab:hover { color: var(--text); background: var(--surface2); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .panel { display: none; }
        .panel.active { display: block; }

        .panel-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i { color: var(--primary); }

        /* CONTROLS */
        .ctrl {
            margin-bottom: 16px;
        }

        .ctrl-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .ctrl-label {
            font-size: 0.78rem;
            color: var(--text2);
            font-weight: 500;
        }

        .ctrl-val {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--primary);
            background: var(--surface2);
            padding: 1px 7px;
            border-radius: 4px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            background: var(--surface2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px;
            background: var(--primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .field {
            width: 100%;
            padding: 9px 12px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.82rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .field:focus { border-color: var(--primary); }

        select.field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%239999aa' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .color-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-row input[type="color"] {
            -webkit-appearance: none;
            width: 36px; height: 36px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            background: none;
            padding: 2px;
        }

        .color-row input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-row input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }

        .color-row label { font-size: 0.78rem; color: var(--text2); }

        .pb {
            width: 100%;
            padding: 10px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 6px;
        }

        .pb:hover { background: #33334a; }
        .pb.accent { background: var(--primary); border-color: var(--primary); }
        .pb.accent:hover { background: var(--primary-h); }

        /* FILTER GRID */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .filter-btn {
            padding: 10px 6px;
            background: var(--surface2);
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text2);
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-btn:hover { border-color: var(--border); color: var(--text); }
        .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(108,92,231,0.1); }

        /* CANVAS AREA */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background:
                linear-gradient(45deg, #151520 25%, transparent 25%),
                linear-gradient(-45deg, #151520 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #151520 75%),
                linear-gradient(-45deg, transparent 75%, #151520 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0;
            background-color: #111118;
            overflow: auto;
        }

        .canvas-wrap {
            position: relative;
            display: none;
        }

        #photoCanvas {
            max-width: 100%;
            max-height: calc(100vh - 100px);
            display: block;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        /* UPLOAD */
        .upload-box {
            text-align: center;
            padding: 40px;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 50px 30px;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 460px;
            margin: 0 auto;
            background: rgba(26,26,36,0.5);
        }

        .drop-zone:hover, .drop-zone.over {
            border-color: var(--primary);
            background: rgba(108,92,231,0.06);
        }

        .drop-icon {
            width: 70px; height: 70px;
            background: rgba(108,92,231,0.12);
            border-radius: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .drop-zone h3 { font-size: 1.15rem; margin-bottom: 6px; }
        .drop-zone p { color: var(--text2); font-size: 0.88rem; }
        .drop-zone .small { font-size: 0.72rem; color: var(--text3); margin-top: 10px; }

        #fileInput { display: none; }

        /* ZOOM BAR */
        .zoom-bar {
            position: absolute;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26,26,36,0.92);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 6px 16px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .zoom-bar button {
            background: none;
            border: none;
            color: var(--text2);
            cursor: pointer;
            font-size: 13px;
            padding: 4px;
        }

        .zoom-bar button:hover { color: var(--text); }
        .zoom-bar span { font-size: 0.78rem; font-weight: 600; min-width: 38px; text-align: center; }

        /* MODAL */
        .modal-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-bg.show { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            max-width: 420px;
            width: 92%;
            animation: mIn 0.3s ease;
        }

        @keyframes mIn { from { opacity:0; transform:scale(0.92) translateY(15px); } to { opacity:1; transform:none; } }

        .modal h3 { font-size: 1.1rem; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
        .modal h3 i { color: var(--primary); }

        .fmt-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }

        .fmt-btn {
            padding: 14px 8px;
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.82rem;
            transition: all 0.2s;
            color: var(--text);
            font-family: inherit;
        }

        .fmt-btn:hover { border-color: var(--text3); }
        .fmt-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(108,92,231,0.08); }
        .fmt-btn .ico { font-size: 1.3rem; display: block; margin-bottom: 4px; }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 24px; right: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 300;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            transform: translateX(130%);
            transition: transform 0.4s ease;
            font-size: 0.85rem;
        }

        .toast.show { transform: translateX(0); }
        .toast.ok i { color: var(--green); }
        .toast.err i { color: var(--red); }

        /* CHECKBOX LABEL */
        .chk-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--text2);
            cursor: pointer;
            margin-bottom: 10px;
        }

        .chk-label input { accent-color: var(--primary); }

        /* SEO CONTENT */
        .seo-wrap {
            max-width: 960px;
            margin: 0 auto;
            padding: 50px 20px;
        }

        .seo-wrap h2 {
            font-size: 1.7rem;
            font-weight: 800;
            margin-bottom: 14px;
            background: linear-gradient(135deg, var(--primary), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .seo-wrap h3 { font-size: 1.2rem; color: var(--cyan); margin: 22px 0 8px; }
        .seo-wrap p { color: var(--text2); line-height: 1.8; margin-bottom: 12px; font-size: 0.92rem; }
        .seo-wrap ul { color: var(--text2); padding-left: 18px; margin-bottom: 12px; }
        .seo-wrap ul li { margin-bottom: 7px; line-height: 1.7; }

        .feat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 16px; margin: 25px 0; }

        .feat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
            transition: all 0.3s;
        }

        .feat-card:hover { border-color: var(--primary); transform: translateY(-3px); }

        .feat-card .fi {
            width: 44px; height: 44px;
            background: rgba(108,92,231,0.12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .feat-card h4 { font-size: 0.95rem; margin-bottom: 6px; }
        .feat-card p { font-size: 0.82rem; color: var(--text2); line-height: 1.6; margin: 0; }

        .faq-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            overflow: hidden;
        }

        .faq-q {
            padding: 16px 18px;
            background: var(--surface);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .faq-q:hover { background: var(--surface2); }
        .faq-q i { color: var(--primary); transition: transform 0.3s; }
        .faq-item.open .faq-q i { transform: rotate(180deg); }
        .faq-a { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .faq-a-in { padding: 0 18px 16px; color: var(--text2); line-height: 1.7; font-size: 0.85rem; }
        .faq-item.open .faq-a { max-height: 250px; }

        .site-footer {
            text-align: center;
            padding: 30px;
            border-top: 1px solid var(--border);
            color: var(--text3);
            font-size: 0.8rem;
        }

        /* MOBILE */
        .menu-toggle {
            display: none;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px; height: 36px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 800px) {
            .menu-toggle { display: inline-flex; }

            .sidebar {
                position: fixed;
                top: 56px;
                left: -320px;
                height: calc(100vh - 56px);
                z-index: 90;
                transition: left 0.3s ease;
                box-shadow: 5px 0 30px rgba(0,0,0,0.4);
            }

            .sidebar.open { left: 0; }

            .nav-btns .hide-m { display: none; }

            .feat-grid { grid-template-columns: 1fr; }
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav class="nav">
        <div style="display:flex;align-items:center;gap:10px">
            <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">
                <i class="fas fa-bars"></i>
            </button>
            <div class="nav-brand">
                <div class="nav-logo"><i class="fas fa-wand-magic-sparkles"></i></div>
                <span>Photo</span>Editor
            </div>
        </div>
        <div class="nav-btns">
            <button class="btn btn-dark" onclick="openFile()" title="Open"><i class="fas fa-folder-open"></i> <span class="hide-m">Open</span></button>
            <button class="btn btn-dark" id="undoBtn" onclick="undo()" disabled title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            <button class="btn btn-dark" id="redoBtn" onclick="redo()" disabled title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
            <button class="btn btn-red" onclick="resetAll()" title="Reset"><i class="fas fa-rotate-left"></i> <span class="hide-m">Reset</span></button>
            <button class="btn btn-green" onclick="showExport()" title="Download"><i class="fas fa-download"></i> <span class="hide-m">Export</span></button>
        </div>
    </nav>

    <input type="file" id="fileInput" accept="image/*">

    <!-- APP -->
    <div class="app">

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('adjust',this)"><i class="fas fa-sliders-h"></i>Adjust</button>
                <button class="tab" onclick="switchTab('filters',this)"><i class="fas fa-palette"></i>Filters</button>
                <button class="tab" onclick="switchTab('crop',this)"><i class="fas fa-crop-alt"></i>Crop</button>
                <button class="tab" onclick="switchTab('resize',this)"><i class="fas fa-expand-arrows-alt"></i>Resize</button>
                <button class="tab" onclick="switchTab('rotate',this)"><i class="fas fa-sync-alt"></i>Rotate</button>
                <button class="tab" onclick="switchTab('text',this)"><i class="fas fa-font"></i>Text</button>
                <button class="tab" onclick="switchTab('draw',this)"><i class="fas fa-paint-brush"></i>Draw</button>
            </div>

            <div class="sidebar-content">

                <!-- ADJUST -->
                <div class="panel active" id="p-adjust">
                    <div class="panel-title"><i class="fas fa-sliders-h"></i> Adjustments</div>
                    <div id="adjustControls"></div>
                    <button class="pb" onclick="resetAdjust()"><i class="fas fa-undo"></i> Reset Adjustments</button>
                </div>

                <!-- FILTERS -->
                <div class="panel" id="p-filters">
                    <div class="panel-title"><i class="fas fa-palette"></i> Photo Filters</div>
                    <div class="filter-grid" id="filterGrid"></div>
                </div>

                <!-- CROP -->
                <div class="panel" id="p-crop">
                    <div class="panel-title"><i class="fas fa-crop-alt"></i> Crop Image</div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Aspect Ratio</div>
                        <select class="field" id="cropRatio">
                            <option value="free">Free Form</option>
                            <option value="1">1:1 Square</option>
                            <option value="1.333">4:3</option>
                            <option value="1.5">3:2</option>
                            <option value="1.778">16:9</option>
                            <option value="0.5625">9:16</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">X</div>
                            <input type="number" class="field" id="cropX" value="0" min="0">
                        </div>
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Y</div>
                            <input type="number" class="field" id="cropY" value="0" min="0">
                        </div>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Width</div>
                            <input type="number" class="field" id="cropW" value="200" min="1">
                        </div>
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Height</div>
                            <input type="number" class="field" id="cropH" value="200" min="1">
                        </div>
                    </div>
                    <p style="font-size:0.72rem;color:var(--text3);margin-top:8px">üí° Click and drag on the image to select crop area, or enter values above.</p>
                    <button class="pb accent" onclick="applyCrop()"><i class="fas fa-check"></i> Apply Crop</button>
                </div>

                <!-- RESIZE -->
                <div class="panel" id="p-resize">
                    <div class="panel-title"><i class="fas fa-expand-arrows-alt"></i> Resize Image</div>
                    <div class="row">
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Width (px)</div>
                            <input type="number" class="field" id="resizeW" min="1" oninput="resizeLock('w')">
                        </div>
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Height (px)</div>
                            <input type="number" class="field" id="resizeH" min="1" oninput="resizeLock('h')">
                        </div>
                    </div>
                    <label class="chk-label"><input type="checkbox" id="lockAR" checked> Lock Aspect Ratio</label>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Scale</span><span class="ctrl-val" id="v-scale">100%</span></div>
                        <input type="range" min="10" max="300" value="100" id="scaleRange" oninput="scaleImg()">
                    </div>
                    <button class="pb accent" onclick="applyResize()"><i class="fas fa-check"></i> Apply Resize</button>
                </div>

                <!-- ROTATE -->
                <div class="panel" id="p-rotate">
                    <div class="panel-title"><i class="fas fa-sync-alt"></i> Rotate & Flip</div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Angle</span><span class="ctrl-val" id="v-angle">0¬∞</span></div>
                        <input type="range" min="-180" max="180" value="0" id="angleRange" oninput="document.getElementById('v-angle').textContent=this.value+'¬∞'">
                    </div>
                    <div class="row">
                        <button class="pb" onclick="rotateQuick(-90)"><i class="fas fa-undo"></i> -90¬∞</button>
                        <button class="pb" onclick="rotateQuick(90)"><i class="fas fa-redo"></i> +90¬∞</button>
                    </div>
                    <div class="row" style="margin-top:6px">
                        <button class="pb" onclick="flipImg('h')"><i class="fas fa-arrows-alt-h"></i> Flip H</button>
                        <button class="pb" onclick="flipImg('v')"><i class="fas fa-arrows-alt-v"></i> Flip V</button>
                    </div>
                    <button class="pb accent" style="margin-top:10px" onclick="applyAngle()"><i class="fas fa-check"></i> Apply Rotation</button>
                </div>

                <!-- TEXT -->
                <div class="panel" id="p-text">
                    <div class="panel-title"><i class="fas fa-font"></i> Add Text</div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Your Text</div>
                        <input type="text" class="field" id="txtVal" placeholder="Type text here..." value="Hello World">
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Font</div>
                        <select class="field" id="txtFont">
                            <option value="Inter">Inter</option>
                            <option value="Arial">Arial</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Impact">Impact</option>
                        </select>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Size</span><span class="ctrl-val" id="v-fontSize">40px</span></div>
                        <input type="range" min="10" max="200" value="40" id="txtSize" oninput="document.getElementById('v-fontSize').textContent=this.value+'px'">
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Style</div>
                        <select class="field" id="txtWeight">
                            <option value="normal">Normal</option>
                            <option value="bold" selected>Bold</option>
                            <option value="italic">Italic</option>
                            <option value="bold italic">Bold Italic</option>
                        </select>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Alignment</div>
                        <select class="field" id="txtAlign">
                            <option value="center">Center</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                    <div class="color-row">
                        <input type="color" id="txtColor" value="#ffffff">
                        <label>Text Color</label>
                    </div>
                    <div class="color-row">
                        <input type="color" id="txtShadow" value="#000000">
                        <label>Shadow Color</label>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Shadow Size</span><span class="ctrl-val" id="v-shadowSize">2</span></div>
                        <input type="range" min="0" max="20" value="2" id="txtShadowSize" oninput="document.getElementById('v-shadowSize').textContent=this.value">
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Stroke Width</span><span class="ctrl-val" id="v-strokeW">0</span></div>
                        <input type="range" min="0" max="15" value="0" id="txtStrokeW" oninput="document.getElementById('v-strokeW').textContent=this.value">
                    </div>
                    <div class="color-row">
                        <input type="color" id="txtStrokeC" value="#000000">
                        <label>Stroke Color</label>
                    </div>
                    <div class="row">
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Position X</div>
                            <input type="number" class="field" id="txtX" value="50">
                        </div>
                        <div class="ctrl">
                            <div class="ctrl-label" style="margin-bottom:6px">Position Y</div>
                            <input type="number" class="field" id="txtY" value="50">
                        </div>
                    </div>
                    <p style="font-size:0.72rem;color:var(--text3);margin:6px 0">üí° X & Y are percentage (0-100). 50,50 = center.</p>
                    <button class="pb accent" onclick="addText()"><i class="fas fa-plus"></i> Add Text to Image</button>
                </div>

                <!-- DRAW -->
                <div class="panel" id="p-draw">
                    <div class="panel-title"><i class="fas fa-paint-brush"></i> Drawing Tool</div>
                    <div class="color-row">
                        <input type="color" id="drawColor" value="#ff0000">
                        <label>Brush Color</label>
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Brush Size</span><span class="ctrl-val" id="v-brushSize">5</span></div>
                        <input type="range" min="1" max="60" value="5" id="brushSize" oninput="document.getElementById('v-brushSize').textContent=this.value">
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-top"><span class="ctrl-label">Opacity</span><span class="ctrl-val" id="v-brushOp">100%</span></div>
                        <input type="range" min="5" max="100" value="100" id="brushOp" oninput="document.getElementById('v-brushOp').textContent=this.value+'%'">
                    </div>
                    <div class="ctrl">
                        <div class="ctrl-label" style="margin-bottom:6px">Tool</div>
                        <select class="field" id="drawTool">
                            <option value="brush">üñåÔ∏è Brush</option>
                            <option value="eraser">üßπ Eraser</option>
                        </select>
                    </div>
                    <p style="font-size:0.72rem;color:var(--text3);margin:6px 0">üé® Click "Start Drawing" then draw on the image. Click "Done" to apply.</p>
                    <button class="pb accent" id="drawToggle" onclick="toggleDraw()"><i class="fas fa-paint-brush"></i> Start Drawing</button>
                    <button class="pb" onclick="applyDraw()" id="applyDrawBtn" style="display:none"><i class="fas fa-check"></i> Done - Apply Drawing</button>
                    <button class="pb" onclick="clearDraw()" id="clearDrawBtn" style="display:none"><i class="fas fa-trash"></i> Clear Drawing</button>
                </div>

            </div>
        </aside>

        <!-- CANVAS AREA -->
        <main class="canvas-area" id="canvasArea">
            <div class="upload-box" id="uploadBox">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h3>Upload Your Photo</h3>
                    <p>Click here or drag & drop an image</p>
                    <p class="small">Supports: JPG, PNG, WebP, BMP, GIF, SVG</p>
                </div>
            </div>

            <div class="canvas-wrap" id="canvasWrap">
                <canvas id="photoCanvas"></canvas>
                <canvas id="drawCanvas"></canvas>
            </div>

            <div class="zoom-bar" id="zoomBar">
                <button onclick="zoomChange(-10)"><i class="fas fa-minus"></i></button>
                <span id="zoomVal">100%</span>
                <button onclick="zoomChange(10)"><i class="fas fa-plus"></i></button>
                <button onclick="zoomSet(100)" title="Fit"><i class="fas fa-compress"></i></button>
            </div>
        </main>
    </div>

    <!-- EXPORT MODAL -->
    <div class="modal-bg" id="exportModal">
        <div class="modal">
            <h3><i class="fas fa-download"></i> Export Image</h3>
            <div class="fmt-grid">
                <button class="fmt-btn active" onclick="pickFmt('png',this)"><span class="ico">üñºÔ∏è</span>PNG</button>
                <button class="fmt-btn" onclick="pickFmt('jpeg',this)"><span class="ico">üì∑</span>JPEG</button>
                <button class="fmt-btn" onclick="pickFmt('webp',this)"><span class="ico">üåê</span>WebP</button>
            </div>
            <div class="ctrl">
                <div class="ctrl-top"><span class="ctrl-label">Quality</span><span class="ctrl-val" id="v-quality">92%</span></div>
                <input type="range" min="10" max="100" value="92" id="exportQuality" oninput="document.getElementById('v-quality').textContent=this.value+'%'">
            </div>
            <div class="ctrl">
                <div class="ctrl-label" style="margin-bottom:6px">File Name</div>
                <input type="text" class="field" id="exportName" value="edited-photo">
            </div>
            <div class="row" style="margin-top:14px">
                <button class="pb" onclick="hideExport()">Cancel</button>
                <button class="pb accent" onclick="doExport()"><i class="fas fa-download"></i> Download</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMsg"></span></div>

    <!-- SEO CONTENT -->
    <div class="seo-wrap">
        <article>
            <h2>Free Online Photo Editor ‚Äî Professional Image Editing Tool</h2>
            <p>Welcome to our <strong>free online photo editor</strong>. A powerful, professional-grade image editing tool that works directly in your browser. No downloads, no signups, no watermarks. Edit photos with <strong>crop, resize, rotate, flip, filters, brightness, contrast, saturation, text overlay, drawing tools</strong> and more.</p>

            <h3>‚ú® How to Edit Photos Online</h3>
            <ul>
                <li><strong>Step 1:</strong> Click "Open" or drag & drop your image to upload</li>
                <li><strong>Step 2:</strong> Use tabs on the left ‚Äî Adjust, Filters, Crop, Resize, Rotate, Text, Draw</li>
                <li><strong>Step 3:</strong> Fine-tune your photo using the professional editing controls</li>
                <li><strong>Step 4:</strong> Click "Export" to download your edited image in PNG, JPEG or WebP</li>
            </ul>

            <h3>üé® Complete Editing Features</h3>
            <div class="feat-grid">
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-sliders-h"></i></div>
                    <h4>Advanced Adjustments</h4>
                    <p>Fine-tune brightness, contrast, saturation, hue, exposure, warmth, blur, grayscale, sepia, invert and opacity.</p>
                </div>
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-palette"></i></div>
                    <h4>20+ Photo Filters</h4>
                    <p>Professional filters like Vivid, Warm, Cool, Vintage, Cinema, Noir, Fade, Dramatic, Retro and more.</p>
                </div>
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-crop-alt"></i></div>
                    <h4>Smart Crop & Resize</h4>
                    <p>Crop with preset ratios (1:1, 4:3, 16:9) or custom values. Resize to exact pixel dimensions.</p>
                </div>
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-sync-alt"></i></div>
                    <h4>Rotate & Flip</h4>
                    <p>Rotate images to any angle. Quick 90¬∞ rotation. Flip horizontally or vertically.</p>
                </div>
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-font"></i></div>
                    <h4>Text Overlay</h4>
                    <p>Add text with custom fonts, sizes, colors, shadows, stroke effects and precise positioning.</p>
                </div>
                <div class="feat-card">
                    <div class="fi"><i class="fas fa-paint-brush"></i></div>
                    <h4>Drawing Tool</h4>
                    <p>Free-hand drawing with customizable brush size, color, opacity. Includes eraser tool.</p>
                </div>
            </div>

            <h3>üîí Privacy & Security</h3>
            <p>All image editing happens <strong>100% in your browser</strong>. Your photos are never uploaded to any server. We don't store, collect, or access your images. Complete privacy guaranteed.</p>
        </article>

        <section style="margin-top:40px">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-item">
                <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">How do I edit photos online for free? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-a"><div class="faq-a-in">Upload your photo by clicking the upload area or dragging your image. Use the editing tabs to access tools like adjustments, filters, crop, resize, rotate, text and drawing. Click Export to download your edited image. Everything is 100% free with no signup needed.</div></div>
            </div>
            <div class="faq-item">
                <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">What image formats are supported? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-a"><div class="faq-a-in">Our editor supports JPG, JPEG, PNG, WebP, BMP, GIF and SVG for upload. You can export edited images in PNG, JPEG or WebP format with custom quality settings.</div></div>
            </div>
            <div class="faq-item">
                <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Are my photos safe and private? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-a"><div class="faq-a-in">Yes, 100% safe. All processing happens locally in your browser using HTML5 Canvas. Your photos never leave your device. We don't upload, store or access any of your images.</div></div>
            </div>
            <div class="faq-item">
                <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Does the editor add watermarks? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-a"><div class="faq-a-in">No, absolutely not. Your exported image is exactly what you see ‚Äî clean, professional, and watermark-free.</div></div>
            </div>
            <div class="faq-item">
                <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Can I use this on mobile? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-a"><div class="faq-a-in">Yes! Our photo editor is fully responsive and works on all devices ‚Äî phones, tablets and desktops. All features work on mobile including touch drawing.</div></div>
            </div>
        </section>

        <footer class="site-footer">
            <p>&copy; 2024 Photo Editor Pro. All rights reserved.</p>
            <p>Free online photo editor ‚Äî Edit, crop, resize, filter and enhance your photos instantly.</p>
        </footer>
    </div>

    <script>
    // ========================================
    //          STATE & GLOBALS
    // ========================================
    const C = document.getElementById('photoCanvas');
    const X = C.getContext('2d');
    const DC = document.getElementById('drawCanvas');
    const DX = DC.getContext('2d');

    let img = null;           // current base image (Image object)
    let origImg = null;       // very first loaded image
    let undoStack = [];
    let redoStack = [];
    let zoom = 100;
    let drawMode = false;
    let isDrawing = false;
    let lastPt = null;
    let cropDrag = false;
    let cropStart = null;
    let exportFmt = 'png';
    let currentTab = 'adjust';

    // Adjustments config
    const adjDefs = [
        { id:'brightness', label:'Brightness', min:-100, max:100, def:0 },
        { id:'contrast', label:'Contrast', min:-100, max:100, def:0 },
        { id:'saturate', label:'Saturation', min:-100, max:100, def:0 },
        { id:'hue', label:'Hue Rotate', min:0, max:360, def:0, unit:'¬∞' },
        { id:'exposure', label:'Exposure', min:-100, max:100, def:0 },
        { id:'warmth', label:'Warmth', min:-50, max:50, def:0 },
        { id:'blur', label:'Blur', min:0, max:20, def:0, unit:'px' },
        { id:'grayscale', label:'Grayscale', min:0, max:100, def:0, unit:'%' },
        { id:'sepia', label:'Sepia', min:0, max:100, def:0, unit:'%' },
        { id:'invert', label:'Invert', min:0, max:100, def:0, unit:'%' },
        { id:'opacity', label:'Opacity', min:0, max:100, def:100, unit:'%' },
    ];

    const adjVals = {};
    adjDefs.forEach(a => adjVals[a.id] = a.def);

    // Build adjustment controls
    const adjContainer = document.getElementById('adjustControls');
    adjDefs.forEach(a => {
        const unit = a.unit || '';
        const html = `
            <div class="ctrl">
                <div class="ctrl-top">
                    <span class="ctrl-label">${a.label}</span>
                    <span class="ctrl-val" id="av-${a.id}">${a.def}${unit}</span>
                </div>
                <input type="range" min="${a.min}" max="${a.max}" value="${a.def}" id="ar-${a.id}">
            </div>`;
        adjContainer.insertAdjacentHTML('beforeend', html);

        document.getElementById('ar-'+a.id).addEventListener('input', function() {
            adjVals[a.id] = parseFloat(this.value);
            document.getElementById('av-'+a.id).textContent = this.value + unit;
            renderImage();
        });
    });

    // Filters
    const FILTERS = [
        { name:'None', fn: null },
        { name:'Vivid', fn: d => colorMatrix(d, 1.0, 1.15, 1.5, 0) },
        { name:'Warm', fn: d => colorMatrix(d, 1.1, 1.0, 0.85, 15) },
        { name:'Cool', fn: d => colorMatrix(d, 0.9, 1.0, 1.15, -10) },
        { name:'Vintage', fn: d => { colorMatrix(d, 1.05, 0.95, 0.85, 20); sepiaTone(d, 0.35); }},
        { name:'Cinema', fn: d => { colorMatrix(d, 1.0, 1.2, 0.9, 0); adjustCurve(d, 0.95, 10); }},
        { name:'Noir', fn: d => { grayscaleFilter(d, 1); colorMatrix(d, 1.0, 1.35, 1.0, 0); }},
        { name:'Fade', fn: d => { colorMatrix(d, 1.0, 0.85, 0.75, 0); liftBlacks(d, 30); }},
        { name:'Dramatic', fn: d => colorMatrix(d, 1.0, 1.4, 1.25, 0) },
        { name:'Soft', fn: d => { colorMatrix(d, 1.08, 0.92, 0.9, 0); liftBlacks(d, 15); }},
        { name:'Arctic', fn: d => { colorMatrix(d, 0.85, 1.0, 1.3, -15); liftBlacks(d, 20); }},
        { name:'Sunset', fn: d => colorMatrix(d, 1.2, 1.05, 0.8, 25) },
        { name:'Retro', fn: d => { sepiaTone(d, 0.5); colorMatrix(d, 1.1, 0.9, 0.85, 10); }},
        { name:'B&W Hard', fn: d => { grayscaleFilter(d, 1); colorMatrix(d, 1.0, 1.6, 1.0, 0); }},
        { name:'Moody', fn: d => { colorMatrix(d, 0.9, 1.2, 0.85, 0); liftBlacks(d, 10); }},
        { name:'Pop', fn: d => colorMatrix(d, 1.0, 1.15, 2.0, 0) },
        { name:'Pastel', fn: d => { colorMatrix(d, 1.15, 0.88, 0.6, 0); liftBlacks(d, 35); }},
        { name:'Emerald', fn: d => colorMatrix(d, 0.85, 1.15, 1.1, 0) },
        { name:'Amber', fn: d => { sepiaTone(d, 0.6); colorMatrix(d, 1.15, 1.0, 0.8, 15); }},
        { name:'Neon', fn: d => colorMatrix(d, 1.1, 1.2, 1.8, 0) },
    ];

    let activeFilter = 0;

    const filterGrid = document.getElementById('filterGrid');
    FILTERS.forEach((f, i) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (i===0?' active':'');
        btn.textContent = f.name;
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeFilter = i;
            renderImage();
            toast(f.name + ' filter applied');
        });
        filterGrid.appendChild(btn);
    });

    // ========================================
    //         PIXEL MANIPULATION HELPERS
    // ========================================
    function colorMatrix(imgData, brightness, contrast, saturation, warmth) {
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            let r = d[i], g = d[i+1], b = d[i+2];

            // Brightness
            r *= brightness; g *= brightness; b *= brightness;

            // Contrast
            r = ((r/255 - 0.5) * contrast + 0.5) * 255;
            g = ((g/255 - 0.5) * contrast + 0.5) * 255;
            b = ((b/255 - 0.5) * contrast + 0.5) * 255;

            // Saturation
            const gray = 0.2126*r + 0.7152*g + 0.0722*b;
            r = gray + (r - gray) * saturation;
            g = gray + (g - gray) * saturation;
            b = gray + (b - gray) * saturation;

            // Warmth
            r += warmth;
            b -= warmth;

            d[i] = clamp(r);
            d[i+1] = clamp(g);
            d[i+2] = clamp(b);
        }
    }

    function sepiaTone(imgData, amount) {
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            const r = d[i], g = d[i+1], b = d[i+2];
            const sr = 0.393*r + 0.769*g + 0.189*b;
            const sg = 0.349*r + 0.686*g + 0.168*b;
            const sb = 0.272*r + 0.534*g + 0.131*b;
            d[i] = clamp(r + (sr - r) * amount);
            d[i+1] = clamp(g + (sg - g) * amount);
            d[i+2] = clamp(b + (sb - b) * amount);
        }
    }

    function grayscaleFilter(imgData, amount) {
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            const gray = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
            d[i] = d[i] + (gray - d[i]) * amount;
            d[i+1] = d[i+1] + (gray - d[i+1]) * amount;
            d[i+2] = d[i+2] + (gray - d[i+2]) * amount;
        }
    }

    function liftBlacks(imgData, amount) {
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            d[i] = clamp(d[i] + amount);
            d[i+1] = clamp(d[i+1] + amount);
            d[i+2] = clamp(d[i+2] + amount);
        }
    }

    function adjustCurve(imgData, gamma, shift) {
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            d[i] = clamp(255 * Math.pow(d[i]/255, gamma) + shift);
            d[i+1] = clamp(255 * Math.pow(d[i+1]/255, gamma) + shift);
            d[i+2] = clamp(255 * Math.pow(d[i+2]/255, gamma) + shift);
        }
    }

    function clamp(v) { return Math.max(0, Math.min(255, Math.round(v))); }

    // ========================================
    //           CORE RENDER
    // ========================================
    function renderImage() {
        if (!img) return;

        // Draw original image
        C.width = img.width;
        C.height = img.height;
        X.clearRect(0, 0, C.width, C.height);
        X.drawImage(img, 0, 0);

        // Get pixel data
        let imgData = X.getImageData(0, 0, C.width, C.height);
        const d = imgData.data;

        // 1) Brightness
        const br = adjVals.brightness / 100;
        // 2) Contrast
        const ct = (adjVals.contrast + 100) / 100;
        // 3) Saturation
        const sat = (adjVals.saturate + 100) / 100;
        // 4) Exposure
        const exp = adjVals.exposure / 100;
        // 5) Warmth
        const warm = adjVals.warmth;

        for (let i = 0; i < d.length; i += 4) {
            let r = d[i], g = d[i+1], b = d[i+2];

            // Brightness + Exposure
            const brightFactor = 1 + br + exp * 0.5;
            r *= brightFactor;
            g *= brightFactor;
            b *= brightFactor;

            // Contrast
            r = ((r/255 - 0.5) * ct + 0.5) * 255;
            g = ((g/255 - 0.5) * ct + 0.5) * 255;
            b = ((b/255 - 0.5) * ct + 0.5) * 255;

            // Saturation
            const gray = 0.2126*r + 0.7152*g + 0.0722*b;
            r = gray + (r - gray) * sat;
            g = gray + (g - gray) * sat;
            b = gray + (b - gray) * sat;

            // Warmth
            r += warm * 1.5;
            b -= warm * 1.5;

            d[i] = clamp(r);
            d[i+1] = clamp(g);
            d[i+2] = clamp(b);
        }

        // Hue Rotate
        if (adjVals.hue > 0) {
            const angle = adjVals.hue * Math.PI / 180;
            for (let i = 0; i < d.length; i += 4) {
                const [h, s, l] = rgbToHsl(d[i], d[i+1], d[i+2]);
                const [r, g, b] = hslToRgb(((h + angle / (2*Math.PI)) % 1 + 1) % 1, s, l);
                d[i] = r; d[i+1] = g; d[i+2] = b;
            }
        }

        // Grayscale
        if (adjVals.grayscale > 0) {
            grayscaleFilter(imgData, adjVals.grayscale / 100);
        }

        // Sepia
        if (adjVals.sepia > 0) {
            sepiaTone(imgData, adjVals.sepia / 100);
        }

        // Invert
        if (adjVals.invert > 0) {
            const inv = adjVals.invert / 100;
            for (let i = 0; i < d.length; i += 4) {
                d[i] = d[i] + (255 - 2 * d[i]) * inv;
                d[i+1] = d[i+1] + (255 - 2 * d[i+1]) * inv;
                d[i+2] = d[i+2] + (255 - 2 * d[i+2]) * inv;
            }
        }

        // Opacity
        if (adjVals.opacity < 100) {
            const op = adjVals.opacity / 100;
            for (let i = 0; i < d.length; i += 4) {
                d[i+3] = Math.round(d[i+3] * op);
            }
        }

        // Apply selected filter
        if (activeFilter > 0 && FILTERS[activeFilter].fn) {
            FILTERS[activeFilter].fn(imgData);
        }

        X.putImageData(imgData, 0, 0);

        // Blur (via CSS because pixel blur is expensive)
        if (adjVals.blur > 0) {
            const tempC = document.createElement('canvas');
            tempC.width = C.width;
            tempC.height = C.height;
            const tempX = tempC.getContext('2d');
            tempX.filter = `blur(${adjVals.blur}px)`;
            tempX.drawImage(C, 0, 0);
            X.clearRect(0, 0, C.width, C.height);
            X.drawImage(tempC, 0, 0);
        }

        updateCanvasSize();
    }

    // HSL helpers
    function rgbToHsl(r, g, b) {
        r/=255; g/=255; b/=255;
        const max=Math.max(r,g,b), min=Math.min(r,g,b);
        let h,s,l=(max+min)/2;
        if(max===min){h=s=0;}
        else{
            const d=max-min;
            s=l>0.5?d/(2-max-min):d/(max+min);
            switch(max){
                case r:h=((g-b)/d+(g<b?6:0))/6;break;
                case g:h=((b-r)/d+2)/6;break;
                case b:h=((r-g)/d+4)/6;break;
            }
        }
        return[h,s,l];
    }

    function hslToRgb(h,s,l) {
        let r,g,b;
        if(s===0){r=g=b=l;}
        else{
            const hue2rgb=(p,q,t)=>{
                if(t<0)t+=1;if(t>1)t-=1;
                if(t<1/6)return p+(q-p)*6*t;
                if(t<1/2)return q;
                if(t<2/3)return p+(q-p)*(2/3-t)*6;
                return p;
            };
            const q=l<0.5?l*(1+s):l+s-l*s;
            const p=2*l-q;
            r=hue2rgb(p,q,h+1/3);
            g=hue2rgb(p,q,h);
            b=hue2rgb(p,q,h-1/3);
        }
        return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];
    }

    // ========================================
    //         IMAGE LOADING
    // ========================================
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');

    function openFile() { fileInput.click(); }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('over'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('over');
        if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files[0]) loadFile(fileInput.files[0]);
    });

    function loadFile(file) {
        if (!file.type.startsWith('image/')) {
            toast('Please select an image file!', true);
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const newImg = new Image();
            newImg.onload = function() {
                origImg = newImg;
                img = newImg;

                // Reset all adjustments
                adjDefs.forEach(a => {
                    adjVals[a.id] = a.def;
                    document.getElementById('ar-'+a.id).value = a.def;
                    document.getElementById('av-'+a.id).textContent = a.def + (a.unit||'');
                });

                activeFilter = 0;
                document.querySelectorAll('.filter-btn').forEach((b,i) => b.classList.toggle('active', i===0));

                renderImage();

                document.getElementById('uploadBox').style.display = 'none';
                document.getElementById('canvasWrap').style.display = 'block';
                document.getElementById('zoomBar').style.display = 'flex';

                document.getElementById('resizeW').value = newImg.width;
                document.getElementById('resizeH').value = newImg.height;
                document.getElementById('cropW').value = newImg.width;
                document.getElementById('cropH').value = newImg.height;
                document.getElementById('cropX').value = 0;
                document.getElementById('cropY').value = 0;

                document.getElementById('exportName').value = file.name.replace(/\.[^.]+$/, '') + '-edited';

                undoStack = [C.toDataURL()];
                redoStack = [];
                updateUndoRedo();

                zoom = 100;
                zoomSet(100);

                toast('Image loaded successfully!');
            };
            newImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function updateCanvasSize() {
        const scale = zoom / 100;
        C.style.width = (C.width * scale) + 'px';
        C.style.height = (C.height * scale) + 'px';

        DC.width = C.width;
        DC.height = C.height;
        DC.style.width = C.style.width;
        DC.style.height = C.style.height;
    }

    // ========================================
    //         CROP - CLICK & DRAG
    // ========================================
    C.addEventListener('mousedown', canvasMouseDown);
    C.addEventListener('mousemove', canvasMouseMove);
    C.addEventListener('mouseup', canvasMouseUp);

    C.addEventListener('touchstart', e => { e.preventDefault(); canvasMouseDown(touchToMouse(e)); }, { passive: false });
    C.addEventListener('touchmove', e => { e.preventDefault(); canvasMouseMove(touchToMouse(e)); }, { passive: false });
    C.addEventListener('touchend', e => { e.preventDefault(); canvasMouseUp(e); }, { passive: false });

    function touchToMouse(e) {
        const touch = e.touches[0];
        const rect = C.getBoundingClientRect();
        return {
            offsetX: touch.clientX - rect.left,
            offsetY: touch.clientY - rect.top,
            preventDefault: () => {}
        };
    }

    function getCanvasXY(e) {
        const rect = C.getBoundingClientRect();
        const scaleX = C.width / rect.width;
        const scaleY = C.height / rect.height;
        return {
            x: Math.round((e.offsetX || 0) * scaleX),
            y: Math.round((e.offsetY || 0) * scaleY)
        };
    }

    function canvasMouseDown(e) {
        const pt = getCanvasXY(e);

        if (currentTab === 'crop') {
            cropDrag = true;
            cropStart = pt;
        }
    }

    function canvasMouseMove(e) {
        const pt = getCanvasXY(e);

        if (currentTab === 'crop' && cropDrag && cropStart) {
            const x = Math.min(cropStart.x, pt.x);
            const y = Math.min(cropStart.y, pt.y);
            const w = Math.abs(pt.x - cropStart.x);
            const h = Math.abs(pt.y - cropStart.y);

            document.getElementById('cropX').value = x;
            document.getElementById('cropY').value = y;
            document.getElementById('cropW').value = w;
            document.getElementById('cropH').value = h;

            // Draw crop preview
            renderImage();
            X.save();
            X.fillStyle = 'rgba(0,0,0,0.5)';
            X.fillRect(0, 0, C.width, C.height);
            X.clearRect(x, y, w, h);
            // Redraw image in crop area
            const tempC = document.createElement('canvas');
            tempC.width = C.width;
            tempC.height = C.height;
            const tempX = tempC.getContext('2d');
            tempX.drawImage(img, 0, 0);
            X.drawImage(tempC, x, y, w, h, x, y, w, h);
            // Border
            X.strokeStyle = '#6c5ce7';
            X.lineWidth = 2;
            X.setLineDash([6, 4]);
            X.strokeRect(x, y, w, h);
            X.setLineDash([]);
            X.restore();
        }
    }

    function canvasMouseUp(e) {
        cropDrag = false;
    }

    function applyCrop() {
        if (!img) return;
        const cx = parseInt(document.getElementById('cropX').value) || 0;
        const cy = parseInt(document.getElementById('cropY').value) || 0;
        let cw = parseInt(document.getElementById('cropW').value) || C.width;
        let ch = parseInt(document.getElementById('cropH').value) || C.height;

        if (cw < 1 || ch < 1) { toast('Invalid crop size!', true); return; }

        cw = Math.min(cw, C.width - cx);
        ch = Math.min(ch, C.height - cy);

        // Get current rendered image
        renderImage();
        const cropData = X.getImageData(cx, cy, cw, ch);

        C.width = cw;
        C.height = ch;
        X.putImageData(cropData, 0, 0);

        // Update img to cropped version
        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            document.getElementById('resizeW').value = cw;
            document.getElementById('resizeH').value = ch;
            document.getElementById('cropW').value = cw;
            document.getElementById('cropH').value = ch;
            document.getElementById('cropX').value = 0;
            document.getElementById('cropY').value = 0;
            updateCanvasSize();
            saveState();
            toast('Image cropped!');
        };
        newImg.src = C.toDataURL();
    }

    // ========================================
    //         RESIZE
    // ========================================
    function resizeLock(changed) {
        if (!img || !document.getElementById('lockAR').checked) return;
        const ratio = img.width / img.height;
        if (changed === 'w') {
            document.getElementById('resizeH').value = Math.round((parseInt(document.getElementById('resizeW').value)||1) / ratio);
        } else {
            document.getElementById('resizeW').value = Math.round((parseInt(document.getElementById('resizeH').value)||1) * ratio);
        }
    }

    function scaleImg() {
        if (!img) return;
        const s = parseInt(document.getElementById('scaleRange').value);
        document.getElementById('v-scale').textContent = s + '%';
        document.getElementById('resizeW').value = Math.round(img.width * s / 100);
        document.getElementById('resizeH').value = Math.round(img.height * s / 100);
    }

    function applyResize() {
        if (!img) return;
        const nw = parseInt(document.getElementById('resizeW').value) || C.width;
        const nh = parseInt(document.getElementById('resizeH').value) || C.height;
        if (nw < 1 || nh < 1) { toast('Invalid size!', true); return; }

        // Render current, then resize
        renderImage();
        const tempC = document.createElement('canvas');
        tempC.width = nw;
        tempC.height = nh;
        const tempX = tempC.getContext('2d');
        tempX.drawImage(C, 0, 0, nw, nh);

        C.width = nw;
        C.height = nh;
        X.drawImage(tempC, 0, 0);

        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            document.getElementById('cropW').value = nw;
            document.getElementById('cropH').value = nh;
            updateCanvasSize();
            saveState();
            toast('Image resized to ' + nw + 'x' + nh + '!');
        };
        newImg.src = C.toDataURL();
    }

    // ========================================
    //         ROTATE & FLIP
    // ========================================
    function rotateQuick(deg) {
        if (!img) return;
        renderImage();
        const rad = deg * Math.PI / 180;
        const abs = Math.abs(deg);

        const tempC = document.createElement('canvas');
        if (abs === 90 || abs === 270) {
            tempC.width = C.height;
            tempC.height = C.width;
        } else {
            tempC.width = C.width;
            tempC.height = C.height;
        }
        const tempX = tempC.getContext('2d');
        tempX.translate(tempC.width/2, tempC.height/2);
        tempX.rotate(rad);
        tempX.drawImage(C, -C.width/2, -C.height/2);

        C.width = tempC.width;
        C.height = tempC.height;
        X.drawImage(tempC, 0, 0);

        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            document.getElementById('resizeW').value = C.width;
            document.getElementById('resizeH').value = C.height;
            updateCanvasSize();
            saveState();
            toast('Rotated ' + deg + '¬∞!');
        };
        newImg.src = C.toDataURL();
    }

    function applyAngle() {
        const deg = parseInt(document.getElementById('angleRange').value);
        if (deg === 0) { toast('Set an angle first!', true); return; }

        renderImage();
        const rad = deg * Math.PI / 180;
        const absCos = Math.abs(Math.cos(rad));
        const absSin = Math.abs(Math.sin(rad));
        const nw = Math.round(C.width * absCos + C.height * absSin);
        const nh = Math.round(C.width * absSin + C.height * absCos);

        const tempC = document.createElement('canvas');
        tempC.width = nw;
        tempC.height = nh;
        const tempX = tempC.getContext('2d');
        tempX.translate(nw/2, nh/2);
        tempX.rotate(rad);
        tempX.drawImage(C, -C.width/2, -C.height/2);

        C.width = nw;
        C.height = nh;
        X.drawImage(tempC, 0, 0);

        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            updateCanvasSize();
            saveState();
            toast('Rotated ' + deg + '¬∞!');
        };
        newImg.src = C.toDataURL();

        document.getElementById('angleRange').value = 0;
        document.getElementById('v-angle').textContent = '0¬∞';
    }

    function flipImg(dir) {
        if (!img) return;
        renderImage();
        const tempC = document.createElement('canvas');
        tempC.width = C.width;
        tempC.height = C.height;
        const tempX = tempC.getContext('2d');

        if (dir === 'h') {
            tempX.translate(C.width, 0);
            tempX.scale(-1, 1);
        } else {
            tempX.translate(0, C.height);
            tempX.scale(1, -1);
        }
        tempX.drawImage(C, 0, 0);

        X.clearRect(0, 0, C.width, C.height);
        X.drawImage(tempC, 0, 0);

        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            saveState();
            toast('Flipped ' + (dir==='h'?'horizontally':'vertically') + '!');
        };
        newImg.src = C.toDataURL();
    }

    // ========================================
    //           TEXT
    // ========================================
    function addText() {
        if (!img) { toast('Load an image first!', true); return; }
        const text = document.getElementById('txtVal').value;
        if (!text) { toast('Enter text first!', true); return; }

        renderImage();

        const font = document.getElementById('txtFont').value;
        const size = parseInt(document.getElementById('txtSize').value);
        const weight = document.getElementById('txtWeight').value;
        const align = document.getElementById('txtAlign').value;
        const color = document.getElementById('txtColor').value;
        const shadowColor = document.getElementById('txtShadow').value;
        const shadowSize = parseInt(document.getElementById('txtShadowSize').value);
        const strokeW = parseInt(document.getElementById('txtStrokeW').value);
        const strokeC = document.getElementById('txtStrokeC').value;
        const posX = parseFloat(document.getElementById('txtX').value) / 100;
        const posY = parseFloat(document.getElementById('txtY').value) / 100;

        const x = C.width * posX;
        const y = C.height * posY;

        X.save();
        X.font = `${weight} ${size}px "${font}"`;
        X.textAlign = align;
        X.textBaseline = 'middle';

        // Shadow
        if (shadowSize > 0) {
            X.shadowColor = shadowColor;
            X.shadowBlur = shadowSize;
            X.shadowOffsetX = shadowSize / 2;
            X.shadowOffsetY = shadowSize / 2;
        }

        // Stroke
        if (strokeW > 0) {
            X.strokeStyle = strokeC;
            X.lineWidth = strokeW;
            X.lineJoin = 'round';
            X.strokeText(text, x, y);
        }

        // Fill
        X.fillStyle = color;
        X.fillText(text, x, y);
        X.restore();

        // Update img
        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            saveState();
            toast('Text added!');
        };
        newImg.src = C.toDataURL();
    }

    // ========================================
    //           DRAWING
    // ========================================
    function toggleDraw() {
        if (!img) { toast('Load an image first!', true); return; }
        drawMode = !drawMode;
        const btn = document.getElementById('drawToggle');
        const applyBtn = document.getElementById('applyDrawBtn');
        const clearBtn = document.getElementById('clearDrawBtn');

        if (drawMode) {
            renderImage(); // make sure canvas is up to date
            DC.style.display = 'block';
            DC.width = C.width;
            DC.height = C.height;
            DC.style.width = C.style.width;
            DC.style.height = C.style.height;
            DX.clearRect(0, 0, DC.width, DC.height);
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop Drawing';
            btn.style.background = 'var(--red)';
            btn.style.borderColor = 'var(--red)';
            applyBtn.style.display = 'block';
            clearBtn.style.display = 'block';
            C.style.pointerEvents = 'none';
        } else {
            DC.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-paint-brush"></i> Start Drawing';
            btn.style.background = '';
            btn.style.borderColor = '';
            applyBtn.style.display = 'none';
            clearBtn.style.display = 'none';
            C.style.pointerEvents = 'auto';
        }
    }

    // Draw canvas events
    DC.addEventListener('mousedown', drawStart);
    DC.addEventListener('mousemove', drawMove);
    DC.addEventListener('mouseup', drawEnd);
    DC.addEventListener('mouseleave', drawEnd);

    DC.addEventListener('touchstart', e => { e.preventDefault(); drawStart(drawTouch(e)); }, { passive: false });
    DC.addEventListener('touchmove', e => { e.preventDefault(); drawMove(drawTouch(e)); }, { passive: false });
    DC.addEventListener('touchend', e => { e.preventDefault(); drawEnd(); }, { passive: false });

    function drawTouch(e) {
        const touch = e.touches[0];
        const rect = DC.getBoundingClientRect();
        return {
            offsetX: touch.clientX - rect.left,
            offsetY: touch.clientY - rect.top
        };
    }

    function drawStart(e) {
        if (!drawMode) return;
        isDrawing = true;
        const rect = DC.getBoundingClientRect();
        const sx = DC.width / rect.width;
        const sy = DC.height / rect.height;
        lastPt = { x: e.offsetX * sx, y: e.offsetY * sy };
    }

    function drawMove(e) {
        if (!isDrawing || !drawMode) return;
        const rect = DC.getBoundingClientRect();
        const sx = DC.width / rect.width;
        const sy = DC.height / rect.height;
        const x = e.offsetX * sx;
        const y = e.offsetY * sy;

        const tool = document.getElementById('drawTool').value;
        const brushSz = parseInt(document.getElementById('brushSize').value);
        const opacity = parseInt(document.getElementById('brushOp').value) / 100;

        DX.globalAlpha = opacity;
        DX.lineWidth = brushSz;
        DX.lineCap = 'round';
        DX.lineJoin = 'round';

        if (tool === 'eraser') {
            DX.globalCompositeOperation = 'destination-out';
            DX.strokeStyle = 'rgba(0,0,0,1)';
        } else {
            DX.globalCompositeOperation = 'source-over';
            DX.strokeStyle = document.getElementById('drawColor').value;
        }

        DX.beginPath();
        DX.moveTo(lastPt.x, lastPt.y);
        DX.lineTo(x, y);
        DX.stroke();

        DX.globalAlpha = 1;
        DX.globalCompositeOperation = 'source-over';

        lastPt = { x, y };
    }

    function drawEnd() {
        isDrawing = false;
        lastPt = null;
    }

    function applyDraw() {
        if (!img) return;
        // Merge draw canvas onto main canvas
        renderImage();
        X.drawImage(DC, 0, 0);

        const newImg = new Image();
        newImg.onload = function() {
            img = newImg;
            saveState();
            toast('Drawing applied!');
        };
        newImg.src = C.toDataURL();

        // Exit draw mode
        drawMode = true; // set to true so toggle will make it false
        toggleDraw();
    }

    function clearDraw() {
        DX.clearRect(0, 0, DC.width, DC.height);
        toast('Drawing cleared');
    }

    // ========================================
    //        UNDO / REDO
    // ========================================
    function saveState() {
        undoStack.push(C.toDataURL());
        redoStack = [];
        if (undoStack.length > 25) undoStack.shift();
        updateUndoRedo();
    }

    function undo() {
        if (undoStack.length <= 1) return;
        redoStack.push(undoStack.pop());
        restoreState(undoStack[undoStack.length - 1]);
        toast('Undo');
    }

    function redo() {
        if (redoStack.length === 0) return;
        const state = redoStack.pop();
        undoStack.push(state);
        restoreState(state);
        toast('Redo');
    }

    function restoreState(dataURL) {
        const tempImg = new Image();
        tempImg.onload = function() {
            img = tempImg;
            C.width = tempImg.width;
            C.height = tempImg.height;
            X.drawImage(tempImg, 0, 0);

            // Reset adjustments since state is baked
            adjDefs.forEach(a => {
                adjVals[a.id] = a.def;
                document.getElementById('ar-'+a.id).value = a.def;
                document.getElementById('av-'+a.id).textContent = a.def + (a.unit||'');
            });
            activeFilter = 0;
            document.querySelectorAll('.filter-btn').forEach((b,i) => b.classList.toggle('active', i===0));

            updateCanvasSize();
            updateUndoRedo();
        };
        tempImg.src = dataURL;
    }

    function updateUndoRedo() {
        document.getElementById('undoBtn').disabled = undoStack.length <= 1;
        document.getElementById('redoBtn').disabled = redoStack.length === 0;
    }

    function resetAll() {
        if (!origImg) return;
        if (!confirm('Reset all changes?')) return;

        img = origImg;

        adjDefs.forEach(a => {
            adjVals[a.id] = a.def;
            document.getElementById('ar-'+a.id).value = a.def;
            document.getElementById('av-'+a.id).textContent = a.def + (a.unit||'');
        });
        activeFilter = 0;
        document.querySelectorAll('.filter-btn').forEach((b,i) => b.classList.toggle('active', i===0));

        renderImage();

        undoStack = [C.toDataURL()];
        redoStack = [];
        updateUndoRedo();

        document.getElementById('resizeW').value = img.width;
        document.getElementById('resizeH').value = img.height;

        toast('All changes reset!');
    }

    // ========================================
    //          ZOOM
    // ========================================
    function zoomChange(delta) {
        zoomSet(Math.max(10, Math.min(400, zoom + delta)));
    }

    function zoomSet(val) {
        zoom = parseInt(val);
        document.getElementById('zoomVal').textContent = zoom + '%';
        updateCanvasSize();
    }

    C.addEventListener('wheel', e => {
        e.preventDefault();
        zoomChange(e.deltaY > 0 ? -5 : 5);
    }, { passive: false });

    // ========================================
    //         EXPORT
    // ========================================
    function showExport() {
        if (!img) { toast('Load an image first!', true); return; }
        // Make sure we render the latest
        renderImage();
        document.getElementById('exportModal').classList.add('show');
    }

    function hideExport() {
        document.getElementById('exportModal').classList.remove('show');
    }

    function pickFmt(fmt, el) {
        exportFmt = fmt;
        document.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function doExport() {
        const quality = parseInt(document.getElementById('exportQuality').value) / 100;
        const name = document.getElementById('exportName').value || 'photo';
        const mime = exportFmt === 'jpeg' ? 'image/jpeg' : exportFmt === 'webp' ? 'image/webp' : 'image/png';

        // Render final
        renderImage();

        const dataURL = C.toDataURL(mime, quality);
        const link = document.createElement('a');
        link.download = name + '.' + exportFmt;
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        hideExport();
        toast('Image downloaded as ' + exportFmt.toUpperCase() + '!');
    }

    // ========================================
    //         TABS
    // ========================================
    function switchTab(id, el) {
        currentTab = id;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('p-'+id).classList.add('active');

        // Update cursor
        if (id === 'crop') C.style.cursor = 'crosshair';
        else if (id === 'draw') C.style.cursor = 'crosshair';
        else C.style.cursor = 'default';

        // Close sidebar on mobile
        document.getElementById('sidebar').classList.remove('open');
    }

    // ========================================
    //           TOAST
    // ========================================
    function toast(msg, isErr) {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').textContent = msg;
        t.className = 'toast ' + (isErr ? 'err' : 'ok');
        t.querySelector('i').className = isErr ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
        t.classList.add('show');
        clearTimeout(t._timer);
        t._timer = setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ========================================
    //        KEYBOARD SHORTCUTS
    // ========================================
    document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
        if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); showExport(); }
        if (e.ctrlKey && e.key === 'o') { e.preventDefault(); openFile(); }
    });

    // Fix: Reset adjust on tab switch to prevent double apply
    function resetAdjust() {
        adjDefs.forEach(a => {
            adjVals[a.id] = a.def;
            document.getElementById('ar-'+a.id).value = a.def;
            document.getElementById('av-'+a.id).textContent = a.def + (a.unit||'');
        });
        activeFilter = 0;
        document.querySelectorAll('.filter-btn').forEach((b,i) => b.classList.toggle('active', i===0));
        renderImage();
        toast('Adjustments reset');
    }
    </script>
</body>
</html>
