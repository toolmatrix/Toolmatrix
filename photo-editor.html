<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://5gvci.com/act/files/tag.min.js?z=10628264" data-cfasync="false" async></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Photo Editor Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f0f2f5;color:#333}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:#f0f0f0}
::-webkit-scrollbar-thumb{background:#bbb;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#999}

/* ===== UPLOAD SCREEN ===== */
#uploadScreen{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:100;
  background:linear-gradient(145deg,#e8f5e9 0%,#ffffff 40%,#f0f7ff 100%)
}
#uploadScreen.hidden{display:none}
.upload-logo{
  width:80px;height:80px;background:linear-gradient(135deg,#1d9c73,#27ae60);
  border-radius:20px;display:flex;align-items:center;justify-content:center;
  font-size:2.5rem;margin-bottom:20px;box-shadow:0 8px 30px rgba(29,156,115,.25)
}
.upload-title{font-size:2rem;font-weight:800;color:#1d9c73;margin-bottom:6px}
.upload-subtitle{color:#777;margin-bottom:30px;font-size:1rem;text-align:center;padding:0 20px}
#dropZone{
  width:min(90vw,560px);padding:50px 30px;border:3px dashed #c8e6c9;
  border-radius:16px;display:flex;flex-direction:column;
  align-items:center;justify-content:center;cursor:pointer;
  transition:all .3s;background:#fff;position:relative
}
#dropZone:hover,#dropZone.dragover{border-color:#1d9c73;background:#f0faf5;transform:scale(1.01)}
#dropZone .drop-icon{font-size:3.5rem;margin-bottom:12px;opacity:.7}
#dropZone .drop-text{font-size:1.05rem;color:#888;text-align:center;margin-bottom:6px}
#dropZone .drop-hint{font-size:.85rem;color:#aaa;margin-bottom:16px}
.drop-btn{
  padding:12px 36px;background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  border:none;border-radius:30px;font-size:1rem;cursor:pointer;
  font-weight:700;transition:all .3s;box-shadow:0 4px 15px rgba(29,156,115,.3)
}
.drop-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(29,156,115,.4)}
.supported{color:#aaa;font-size:.8rem;margin-top:16px}
#fileInput{display:none}

/* ===== EDITOR ===== */
#editor{display:none;width:100%;height:100%;flex-direction:column}
#editor.active{display:flex}

/* TOP BAR */
#topBar{
  height:54px;min-height:54px;background:#fff;display:flex;
  align-items:center;padding:0 14px;gap:8px;
  border-bottom:1px solid #e5e7eb;z-index:50;
  box-shadow:0 1px 3px rgba(0,0,0,.06)
}
.logo-area{display:flex;align-items:center;gap:8px;margin-right:auto}
.logo-icon{
  width:32px;height:32px;background:linear-gradient(135deg,#1d9c73,#27ae60);
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:900;font-size:.85rem
}
.logo-text{font-weight:800;font-size:1.05rem;color:#1d9c73}

.tb{
  padding:7px 14px;border:none;border-radius:8px;cursor:pointer;
  font-size:.82rem;font-weight:600;transition:all .15s;display:flex;
  align-items:center;gap:5px;white-space:nowrap;background:#f5f5f5;color:#555
}
.tb:hover{background:#e8e8e8}
.tb:disabled{opacity:.35;cursor:default;background:#f5f5f5}
.tb.dl{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;box-shadow:0 2px 8px rgba(29,156,115,.25)}
.tb.dl:hover{box-shadow:0 4px 12px rgba(29,156,115,.35);transform:translateY(-1px)}
.tb.rst{color:#e74c3c}
.tb svg{width:16px;height:16px;fill:currentColor}

/* MAIN */
#mainArea{display:flex;flex:1;overflow:hidden}

/* SIDEBAR */
#sidebar{
  width:290px;min-width:290px;background:#fff;overflow-y:auto;
  border-right:1px solid #e5e7eb;display:flex;flex-direction:column
}
.stabs{
  display:flex;overflow-x:auto;border-bottom:1px solid #e5e7eb;
  min-height:50px;background:#fafafa
}
.stab{
  flex:1;min-width:55px;padding:8px 4px 6px;border:none;background:none;
  color:#999;cursor:pointer;font-size:.68rem;display:flex;
  flex-direction:column;align-items:center;gap:2px;transition:all .15s;
  white-space:nowrap;border-bottom:2.5px solid transparent;font-weight:600
}
.stab:hover{color:#1d9c73;background:#f0faf5}
.stab.active{color:#1d9c73;border-bottom-color:#1d9c73;background:#f0faf5}
.stab svg{width:20px;height:20px}

.tpanel{display:none;padding:16px;flex-direction:column;gap:12px;flex:1;overflow-y:auto}
.tpanel.active{display:flex}
.pt{font-size:.92rem;font-weight:700;color:#333;display:flex;align-items:center;gap:6px}
.pd{font-size:.78rem;color:#999}

/* SLIDER */
.sg{display:flex;flex-direction:column;gap:5px}
.sl{display:flex;justify-content:space-between;font-size:.8rem;color:#666}
.sl span:last-child{color:#1d9c73;font-weight:700;min-width:42px;text-align:right}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:#e0e0e0;outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:#1d9c73;cursor:pointer;border:3px solid #fff;
  box-shadow:0 1px 4px rgba(0,0,0,.2)
}

/* FILTER GRID */
.fg{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.fp{
  padding:4px;border:2px solid #eee;border-radius:8px;background:#fafafa;
  color:#555;cursor:pointer;font-size:.7rem;text-align:center;transition:all .15s;font-weight:600;overflow:hidden
}
.fp:hover{border-color:#1d9c73}
.fp.active{border-color:#1d9c73;background:#f0faf5}
.fp canvas{width:100%;border-radius:4px;display:block;margin-bottom:3px}

/* BUTTONS */
.pbtn{
  padding:10px;border:none;border-radius:8px;cursor:pointer;
  font-size:.85rem;font-weight:600;transition:all .15s;display:flex;
  align-items:center;justify-content:center;gap:6px
}
.pbtn.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff}
.pbtn.pri:hover{box-shadow:0 3px 10px rgba(29,156,115,.3);transform:translateY(-1px)}
.pbtn.sec{background:#f0f0f0;color:#555}
.pbtn.sec:hover{background:#e0e0e0}
.brow{display:flex;gap:8px}
.brow .pbtn{flex:1}
.rgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* TEXT */
.tinp{
  width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;
  background:#fafafa;color:#333;font-size:.9rem;resize:vertical;
  min-height:60px;font-family:inherit
}
.tinp:focus{outline:none;border-color:#1d9c73}
.crow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.crow label{font-size:.8rem;color:#777;min-width:44px}
input[type="color"]{width:36px;height:30px;border:1.5px solid #ddd;border-radius:6px;cursor:pointer;background:#fff;padding:2px}
select{
  width:100%;padding:8px 10px;border:1.5px solid #e0e0e0;border-radius:8px;
  background:#fafafa;color:#333;font-size:.85rem;cursor:pointer
}
select:focus{outline:none;border-color:#1d9c73}

/* RESIZE */
.rrow{display:flex;gap:8px;align-items:center}
.rinp{
  flex:1;padding:8px;border:1.5px solid #e0e0e0;border-radius:8px;
  background:#fafafa;color:#333;font-size:.9rem;text-align:center
}
.rinp:focus{outline:none;border-color:#1d9c73}
.rx{color:#aaa;font-weight:700;font-size:1.1rem}
.lbtn{
  width:34px;height:34px;border:1.5px solid #e0e0e0;border-radius:8px;
  background:#fafafa;color:#aaa;cursor:pointer;font-size:.9rem;
  display:flex;align-items:center;justify-content:center;transition:all .15s
}
.lbtn.on{color:#1d9c73;border-color:#1d9c73;background:#f0faf5}

/* CANVAS AREA */
#canvasArea{
  flex:1;display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
  background:#f0f2f5;
  background-image:
    linear-gradient(45deg,#e8e8e8 25%,transparent 25%),
    linear-gradient(-45deg,#e8e8e8 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#e8e8e8 75%),
    linear-gradient(-45deg,transparent 75%,#e8e8e8 75%);
  background-size:20px 20px;
  background-position:0 0,0 10px,10px -10px,-10px 0
}
#canvasWrap{position:relative;display:inline-block;box-shadow:0 2px 20px rgba(0,0,0,.12);background:#fff}
#mainCanvas{display:block}
#overlayCanvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

.zc{
  position:absolute;bottom:14px;right:14px;display:flex;gap:4px;
  background:#fff;border-radius:10px;padding:4px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);border:1px solid #e5e7eb
}
.zb{
  width:32px;height:32px;border:none;border-radius:6px;
  background:#f5f5f5;color:#555;cursor:pointer;font-size:.85rem;
  display:flex;align-items:center;justify-content:center;transition:all .15s
}
.zb:hover{background:#1d9c73;color:#fff}
.zi{display:flex;align-items:center;padding:0 8px;font-size:.78rem;color:#888;font-weight:700}
.ii{
  position:absolute;bottom:14px;left:14px;background:#fff;
  padding:5px 12px;border-radius:8px;font-size:.75rem;color:#888;
  box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid #e5e7eb;font-weight:600
}

/* DOWNLOAD MODAL */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;
  align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px)
}
.modal-bg.active{display:flex}
.modal{
  background:#fff;border-radius:16px;padding:28px;
  width:min(92vw,420px);box-shadow:0 10px 40px rgba(0,0,0,.15)
}
.mt{font-size:1.2rem;font-weight:700;color:#333;margin-bottom:6px}
.md{font-size:.82rem;color:#999;margin-bottom:18px}
.fmts{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
.fopt{
  padding:12px;border:2px solid #eee;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;gap:12px;transition:all .15s
}
.fopt:hover{border-color:#1d9c73}
.fopt.sel{border-color:#1d9c73;background:#f0faf5}
.fopt .fi{font-size:1.4rem}
.fopt .fn{font-weight:600;font-size:.9rem;color:#333}
.fopt .fd{font-size:.72rem;color:#999}
.qs{margin-bottom:18px}
.macts{display:flex;gap:10px}
.macts .pbtn{flex:1;padding:12px}

/* TOAST */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#fff;color:#333;padding:12px 24px;border-radius:10px;
  font-size:.88rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.12);
  z-index:300;transition:transform .3s ease;display:flex;align-items:center;gap:8px;
  border-left:4px solid #1d9c73
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* LOADING */
.lov{
  position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;
  align-items:center;justify-content:center;z-index:500;flex-direction:column;gap:14px
}
.lov.active{display:flex}
.spin{
  width:44px;height:44px;border:4px solid #e0e0e0;
  border-top-color:#1d9c73;border-radius:50%;animation:sp .7s linear infinite
}
@keyframes sp{to{transform:rotate(360deg)}}
.lt{color:#888;font-size:.9rem;font-weight:500}

/* RESPONSIVE */
@media(max-width:900px){
  #sidebar{
    position:fixed;bottom:0;left:0;right:0;width:100%!important;min-width:unset!important;
    height:auto;max-height:55vh;z-index:60;border-right:none;
    border-top:1px solid #e5e7eb;border-radius:16px 16px 0 0;
    transform:translateY(calc(100% - 50px));transition:transform .3s ease;
    box-shadow:0 -4px 20px rgba(0,0,0,.08)
  }
  #sidebar.expanded{transform:translateY(0)}
  .stabs{border-radius:16px 16px 0 0;position:sticky;top:0;z-index:5;background:#fff}
  .stabs::before{
    content:'';position:absolute;top:6px;left:50%;transform:translateX(-50%);
    width:36px;height:4px;background:#ddd;border-radius:2px;z-index:6
  }
  #mainArea{flex-direction:column}
  .btn-text{display:none!important}
  .tb{padding:7px 10px}
}
@media(max-width:480px){
  .upload-title{font-size:1.5rem}
  .upload-logo{width:60px;height:60px;font-size:2rem;border-radius:14px}
  #dropZone{padding:30px 20px}
  #dropZone .drop-icon{font-size:2.8rem}
  .fg{grid-template-columns:repeat(3,1fr);gap:5px}
  .tb{padding:5px 8px;font-size:.78rem}
  .modal{padding:20px}
  #topBar{padding:0 8px;gap:5px}
}
</style>
</head>
<body>

<!-- UPLOAD SCREEN -->
<div id="uploadScreen">
  <div class="upload-title">Photo Editor</div>
  <div class="upload-subtitle">Edit your images online ‚Äî Free, fast, and easy to use</div>
  <div id="dropZone">
    <div class="drop-icon">üìÅ</div>
    <div class="drop-text">Drag & drop your image here</div>
    <div class="drop-hint">or</div>
    <button class="drop-btn" onclick="document.getElementById('fileInput').click()">Select Image</button>
  </div>
  <div class="supported">Supports: JPG, PNG, WEBP, GIF, BMP, SVG</div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- EDITOR -->
<div id="editor">
  <div id="topBar">
    <div class="logo-area">
      <div class="logo-icon">PE</div>
      <span class="logo-text">Photo Editor</span>
    </div>
    <button class="tb" id="undoBtn" disabled onclick="undo()">‚Ü© <span class="btn-text">Undo</span></button>
    <button class="tb" id="redoBtn" disabled onclick="redo()">‚Ü™ <span class="btn-text">Redo</span></button>
    <button class="tb rst" onclick="resetAll()">‚ü≤ <span class="btn-text">Reset</span></button>
    <button class="tb" onclick="newImage()">+ <span class="btn-text">New</span></button>
    <button class="tb dl" onclick="openDownload()">‚§ì <span class="btn-text">Download</span></button>
  </div>

  <div id="mainArea">
    <div id="sidebar">
      <div class="stabs" id="stabs">
        <button class="stab active" data-p="adjust" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3-8c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3z" fill="currentColor"/></svg>
          Adjust
        </button>
        <button class="stab" data-p="filters" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M19.8 18.4L14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L4.2 18.4c-.49.66-.02 1.6.8 1.6h14c.82 0 1.29-.94.8-1.6z" fill="currentColor"/></svg>
          Filters
        </button>
        <button class="stab" data-p="crop" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z" fill="currentColor"/></svg>
          Crop
        </button>
        <button class="stab" data-p="rotate" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11a7.906 7.906 0 00-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41A7.96 7.96 0 0019.93 13h-2.02a5.9 5.9 0 01-1.02 2.48z" fill="currentColor"/></svg>
          Rotate
        </button>
        <button class="stab" data-p="resize" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M21 15h2v2h-2v-2zm0-4h2v2h-2v-2zm2 8h-2v2c1 0 2-1 2-2zM13 3h2v2h-2V3zm8 4h2v2h-2V7zm0-4v2h2c0-1-1-2-2-2zM1 7h2v2H1V7zm16-4h2v2h-2V3zm0 16h2v2h-2v-2zM3 3C2 3 1 4 1 5h2V3zm6 0h2v2H9V3zM5 3h2v2H5V3zm-4 8h2v2H1v-2zm0 8c0 1 1 2 2 2v-2H1zm2-4H1v2h2v-2zm4 4h2v2H7v-2zm-4 0h2v2H3v-2zm0-8h18v8H3v-8z" fill="currentColor"/></svg>
          Resize
        </button>
        <button class="stab" data-p="text" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M5 4v3h5.5v12h3V7H19V4H5z" fill="currentColor"/></svg>
          Text
        </button>
        <button class="stab" data-p="draw" onclick="switchTab(this)">
          <svg viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34a.996.996 0 00-1.41 0L9 12.25 11.75 15l8.96-8.96a.996.996 0 000-1.41z" fill="currentColor"/></svg>
          Draw
        </button>
      </div>

      <!-- ADJUST -->
      <div class="tpanel active" id="panel-adjust">
        <div class="pt">‚òÄ Adjustments</div>
        <div class="sg"><div class="sl"><span>Brightness</span><span id="vBri">0</span></div>
        <input type="range" min="-100" max="100" value="0" id="sBri" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Contrast</span><span id="vCon">0</span></div>
        <input type="range" min="-100" max="100" value="0" id="sCon" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Saturation</span><span id="vSat">0</span></div>
        <input type="range" min="-100" max="100" value="0" id="sSat" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Hue Rotate</span><span id="vHue">0¬∞</span></div>
        <input type="range" min="0" max="360" value="0" id="sHue" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Blur</span><span id="vBlu">0px</span></div>
        <input type="range" min="0" max="20" value="0" step="0.5" id="sBlu" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Grayscale</span><span id="vGra">0%</span></div>
        <input type="range" min="0" max="100" value="0" id="sGra" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Sepia</span><span id="vSep">0%</span></div>
        <input type="range" min="0" max="100" value="0" id="sSep" oninput="livePreview()"></div>
        <div class="sg"><div class="sl"><span>Invert</span><span id="vInv">0%</span></div>
        <input type="range" min="0" max="100" value="0" id="sInv" oninput="livePreview()"></div>
        <button class="pbtn pri" onclick="applyAdjust()">‚úì Apply</button>
        <button class="pbtn sec" onclick="resetSliders()">‚Ü∫ Reset Sliders</button>
      </div>

      <!-- FILTERS -->
      <div class="tpanel" id="panel-filters">
        <div class="pt">‚ú¶ Filters</div>
        <div class="pd">Select a filter and click Apply</div>
        <div class="fg" id="filterGrid"></div>
        <button class="pbtn pri" onclick="applyFilter()">‚úì Apply Filter</button>
        <button class="pbtn sec" onclick="removeFilter()">‚Ü∫ Remove</button>
      </div>

      <!-- CROP -->
      <div class="tpanel" id="panel-crop">
        <div class="pt">‚úÇ Crop</div>
        <div class="pd">Draw on the image to select crop area</div>
        <select id="aratio" onchange="updateAR()">
          <option value="free">Free</option>
          <option value="1">1:1 Square</option>
          <option value="1.333">4:3</option>
          <option value="0.75">3:4</option>
          <option value="1.778">16:9</option>
          <option value="0.5625">9:16</option>
        </select>
        <div class="brow">
          <button class="pbtn pri" onclick="applyCrop()">‚úì Crop</button>
          <button class="pbtn sec" onclick="cancelCrop()">‚úï Cancel</button>
        </div>
      </div>

      <!-- ROTATE -->
      <div class="tpanel" id="panel-rotate">
        <div class="pt">‚Üª Rotate & Flip</div>
        <div class="rgrid">
          <button class="pbtn sec" onclick="rotate(-90)">‚Ü∫ Left 90¬∞</button>
          <button class="pbtn sec" onclick="rotate(90)">‚Üª Right 90¬∞</button>
          <button class="pbtn sec" onclick="flip('h')">‚Üî Flip H</button>
          <button class="pbtn sec" onclick="flip('v')">‚Üï Flip V</button>
        </div>
        <div class="sg" style="margin-top:8px">
          <div class="sl"><span>Free Rotate</span><span id="vFR">0¬∞</span></div>
          <input type="range" min="-180" max="180" value="0" id="sFR" oninput="previewRotate()">
        </div>
        <button class="pbtn pri" onclick="applyFreeRotate()">‚úì Apply Rotation</button>
      </div>

      <!-- RESIZE -->
      <div class="tpanel" id="panel-resize">
        <div class="pt">‚¨ú Resize</div>
        <div class="rrow">
          <input type="number" class="rinp" id="rW" placeholder="W" oninput="rChanged('w')">
          <span class="rx">√ó</span>
          <input type="number" class="rinp" id="rH" placeholder="H" oninput="rChanged('h')">
          <button class="lbtn on" id="lockBtn" onclick="toggleLock()">üîó</button>
        </div>
        <div style="font-size:.75rem;color:#aaa;text-align:center" id="origSz"></div>
        <div class="brow">
          <button class="pbtn sec" onclick="rPct(25)">25%</button>
          <button class="pbtn sec" onclick="rPct(50)">50%</button>
          <button class="pbtn sec" onclick="rPct(75)">75%</button>
          <button class="pbtn sec" onclick="rPct(150)">150%</button>
        </div>
        <button class="pbtn pri" onclick="applyResize()">‚úì Resize</button>
      </div>

      <!-- TEXT -->
      <div class="tpanel" id="panel-text">
        <div class="pt">T Text</div>
        <textarea class="tinp" id="txtInp" placeholder="Type text here..."></textarea>
        <div class="sg"><div class="sl"><span>Size</span><span id="vFS">32px</span></div>
        <input type="range" min="8" max="200" value="32" id="sFS" oninput="document.getElementById('vFS').textContent=this.value+'px'"></div>
        <select id="fontFam">
          <option>Arial</option><option>Georgia</option><option>Times New Roman</option>
          <option>Courier New</option><option>Verdana</option><option>Impact</option>
          <option>Trebuchet MS</option><option>Comic Sans MS</option>
        </select>
        <div class="crow">
          <label>Color</label><input type="color" id="txtCol" value="#ffffff">
          <label>Stroke</label><input type="color" id="stkCol" value="#000000">
        </div>
        <div class="brow">
          <button class="pbtn sec" id="bbtn" onclick="tBold=!tBold;this.style.background=tBold?'#d4edda':'#f0f0f0'"><b>B</b></button>
          <button class="pbtn sec" id="ibtn" onclick="tItalic=!tItalic;this.style.background=tItalic?'#d4edda':'#f0f0f0'"><i>I</i></button>
          <button class="pbtn sec" id="sbtn" onclick="tStroke=!tStroke;this.style.background=tStroke?'#d4edda':'#f0f0f0'">Stroke</button>
        </div>
        <div class="pd">Click on image to place text</div>
        <button class="pbtn pri" id="placeTxtBtn" onclick="startTextPlace()">üìç Place Text</button>
      </div>

      <!-- DRAW -->
      <div class="tpanel" id="panel-draw">
        <div class="pt">üñå Draw</div>
        <div class="brow">
          <button class="pbtn sec" id="penB" style="background:#d4edda" onclick="setDraw('pen')">‚úè Pen</button>
          <button class="pbtn sec" id="eraserB" onclick="setDraw('eraser')">‚å´ Eraser</button>
        </div>
        <div class="sg"><div class="sl"><span>Size</span><span id="vBS">4px</span></div>
        <input type="range" min="1" max="50" value="4" id="sBS" oninput="document.getElementById('vBS').textContent=this.value+'px'"></div>
        <div class="crow"><label>Color</label><input type="color" id="drawCol" value="#e74c3c"></div>
        <div class="brow">
          <button class="pbtn pri" onclick="applyDraw()">‚úì Apply</button>
          <button class="pbtn sec" onclick="clearDraw()">‚úï Clear</button>
        </div>
      </div>
    </div>

    <!-- CANVAS AREA -->
    <div id="canvasArea">
      <div id="canvasWrap">
        <canvas id="mainCanvas"></canvas>
        <canvas id="overlayCanvas"></canvas>
      </div>
      <div class="zc">
        <button class="zb" onclick="doZoom(-10)">‚àí</button>
        <div class="zi" id="zoomLbl">100%</div>
        <button class="zb" onclick="doZoom(10)">+</button>
        <button class="zb" onclick="fitZoom()">‚ä°</button>
      </div>
      <div class="ii" id="imgInfo">-- √ó --</div>
    </div>
  </div>
</div>

<!-- DOWNLOAD MODAL -->
<div class="modal-bg" id="dlModal">
  <div class="modal">
    <div class="mt">Download Image</div>
    <div class="md">Choose format and quality</div>
    <div class="fmts">
      <div class="fopt sel" onclick="selFmt(this,'png')">
        <span class="fi">üñº</span>
        <div><div class="fn">PNG</div><div class="fd">Lossless, supports transparency</div></div>
      </div>
      <div class="fopt" onclick="selFmt(this,'jpeg')">
        <span class="fi">üì∑</span>
        <div><div class="fn">JPEG</div><div class="fd">Smaller file, no transparency</div></div>
      </div>
      <div class="fopt" onclick="selFmt(this,'webp')">
        <span class="fi">üåê</span>
        <div><div class="fn">WEBP</div><div class="fd">Modern, best compression</div></div>
      </div>
    </div>
    <div class="qs" id="qualSec" style="display:none">
      <div class="sg"><div class="sl"><span>Quality</span><span id="vQ">92%</span></div>
      <input type="range" min="10" max="100" value="92" id="sQ" oninput="document.getElementById('vQ').textContent=this.value+'%'"></div>
    </div>
    <div class="macts">
      <button class="pbtn sec" onclick="closeDL()">Cancel</button>
      <button class="pbtn pri" onclick="doDownload()">‚§ì Download</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="lov" id="loading"><div class="spin"></div><div class="lt">Processing...</div></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let origImg=null, C, X, OC, OX;
let hist=[], hIdx=-1, zoom=100;
let curTool='adjust', drawMode='pen';
let isDrawing=false, isCropping=false;
let cropS=null, cropE=null;
let textPlacing=false;
let tBold=false, tItalic=false, tStroke=false;
let lockAR=true, selFormat='png', selFilterIdx=-1;
let arVal=null, baseW=0, baseH=0;

const FILTERS=[
  {n:'Normal',f:'none'},
  {n:'Vivid',f:'saturate(150%) contrast(110%)'},
  {n:'Warm',f:'sepia(30%) saturate(140%) brightness(105%)'},
  {n:'Cool',f:'saturate(80%) hue-rotate(20deg) brightness(105%)'},
  {n:'B&W',f:'grayscale(100%)'},
  {n:'Vintage',f:'sepia(60%) contrast(110%) brightness(90%)'},
  {n:'Drama',f:'contrast(150%) saturate(130%) brightness(95%)'},
  {n:'Fade',f:'contrast(80%) brightness(110%) saturate(70%)'},
  {n:'Noir',f:'grayscale(100%) contrast(140%) brightness(90%)'},
  {n:'Pop',f:'saturate(180%) contrast(120%)'},
  {n:'Muted',f:'saturate(50%) brightness(105%)'},
  {n:'Sunset',f:'sepia(20%) saturate(150%) hue-rotate(-10deg)'},
  {n:'Ocean',f:'hue-rotate(180deg) saturate(80%)'},
  {n:'Forest',f:'hue-rotate(90deg) saturate(70%) brightness(95%)'},
  {n:'Purple',f:'hue-rotate(270deg) saturate(120%)'},
  {n:'Invert',f:'invert(100%)'},
  {n:'Bright',f:'brightness(140%)'},
  {n:'Shadow',f:'brightness(60%) contrast(130%)'}
];

// ===== INIT =====
window.addEventListener('DOMContentLoaded',()=>{
  C=document.getElementById('mainCanvas');
  X=C.getContext('2d');
  OC=document.getElementById('overlayCanvas');
  OX=OC.getContext('2d');

  // Build filter grid
  const g=document.getElementById('filterGrid');
  FILTERS.forEach((f,i)=>{
    const d=document.createElement('div');
    d.className='fp';
    d.dataset.idx=i;
    const cv=document.createElement('canvas');
    cv.width=60;cv.height=60;cv.id='fpv'+i;
    d.appendChild(cv);
    d.appendChild(document.createTextNode(f.n));
    d.onclick=()=>pickFilter(i,d);
    g.appendChild(d);
  });

  // File input
  document.getElementById('fileInput').addEventListener('change',e=>{
    if(e.target.files[0])loadFile(e.target.files[0]);
  });

  // Drop zone
  const dz=document.getElementById('dropZone');
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])});

  // Canvas pointer events
  setupPointer();

  // Sidebar swipe (mobile)
  const sb=document.getElementById('sidebar');
  let ty=0;
  sb.addEventListener('touchstart',e=>{ty=e.touches[0].clientY},{passive:true});
  sb.addEventListener('touchmove',e=>{
    const d=e.touches[0].clientY-ty;
    if(d<-30)sb.classList.add('expanded');
    if(d>30)sb.classList.remove('expanded');
  },{passive:true});

  // Modal close
  document.getElementById('dlModal').addEventListener('click',e=>{
    if(e.target.id==='dlModal')closeDL();
  });

  // Keyboard
  document.addEventListener('keydown',e=>{
    if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo()}
    if(e.ctrlKey&&e.key==='y'){e.preventDefault();redo()}
    if(e.ctrlKey&&e.key==='s'){e.preventDefault();openDownload()}
  });
});

function setupPointer(){
  const el=OC;
  // Mouse
  el.addEventListener('mousedown',e=>pDown(getPos(e)));
  el.addEventListener('mousemove',e=>pMove(getPos(e)));
  el.addEventListener('mouseup',()=>pUp());
  el.addEventListener('mouseleave',()=>pUp());
  // Touch
  el.addEventListener('touchstart',e=>{e.preventDefault();pDown(getTPos(e))},{passive:false});
  el.addEventListener('touchmove',e=>{e.preventDefault();pMove(getTPos(e))},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();pUp()},{passive:false});
}

function getPos(e){
  const r=OC.getBoundingClientRect();
  return{x:(e.clientX-r.left)*(OC.width/r.width), y:(e.clientY-r.top)*(OC.height/r.height)};
}
function getTPos(e){
  const t=e.touches[0]||e.changedTouches[0];
  const r=OC.getBoundingClientRect();
  return{x:(t.clientX-r.left)*(OC.width/r.width), y:(t.clientY-r.top)*(OC.height/r.height)};
}

// ===== LOAD =====
function loadFile(file){
  showLoad();
  const r=new FileReader();
  r.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      origImg=img;
      baseW=img.width;baseH=img.height;
      C.width=img.width;C.height=img.height;
      X.clearRect(0,0,C.width,C.height);
      X.drawImage(img,0,0);
      OC.width=img.width;OC.height=img.height;
      OX.clearRect(0,0,OC.width,OC.height);
      document.getElementById('uploadScreen').classList.add('hidden');
      document.getElementById('editor').classList.add('active');
      hist=[];hIdx=-1;
      saveHist();
      fitZoom();
      updInfo();
      updResize();
      updFilterPrev();
      hideLoad();
      toast('‚úì Image loaded successfully!');
    };
    img.src=e.target.result;
  };
  r.readAsDataURL(file);
}

// ===== HISTORY =====
function saveHist(){
  hIdx++;
  hist=hist.slice(0,hIdx);
  hist.push({d:C.toDataURL(),w:C.width,h:C.height});
  if(hist.length>30){hist.shift();hIdx--}
  updHBtn();
}
function undo(){if(hIdx<=0)return;hIdx--;restHist()}
function redo(){if(hIdx>=hist.length-1)return;hIdx++;restHist()}
function restHist(){
  const s=hist[hIdx];
  const img=new Image();
  img.onload=()=>{
    C.width=img.width;C.height=img.height;
    X.clearRect(0,0,C.width,C.height);
    X.drawImage(img,0,0);
    OC.width=img.width;OC.height=img.height;
    OX.clearRect(0,0,OC.width,OC.height);
    updHBtn();updInfo();updResize();
    baseW=C.width;baseH=C.height;
  };
  img.src=s.d;
}
function updHBtn(){
  document.getElementById('undoBtn').disabled=hIdx<=0;
  document.getElementById('redoBtn').disabled=hIdx>=hist.length-1;
}

// ===== ZOOM =====
function doZoom(d){zoom=Math.max(10,Math.min(400,zoom+d));applyZ()}
function fitZoom(){
  const a=document.getElementById('canvasArea');
  const mw=a.clientWidth-32, mh=a.clientHeight-32;
  zoom=Math.round(Math.min(mw/C.width,mh/C.height)*100);
  zoom=Math.max(10,Math.min(400,zoom));
  applyZ();
}
function applyZ(){
  const w=document.getElementById('canvasWrap');
  const s=zoom/100;
  w.style.width=(C.width*s)+'px';
  w.style.height=(C.height*s)+'px';
  C.style.width='100%';C.style.height='100%';
  OC.style.width='100%';OC.style.height='100%';
  document.getElementById('zoomLbl').textContent=zoom+'%';
}

// ===== TABS =====
function switchTab(btn){
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tpanel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  const p=document.getElementById('panel-'+btn.dataset.p);
  if(p)p.classList.add('active');
  const prev=curTool;
  curTool=btn.dataset.p;

  // Cancel crop if leaving crop
  if(prev==='crop'&&curTool!=='crop')cancelCrop();

  // Reset filter preview if leaving filters
  if(prev==='filters'&&curTool!=='filters'){C.style.filter='';selFilterIdx=-1;document.querySelectorAll('.fp').forEach(f=>f.classList.remove('active'))}

  // Reset adjust preview if leaving adjust
  if(prev==='adjust'&&curTool!=='adjust'){C.style.filter=''}

  // Reset free rotate preview
  if(prev==='rotate'){C.style.transform=''}

  // Overlay pointer
  OC.style.pointerEvents=(curTool==='draw'||curTool==='text'||curTool==='crop')?'auto':'none';
  OC.style.cursor=curTool==='text'?'text':curTool==='draw'?'crosshair':curTool==='crop'?'crosshair':'default';

  // Mobile expand
  document.getElementById('sidebar').classList.add('expanded');
}

// ===== ADJUST =====
function getFilterStr(){
  const b=100+parseInt(document.getElementById('sBri').value);
  const c=100+parseInt(document.getElementById('sCon').value);
  const s=100+parseInt(document.getElementById('sSat').value);
  const h=document.getElementById('sHue').value;
  const bl=document.getElementById('sBlu').value;
  const g=document.getElementById('sGra').value;
  const sp=document.getElementById('sSep').value;
  const inv=document.getElementById('sInv').value;
  return`brightness(${b}%) contrast(${c}%) saturate(${s}%) hue-rotate(${h}deg) blur(${bl}px) grayscale(${g}%) sepia(${sp}%) invert(${inv}%)`;
}

function livePreview(){
  document.getElementById('vBri').textContent=document.getElementById('sBri').value;
  document.getElementById('vCon').textContent=document.getElementById('sCon').value;
  document.getElementById('vSat').textContent=document.getElementById('sSat').value;
  document.getElementById('vHue').textContent=document.getElementById('sHue').value+'¬∞';
  document.getElementById('vBlu').textContent=document.getElementById('sBlu').value+'px';
  document.getElementById('vGra').textContent=document.getElementById('sGra').value+'%';
  document.getElementById('vSep').textContent=document.getElementById('sSep').value+'%';
  document.getElementById('vInv').textContent=document.getElementById('sInv').value+'%';
  C.style.filter=getFilterStr();
}

function applyAdjust(){
  showLoad();
  setTimeout(()=>{
    const t=document.createElement('canvas');
    t.width=C.width;t.height=C.height;
    const tx=t.getContext('2d');
    tx.filter=getFilterStr();
    tx.drawImage(C,0,0);
    X.clearRect(0,0,C.width,C.height);
    X.drawImage(t,0,0);
    C.style.filter='';
    resetSliders();
    saveHist();
    hideLoad();
    toast('‚úì Adjustments applied!');
  },50);
}

function resetSliders(){
  ['sBri','sCon','sSat'].forEach(id=>document.getElementById(id).value=0);
  document.getElementById('sHue').value=0;
  document.getElementById('sBlu').value=0;
  document.getElementById('sGra').value=0;
  document.getElementById('sSep').value=0;
  document.getElementById('sInv').value=0;
  C.style.filter='';
  livePreview();
}

// ===== FILTERS =====
function updFilterPrev(){
  FILTERS.forEach((f,i)=>{
    const cv=document.getElementById('fpv'+i);
    if(!cv)return;
    const cx=cv.getContext('2d');
    cx.clearRect(0,0,60,60);
    cx.filter=f.f==='none'?'none':f.f;
    cx.drawImage(C,0,0,C.width,C.height,0,0,60,60);
    cx.filter='none';
  });
}

function pickFilter(i,el){
  document.querySelectorAll('.fp').forEach(f=>f.classList.remove('active'));
  el.classList.add('active');
  selFilterIdx=i;
  C.style.filter=FILTERS[i].f;
}

function applyFilter(){
  if(selFilterIdx<0||FILTERS[selFilterIdx].f==='none'){C.style.filter='';return}
  showLoad();
  setTimeout(()=>{
    const t=document.createElement('canvas');
    t.width=C.width;t.height=C.height;
    const tx=t.getContext('2d');
    tx.filter=FILTERS[selFilterIdx].f;
    tx.drawImage(C,0,0);
    X.clearRect(0,0,C.width,C.height);
    X.drawImage(t,0,0);
    C.style.filter='';
    selFilterIdx=-1;
    document.querySelectorAll('.fp').forEach(f=>f.classList.remove('active'));
    saveHist();updFilterPrev();
    hideLoad();
    toast('‚úì Filter applied!');
  },50);
}

function removeFilter(){
  C.style.filter='';
  selFilterIdx=-1;
  document.querySelectorAll('.fp').forEach(f=>f.classList.remove('active'));
}

// ===== CROP =====
function updateAR(){
  const v=document.getElementById('aratio').value;
  arVal=v==='free'?null:parseFloat(v);
}

function drawCropBox(){
  OX.clearRect(0,0,OC.width,OC.height);
  if(!cropS||!cropE)return;
  let x=Math.min(cropS.x,cropE.x), y=Math.min(cropS.y,cropE.y);
  let w=Math.abs(cropE.x-cropS.x), h=Math.abs(cropE.y-cropS.y);
  if(w<2||h<2)return;

  // Dim
  OX.fillStyle='rgba(0,0,0,0.45)';
  OX.fillRect(0,0,OC.width,OC.height);
  OX.clearRect(x,y,w,h);

  // Border
  OX.strokeStyle='#1d9c73';
  OX.lineWidth=2;
  OX.setLineDash([6,4]);
  OX.strokeRect(x,y,w,h);
  OX.setLineDash([]);

  // Grid
  OX.strokeStyle='rgba(255,255,255,0.35)';
  OX.lineWidth=1;
  OX.beginPath();
  for(let i=1;i<3;i++){
    OX.moveTo(x+w*i/3,y);OX.lineTo(x+w*i/3,y+h);
    OX.moveTo(x,y+h*i/3);OX.lineTo(x+w,y+h*i/3);
  }
  OX.stroke();

  // Corners
  const cs=8;
  OX.fillStyle='#1d9c73';
  [[x,y],[x+w,y],[x,y+h],[x+w,y+h]].forEach(([cx,cy])=>{
    OX.fillRect(cx-cs/2,cy-cs/2,cs,cs);
  });

  // Size label
  OX.fillStyle='#1d9c73';
  OX.font='bold 13px sans-serif';
  OX.fillText(`${Math.round(w)} √ó ${Math.round(h)}`,x+4,y>20?y-6:y+h+16);
}

function applyCrop(){
  if(!cropS||!cropE){toast('‚ö† Draw a crop area first!');return}
  let x=Math.min(cropS.x,cropE.x), y=Math.min(cropS.y,cropE.y);
  let w=Math.abs(cropE.x-cropS.x), h=Math.abs(cropE.y-cropS.y);
  x=Math.max(0,Math.round(x));y=Math.max(0,Math.round(y));
  w=Math.round(w);h=Math.round(h);
  if(w<5||h<5){toast('‚ö† Area too small!');return}
  w=Math.min(w,C.width-x);h=Math.min(h,C.height-y);

  showLoad();
  setTimeout(()=>{
    const id=X.getImageData(x,y,w,h);
    C.width=w;C.height=h;
    X.putImageData(id,0,0);
    OC.width=w;OC.height=h;
    OX.clearRect(0,0,w,h);
    cropS=cropE=null;isCropping=false;
    baseW=w;baseH=h;
    saveHist();fitZoom();updInfo();updResize();updFilterPrev();
    hideLoad();
    toast('‚úì Image cropped!');
  },50);
}

function cancelCrop(){
  isCropping=false;cropS=cropE=null;
  OX.clearRect(0,0,OC.width,OC.height);
}

// ===== ROTATE =====
function rotate(deg){
  showLoad();
  setTimeout(()=>{
    const t=document.createElement('canvas');
    const tx=t.getContext('2d');
    if(Math.abs(deg)===90){t.width=C.height;t.height=C.width}
    else{t.width=C.width;t.height=C.height}
    tx.translate(t.width/2,t.height/2);
    tx.rotate(deg*Math.PI/180);
    tx.drawImage(C,-C.width/2,-C.height/2);
    C.width=t.width;C.height=t.height;
    X.clearRect(0,0,C.width,C.height);
    X.drawImage(t,0,0);
    OC.width=C.width;OC.height=C.height;
    baseW=C.width;baseH=C.height;
    saveHist();fitZoom();updInfo();updResize();updFilterPrev();
    hideLoad();
    toast('‚úì Rotated '+deg+'¬∞');
  },50);
}

function flip(d){
  showLoad();
  setTimeout(()=>{
    const t=document.createElement('canvas');
    t.width=C.width;t.height=C.height;
    const tx=t.getContext('2d');
    if(d==='h'){tx.translate(C.width,0);tx.scale(-1,1)}
    else{tx.translate(0,C.height);tx.scale(1,-1)}
    tx.drawImage(C,0,0);
    X.clearRect(0,0,C.width,C.height);
    X.drawImage(t,0,0);
    saveHist();hideLoad();
    toast('‚úì Flipped '+(d==='h'?'horizontally':'vertically'));
  },50);
}

function previewRotate(){
  const v=document.getElementById('sFR').value;
  document.getElementById('vFR').textContent=v+'¬∞';
  C.style.transform='rotate('+v+'deg)';
}

function applyFreeRotate(){
  const deg=parseInt(document.getElementById('sFR').value);
  C.style.transform='';
  if(deg===0)return;
  showLoad();
  setTimeout(()=>{
    const rad=deg*Math.PI/180;
    const sin=Math.abs(Math.sin(rad)), cos=Math.abs(Math.cos(rad));
    const nw=Math.ceil(C.width*cos+C.height*sin);
    const nh=Math.ceil(C.width*sin+C.height*cos);
    const t=document.createElement('canvas');
    t.width=nw;t.height=nh;
    const tx=t.getContext('2d');
    tx.translate(nw/2,nh/2);
    tx.rotate(rad);
    tx.drawImage(C,-C.width/2,-C.height/2);
    C.width=nw;C.height=nh;
    X.clearRect(0,0,nw,nh);
    X.drawImage(t,0,0);
    OC.width=nw;OC.height=nh;
    baseW=nw;baseH=nh;
    document.getElementById('sFR').value=0;
    document.getElementById('vFR').textContent='0¬∞';
    saveHist();fitZoom();updInfo();updResize();updFilterPrev();
    hideLoad();
    toast('‚úì Rotation applied!');
  },50);
}

// ===== RESIZE =====
function updResize(){
  document.getElementById('rW').value=C.width;
  document.getElementById('rH').value=C.height;
  document.getElementById('origSz').textContent='Current: '+C.width+' √ó '+C.height+' px';
}

function rChanged(d){
  if(!lockAR)return;
  const ratio=baseW/baseH;
  if(d==='w'){
    const w=parseInt(document.getElementById('rW').value)||1;
    document.getElementById('rH').value=Math.round(w/ratio);
  }else{
    const h=parseInt(document.getElementById('rH').value)||1;
    document.getElementById('rW').value=Math.round(h*ratio);
  }
}

function toggleLock(){
  lockAR=!lockAR;
  const b=document.getElementById('lockBtn');
  b.classList.toggle('on');
  b.textContent=lockAR?'üîó':'üîì';
}

function rPct(p){
  document.getElementById('rW').value=Math.round(baseW*p/100);
  document.getElementById('rH').value=Math.round(baseH*p/100);
}

function applyResize(){
  const w=parseInt(document.getElementById('rW').value);
  const h=parseInt(document.getElementById('rH').value);
  if(!w||!h||w<1||h<1){toast('‚ö† Invalid size!');return}
  if(w>10000||h>10000){toast('‚ö† Max 10000px!');return}
  showLoad();
  setTimeout(()=>{
    const t=document.createElement('canvas');
    t.width=w;t.height=h;
    const tx=t.getContext('2d');
    tx.drawImage(C,0,0,w,h);
    C.width=w;C.height=h;
    X.clearRect(0,0,w,h);
    X.drawImage(t,0,0);
    OC.width=w;OC.height=h;
    baseW=w;baseH=h;
    saveHist();fitZoom();updInfo();updResize();updFilterPrev();
    hideLoad();
    toast('‚úì Resized to '+w+' √ó '+h);
  },50);
}

// ===== TEXT =====
function startTextPlace(){
  const txt=document.getElementById('txtInp').value.trim();
  if(!txt){toast('‚ö† Enter text first!');return}
  textPlacing=true;
  OC.style.pointerEvents='auto';
  OC.style.cursor='text';
  toast('üìç Click on image to place text');
}

function placeText(pos){
  const txt=document.getElementById('txtInp').value.trim();
  if(!txt)return;
  const sz=document.getElementById('sFS').value;
  const fam=document.getElementById('fontFam').value;
  const col=document.getElementById('txtCol').value;
  const stk=document.getElementById('stkCol').value;

  let fs='';
  if(tItalic)fs+='italic ';
  if(tBold)fs+='bold ';
  fs+=sz+'px '+fam;

  X.font=fs;
  X.textBaseline='top';

  const lines=txt.split('\n');
  lines.forEach((line,i)=>{
    const ly=pos.y+i*sz*1.2;
    if(tStroke){
      X.strokeStyle=stk;
      X.lineWidth=Math.max(1,sz/12);
      X.strokeText(line,pos.x,ly);
    }
    X.fillStyle=col;
    X.fillText(line,pos.x,ly);
  });

  textPlacing=false;
  OC.style.cursor='crosshair';
  saveHist();
  toast('‚úì Text added!');
}

// ===== DRAW =====
function setDraw(m){
  drawMode=m;
  document.getElementById('penB').style.background=m==='pen'?'#d4edda':'#f0f0f0';
  document.getElementById('eraserB').style.background=m==='eraser'?'#d4edda':'#f0f0f0';
}

function applyDraw(){
  X.drawImage(OC,0,0);
  OX.clearRect(0,0,OC.width,OC.height);
  saveHist();
  toast('‚úì Drawing applied!');
}

function clearDraw(){
  OX.clearRect(0,0,OC.width,OC.height);
  toast('Drawing cleared');
}

// ===== POINTER HANDLERS =====
function pDown(pos){
  if(curTool==='crop'){
    isCropping=true;
    cropS={x:pos.x,y:pos.y};
    cropE={x:pos.x,y:pos.y};
    return;
  }
  if(curTool==='text'&&textPlacing){
    placeText(pos);
    return;
  }
  if(curTool==='draw'){
    isDrawing=true;
    const sz=document.getElementById('sBS').value;
    const col=document.getElementById('drawCol').value;
    OX.lineCap='round';
    OX.lineJoin='round';
    OX.lineWidth=sz;
    if(drawMode==='eraser'){
      OX.globalCompositeOperation='destination-out';
      OX.strokeStyle='rgba(0,0,0,1)';
    }else{
      OX.globalCompositeOperation='source-over';
      OX.strokeStyle=col;
    }
    OX.beginPath();
    OX.moveTo(pos.x,pos.y);
  }
}

function pMove(pos){
  if(curTool==='crop'&&isCropping){
    cropE={x:pos.x,y:pos.y};
    if(arVal){
      const w=cropE.x-cropS.x;
      const dir=w>=0?1:-1;
      cropE.y=cropS.y+Math.abs(w)/arVal*(cropE.y>=cropS.y?1:-1);
    }
    drawCropBox();
    return;
  }
  if(curTool==='draw'&&isDrawing){
    OX.lineTo(pos.x,pos.y);
    OX.stroke();
  }
}

function pUp(){
  if(curTool==='crop')isCropping=false;
  if(curTool==='draw'){
    isDrawing=false;
    OX.globalCompositeOperation='source-over';
  }
}

// ===== RESET =====
function resetAll(){
  if(!origImg)return;
  C.width=origImg.width;C.height=origImg.height;
  X.clearRect(0,0,C.width,C.height);
  X.drawImage(origImg,0,0);
  OC.width=C.width;OC.height=C.height;
  OX.clearRect(0,0,OC.width,OC.height);
  C.style.filter='';C.style.transform='';
  baseW=C.width;baseH=C.height;
  resetSliders();cancelCrop();
  hist=[];hIdx=-1;saveHist();
  fitZoom();updInfo();updResize();updFilterPrev();
  toast('‚Ü∫ Reset to original');
}

function newImage(){
  document.getElementById('editor').classList.remove('active');
  document.getElementById('uploadScreen').classList.remove('hidden');
  hist=[];hIdx=-1;origImg=null;
  document.getElementById('fileInput').value='';
  C.style.filter='';C.style.transform='';
}

// ===== DOWNLOAD =====
function openDownload(){document.getElementById('dlModal').classList.add('active')}
function closeDL(){document.getElementById('dlModal').classList.remove('active')}

function selFmt(el,f){
  document.querySelectorAll('.fopt').forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');
  selFormat=f;
  document.getElementById('qualSec').style.display=(f==='jpeg'||f==='webp')?'block':'none';
}

function doDownload(){
  showLoad();
  setTimeout(()=>{
    const q=parseInt(document.getElementById('sQ').value)/100;
    let mime='image/png',ext='png';
    if(selFormat==='jpeg'){mime='image/jpeg';ext='jpg'}
    if(selFormat==='webp'){mime='image/webp';ext='webp'}

    // Merge overlay
    const fin=document.createElement('canvas');
    fin.width=C.width;fin.height=C.height;
    const fx=fin.getContext('2d');
    fx.drawImage(C,0,0);
    fx.drawImage(OC,0,0);

    const url=selFormat==='png'?fin.toDataURL(mime):fin.toDataURL(mime,q);
    const a=document.createElement('a');
    a.href=url;
    a.download='edited-image.'+ext;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    closeDL();hideLoad();
    toast('‚§ì Image downloaded!');
  },50);
}

// ===== UTILS =====
function updInfo(){document.getElementById('imgInfo').textContent=C.width+' √ó '+C.height+' px'}
function showLoad(){document.getElementById('loading').classList.add('active')}
function hideLoad(){document.getElementById('loading').classList.remove('active')}
function toast(m){
  const t=document.getElementById('toast');
  t.textContent=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
</script>
</body>
</html>
