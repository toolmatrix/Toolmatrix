<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProEdit - Professional Photo Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --accent-hover: #ff6b81;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2a2a4a;
            --panel-bg: #1e1e3a;
            --input-bg: #252545;
            --success: #00d2d3;
            --warning: #feca57;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Top Menubar */
        .menubar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #0f0f23, #1a1a3e);
            padding: 0 20px;
            height: 50px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .logo svg {
            width: 30px;
            height: 30px;
        }

        .logo span {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu-items {
            display: flex;
            gap: 5px;
        }

        .menu-item {
            position: relative;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        .menu-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 7px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #c73e54);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-hover), var(--accent));
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* Left Toolbar */
        .toolbar {
            width: 55px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 4px;
            overflow-y: auto;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .tool-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .tool-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 10px rgba(233, 69, 96, 0.4);
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
        }

        .tool-separator {
            width: 30px;
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .tool-btn .tooltip {
            display: none;
            position: absolute;
            left: 50px;
            background: #333;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 999;
        }

        .tool-btn:hover .tooltip {
            display: block;
        }

        /* Left Panel */
        .left-panel {
            width: 260px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: none;
        }

        .left-panel.active {
            display: block;
        }

        .panel-header {
            padding: 15px;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-close {
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .panel-content {
            padding: 15px;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111125;
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #1a1a35 25%, transparent 25%), 
                linear-gradient(-45deg, #1a1a35 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1a1a35 75%), 
                linear-gradient(-45deg, transparent 75%, #1a1a35 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #mainCanvas {
            display: block;
            cursor: crosshair;
        }

        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 60px;
            border: 2px dashed var(--border);
            border-radius: 20px;
            background: rgba(30, 30, 58, 0.5);
            backdrop-filter: blur(10px);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.05);
        }

        .upload-area svg {
            width: 80px;
            height: 80px;
            color: var(--accent);
        }

        .upload-area h3 {
            font-size: 20px;
            font-weight: 600;
        }

        .upload-area p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Right Panel */
        .right-panel {
            width: 300px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .right-panel::-webkit-scrollbar {
            width: 6px;
        }

        .right-panel::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .section {
            border-bottom: 1px solid var(--border);
        }

        .section-header {
            padding: 12px 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .section-header:hover {
            background: rgba(255,255,255,0.03);
        }

        .section-header .arrow {
            transition: transform 0.3s;
            font-size: 10px;
        }

        .section-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .section-body {
            padding: 0 15px 15px;
        }

        .section-body.hidden {
            display: none;
        }

        /* Controls */
        .control-group {
            margin-bottom: 12px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .control-value {
            color: var(--accent);
            font-weight: 600;
            font-size: 11px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--input-bg);
            border-radius: 2px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type="color"] {
            width: 100%;
            height: 35px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            background: var(--input-bg);
            padding: 3px;
        }

        select {
            width: 100%;
            padding: 8px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Filter Grid */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .filter-item {
            background: var(--input-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-item:hover {
            border-color: var(--accent);
        }

        .filter-item.active {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .filter-preview {
            width: 100%;
            height: 40px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        /* Action Buttons */
        .action-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .action-btn {
            padding: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-family: 'Inter', sans-serif;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .action-btn.full {
            grid-column: span 2;
        }

        /* History */
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 10px;
            font-size: 11px;
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .history-item .h-num {
            color: var(--accent);
            font-weight: 600;
            min-width: 20px;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: var(--panel-bg);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 11px;
            color: var(--text-secondary);
            z-index: 10;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .zoom-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        /* Crop Overlay */
        .crop-overlay {
            position: absolute;
            border: 2px dashed var(--accent);
            background: rgba(233, 69, 96, 0.1);
            display: none;
            cursor: move;
            z-index: 50;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border: 1px solid white;
        }

        /* Text Overlay */
        .text-overlay {
            position: absolute;
            cursor: move;
            padding: 5px 10px;
            border: 1px dashed transparent;
            z-index: 40;
        }

        .text-overlay:hover {
            border-color: var(--accent);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal h3 {
            margin-bottom: 20px;
            font-size: 18px;
        }

        .modal-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .modal-field {
            flex: 1;
        }

        .modal-field label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Color swatches */
        .color-swatches {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
            border-color: white;
        }

        /* Tabs */
        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--bg-tertiary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 2000;
            display: none;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .right-panel { width: 250px; }
        }

        @media (max-width: 900px) {
            .right-panel { width: 220px; }
            .toolbar { width: 45px; }
        }

        .new-canvas-size {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .new-canvas-size input {
            width: 100px;
        }
    </style>
</head>
<body>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Top Menubar -->
    <div class="menubar">
        <div class="logo">
            <svg viewBox="0 0 30 30" fill="none">
                <rect width="30" height="30" rx="6" fill="url(#grad)"/>
                <path d="M8 22L15 8L22 22H8Z" fill="white" opacity="0.9"/>
                <circle cx="20" cy="10" r="3" fill="white" opacity="0.7"/>
                <defs><linearGradient id="grad" x1="0" y1="0" x2="30" y2="30">
                    <stop stop-color="#e94560"/><stop offset="1" stop-color="#c73e54"/>
                </linearGradient></defs>
            </svg>
            <span>ProEdit</span>
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="document.getElementById('fileInput').click()">üìÇ Open</div>
            <div class="menu-item" onclick="showNewCanvasModal()">üìÑ New</div>
            <div class="menu-item" onclick="saveImage('png')">üíæ Save PNG</div>
            <div class="menu-item" onclick="saveImage('jpeg')">üíæ Save JPG</div>
            <div class="menu-item" onclick="undo()">‚Ü© Undo</div>
            <div class="menu-item" onclick="redo()">‚Ü™ Redo</div>
            <div class="menu-item" onclick="resetAll()">üîÑ Reset</div>
        </div>
        <div class="menu-actions">
            <span id="imageDimensions" style="font-size:11px; color: var(--text-secondary);">No Image</span>
            <button class="btn btn-primary" onclick="saveImage('png')">
                ‚¨á Export
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Toolbar -->
        <div class="toolbar">
            <button class="tool-btn active" onclick="setTool('select')" id="tool-select" title="Select">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
                <span class="tooltip">Select (V)</span>
            </button>
            <button class="tool-btn" onclick="setTool('brush')" id="tool-brush" title="Brush">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                <span class="tooltip">Brush (B)</span>
            </button>
            <button class="tool-btn" onclick="setTool('eraser')" id="tool-eraser" title="Eraser">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l9-9 8 8-4 4z"/><path d="M6 11l8 8"/></svg>
                <span class="tooltip">Eraser (E)</span>
            </button>
            <button class="tool-btn" onclick="setTool('line')" id="tool-line" title="Line">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/></svg>
                <span class="tooltip">Line (L)</span>
            </button>
            <button class="tool-btn" onclick="setTool('rect')" id="tool-rect" title="Rectangle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                <span class="tooltip">Rectangle (R)</span>
            </button>
            <button class="tool-btn" onclick="setTool('circle')" id="tool-circle" title="Circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>
                <span class="tooltip">Circle (C)</span>
            </button>
            <div class="tool-separator"></div>
            <button class="tool-btn" onclick="setTool('text')" id="tool-text" title="Text">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                <span class="tooltip">Text (T)</span>
            </button>
            <button class="tool-btn" onclick="setTool('crop')" id="tool-crop" title="Crop">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.13 1L6 16a2 2 0 002 2h15"/><path d="M1 6.13L16 6a2 2 0 012 2v15"/></svg>
                <span class="tooltip">Crop (X)</span>
            </button>
            <button class="tool-btn" onclick="setTool('eyedropper')" id="tool-eyedropper" title="Eyedropper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22l1-1h3l9-9"/><path d="M3 21v-3l9-9"/><circle cx="17.5" cy="6.5" r="3.5"/></svg>
                <span class="tooltip">Eyedropper (I)</span>
            </button>
            <button class="tool-btn" onclick="setTool('fill')" id="tool-fill" title="Fill">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15a1.49 1.49 0 000 2.12l5.5 5.5a1.49 1.49 0 002.12 0l5.5-5.5a1.49 1.49 0 000-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5a2 2 0 104 0c0-1.33-2-3.5-2-3.5z"/></svg>
                <span class="tooltip">Fill Bucket (G)</span>
            </button>
            <div class="tool-separator"></div>
            <button class="tool-btn" onclick="setTool('move')" id="tool-move" title="Move">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
                <span class="tooltip">Move (M)</span>
            </button>
            <button class="tool-btn" onclick="setTool('zoom')" id="tool-zoom" title="Zoom">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                <span class="tooltip">Zoom (Z)</span>
            </button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area" id="canvasArea">
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <h3>Open an Image or Create New Canvas</h3>
                <p>Click to upload or drag & drop<br>Supports JPG, PNG, GIF, BMP, WebP</p>
                <button class="btn btn-primary" style="padding: 10px 24px; font-size: 14px;">Choose Image</button>
            </div>
            <div class="canvas-wrapper" id="canvasWrapper" style="display:none;">
                <canvas id="mainCanvas"></canvas>
                <canvas id="drawCanvas"></canvas>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            
            <!-- Bottom Bar -->
            <div class="bottom-bar">
                <div>
                    <span id="cursorPos">X: 0 Y: 0</span> &nbsp;|&nbsp;
                    <span id="imageSize">0 √ó 0</span>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="changeZoom(-10)">‚àí</button>
                    <span id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="changeZoom(10)">+</button>
                    <button class="zoom-btn" onclick="fitToScreen()">Fit</button>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Tab Bar -->
            <div class="tab-bar">
                <div class="tab active" onclick="switchTab('adjust')">Adjust</div>
                <div class="tab" onclick="switchTab('filters')">Filters</div>
                <div class="tab" onclick="switchTab('tools')">Tools</div>
            </div>

            <!-- Adjustments Tab -->
            <div id="tab-adjust">
                <!-- Adjustments -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        üé® Adjustments <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="control-group">
                            <div class="control-label">Brightness <span class="control-value" id="val-brightness">0</span></div>
                            <input type="range" min="-100" max="100" value="0" id="brightness" oninput="updateAdjustment('brightness', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Contrast <span class="control-value" id="val-contrast">0</span></div>
                            <input type="range" min="-100" max="100" value="0" id="contrast" oninput="updateAdjustment('contrast', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Saturation <span class="control-value" id="val-saturation">0</span></div>
                            <input type="range" min="-100" max="100" value="0" id="saturation" oninput="updateAdjustment('saturation', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Exposure <span class="control-value" id="val-exposure">0</span></div>
                            <input type="range" min="-100" max="100" value="0" id="exposure" oninput="updateAdjustment('exposure', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Hue Rotate <span class="control-value" id="val-hue">0¬∞</span></div>
                            <input type="range" min="0" max="360" value="0" id="hue" oninput="updateAdjustment('hue', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Blur <span class="control-value" id="val-blur">0</span></div>
                            <input type="range" min="0" max="20" value="0" id="blur" oninput="updateAdjustment('blur', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Sharpen <span class="control-value" id="val-sharpen">0</span></div>
                            <input type="range" min="0" max="100" value="0" id="sharpen" oninput="updateAdjustment('sharpen', this.value)">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Opacity <span class="control-value" id="val-opacity">100%</span></div>
                            <input type="range" min="0" max="100" value="100" id="opacity" oninput="updateAdjustment('opacity', this.value)">
                        </div>
                        <button class="action-btn full" onclick="resetAdjustments()" style="margin-top:8px;">üîÑ Reset Adjustments</button>
                    </div>
                </div>

                <!-- Transform -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        üîÑ Transform <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="action-btns">
                            <button class="action-btn" onclick="rotateImage(90)">‚Üª Rotate 90¬∞</button>
                            <button class="action-btn" onclick="rotateImage(-90)">‚Ü∫ Rotate -90¬∞</button>
                            <button class="action-btn" onclick="flipImage('h')">‚Üî Flip H</button>
                            <button class="action-btn" onclick="flipImage('v')">‚Üï Flip V</button>
                            <button class="action-btn" onclick="rotateImage(180)">üîÉ Rotate 180¬∞</button>
                            <button class="action-btn" onclick="showResizeModal()">üìê Resize</button>
                        </div>
                    </div>
                </div>

                <!-- Color -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        üé® Color Effects <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="action-btns">
                            <button class="action-btn" onclick="applyColorEffect('grayscale')">‚¨ú Grayscale</button>
                            <button class="action-btn" onclick="applyColorEffect('sepia')">üü´ Sepia</button>
                            <button class="action-btn" onclick="applyColorEffect('invert')">üîÑ Invert</button>
                            <button class="action-btn" onclick="applyColorEffect('threshold')">‚óº Threshold</button>
                            <button class="action-btn" onclick="applyColorEffect('posterize')">üé≠ Posterize</button>
                            <button class="action-btn" onclick="applyColorEffect('solarize')">‚òÄ Solarize</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Tab -->
            <div id="tab-filters" style="display:none;">
                <div class="section">
                    <div class="section-header">üéû Photo Filters</div>
                    <div class="section-body">
                        <div class="filter-grid">
                            <div class="filter-item" onclick="applyFilter('none')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                                None
                            </div>
                            <div class="filter-item" onclick="applyFilter('vintage')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #d4a574, #8b6914); filter: sepia(0.4);"></div>
                                Vintage
                            </div>
                            <div class="filter-item" onclick="applyFilter('cool')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                                Cool
                            </div>
                            <div class="filter-item" onclick="applyFilter('warm')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #fa709a, #fee140);"></div>
                                Warm
                            </div>
                            <div class="filter-item" onclick="applyFilter('dramatic')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #1a1a2e, #e94560);"></div>
                                Dramatic
                            </div>
                            <div class="filter-item" onclick="applyFilter('bw')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #333, #999);"></div>
                                B&W
                            </div>
                            <div class="filter-item" onclick="applyFilter('sunset')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div>
                                Sunset
                            </div>
                            <div class="filter-item" onclick="applyFilter('forest')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #11998e, #38ef7d);"></div>
                                Forest
                            </div>
                            <div class="filter-item" onclick="applyFilter('ocean')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #2193b0, #6dd5ed);"></div>
                                Ocean
                            </div>
                            <div class="filter-item" onclick="applyFilter('lomo')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #c94b4b, #4b134f);"></div>
                                Lomo
                            </div>
                            <div class="filter-item" onclick="applyFilter('cross')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #e1eec3, #f05053);"></div>
                                X-Process
                            </div>
                            <div class="filter-item" onclick="applyFilter('polaroid')">
                                <div class="filter-preview" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);"></div>
                                Polaroid
                            </div>
                        </div>
                        <div class="control-group" style="margin-top: 15px;">
                            <div class="control-label">Filter Intensity <span class="control-value" id="val-filterIntensity">100%</span></div>
                            <input type="range" min="0" max="100" value="100" id="filterIntensity" oninput="updateFilterIntensity(this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Tab -->
            <div id="tab-tools" style="display:none;">
                <!-- Brush Settings -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        üñå Brush Settings <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="control-group">
                            <div class="control-label">Size <span class="control-value" id="val-brushSize">5</span></div>
                            <input type="range" min="1" max="100" value="5" id="brushSize" oninput="document.getElementById('val-brushSize').textContent=this.value">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Hardness <span class="control-value" id="val-brushHardness">100%</span></div>
                            <input type="range" min="0" max="100" value="100" id="brushHardness" oninput="document.getElementById('val-brushHardness').textContent=this.value+'%'">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Opacity <span class="control-value" id="val-brushOpacity">100%</span></div>
                            <input type="range" min="1" max="100" value="100" id="brushOpacity" oninput="document.getElementById('val-brushOpacity').textContent=this.value+'%'">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Color</div>
                            <input type="color" id="brushColor" value="#e94560">
                            <div class="color-swatches">
                                <div class="color-swatch" style="background:#e94560" onclick="document.getElementById('brushColor').value='#e94560'"></div>
                                <div class="color-swatch" style="background:#ffffff" onclick="document.getElementById('brushColor').value='#ffffff'"></div>
                                <div class="color-swatch" style="background:#000000" onclick="document.getElementById('brushColor').value='#000000'"></div>
                                <div class="color-swatch" style="background:#ff6b6b" onclick="document.getElementById('brushColor').value='#ff6b6b'"></div>
                                <div class="color-swatch" style="background:#feca57" onclick="document.getElementById('brushColor').value='#feca57'"></div>
                                <div class="color-swatch" style="background:#48dbfb" onclick="document.getElementById('brushColor').value='#48dbfb'"></div>
                                <div class="color-swatch" style="background:#ff9ff3" onclick="document.getElementById('brushColor').value='#ff9ff3'"></div>
                                <div class="color-swatch" style="background:#54a0ff" onclick="document.getElementById('brushColor').value='#54a0ff'"></div>
                                <div class="color-swatch" style="background:#5f27cd" onclick="document.getElementById('brushColor').value='#5f27cd'"></div>
                                <div class="color-swatch" style="background:#01a3a4" onclick="document.getElementById('brushColor').value='#01a3a4'"></div>
                                <div class="color-swatch" style="background:#10ac84" onclick="document.getElementById('brushColor').value='#10ac84'"></div>
                                <div class="color-swatch" style="background:#ee5a24" onclick="document.getElementById('brushColor').value='#ee5a24'"></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-label">Shape</div>
                            <select id="brushShape">
                                <option value="round">Round</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Text Settings -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        ‚úèÔ∏è Text Settings <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="control-group">
                            <div class="control-label">Text</div>
                            <input type="text" id="textInput" placeholder="Enter text..." value="Hello World">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Font</div>
                            <select id="textFont">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <div class="control-label">Size <span class="control-value" id="val-textSize">32</span></div>
                            <input type="range" min="8" max="200" value="32" id="textSize" oninput="document.getElementById('val-textSize').textContent=this.value">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Color</div>
                            <input type="color" id="textColor" value="#ffffff">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Style</div>
                            <div class="action-btns">
                                <button class="action-btn" onclick="toggleTextStyle('bold')" id="btn-bold"><b>B</b></button>
                                <button class="action-btn" onclick="toggleTextStyle('italic')" id="btn-italic"><i>I</i></button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-label">Stroke</div>
                            <input type="color" id="textStrokeColor" value="#000000">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Stroke Width <span class="control-value" id="val-textStroke">0</span></div>
                            <input type="range" min="0" max="10" value="0" id="textStrokeWidth" oninput="document.getElementById('val-textStroke').textContent=this.value">
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        üìú History <span class="arrow">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="history-list" id="historyList">
                            <div class="history-item"><span class="h-num">0</span> Original</div>
                        </div>
                        <div class="action-btns" style="margin-top:10px;">
                            <button class="action-btn" onclick="undo()">‚Ü© Undo</button>
                            <button class="action-btn" onclick="redo()">‚Ü™ Redo</button>
                            <button class="action-btn full" onclick="clearHistory()">üóë Clear History</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resize Modal -->
    <div class="modal-overlay" id="resizeModal">
        <div class="modal">
            <h3>üìê Resize Image</h3>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Width (px)</label>
                    <input type="number" id="resizeWidth" value="800">
                </div>
                <div class="modal-field">
                    <label>Height (px)</label>
                    <input type="number" id="resizeHeight" value="600">
                </div>
            </div>
            <div class="control-group">
                <label style="font-size:12px; display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="maintainAspect" checked> Maintain Aspect Ratio
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('resizeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="applyResize()">Apply</button>
            </div>
        </div>
    </div>

    <!-- New Canvas Modal -->
    <div class="modal-overlay" id="newCanvasModal">
        <div class="modal">
            <h3>üìÑ New Canvas</h3>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Width (px)</label>
                    <input type="number" id="newWidth" value="800">
                </div>
                <div class="modal-field">
                    <label>Height (px)</label>
                    <input type="number" id="newHeight" value="600">
                </div>
            </div>
            <div class="control-group">
                <label style="font-size:12px;">Background Color</label>
                <input type="color" id="newBgColor" value="#ffffff">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('newCanvasModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewCanvas()">Create</button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let state = {
            tool: 'select',
            image: null,
            originalImageData: null,
            zoom: 100,
            history: [],
            historyIndex: -1,
            maxHistory: 50,
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            startX: 0,
            startY: 0,
            textBold: false,
            textItalic: false,
            currentFilter: 'none',
            filterIntensity: 100,
            adjustments: {
                brightness: 0,
                contrast: 0,
                saturation: 0,
                exposure: 0,
                hue: 0,
                blur: 0,
                sharpen: 0,
                opacity: 100
            },
            aspectRatio: 1,
            imageLoaded: false,
            cropActive: false,
            cropStart: null,
            cropEnd: null
        };

        // ============ DOM REFS ============
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const canvasArea = document.getElementById('canvasArea');

        // ============ FILE UPLOAD ============
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag & Drop
        canvasArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent)';
        });
        canvasArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--border)';
        });
        canvasArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) loadImage(file);
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    state.image = img;
                    state.imageLoaded = true;
                    
                    mainCanvas.width = img.width;
                    mainCanvas.height = img.height;
                    drawCanvas.width = img.width;
                    drawCanvas.height = img.height;
                    
                    mainCtx.drawImage(img, 0, 0);
                    state.originalImageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
                    state.aspectRatio = img.width / img.height;
                    
                    uploadArea.style.display = 'none';
                    canvasWrapper.style.display = 'block';
                    
                    fitToScreen();
                    saveToHistory('Image Loaded');
                    updateImageInfo();
                    notify('Image loaded successfully!');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ============ NEW CANVAS ============
        function showNewCanvasModal() {
            document.getElementById('newCanvasModal').classList.add('active');
        }

        function createNewCanvas() {
            const w = parseInt(document.getElementById('newWidth').value) || 800;
            const h = parseInt(document.getElementById('newHeight').value) || 600;
            const color = document.getElementById('newBgColor').value;
            
            mainCanvas.width = w;
            mainCanvas.height = h;
            drawCanvas.width = w;
            drawCanvas.height = h;
            
            mainCtx.fillStyle = color;
            mainCtx.fillRect(0, 0, w, h);
            
            state.originalImageData = mainCtx.getImageData(0, 0, w, h);
            state.imageLoaded = true;
            state.aspectRatio = w / h;
            
            uploadArea.style.display = 'none';
            canvasWrapper.style.display = 'block';
            
            fitToScreen();
            saveToHistory('New Canvas');
            updateImageInfo();
            closeModal('newCanvasModal');
            notify('New canvas created!');
        }

        // ============ TOOLS ============
        function setTool(tool) {
            state.tool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('tool-' + tool);
            if (btn) btn.classList.add('active');
            
            drawCanvas.style.cursor = getCursorForTool(tool);
            
            if (tool === 'crop' && state.imageLoaded) {
                state.cropActive = true;
                notify('Click and drag to crop');
            } else {
                state.cropActive = false;
            }

            if (tool === 'text') {
                switchTab('tools');
            }
            if (tool === 'brush' || tool === 'eraser') {
                switchTab('tools');
            }
        }

        function getCursorForTool(tool) {
            switch(tool) {
                case 'brush': case 'eraser': return 'crosshair';
                case 'move': return 'grab';
                case 'text': return 'text';
                case 'zoom': return 'zoom-in';
                case 'eyedropper': return 'crosshair';
                case 'crop': return 'crosshair';
                case 'fill': return 'crosshair';
                default: return 'default';
            }
        }

        // ============ DRAWING ============
        drawCanvas.addEventListener('mousedown', onMouseDown);
        drawCanvas.addEventListener('mousemove', onMouseMove);
        drawCanvas.addEventListener('mouseup', onMouseUp);
        drawCanvas.addEventListener('mouseleave', onMouseUp);

        function getCanvasPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function onMouseDown(e) {
            if (!state.imageLoaded) return;
            const pos = getCanvasPos(e);
            state.isDrawing = true;
            state.startX = pos.x;
            state.startY = pos.y;
            state.lastX = pos.x;
            state.lastY = pos.y;

            switch(state.tool) {
                case 'brush':
                case 'eraser':
                    drawDot(pos.x, pos.y);
                    break;
                case 'text':
                    addText(pos.x, pos.y);
                    break;
                case 'eyedropper':
                    pickColor(pos.x, pos.y);
                    break;
                case 'fill':
                    floodFill(Math.round(pos.x), Math.round(pos.y));
                    break;
                case 'zoom':
                    if (e.shiftKey || e.button === 2) {
                        changeZoom(-10);
                    } else {
                        changeZoom(10);
                    }
                    break;
            }
        }

        function onMouseMove(e) {
            if (!state.imageLoaded) return;
            const pos = getCanvasPos(e);
            
            document.getElementById('cursorPos').textContent = `X: ${Math.round(pos.x)} Y: ${Math.round(pos.y)}`;

            if (!state.isDrawing) return;

            switch(state.tool) {
                case 'brush':
                    drawLine(state.lastX, state.lastY, pos.x, pos.y);
                    state.lastX = pos.x;
                    state.lastY = pos.y;
                    break;
                case 'eraser':
                    eraseLine(state.lastX, state.lastY, pos.x, pos.y);
                    state.lastX = pos.x;
                    state.lastY = pos.y;
                    break;
                case 'line':
                case 'rect':
                case 'circle':
                    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                    drawShape(state.tool, state.startX, state.startY, pos.x, pos.y);
                    break;
                case 'crop':
                    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                    drawCropPreview(state.startX, state.startY, pos.x, pos.y);
                    break;
            }
        }

        function onMouseUp(e) {
            if (!state.isDrawing) return;
            state.isDrawing = false;
            
            if (!state.imageLoaded) return;
            const pos = getCanvasPos(e);

            switch(state.tool) {
                case 'brush':
                case 'eraser':
                    mergeDrawCanvas();
                    saveToHistory(state.tool === 'brush' ? 'Brush Stroke' : 'Eraser');
                    break;
                case 'line':
                case 'rect':
                case 'circle':
                    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                    drawShapeOnMain(state.tool, state.startX, state.startY, pos.x, pos.y);
                    saveToHistory('Draw ' + state.tool);
                    break;
                case 'crop':
                    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                    applyCrop(state.startX, state.startY, pos.x, pos.y);
                    break;
            }
        }

        function drawDot(x, y) {
            const size = parseInt(document.getElementById('brushSize').value);
            const color = document.getElementById('brushColor').value;
            const opacity = parseInt(document.getElementById('brushOpacity').value) / 100;
            const shape = document.getElementById('brushShape').value;

            drawCtx.globalAlpha = opacity;
            drawCtx.fillStyle = color;
            
            if (state.tool === 'eraser') {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.fillStyle = 'rgba(0,0,0,1)';
            }

            drawCtx.beginPath();
            if (shape === 'round') {
                drawCtx.arc(x, y, size / 2, 0, Math.PI * 2);
            } else {
                drawCtx.rect(x - size/2, y - size/2, size, size);
            }
            drawCtx.fill();
            drawCtx.globalAlpha = 1;
            drawCtx.globalCompositeOperation = 'source-over';
        }

        function drawLine(x1, y1, x2, y2) {
            const size = parseInt(document.getElementById('brushSize').value);
            const color = document.getElementById('brushColor').value;
            const opacity = parseInt(document.getElementById('brushOpacity').value) / 100;

            drawCtx.globalAlpha = opacity;
            drawCtx.strokeStyle = color;
            drawCtx.lineWidth = size;
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';

            if (state.tool === 'eraser') {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.strokeStyle = 'rgba(0,0,0,1)';
            }

            drawCtx.beginPath();
            drawCtx.moveTo(x1, y1);
            drawCtx.lineTo(x2, y2);
            drawCtx.stroke();
            
            drawCtx.globalAlpha = 1;
            drawCtx.globalCompositeOperation = 'source-over';
        }

        function eraseLine(x1, y1, x2, y2) {
            drawLine(x1, y1, x2, y2);
        }

        function drawShape(type, x1, y1, x2, y2) {
            const color = document.getElementById('brushColor').value;
            const size = parseInt(document.getElementById('brushSize').value);

            drawCtx.strokeStyle = color;
            drawCtx.lineWidth = size;
            drawCtx.beginPath();

            switch(type) {
                case 'line':
                    drawCtx.moveTo(x1, y1);
                    drawCtx.lineTo(x2, y2);
                    break;
                case 'rect':
                    drawCtx.rect(x1, y1, x2-x1, y2-y1);
                    break;
                case 'circle':
                    const rx = Math.abs(x2-x1)/2;
                    const ry = Math.abs(y2-y1)/2;
                    const cx = x1 + (x2-x1)/2;
                    const cy = y1 + (y2-y1)/2;
                    drawCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
                    break;
            }
            drawCtx.stroke();
        }

        function drawShapeOnMain(type, x1, y1, x2, y2) {
            const color = document.getElementById('brushColor').value;
            const size = parseInt(document.getElementById('brushSize').value);

            mainCtx.strokeStyle = color;
            mainCtx.lineWidth = size;
            mainCtx.beginPath();

            switch(type) {
                case 'line':
                    mainCtx.moveTo(x1, y1);
                    mainCtx.lineTo(x2, y2);
                    break;
                case 'rect':
                    mainCtx.rect(x1, y1, x2-x1, y2-y1);
                    break;
                case 'circle':
                    const rx = Math.abs(x2-x1)/2;
                    const ry = Math.abs(y2-y1)/2;
                    const cx = x1 + (x2-x1)/2;
                    const cy = y1 + (y2-y1)/2;
                    mainCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
                    break;
            }
            mainCtx.stroke();
        }

        function mergeDrawCanvas() {
            mainCtx.drawImage(drawCanvas, 0, 0);
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        }

        // ============ TEXT ============
        function addText(x, y) {
            const text = document.getElementById('textInput').value;
            if (!text) return;
            
            const font = document.getElementById('textFont').value;
            const size = document.getElementById('textSize').value;
            const color = document.getElementById('textColor').value;
            const strokeColor = document.getElementById('textStrokeColor').value;
            const strokeWidth = parseInt(document.getElementById('textStrokeWidth').value);
            
            let fontStyle = '';
            if (state.textBold) fontStyle += 'bold ';
            if (state.textItalic) fontStyle += 'italic ';
            
            mainCtx.font = `${fontStyle}${size}px ${font}`;
            mainCtx.fillStyle = color;
            mainCtx.textBaseline = 'top';
            
            if (strokeWidth > 0) {
                mainCtx.strokeStyle = strokeColor;
                mainCtx.lineWidth = strokeWidth;
                mainCtx.strokeText(text, x, y);
            }
            
            mainCtx.fillText(text, x, y);
            saveToHistory('Add Text');
            notify('Text added!');
        }

        function toggleTextStyle(style) {
            if (style === 'bold') {
                state.textBold = !state.textBold;
                document.getElementById('btn-bold').style.background = state.textBold ? 'var(--accent)' : '';
            } else {
                state.textItalic = !state.textItalic;
                document.getElementById('btn-italic').style.background = state.textItalic ? 'var(--accent)' : '';
            }
        }

        // ============ EYEDROPPER ============
        function pickColor(x, y) {
            const pixel = mainCtx.getImageData(Math.round(x), Math.round(y), 1, 1).data;
            const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => v.toString(16).padStart(2, '0')).join('');
            document.getElementById('brushColor').value = hex;
            document.getElementById('textColor').value = hex;
            notify(`Color picked: ${hex}`);
        }

        // ============ FLOOD FILL ============
        function floodFill(startX, startY) {
            if (startX < 0 || startX >= mainCanvas.width || startY < 0 || startY >= mainCanvas.height) return;
            
            const imageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            const data = imageData.data;
            const w = mainCanvas.width;
            const h = mainCanvas.height;
            
            const color = document.getElementById('brushColor').value;
            const fillR = parseInt(color.slice(1,3), 16);
            const fillG = parseInt(color.slice(3,5), 16);
            const fillB = parseInt(color.slice(5,7), 16);
            
            const startIdx = (startY * w + startX) * 4;
            const targetR = data[startIdx];
            const targetG = data[startIdx+1];
            const targetB = data[startIdx+2];
            const targetA = data[startIdx+3];
            
            if (fillR === targetR && fillG === targetG && fillB === targetB) return;
            
            const tolerance = 30;
            const stack = [[startX, startY]];
            const visited = new Set();
            
            function matches(idx) {
                return Math.abs(data[idx] - targetR) <= tolerance &&
                       Math.abs(data[idx+1] - targetG) <= tolerance &&
                       Math.abs(data[idx+2] - targetB) <= tolerance;
            }
            
            let iterations = 0;
            const maxIterations = w * h;
            
            while (stack.length > 0 && iterations < maxIterations) {
                iterations++;
                const [x, y] = stack.pop();
                const key = y * w + x;
                
                if (x < 0 || x >= w || y < 0 || y >= h || visited.has(key)) continue;
                
                const idx = key * 4;
                if (!matches(idx)) continue;
                
                visited.add(key);
                data[idx] = fillR;
                data[idx+1] = fillG;
                data[idx+2] = fillB;
                data[idx+3] = 255;
                
                stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
            
            mainCtx.putImageData(imageData, 0, 0);
            saveToHistory('Fill');
            notify('Area filled!');
        }

        // ============ CROP ============
        function drawCropPreview(x1, y1, x2, y2) {
            // Dim outside
            drawCtx.fillStyle = 'rgba(0,0,0,0.5)';
            drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            // Clear crop area
            const cx = Math.min(x1, x2);
            const cy = Math.min(y1, y2);
            const cw = Math.abs(x2 - x1);
            const ch = Math.abs(y2 - y1);
            
            drawCtx.clearRect(cx, cy, cw, ch);
            
            // Border
            drawCtx.strokeStyle = '#e94560';
            drawCtx.lineWidth = 2;
            drawCtx.setLineDash([5, 5]);
            drawCtx.strokeRect(cx, cy, cw, ch);
            drawCtx.setLineDash([]);
            
            // Grid lines (rule of thirds)
            drawCtx.strokeStyle = 'rgba(255,255,255,0.3)';
            drawCtx.lineWidth = 1;
            drawCtx.beginPath();
            drawCtx.moveTo(cx + cw/3, cy); drawCtx.lineTo(cx + cw/3, cy + ch);
            drawCtx.moveTo(cx + 2*cw/3, cy); drawCtx.lineTo(cx + 2*cw/3, cy + ch);
            drawCtx.moveTo(cx, cy + ch/3); drawCtx.lineTo(cx + cw, cy + ch/3);
            drawCtx.moveTo(cx, cy + 2*ch/3); drawCtx.lineTo(cx + cw, cy + 2*ch/3);
            drawCtx.stroke();
            
            // Dimensions
            drawCtx.fillStyle = '#e94560';
            drawCtx.font = '14px Inter';
            drawCtx.fillText(`${Math.round(cw)} √ó ${Math.round(ch)}`, cx + 5, cy - 8);
        }

        function applyCrop(x1, y1, x2, y2) {
            const cx = Math.min(x1, x2);
            const cy = Math.min(y1, y2);
            const cw = Math.abs(x2 - x1);
            const ch = Math.abs(y2 - y1);
            
            if (cw < 5 || ch < 5) return;
            
            const cropped = mainCtx.getImageData(cx, cy, cw, ch);
            mainCanvas.width = cw;
            mainCanvas.height = ch;
            drawCanvas.width = cw;
            drawCanvas.height = ch;
            mainCtx.putImageData(cropped, 0, 0);
            
            state.aspectRatio = cw / ch;
            fitToScreen();
            saveToHistory('Crop');
            updateImageInfo();
            notify('Image cropped!');
        }

        // ============ ADJUSTMENTS ============
        function updateAdjustment(type, value) {
            state.adjustments[type] = parseInt(value);
            document.getElementById('val-' + type).textContent = type === 'hue' ? value + '¬∞' : (type === 'opacity' ? value + '%' : value);
            applyAllAdjustments();
        }

        function applyAllAdjustments() {
            if (!state.imageLoaded) return;
            
            // Get from history
            if (state.historyIndex >= 0 && state.history.length > 0) {
                const imgData = new ImageData(
                    new Uint8ClampedArray(state.history[state.historyIndex].data),
                    state.history[state.historyIndex].width,
                    state.history[state.historyIndex].height
                );
                
                mainCanvas.width = imgData.width;
                mainCanvas.height = imgData.height;
                drawCanvas.width = imgData.width;
                drawCanvas.height = imgData.height;
                mainCtx.putImageData(imgData, 0, 0);
            }
            
            const imageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            const data = imageData.data;
            const adj = state.adjustments;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];

                // Brightness
                r += adj.brightness * 2.55;
                g += adj.brightness * 2.55;
                b += adj.brightness * 2.55;

                // Exposure
                const expFactor = Math.pow(2, adj.exposure / 50);
                r *= expFactor;
                g *= expFactor;
                b *= expFactor;

                // Contrast
                const contFactor = (259 * (adj.contrast + 255)) / (255 * (259 - adj.contrast));
                r = contFactor * (r - 128) + 128;
                g = contFactor * (g - 128) + 128;
                b = contFactor * (b - 128) + 128;

                // Saturation
                const gray = 0.2989 * r + 0.587 * g + 0.114 * b;
                const satFactor = 1 + adj.saturation / 100;
                r = gray + satFactor * (r - gray);
                g = gray + satFactor * (g - gray);
                b = gray + satFactor * (b - gray);

                // Opacity
                data[i+3] = data[i+3] * (adj.opacity / 100);

                data[i] = Math.max(0, Math.min(255, r));
                data[i+1] = Math.max(0, Math.min(255, g));
                data[i+2] = Math.max(0, Math.min(255, b));
            }

            mainCtx.putImageData(imageData, 0, 0);

            // Apply CSS filter for hue and blur (real-time preview)
            let filters = [];
            if (adj.hue !== 0) filters.push(`hue-rotate(${adj.hue}deg)`);
            if (adj.blur !== 0) filters.push(`blur(${adj.blur}px)`);
            mainCanvas.style.filter = filters.join(' ') || 'none';
        }

        function resetAdjustments() {
            state.adjustments = { brightness:0, contrast:0, saturation:0, exposure:0, hue:0, blur:0, sharpen:0, opacity:100 };
            
            ['brightness','contrast','saturation','exposure','hue','blur','sharpen','opacity'].forEach(adj => {
                const el = document.getElementById(adj);
                if (adj === 'opacity') {
                    el.value = 100;
                    document.getElementById('val-opacity').textContent = '100%';
                } else {
                    el.value = 0;
                    document.getElementById('val-' + adj).textContent = adj === 'hue' ? '0¬∞' : '0';
                }
            });
            
            mainCanvas.style.filter = 'none';
            
            if (state.historyIndex >= 0 && state.history.length > 0) {
                const imgData = new ImageData(
                    new Uint8ClampedArray(state.history[state.historyIndex].data),
                    state.history[state.historyIndex].width,
                    state.history[state.historyIndex].height
                );
                mainCtx.putImageData(imgData, 0, 0);
            }
            notify('Adjustments reset!');
        }

        // ============ FILTERS ============
        function applyFilter(filter) {
            if (!state.imageLoaded) return;
            
            state.currentFilter = filter;
            document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
            event.target.closest('.filter-item').classList.add('active');
            
            // Reset to last history state
            if (state.historyIndex >= 0) {
                const imgData = new ImageData(
                    new Uint8ClampedArray(state.history[state.historyIndex].data),
                    state.history[state.historyIndex].width,
                    state.history[state.historyIndex].height
                );
                mainCanvas.width = imgData.width;
                mainCanvas.height = imgData.height;
                mainCtx.putImageData(imgData, 0, 0);
            }
            
            if (filter === 'none') return;
            
            const imageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            const data = imageData.data;
            const intensity = state.filterIntensity / 100;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                let nr = r, ng = g, nb = b;

                switch(filter) {
                    case 'vintage':
                        nr = r * 0.9 + 40; ng = g * 0.7 + 20; nb = b * 0.5;
                        break;
                    case 'cool':
                        nr = r * 0.85; ng = g * 0.95; nb = b * 1.2 + 10;
                        break;
                    case 'warm':
                        nr = r * 1.2 + 10; ng = g * 1.05; nb = b * 0.8;
                        break;
                    case 'dramatic':
                        const gray2 = 0.299*r + 0.587*g + 0.114*b;
                        const cont2 = ((gray2 - 128) * 1.5) + 128;
                        nr = cont2 * 1.1; ng = cont2 * 0.9; nb = cont2 * 0.95;
                        break;
                    case 'bw':
                        const g3 = 0.299*r + 0.587*g + 0.114*b;
                        nr = ng = nb = g3;
                        break;
                    case 'sunset':
                        nr = r * 1.2 + 20; ng = g * 0.85; nb = b * 0.7;
                        break;
                    case 'forest':
                        nr = r * 0.8; ng = g * 1.2 + 10; nb = b * 0.85;
                        break;
                    case 'ocean':
                        nr = r * 0.7; ng = g * 0.9 + 10; nb = b * 1.3 + 20;
                        break;
                    case 'lomo':
                        nr = r * 1.1 + 15; ng = g * 0.9; nb = b * 0.85;
                        // Vignette effect would be separate
                        break;
                    case 'cross':
                        nr = r * 1.1 + 20; ng = g * 1.1 + 10; nb = b * 0.7;
                        break;
                    case 'polaroid':
                        nr = r * 1.05 + 15; ng = g * 1.02 + 10; nb = b * 0.9 + 5;
                        break;
                }

                // Blend with intensity
                data[i] = Math.max(0, Math.min(255, r + (nr - r) * intensity));
                data[i+1] = Math.max(0, Math.min(255, g + (ng - g) * intensity));
                data[i+2] = Math.max(0, Math.min(255, b + (nb - b) * intensity));
            }

            mainCtx.putImageData(imageData, 0, 0);
            saveToHistory('Filter: ' + filter);
        }

        function updateFilterIntensity(value) {
            state.filterIntensity = parseInt(value);
            document.getElementById('val-filterIntensity').textContent = value + '%';
            if (state.currentFilter !== 'none') {
                // Re-apply current filter with new intensity
                const filterItem = document.querySelector('.filter-item.active');
                if (filterItem) filterItem.click();
            }
        }

        // ============ COLOR EFFECTS ============
        function applyColorEffect(effect) {
            if (!state.imageLoaded) return;
            
            const imageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];

                switch(effect) {
                    case 'grayscale':
                        const gray = 0.299*r + 0.587*g + 0.114*b;
                        data[i] = data[i+1] = data[i+2] = gray;
                        break;
                    case 'sepia':
                        data[i] = Math.min(255, r*0.393 + g*0.769 + b*0.189);
                        data[i+1] = Math.min(255, r*0.349 + g*0.686 + b*0.168);
                        data[i+2] = Math.min(255, r*0.272 + g*0.534 + b*0.131);
                        break;
                    case 'invert':
                        data[i] = 255 - r;
                        data[i+1] = 255 - g;
                        data[i+2] = 255 - b;
                        break;
                    case 'threshold':
                        const avg = (r + g + b) / 3;
                        const val = avg > 128 ? 255 : 0;
                        data[i] = data[i+1] = data[i+2] = val;
                        break;
                    case 'posterize':
                        const levels = 4;
                        data[i] = Math.round(r / 255 * levels) / levels * 255;
                        data[i+1] = Math.round(g / 255 * levels) / levels * 255;
                        data[i+2] = Math.round(b / 255 * levels) / levels * 255;
                        break;
                    case 'solarize':
                        data[i] = r > 128 ? 255 - r : r;
                        data[i+1] = g > 128 ? 255 - g : g;
                        data[i+2] = b > 128 ? 255 - b : b;
                        break;
                }
            }

            mainCtx.putImageData(imageData, 0, 0);
            saveToHistory(effect.charAt(0).toUpperCase() + effect.slice(1));
            notify(effect + ' applied!');
        }

        // ============ TRANSFORM ============
        function rotateImage(degrees) {
            if (!state.imageLoaded) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const rad = degrees * Math.PI / 180;
            const absRad = Math.abs(rad);
            
            if (Math.abs(degrees) === 90 || Math.abs(degrees) === 270) {
                tempCanvas.width = mainCanvas.height;
                tempCanvas.height = mainCanvas.width;
            } else {
                tempCanvas.width = mainCanvas.width;
                tempCanvas.height = mainCanvas.height;
            }
            
            tempCtx.translate(tempCanvas.width/2, tempCanvas.height/2);
            tempCtx.rotate(rad);
            tempCtx.drawImage(mainCanvas, -mainCanvas.width/2, -mainCanvas.height/2);
            
            mainCanvas.width = tempCanvas.width;
            mainCanvas.height = tempCanvas.height;
            drawCanvas.width = tempCanvas.width;
            drawCanvas.height = tempCanvas.height;
            mainCtx.drawImage(tempCanvas, 0, 0);
            
            state.aspectRatio = mainCanvas.width / mainCanvas.height;
            fitToScreen();
            saveToHistory('Rotate ' + degrees + '¬∞');
            updateImageInfo();
            notify('Rotated ' + degrees + '¬∞');
        }

        function flipImage(direction) {
            if (!state.imageLoaded) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = mainCanvas.width;
            tempCanvas.height = mainCanvas.height;
            
            if (direction === 'h') {
                tempCtx.translate(tempCanvas.width, 0);
                tempCtx.scale(-1, 1);
            } else {
                tempCtx.translate(0, tempCanvas.height);
                tempCtx.scale(1, -1);
            }
            
            tempCtx.drawImage(mainCanvas, 0, 0);
            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            mainCtx.drawImage(tempCanvas, 0, 0);
            
            saveToHistory('Flip ' + (direction === 'h' ? 'Horizontal' : 'Vertical'));
            notify('Flipped ' + (direction === 'h' ? 'horizontally' : 'vertically'));
        }

        // ============ RESIZE ============
        function showResizeModal() {
            if (!state.imageLoaded) return;
            document.getElementById('resizeWidth').value = mainCanvas.width;
            document.getElementById('resizeHeight').value = mainCanvas.height;
            document.getElementById('resizeModal').classList.add('active');
        }

        document.getElementById('resizeWidth').addEventListener('input', function() {
            if (document.getElementById('maintainAspect').checked) {
                document.getElementById('resizeHeight').value = Math.round(this.value / state.aspectRatio);
            }
        });

        document.getElementById('resizeHeight').addEventListener('input', function() {
            if (document.getElementById('maintainAspect').checked) {
                document.getElementById('resizeWidth').value = Math.round(this.value * state.aspectRatio);
            }
        });

        function applyResize() {
            const w = parseInt(document.getElementById('resizeWidth').value);
            const h = parseInt(document.getElementById('resizeHeight').value);
            
            if (w < 1 || h < 1) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = w;
            tempCanvas.height = h;
            tempCtx.drawImage(mainCanvas, 0, 0, w, h);
            
            mainCanvas.width = w;
            mainCanvas.height = h;
            drawCanvas.width = w;
            drawCanvas.height = h;
            mainCtx.drawImage(tempCanvas, 0, 0);
            
            state.aspectRatio = w / h;
            fitToScreen();
            saveToHistory('Resize');
            updateImageInfo();
            closeModal('resizeModal');
            notify(`Resized to ${w}√ó${h}`);
        }

        // ============ ZOOM ============
        function changeZoom(delta) {
            state.zoom = Math.max(10, Math.min(500, state.zoom + delta));
            applyZoom();
        }

        function applyZoom() {
            const scale = state.zoom / 100;
            canvasWrapper.style.transform = `scale(${scale})`;
            document.getElementById('zoomLevel').textContent = state.zoom + '%';
        }

        function fitToScreen() {
            if (!state.imageLoaded) return;
            const area = canvasArea.getBoundingClientRect();
            const maxW = area.width - 40;
            const maxH = area.height - 70;
            
            const scaleW = maxW / mainCanvas.width;
            const scaleH = maxH / mainCanvas.height;
            const scale = Math.min(scaleW, scaleH, 1);
            
            state.zoom = Math.round(scale * 100);
            applyZoom();
        }

        // ============ HISTORY ============
        function saveToHistory(action) {
            const imageData = mainCtx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            
            // Remove future states
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }
            
            // Limit history
            if (state.history.length >= state.maxHistory) {
                state.history.shift();
            }
            
            state.history.push({
                data: new Uint8ClampedArray(imageData.data),
                width: imageData.width,
                height: imageData.height,
                action: action
            });
            
            state.historyIndex = state.history.length - 1;
            updateHistoryPanel();
        }

        function undo() {
            if (state.historyIndex <= 0) return;
            state.historyIndex--;
            restoreFromHistory();
            notify('Undo');
        }

        function redo() {
            if (state.historyIndex >= state.history.length - 1) return;
            state.historyIndex++;
            restoreFromHistory();
            notify('Redo');
        }

        function restoreFromHistory() {
            const entry = state.history[state.historyIndex];
            const imageData = new ImageData(
                new Uint8ClampedArray(entry.data),
                entry.width,
                entry.height
            );
            
            mainCanvas.width = entry.width;
            mainCanvas.height = entry.height;
            drawCanvas.width = entry.width;
            drawCanvas.height = entry.height;
            mainCtx.putImageData(imageData, 0, 0);
            
            state.aspectRatio = entry.width / entry.height;
            fitToScreen();
            updateHistoryPanel();
            updateImageInfo();
        }

        function updateHistoryPanel() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            state.history.forEach((entry, i) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.style.background = i === state.historyIndex ? 'var(--input-bg)' : '';
                item.style.color = i === state.historyIndex ? 'var(--text-primary)' : '';
                item.innerHTML = `<span class="h-num">${i}</span> ${entry.action}`;
                item.onclick = () => {
                    state.historyIndex = i;
                    restoreFromHistory();
                };
                list.appendChild(item);
            });
            list.scrollTop = list.scrollHeight;
        }

        function clearHistory() {
            if (state.history.length > 0) {
                const current = state.history[state.historyIndex];
                state.history = [current];
                state.historyIndex = 0;
                updateHistoryPanel();
                notify('History cleared');
            }
        }

        // ============ SAVE / EXPORT ============
        function saveImage(format) {
            if (!state.imageLoaded) {
                notify('No image to export!');
                return;
            }
            
            // Create export canvas without CSS filters
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            exportCanvas.width = mainCanvas.width;
            exportCanvas.height = mainCanvas.height;
            
            // Apply current filters to pixel data
            exportCtx.drawImage(mainCanvas, 0, 0);
            
            // Apply hue and blur if set
            if (state.adjustments.hue !== 0 || state.adjustments.blur !== 0) {
                exportCtx.filter = mainCanvas.style.filter;
                exportCtx.drawImage(mainCanvas, 0, 0);
            }
            
            const link = document.createElement('a');
            const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
            const quality = format === 'jpeg' ? 0.92 : undefined;
            
            link.download = `proedit-image.${format}`;
            link.href = exportCanvas.toDataURL(mimeType, quality);
            link.click();
            
            notify(`Image exported as ${format.toUpperCase()}!`);
        }

        // ============ RESET ============
        function resetAll() {
            if (state.originalImageData) {
                mainCanvas.width = state.originalImageData.width;
                mainCanvas.height = state.originalImageData.height;
                drawCanvas.width = state.originalImageData.width;
                drawCanvas.height = state.originalImageData.height;
                mainCtx.putImageData(state.originalImageData, 0, 0);
                
                resetAdjustments();
                state.currentFilter = 'none';
                state.filterIntensity = 100;
                document.getElementById('filterIntensity').value = 100;
                document.getElementById('val-filterIntensity').textContent = '100%';
                document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
                
                fitToScreen();
                saveToHistory('Reset');
                updateImageInfo();
                notify('Image reset to original!');
            }
        }

        // ============ UI HELPERS ============
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const body = header.nextElementSibling;
            body.classList.toggle('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-adjust').style.display = tab === 'adjust' ? 'block' : 'none';
            document.getElementById('tab-filters').style.display = tab === 'filters' ? 'block' : 'none';
            document.getElementById('tab-tools').style.display = tab === 'tools' ? 'block' : 'none';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function updateImageInfo() {
            document.getElementById('imageSize').textContent = `${mainCanvas.width} √ó ${mainCanvas.height}`;
            document.getElementById('imageDimensions').textContent = `${mainCanvas.width} √ó ${mainCanvas.height}`;
        }

        function notify(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, 2500);
        }

        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const ctrl = e.ctrlKey || e.metaKey;
            
            switch(e.key.toLowerCase()) {
                case 'v': setTool('select'); break;
                case 'b': setTool('brush'); break;
                case 'e': setTool('eraser'); break;
                case 'l': setTool('line'); break;
                case 'r': if (!ctrl) setTool('rect'); break;
                case 'c': if (!ctrl) setTool('circle'); break;
                case 't': setTool('text'); break;
                case 'x': setTool('crop'); break;
                case 'i': setTool('eyedropper'); break;
                case 'g': setTool('fill'); break;
                case 'm': setTool('move'); break;
                case 'z':
                    if (ctrl && e.shiftKey) { redo(); e.preventDefault(); }
                    else if (ctrl) { undo(); e.preventDefault(); }
                    else setTool('zoom');
                    break;
                case 's':
                    if (ctrl) { e.preventDefault(); saveImage('png'); }
                    break;
                case '=': case '+':
                    if (ctrl) { e.preventDefault(); changeZoom(10); }
                    break;
                case '-':
                    if (ctrl) { e.preventDefault(); changeZoom(-10); }
                    break;
                case '0':
                    if (ctrl) { e.preventDefault(); fitToScreen(); }
                    break;
                case 'delete': case 'backspace':
                    if (ctrl) { e.preventDefault(); resetAll(); }
                    break;
            }
        });

        // ============ MOUSE WHEEL ZOOM ============
        canvasArea.addEventListener('wheel', (e) => {
            e.preventDefault();
            changeZoom(e.deltaY > 0 ? -5 : 5);
        }, { passive: false });

        // ============ WINDOW RESIZE ============
        window.addEventListener('resize', () => {
            if (state.imageLoaded) fitToScreen();
        });

        // ============ INIT ============
        console.log('ProEdit Photo Editor loaded. Open an image to start editing!');
    </script>
</body>
</html>
