<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Compress Image - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column
}

/* NAV */
nav{
  background:#fff;padding:13px 24px;display:flex;align-items:center;
  border-bottom:1px solid #e8ecf0;box-shadow:0 1px 3px rgba(0,0,0,.04);
  position:sticky;top:0;z-index:100
}
.nav-t{font-weight:700;font-size:1.08rem;color:#1d9c73}
.nav-s{color:#aaa;font-size:.76rem;margin-left:8px;font-weight:500}
.nav-r{margin-left:auto;display:flex;gap:8px}
.nb{
  padding:8px 18px;border:none;border-radius:8px;font-size:.82rem;
  font-weight:600;cursor:pointer;transition:all .15s;display:flex;
  align-items:center;gap:5px;white-space:nowrap
}
.nb.sec{background:#f0f2f5;color:#666}
.nb.sec:hover{background:#e4e6e9}
.nb.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  box-shadow:0 2px 8px rgba(29,156,115,.2)}
.nb.pri:hover{box-shadow:0 4px 14px rgba(29,156,115,.3);transform:translateY(-1px)}
.nb.red{color:#e74c3c;background:#fdf2f2}
.nb.red:hover{background:#fce4e4}

/* UPLOAD */
.upload-area{
  display:flex;flex-direction:column;align-items:center;
  padding:44px 20px 36px;
  background:linear-gradient(180deg,#eefaf4 0%,#f5f7fa 100%)
}
.upload-area.mini{padding:16px 20px}
.upload-area h1{font-size:1.8rem;font-weight:800;color:#222;margin-bottom:8px;text-align:center}
.upload-area h1 span{color:#1d9c73}
.upload-area p{color:#888;font-size:.92rem;margin-bottom:26px;text-align:center;max-width:500px;line-height:1.5}
.upload-area.mini h1,.upload-area.mini p{display:none}

#dropZone{
  width:100%;max-width:600px;padding:48px 28px;border:2.5px dashed #c8e6c9;
  border-radius:16px;background:#fff;text-align:center;cursor:pointer;
  transition:all .25s
}
#dropZone:hover,#dropZone.dragover{
  border-color:#1d9c73;background:#f7fdf9;transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(29,156,115,.08)
}
.upload-area.mini #dropZone{padding:16px 20px;max-width:100%}
.dz-icon{font-size:3rem;margin-bottom:10px;opacity:.55}
.dz-text{font-size:1rem;color:#666;font-weight:500;margin-bottom:3px}
.dz-hint{font-size:.82rem;color:#bbb;margin-bottom:16px}
.dz-btn{
  display:inline-block;padding:12px 34px;
  background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;border:none;
  border-radius:30px;font-size:.95rem;font-weight:700;cursor:pointer;
  transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.25)
}
.dz-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.3)}
.dz-fmt{font-size:.72rem;color:#ccc;margin-top:14px}
.upload-area.mini .dz-icon,
.upload-area.mini .dz-hint,
.upload-area.mini .dz-fmt{display:none}
.upload-area.mini .dz-text{margin-bottom:0}
.upload-area.mini .dz-btn{padding:8px 22px;font-size:.82rem}
#fileInput{display:none}

/* SETTINGS */
.settings-bar{
  display:none;max-width:820px;width:100%;margin:0 auto;padding:0 20px
}
.settings-bar.show{display:block}
.settings-card{
  background:#fff;border-radius:14px;border:1px solid #eef0f3;
  padding:20px 24px;margin-top:16px;box-shadow:0 1px 4px rgba(0,0,0,.03)
}
.settings-title{font-size:.88rem;font-weight:700;color:#333;margin-bottom:14px;
  display:flex;align-items:center;gap:6px}
.mode-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.mode-btn{
  flex:1;min-width:120px;padding:14px 12px;border:2px solid #eef0f3;
  border-radius:10px;background:#fff;cursor:pointer;text-align:center;
  transition:all .15s
}
.mode-btn:hover{border-color:#1d9c73}
.mode-btn.active{border-color:#1d9c73;background:#eef9f3}
.mode-btn .m-icon{font-size:1.4rem;margin-bottom:4px}
.mode-btn .m-name{font-size:.82rem;font-weight:700;color:#333}
.mode-btn .m-desc{font-size:.68rem;color:#999;margin-top:2px}

.slider-row{display:none;flex-direction:column;gap:6px}
.slider-row.show{display:flex}
.sl-label{display:flex;justify-content:space-between;font-size:.8rem;color:#666}
.sl-label span:last-child{color:#1d9c73;font-weight:700;min-width:40px;text-align:right}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:#e0e0e0;outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:#1d9c73;cursor:pointer;border:3px solid #fff;
  box-shadow:0 1px 5px rgba(0,0,0,.2)
}
.res-row{display:none;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.res-row.show{display:flex}
.res-inp{
  width:80px;padding:7px 8px;border:1.5px solid #e0e3e7;border-radius:6px;
  font-size:.82rem;text-align:center;color:#333;background:#fafafa;font-weight:600
}
.res-inp:focus{outline:none;border-color:#1d9c73}
.res-x{color:#bbb;font-weight:700}
.res-label{font-size:.78rem;color:#999}
.lock-btn{
  width:32px;height:32px;border:1.5px solid #e0e3e7;border-radius:6px;
  background:#fafafa;color:#aaa;cursor:pointer;font-size:.85rem;
  display:flex;align-items:center;justify-content:center;transition:all .12s
}
.lock-btn.on{color:#1d9c73;border-color:#1d9c73;background:#eef9f3}
.pct-btns{display:flex;gap:5px;margin-left:8px}
.pct-btn{
  padding:5px 10px;border:1.5px solid #e0e3e7;border-radius:6px;
  background:#fff;color:#555;font-size:.72rem;font-weight:600;
  cursor:pointer;transition:all .12s
}
.pct-btn:hover{border-color:#1d9c73;color:#1d9c73}

/* FILES */
.files-area{
  display:none;max-width:820px;width:100%;margin:0 auto;padding:16px 20px 0
}
.files-area.show{display:block}
.files-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:12px
}
.files-header h3{font-size:.95rem;font-weight:700;color:#333}
.file-count{font-size:.78rem;color:#999;font-weight:500}

.file-list{display:flex;flex-direction:column;gap:8px}
.file-item{
  background:#fff;border-radius:12px;border:1px solid #eef0f3;
  padding:14px 16px;display:flex;align-items:center;gap:12px;
  transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.02)
}
.file-item:hover{box-shadow:0 2px 8px rgba(0,0,0,.04)}
.f-thumb{
  width:50px;height:50px;border-radius:8px;background:#f5f7fa;
  overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center
}
.f-thumb img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.f-info{flex:1;min-width:0}
.f-name{font-size:.85rem;font-weight:600;color:#333;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.f-meta{font-size:.73rem;color:#aaa;margin-top:3px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.f-sizes{display:flex;align-items:center;gap:6px;font-size:.76rem}
.f-orig{color:#999}
.f-arrow{color:#ccc}
.f-comp{color:#1d9c73;font-weight:700}
.f-saved{
  font-size:.7rem;font-weight:700;padding:3px 8px;border-radius:10px;
  white-space:nowrap
}
.f-saved.green{background:#e8f8f0;color:#1d9c73}
.f-saved.yellow{background:#fff8e1;color:#e67e22}
.f-saved.red{background:#fde8e8;color:#e74c3c}

.f-status{flex-shrink:0;display:flex;align-items:center;gap:6px}
.badge{
  padding:5px 12px;border-radius:16px;font-size:.72rem;font-weight:600;
  display:inline-flex;align-items:center;gap:4px
}
.badge.wait{background:#f0f2f5;color:#999}
.badge.prog{background:#fff8e1;color:#e67e22}
.badge.done{background:#e8f8f0;color:#1d9c73}
.badge.err{background:#fde8e8;color:#e74c3c}
.mini-spin{
  width:13px;height:13px;border:2px solid #f0d78c;border-top-color:#e67e22;
  border-radius:50%;animation:sp .6s linear infinite;display:inline-block
}
@keyframes sp{to{transform:rotate(360deg)}}

.f-dl{
  padding:6px 14px;border:none;border-radius:8px;background:#1d9c73;
  color:#fff;font-size:.76rem;font-weight:600;cursor:pointer;
  transition:all .12s;white-space:nowrap
}
.f-dl:hover{background:#27ae60}
.f-remove{
  width:28px;height:28px;border:none;border-radius:6px;background:#f5f5f5;
  color:#bbb;cursor:pointer;font-size:.8rem;display:flex;align-items:center;
  justify-content:center;transition:all .12s
}
.f-remove:hover{background:#fde8e8;color:#e74c3c}

/* PROGRESS */
.file-progress{
  width:100%;height:4px;background:#e8ecf0;border-radius:2px;margin-top:6px;overflow:hidden
}
.file-progress .bar{height:100%;background:linear-gradient(90deg,#1d9c73,#27ae60);
  border-radius:2px;transition:width .3s;width:0}

/* SUMMARY */
.summary-card{
  display:none;max-width:820px;width:100%;margin:16px auto 0;padding:0 20px
}
.summary-card.show{display:block}
.summary{
  background:#fff;border-radius:14px;border:1px solid #eef0f3;
  padding:20px 24px;box-shadow:0 1px 4px rgba(0,0,0,.03);
  display:flex;align-items:center;gap:20px;flex-wrap:wrap
}
.sum-item{text-align:center;flex:1;min-width:100px}
.sum-val{font-size:1.4rem;font-weight:800;color:#1d9c73}
.sum-label{font-size:.72rem;color:#999;font-weight:500;margin-top:2px}
.sum-sep{width:1px;height:40px;background:#eef0f3;flex-shrink:0}

/* ACTION BAR */
.action-bar{
  display:none;max-width:820px;width:100%;margin:0 auto;
  padding:16px 20px 36px;
  justify-content:center;gap:10px;flex-wrap:wrap
}
.action-bar.show{display:flex}
.act-btn{
  padding:13px 32px;border:none;border-radius:10px;font-size:.92rem;
  font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;
  align-items:center;gap:8px
}
.act-btn.compress{
  background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;
  box-shadow:0 4px 16px rgba(29,156,115,.25)
}
.act-btn.compress:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(29,156,115,.35)}
.act-btn.compress:disabled{opacity:.5;cursor:default;transform:none}
.act-btn.dlall{background:#fff;color:#1d9c73;border:2px solid #1d9c73}
.act-btn.dlall:hover{background:#eef9f3}
.act-btn .btn-spin{
  width:16px;height:16px;border:2.5px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite
}
.add-more{
  padding:13px 24px;border:2px dashed #ccc;border-radius:10px;
  background:#fff;color:#999;font-size:.88rem;font-weight:600;
  cursor:pointer;transition:all .15s
}
.add-more:hover{border-color:#1d9c73;color:#1d9c73;background:#f7fdf9}

/* TOAST */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#fff;color:#333;padding:12px 22px;border-radius:10px;
  font-size:.85rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);
  z-index:300;transition:transform .3s;border-left:4px solid #1d9c73
}
.toast.err{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

/* FOOTER */
footer{
  margin-top:auto;text-align:center;padding:16px;color:#bbb;
  font-size:.74rem;border-top:1px solid #eef0f3;background:#fff
}
footer span{color:#1d9c73;font-weight:600}

/* RESPONSIVE */
@media(max-width:768px){
  .upload-area{padding:30px 16px 24px}
  .upload-area h1{font-size:1.4rem}
  #dropZone{padding:34px 20px}
  .nb span.txt{display:none}
  .nb{padding:8px 12px}
  .nav-s{display:none}
  .file-item{padding:10px 12px;gap:10px}
  .f-thumb{width:42px;height:42px}
  .summary{gap:12px;padding:16px}
  .sum-sep{display:none}
  .mode-btn{min-width:90px;padding:10px 8px}
}
@media(max-width:480px){
  .upload-area h1{font-size:1.15rem}
  #dropZone{padding:28px 14px}
  .dz-icon{font-size:2.2rem}
  .f-sizes{flex-direction:column;align-items:flex-start;gap:2px}
  .f-arrow{display:none}
  .mode-btn .m-desc{display:none}
  .pct-btns{margin-left:0;margin-top:6px;width:100%}
  .res-row.show{flex-wrap:wrap}
  .settings-card{padding:14px 16px}
}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <span class="nav-t">Compress Image</span>
  <span class="nav-s">Free Online Tool</span>
  <div class="nav-r" id="navBtns" style="display:none">
    <button class="nb red" onclick="clearAll()">‚úï <span class="txt">Clear</span></button>
    <button class="nb sec" onclick="document.getElementById('fileInput').click()">+ <span class="txt">Add</span></button>
  </div>
</nav>

<!-- UPLOAD -->
<div class="upload-area" id="uploadArea">
  <h1>Compress <span>Images</span> Online</h1>
  <p>Reduce image file size without losing quality. Fast, free and works right in your browser.</p>
  <div id="dropZone">
    <div class="dz-icon">üìÅ</div>
    <div class="dz-text">Drag & drop images here</div>
    <div class="dz-hint">or</div>
    <button class="dz-btn" onclick="document.getElementById('fileInput').click()">Select Images</button>
    <div class="dz-fmt">JPG, PNG, WEBP, GIF ‚Äî Up to 50MB each</div>
  </div>
  <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp,image/gif" multiple>
</div>

<!-- SETTINGS -->
<div class="settings-bar" id="settingsBar">
  <div class="settings-card">
    <div class="settings-title">‚öô Compression Settings</div>
    <div class="mode-row">
      <div class="mode-btn active" onclick="setMode('recommended',this)">
        <div class="m-icon">‚ö°</div>
        <div class="m-name">Recommended</div>
        <div class="m-desc">Best balance of size & quality</div>
      </div>
      <div class="mode-btn" onclick="setMode('maximum',this)">
        <div class="m-icon">üî•</div>
        <div class="m-name">Maximum</div>
        <div class="m-desc">Smallest file size</div>
      </div>
      <div class="mode-btn" onclick="setMode('custom',this)">
        <div class="m-icon">üéõ</div>
        <div class="m-name">Custom</div>
        <div class="m-desc">Manual quality control</div>
      </div>
    </div>
    <div class="slider-row" id="qualityRow">
      <div class="sl-label"><span>Quality</span><span id="qVal">75%</span></div>
      <input type="range" min="5" max="100" value="75" id="qSlider" oninput="document.getElementById('qVal').textContent=this.value+'%'">
    </div>
    <div class="res-row" id="resizeRow">
      <span class="res-label">Max Size:</span>
      <input type="number" class="res-inp" id="maxW" placeholder="Width" value="">
      <span class="res-x">√ó</span>
      <input type="number" class="res-inp" id="maxH" placeholder="Height" value="">
      <button class="lock-btn on" id="lockBtn" onclick="toggleLock()">üîó</button>
      <div class="pct-btns">
        <button class="pct-btn" onclick="setPct(100)">100%</button>
        <button class="pct-btn" onclick="setPct(75)">75%</button>
        <button class="pct-btn" onclick="setPct(50)">50%</button>
        <button class="pct-btn" onclick="setPct(25)">25%</button>
      </div>
    </div>
  </div>
</div>

<!-- FILES -->
<div class="files-area" id="filesArea">
  <div class="files-header">
    <div>
      <h3>Images</h3>
      <span class="file-count" id="fileCount">0 images</span>
    </div>
  </div>
  <div class="file-list" id="fileList"></div>
</div>

<!-- SUMMARY -->
<div class="summary-card" id="summaryCard">
  <div class="summary">
    <div class="sum-item">
      <div class="sum-val" id="sumTotal">0</div>
      <div class="sum-label">Total Images</div>
    </div>
    <div class="sum-sep"></div>
    <div class="sum-item">
      <div class="sum-val" id="sumOrig">0 KB</div>
      <div class="sum-label">Original Size</div>
    </div>
    <div class="sum-sep"></div>
    <div class="sum-item">
      <div class="sum-val" id="sumComp">0 KB</div>
      <div class="sum-label">Compressed Size</div>
    </div>
    <div class="sum-sep"></div>
    <div class="sum-item">
      <div class="sum-val" id="sumSaved">0%</div>
      <div class="sum-label">Space Saved</div>
    </div>
  </div>
</div>

<!-- ACTIONS -->
<div class="action-bar" id="actionBar">
  <button class="add-more" onclick="document.getElementById('fileInput').click()">+ Add More Images</button>
  <button class="act-btn compress" id="compressBtn" onclick="compressAll()">‚ö° Compress Images</button>
  <button class="act-btn dlall" id="dlAllBtn" onclick="downloadAll()" style="display:none">‚§ì Download All</button>
</div>

<!-- FOOTER -->
<footer><span>Compress Image</span> ‚Äî 100% free and private. Images never leave your browser.</footer>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
let files=[];
let mode='recommended';
let lockAR=true;
let isCompressing=false;

document.addEventListener('DOMContentLoaded',()=>{
  const fi=document.getElementById('fileInput');
  const dz=document.getElementById('dropZone');

  fi.addEventListener('change',e=>{handleFiles(e.target.files);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});

  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{handleFiles(e.dataTransfer.files)});

  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items;
    if(!items)return;
    const imgFiles=[];
    for(let item of items){if(item.type.startsWith('image/'))imgFiles.push(item.getAsFile())}
    if(imgFiles.length){e.preventDefault();handleFiles(imgFiles)}
  });
});

function handleFiles(fl){
  let added=0;
  for(let f of fl){
    if(!f.type.startsWith('image/')){continue}
    if(f.size>50*1024*1024){toast(f.name+' too large (max 50MB)',true);continue}
    const url=URL.createObjectURL(f);
    files.push({
      file:f,name:f.name,size:f.size,type:f.type,
      thumbUrl:url,
      status:'waiting',
      compBlob:null,compUrl:null,compSize:0,
      width:0,height:0
    });
    added++;
    // Get dimensions
    const idx=files.length-1;
    const img=new Image();
    img.onload=()=>{files[idx].width=img.naturalWidth;files[idx].height=img.naturalHeight;renderFiles()};
    img.src=url;
  }
  if(added===0&&fl.length>0){toast('No valid images found',true);return}
  if(added>0){
    toast('‚úì '+added+' image'+(added>1?'s':'')+' added');
    showUI();renderFiles();
  }
}

function showUI(){
  document.getElementById('uploadArea').classList.add('mini');
  document.getElementById('settingsBar').classList.add('show');
  document.getElementById('filesArea').classList.add('show');
  document.getElementById('actionBar').classList.add('show');
  document.getElementById('navBtns').style.display='flex';

  const allDone=files.length>0&&files.every(f=>f.status==='done');
  document.getElementById('dlAllBtn').style.display=allDone?'inline-flex':'none';
  document.getElementById('compressBtn').style.display=allDone?'none':'inline-flex';
}

function renderFiles(){
  const list=document.getElementById('fileList');
  list.innerHTML='';
  document.getElementById('fileCount').textContent=files.length+' image'+(files.length!==1?'s':'');

  files.forEach((f,i)=>{
    const item=document.createElement('div');
    item.className='file-item';

    let statusHTML='';
    let sizesHTML='';

    if(f.status==='waiting'){
      statusHTML='<span class="badge wait">Waiting</span>';
      sizesHTML=`<span class="f-orig">${fmtSize(f.size)}</span>`;
    }else if(f.status==='compressing'){
      statusHTML='<span class="badge prog"><span class="mini-spin"></span> Compressing</span>';
      sizesHTML=`<span class="f-orig">${fmtSize(f.size)}</span>`;
    }else if(f.status==='done'){
      const saved=((1-f.compSize/f.size)*100);
      const cls=saved>50?'green':saved>20?'green':saved>0?'yellow':'red';
      statusHTML=`<span class="badge done">‚úì Done</span><button class="f-dl" onclick="dlOne(${i})">‚§ì</button>`;
      sizesHTML=`
        <span class="f-orig">${fmtSize(f.size)}</span>
        <span class="f-arrow">‚Üí</span>
        <span class="f-comp">${fmtSize(f.compSize)}</span>
        <span class="f-saved ${cls}">${saved>0?'-':''}${Math.abs(saved).toFixed(0)}%</span>
      `;
    }else if(f.status==='error'){
      statusHTML='<span class="badge err">‚úï Error</span>';
      sizesHTML=`<span class="f-orig">${fmtSize(f.size)}</span>`;
    }

    const dims=f.width&&f.height?`${f.width}√ó${f.height}`:'';

    item.innerHTML=`
      <div class="f-thumb"><img src="${f.thumbUrl}" alt=""></div>
      <div class="f-info">
        <div class="f-name">${esc(f.name)}</div>
        <div class="f-meta">
          <div class="f-sizes">${sizesHTML}</div>
          ${dims?`<span>${dims}</span>`:''}
        </div>
        ${f.status==='compressing'?'<div class="file-progress"><div class="bar" style="width:50%"></div></div>':''}
      </div>
      <div class="f-status">
        ${statusHTML}
        <button class="f-remove" onclick="removeFile(${i})" title="Remove">‚úï</button>
      </div>
    `;
    list.appendChild(item);
  });

  updateSummary();
}

function updateSummary(){
  const doneFiles=files.filter(f=>f.status==='done');
  if(doneFiles.length===0){
    document.getElementById('summaryCard').classList.remove('show');
    return;
  }
  document.getElementById('summaryCard').classList.add('show');

  const totalOrig=doneFiles.reduce((s,f)=>s+f.size,0);
  const totalComp=doneFiles.reduce((s,f)=>s+f.compSize,0);
  const saved=totalOrig>0?((1-totalComp/totalOrig)*100):0;

  document.getElementById('sumTotal').textContent=doneFiles.length;
  document.getElementById('sumOrig').textContent=fmtSize(totalOrig);
  document.getElementById('sumComp').textContent=fmtSize(totalComp);
  document.getElementById('sumSaved').textContent=(saved>0?'-':'')+Math.abs(saved).toFixed(1)+'%';
}

function removeFile(idx){
  if(files[idx].thumbUrl)URL.revokeObjectURL(files[idx].thumbUrl);
  if(files[idx].compUrl)URL.revokeObjectURL(files[idx].compUrl);
  files.splice(idx,1);
  if(files.length===0){clearAll();return}
  renderFiles();showUI();
}

// SETTINGS
function setMode(m,btn){
  mode=m;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('qualityRow').classList.toggle('show',m==='custom');
  document.getElementById('resizeRow').classList.toggle('show',m==='custom');
}

function toggleLock(){
  lockAR=!lockAR;
  const b=document.getElementById('lockBtn');
  b.classList.toggle('on');b.textContent=lockAR?'üîó':'üîì';
}

function setPct(p){
  if(files.length===0)return;
  const f=files[0];
  if(f.width&&f.height){
    document.getElementById('maxW').value=Math.round(f.width*p/100);
    document.getElementById('maxH').value=Math.round(f.height*p/100);
  }
}

// COMPRESS
async function compressAll(){
  if(isCompressing||files.length===0)return;
  isCompressing=true;

  const btn=document.getElementById('compressBtn');
  btn.disabled=true;
  btn.innerHTML='<span class="btn-spin"></span> Compressing...';

  let quality;
  if(mode==='recommended')quality=0.75;
  else if(mode==='maximum')quality=0.4;
  else quality=(parseInt(document.getElementById('qSlider').value)||75)/100;

  const maxW=parseInt(document.getElementById('maxW').value)||0;
  const maxH=parseInt(document.getElementById('maxH').value)||0;

  for(let i=0;i<files.length;i++){
    if(files[i].status==='done')continue;
    files[i].status='compressing';
    renderFiles();

    try{
      const result=await compressImage(files[i],quality,maxW,maxH);
      files[i].compBlob=result.blob;
      files[i].compUrl=URL.createObjectURL(result.blob);
      files[i].compSize=result.blob.size;
      files[i].status='done';

      // Update thumb to compressed version
      if(files[i].compUrl){
        files[i].thumbUrl=files[i].compUrl;
      }
    }catch(err){
      console.error(err);
      files[i].status='error';
    }
    renderFiles();
  }

  isCompressing=false;
  btn.disabled=false;
  btn.innerHTML='‚ö° Compress Images';

  const allDone=files.every(f=>f.status==='done');
  const anyDone=files.some(f=>f.status==='done');

  if(allDone){
    toast('‚úì All images compressed!');
    document.getElementById('dlAllBtn').style.display='inline-flex';
    document.getElementById('compressBtn').style.display='none';
  }else if(anyDone){
    toast('Some images compressed');
    document.getElementById('dlAllBtn').style.display='inline-flex';
  }else{
    toast('Compression failed',true);
  }
}

function compressImage(fileObj,quality,maxW,maxH){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.naturalWidth;
      let h=img.naturalHeight;

      // Resize if needed
      if(maxW>0&&maxH>0){
        if(w>maxW||h>maxH){
          const r=Math.min(maxW/w,maxH/h);
          w=Math.round(w*r);h=Math.round(h*r);
        }
      }else if(maxW>0){
        if(w>maxW){const r=maxW/w;w=maxW;h=Math.round(h*r)}
      }else if(maxH>0){
        if(h>maxH){const r=maxH/h;h=maxH;w=Math.round(w*r)}
      }

      // For recommended/maximum mode, also scale large images
      if(mode!=='custom'){
        const maxDim=mode==='maximum'?1920:3840;
        if(w>maxDim||h>maxDim){
          const r=Math.min(maxDim/w,maxDim/h);
          w=Math.round(w*r);h=Math.round(h*r);
        }
      }

      const canvas=document.createElement('canvas');
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');

      // Smooth rendering
      ctx.imageSmoothingEnabled=true;
      ctx.imageSmoothingQuality='high';
      ctx.drawImage(img,0,0,w,h);

      // Determine output type
      let outType=fileObj.type;
      if(outType==='image/png'){
        // Try JPEG first for PNGs (if not transparent)
        const id=ctx.getImageData(0,0,Math.min(w,100),Math.min(h,100));
        let hasAlpha=false;
        for(let p=3;p<id.data.length;p+=4){
          if(id.data[p]<255){hasAlpha=true;break}
        }
        if(!hasAlpha){
          // Convert to JPEG for better compression
          outType='image/jpeg';
        }
      }
      if(outType==='image/gif')outType='image/png';

      canvas.toBlob(blob=>{
        if(!blob){reject('Failed');return}

        // If compressed is bigger, try harder or use original approach
        if(blob.size>=fileObj.size&&outType==='image/jpeg'){
          canvas.toBlob(blob2=>{
            resolve({blob:blob2||blob});
          },outType,Math.max(0.3,quality-0.2));
        }else{
          resolve({blob});
        }
      },outType,quality);
    };
    img.onerror=()=>reject('Load failed');
    img.src=URL.createObjectURL(fileObj.file);
  });
}

// DOWNLOAD
function dlOne(idx){
  const f=files[idx];
  if(!f.compBlob)return;
  const a=document.createElement('a');
  a.href=f.compUrl||URL.createObjectURL(f.compBlob);
  let ext=f.name.split('.').pop();
  if(f.compBlob.type==='image/jpeg'&&ext.toLowerCase()==='png')ext='jpg';
  const baseName=f.name.replace(/\.[^.]+$/,'');
  a.download=baseName+'-compressed.'+ext;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function downloadAll(){
  const done=files.filter(f=>f.status==='done');
  if(done.length===0)return;
  if(done.length===1){dlOne(files.indexOf(done[0]));return}
  done.forEach((f,i)=>{
    setTimeout(()=>dlOne(files.indexOf(f)),i*400);
  });
  toast('‚§ì Downloading '+done.length+' images...');
}

function clearAll(){
  files.forEach(f=>{
    if(f.thumbUrl)URL.revokeObjectURL(f.thumbUrl);
    if(f.compUrl)URL.revokeObjectURL(f.compUrl);
  });
  files=[];
  document.getElementById('fileList').innerHTML='';
  document.getElementById('uploadArea').classList.remove('mini');
  document.getElementById('settingsBar').classList.remove('show');
  document.getElementById('filesArea').classList.remove('show');
  document.getElementById('actionBar').classList.remove('show');
  document.getElementById('summaryCard').classList.remove('show');
  document.getElementById('navBtns').style.display='none';
  document.getElementById('dlAllBtn').style.display='none';
  document.getElementById('compressBtn').style.display='inline-flex';
  document.getElementById('compressBtn').innerHTML='‚ö° Compress Images';
  toast('Cleared');
}

// UTILS
function fmtSize(b){
  if(b<1024)return b+' B';
  if(b<1048576)return(b/1024).toFixed(1)+' KB';
  return(b/1048576).toFixed(2)+' MB';
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toast(m,e){
  const t=document.getElementById('toast');
  t.textContent=m;t.className='toast'+(e?' err':'');
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
