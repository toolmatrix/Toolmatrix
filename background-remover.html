<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Remove Background - AI Pro Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--g:#1d9c73;--g2:#27ae60;--gb:rgba(29,156,115,.08)}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f5f7fa;color:#333;height:100vh;display:flex;flex-direction:column;overflow:hidden}

nav{background:#fff;padding:11px 18px;display:flex;align-items:center;border-bottom:1px solid #e0ece5;box-shadow:0 1px 3px rgba(0,0,0,.03);z-index:100;flex-shrink:0}
.nt{font-weight:700;font-size:1.02rem;color:var(--g)}
.nr{margin-left:auto;display:flex;gap:6px}
.btn{padding:7px 15px;border:none;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:4px;white-space:nowrap}
.btn-s{background:#eef5f0;color:#555}
.btn-s:hover{background:#ddeee3}
.btn-p{background:linear-gradient(135deg,var(--g),var(--g2));color:#fff;box-shadow:0 2px 8px rgba(29,156,115,.18)}
.btn-p:hover{box-shadow:0 4px 14px rgba(29,156,115,.28);transform:translateY(-1px)}

/* ============ UPLOAD ============ */
.scr{display:none;flex:1;flex-direction:column;overflow:hidden}
.scr.on{display:flex}

#s1{align-items:center;justify-content:center;padding:30px 20px;background:linear-gradient(180deg,#e8f6ef,#f5f7fa)}
.hero h1{font-size:1.6rem;font-weight:800;color:#222;margin-bottom:6px;text-align:center}
.hero h1 b{color:var(--g);font-weight:800}
.hero p{color:#999;font-size:.88rem;margin-bottom:26px;text-align:center;max-width:480px;line-height:1.5}

#drop{width:100%;max-width:540px;padding:44px 22px;border:2.5px dashed #b8dfc9;border-radius:16px;background:#fff;text-align:center;cursor:pointer;transition:all .25s}
#drop:hover,#drop.over{border-color:var(--g);background:#f0faf5;transform:translateY(-2px);box-shadow:0 8px 24px rgba(29,156,115,.06)}
.di{font-size:2.6rem;margin-bottom:8px;opacity:.5}
.dt{font-size:.92rem;color:#666;font-weight:500;margin-bottom:2px}
.dh{font-size:.78rem;color:#c0c0c0;margin-bottom:14px}
.db{padding:11px 30px;background:linear-gradient(135deg,var(--g),var(--g2));color:#fff;border:none;border-radius:28px;font-size:.88rem;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(29,156,115,.2)}
.db:hover{transform:translateY(-1px)}
.df{font-size:.66rem;color:#d0d0d0;margin-top:12px}
.note{margin-top:18px;padding:10px 18px;background:#fff8e1;border-radius:10px;font-size:.72rem;color:#b38600;max-width:540px;text-align:center;line-height:1.5;border:1px solid #ffe082}
#fi{display:none}

/* ============ PROCESSING ============ */
#s2{align-items:center;justify-content:center;padding:30px 20px;background:#fff}
.pcard{text-align:center;max-width:420px;width:100%}
.pprev{width:140px;height:140px;border-radius:14px;background:#f0f5f2;margin:0 auto 18px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.05);position:relative}
.pprev img{width:100%;height:100%;object-fit:cover}
.pprev::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(29,156,115,.08),rgba(29,156,115,.02));animation:shimmer 1.5s infinite}
@keyframes shimmer{0%,100%{opacity:.3}50%{opacity:.8}}

.psteps{display:flex;justify-content:center;gap:6px;margin-bottom:18px}
.ps{display:flex;align-items:center;gap:4px}
.ps-dot{width:26px;height:26px;border-radius:50%;border:2.5px solid #e0ece5;display:flex;align-items:center;justify-content:center;font-size:.6rem;color:#ccc;font-weight:700;transition:all .3s}
.ps-dot.act{border-color:var(--g);color:var(--g);background:#eef9f3;animation:pulse 1s infinite}
.ps-dot.done{border-color:var(--g);background:var(--g);color:#fff}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.ps-line{width:20px;height:2px;background:#e0ece5;border-radius:1px}
.ps-line.done{background:var(--g)}
.ps-lbl{font-size:.58rem;color:#bbb;font-weight:600;margin-top:2px}
.ps-lbl.act{color:var(--g)}

.pt{font-size:1.05rem;font-weight:700;color:#333;margin-bottom:4px}
.pd{font-size:.78rem;color:#999;margin-bottom:14px}
.pbar{width:100%;height:6px;background:#e0ece5;border-radius:3px;overflow:hidden;margin-bottom:5px}
.pfill{height:100%;background:linear-gradient(90deg,var(--g),var(--g2));border-radius:3px;transition:width .4s;width:0}
.ppct{font-size:.72rem;color:var(--g);font-weight:700;margin-bottom:12px}
.ptip{font-size:.68rem;color:#c0c0c0;line-height:1.4}

/* ============ RESULT ============ */
#s3{overflow:hidden}

.tools{background:#fff;border-bottom:1px solid #e0ece5;padding:7px 12px;display:flex;align-items:center;gap:5px;overflow-x:auto;flex-shrink:0}
.tools::-webkit-scrollbar{height:0}
.tb{padding:5px 11px;border:1.5px solid #e0ece5;border-radius:7px;background:#fff;color:#666;font-size:.7rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:3px}
.tb:hover{border-color:var(--g);color:var(--g)}
.tb.on{background:#eef9f3;border-color:var(--g);color:var(--g)}
.tb.rd{border-color:#fde2e2;color:#e74c3c}
.tb.rd:hover{background:#fdf2f2}
.sep{width:1px;height:20px;background:#e0ece5;flex-shrink:0}
.rng{display:flex;align-items:center;gap:3px}
.rng label{font-size:.64rem;font-weight:600;color:#aaa}
.rng input[type=range]{width:60px;-webkit-appearance:none;height:4px;border-radius:2px;background:#d4ede2;outline:none;cursor:pointer}
.rng input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--g);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.12)}
.rng span{font-size:.62rem;color:var(--g);font-weight:700;min-width:16px;text-align:right}

/* CANVAS */
.cv-area{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
  background:#e8ecf0;
  background-image:linear-gradient(45deg,#dfe3e8 25%,transparent 25%),linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#dfe3e8 75%),linear-gradient(-45deg,transparent 75%,#dfe3e8 75%);
  background-size:16px 16px;background-position:0 0,0 8px,8px -8px,-8px 0}

.cv-box{position:relative;display:inline-block;box-shadow:0 3px 24px rgba(0,0,0,.08);max-width:92%;max-height:76vh}
.cv-result{position:relative;display:block}
.cv-ck{position:absolute;inset:0;
  background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);
  background-size:12px 12px;background-position:0 0,0 6px,6px -6px,-6px 0;z-index:0;border-radius:3px}
.cv-clr{position:absolute;inset:0;z-index:0;border-radius:3px;display:none}
#resC{position:relative;display:block;z-index:1}

.ov{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:5}
.ov img{display:block;width:100%;height:100%;object-fit:contain}
.sline{position:absolute;top:0;bottom:0;width:3px;background:#fff;z-index:10;cursor:ew-resize;box-shadow:-1px 0 4px rgba(0,0,0,.12),1px 0 4px rgba(0,0,0,.12)}
.sknob{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:#fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;cursor:ew-resize;font-size:.5rem;color:var(--g);font-weight:900}
.slbl{position:absolute;top:8px;padding:3px 8px;border-radius:5px;font-size:.6rem;font-weight:700;pointer-events:none;z-index:12}
.slbl.bf{left:8px;background:rgba(0,0,0,.5);color:#fff}
.slbl.af{right:8px;background:rgba(29,156,115,.8);color:#fff}

.zbar{position:absolute;bottom:8px;right:8px;display:flex;gap:2px;background:#fff;border-radius:7px;padding:3px;box-shadow:0 2px 8px rgba(0,0,0,.06);border:1px solid #e5e7eb;z-index:20}
.zb{width:26px;height:26px;border:none;border-radius:5px;background:#f5f5f5;color:#555;cursor:pointer;font-size:.72rem;display:flex;align-items:center;justify-content:center;transition:all .1s}
.zb:hover{background:var(--g);color:#fff}
.zi{display:flex;align-items:center;padding:0 5px;font-size:.66rem;color:#999;font-weight:700}

/* BOTTOM */
.bbar{background:#fff;border-top:1px solid #e0ece5;padding:8px 12px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;flex-shrink:0}
.bl{font-size:.68rem;font-weight:600;color:#aaa}
.bgr{display:flex;gap:4px;align-items:center}
.bg{width:22px;height:22px;border-radius:6px;cursor:pointer;border:2px solid #e0ece5;transition:all .1s;flex-shrink:0}
.bg:hover{border-color:var(--g);transform:scale(1.08)}
.bg.on{border-color:var(--g);box-shadow:0 0 0 1.5px rgba(29,156,115,.15)}
.bg.ck{background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:6px 6px;background-position:0 0,0 3px,3px -3px,-3px 0}
.bg-cc{overflow:hidden;display:flex;align-items:center;justify-content:center;padding:0;border:2px solid #e0ece5;border-radius:6px}
.bg-cc input{width:100%;height:100%;border:none;cursor:pointer;padding:0;background:none}
.bbr{margin-left:auto;display:flex;gap:5px;align-items:center}
.bi{font-size:.66rem;color:#bbb}
.bi b{color:var(--g)}

/* BRUSH CURSOR */
.bcur{position:fixed;pointer-events:none;border-radius:50%;z-index:200;display:none}

.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%) translateY(80px);background:#fff;color:#333;padding:9px 18px;border-radius:9px;font-size:.8rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.08);z-index:300;transition:transform .3s;border-left:4px solid var(--g);max-width:92vw}
.toast.er{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

footer{text-align:center;padding:8px;color:#c8c8c8;font-size:.64rem;border-top:1px solid #eef0f3;background:#fff;flex-shrink:0}
footer b{color:var(--g)}

@media(max-width:768px){
  .btn span.tx{display:none}
  .cv-box{max-width:96%;max-height:66vh}
  .tools{padding:5px 7px;gap:3px}
  .tb{padding:4px 8px;font-size:.65rem}
  .sep{display:none}
  .rng label{display:none}
  .rng input[type=range]{width:50px}
}
@media(max-width:480px){
  .hero h1{font-size:1.15rem}
  #drop{padding:28px 14px}
  .di{font-size:2rem}
  .tb{padding:4px 6px;font-size:.6rem;gap:1px}
  .sknob{width:26px;height:26px}
  .bg{width:20px;height:20px}
}
</style>
</head>
<body>

<nav>
  <span class="nt">Remove Background</span>
  <div class="nr" id="navB" style="display:none">
    <button class="btn btn-s" onclick="goHome()">+ <span class="tx">New</span></button>
    <button class="btn btn-p" onclick="dlPng()">‚§ì <span class="tx">Download PNG</span></button>
  </div>
</nav>

<!-- ====== UPLOAD ====== -->
<div class="scr on" id="s1">
  <div class="hero">
    <h1>Remove Image <b>Background</b></h1>
    <p>AI-powered background removal. Professional quality results in seconds.</p>
  </div>
  <div id="drop">
    <div class="di">üñºÔ∏è</div>
    <div class="dt">Drag & drop your image here</div>
    <div class="dh">or</div>
    <button class="db" onclick="E('fi').click()">Select Image</button>
    <div class="df">JPG, PNG, WEBP ‚Äî Up to 20MB</div>
  </div>
  <div class="note">‚ö° First use downloads AI model (~20MB, cached for instant future use). After that, removal takes only 5-10 seconds.</div>
  <input type="file" id="fi" accept="image/*">
</div>

<!-- ====== PROCESSING ====== -->
<div class="scr" id="s2">
  <div class="pcard">
    <div class="pprev" id="pp"></div>
    <div class="psteps">
      <div class="ps"><div class="ps-dot" id="d1">1</div></div>
      <div class="ps-line" id="l1"></div>
      <div class="ps"><div class="ps-dot" id="d2">2</div></div>
      <div class="ps-line" id="l2"></div>
      <div class="ps"><div class="ps-dot" id="d3">3</div></div>
    </div>
    <div class="pt" id="pT">Initializing AI...</div>
    <div class="pd" id="pD">Please wait</div>
    <div class="pbar"><div class="pfill" id="pF"></div></div>
    <div class="ppct" id="pP">0%</div>
    <div class="ptip" id="pTip">Loading AI background removal engine...</div>
  </div>
</div>

<!-- ====== RESULT ====== -->
<div class="scr" id="s3">
  <div class="tools">
    <button class="tb on" id="bView" onclick="setT('view')">üëÅ Compare</button>
    <button class="tb" id="bWand" onclick="setT('wand')">ü™Ñ Remove Area</button>
    <button class="tb" id="bErase" onclick="setT('erase')">üßπ Erase</button>
    <button class="tb" id="bRestore" onclick="setT('restore')">‚úèÔ∏è Restore</button>
    <div class="sep"></div>
    <div class="rng"><label>Tolerance</label><input type="range" min="5" max="80" value="30" id="rTol" oninput="E('vTol').textContent=this.value"><span id="vTol">30</span></div>
    <div class="rng"><label>Brush</label><input type="range" min="4" max="80" value="20" id="rBr" oninput="E('vBr').textContent=this.value"><span id="vBr">20</span></div>
    <div class="sep"></div>
    <button class="tb" onclick="undo()">‚Ü©</button>
    <button class="tb" onclick="redo()">‚Ü™</button>
    <button class="tb rd" onclick="reRun()">‚Ü∫ Redo AI</button>
  </div>

  <div class="cv-area" id="cvA">
    <div class="cv-box" id="cvBox">
      <div class="cv-result">
        <div class="cv-ck" id="cvCk"></div>
        <div class="cv-clr" id="cvClr"></div>
        <canvas id="resC"></canvas>
      </div>
      <div class="ov" id="ov"><img id="oImg" src="" alt=""></div>
      <div class="sline" id="sLine"><div class="sknob">‚óÄ‚ñ∂</div></div>
      <div class="slbl bf">BEFORE</div>
      <div class="slbl af">AFTER</div>
    </div>
    <div class="zbar">
      <button class="zb" onclick="zm(-10)">‚àí</button>
      <div class="zi" id="zL">100%</div>
      <button class="zb" onclick="zm(10)">+</button>
      <button class="zb" onclick="zFit()">‚ä°</button>
    </div>
  </div>

  <div class="bbar">
    <span class="bl">BG:</span>
    <div class="bgr">
      <div class="bg ck on" onclick="setBG('ck',this)"></div>
      <div class="bg" style="background:#fff" onclick="setBG('#fff',this)"></div>
      <div class="bg" style="background:#000" onclick="setBG('#000',this)"></div>
      <div class="bg" style="background:#e53935" onclick="setBG('#e53935',this)"></div>
      <div class="bg" style="background:#1e88e5" onclick="setBG('#1e88e5',this)"></div>
      <div class="bg" style="background:#43a047" onclick="setBG('#43a047',this)"></div>
      <div class="bg" style="background:#fb8c00" onclick="setBG('#fb8c00',this)"></div>
      <div class="bg-cc"><input type="color" value="#e0e0e0" onchange="setBG(this.value,this.parentElement)"></div>
    </div>
    <div class="bbr">
      <span class="bi" id="bInfo"></span>
      <button class="btn btn-s" onclick="goHome()">+ New</button>
      <button class="btn btn-p" onclick="dlPng()">‚§ì Download</button>
    </div>
  </div>
</div>

<div class="bcur" id="bcur"></div>
<footer><b>Remove Background</b> ‚Äî AI-powered, free & 100% private</footer>
<div class="toast" id="toastEl"></div>

<script>
const E=id=>document.getElementById(id);
let removeBgFn=null,origImg=null,origUrl=null,origData=null;
let RC,RX,W=0,H=0,zoom=100,tool='view';
let painting=false,lastP=null,hist=[],hI=-1,curBG='ck';

document.addEventListener('DOMContentLoaded',()=>{
  RC=E('resC');RX=RC.getContext('2d',{willReadFrequently:true});
  const fi=E('fi'),dz=E('drop');
  fi.addEventListener('change',e=>{if(e.target.files[0])go(e.target.files[0]);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});
  ['dragenter','dragover'].forEach(v=>dz.addEventListener(v,e=>{e.preventDefault();dz.classList.add('over')}));
  ['dragleave','drop'].forEach(v=>dz.addEventListener(v,e=>{e.preventDefault();dz.classList.remove('over')}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])go(e.dataTransfer.files[0])});
  document.addEventListener('paste',e=>{
    const it=e.clipboardData?.items;if(!it)return;
    for(let i of it)if(i.type.startsWith('image/')){e.preventDefault();go(i.getAsFile());break}
  });
  RC.addEventListener('mousedown',e=>{if(tool!=='view')pD(gP(e))});
  RC.addEventListener('mousemove',e=>{pM(gP(e));showB(e)});
  RC.addEventListener('mouseup',pU);
  RC.addEventListener('mouseleave',()=>{pU();E('bcur').style.display='none'});
  RC.addEventListener('touchstart',e=>{if(tool!=='view'){e.preventDefault();pD(gTP(e))}},{passive:false});
  RC.addEventListener('touchmove',e=>{if(tool!=='view'){e.preventDefault();pM(gTP(e))}},{passive:false});
  RC.addEventListener('touchend',e=>{if(tool!=='view'){e.preventDefault();pU()}},{passive:false});
  initSlider();
  window.addEventListener('resize',()=>{if(origImg)zFit()});
});

function gP(e){const r=RC.getBoundingClientRect();return{x:Math.round((e.clientX-r.left)*(W/r.width)),y:Math.round((e.clientY-r.top)*(H/r.height))}}
function gTP(e){const t=e.touches[0],r=RC.getBoundingClientRect();return{x:Math.round((t.clientX-r.left)*(W/r.width)),y:Math.round((t.clientY-r.top)*(H/r.height))}}

// ========== MAIN FLOW ==========
async function go(file){
  if(!file.type.startsWith('image/')){toast('Select an image',1);return}
  if(file.size>20*1024*1024){toast('Max 20MB',1);return}
  origUrl=URL.createObjectURL(file);
  E('pp').innerHTML=`<img src="${origUrl}">`;
  scr(2);
  step(1,'Loading AI Model...','Downloading background removal engine',5);
  E('pTip').textContent='‚è≥ First time: ~20 sec download. After that it\'s cached & instant.';

  try{
    if(!removeBgFn){
      step(1,'Downloading AI Model...','This only happens once, then it\'s cached',10);
      const mod=await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.5/+esm');
      removeBgFn=mod.removeBackground||mod.default;
    }

    step(2,'Analyzing Image...','AI is detecting the subject',35);
    E('pTip').textContent='üß† AI is processing your image...';

    const img=new Image();
    await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=origUrl});
    origImg=img;
    W=img.naturalWidth;H=img.naturalHeight;
    const MX=2048;
    if(W>MX||H>MX){const s=Math.min(MX/W,MX/H);W=Math.round(W*s);H=Math.round(H*s)}

    // Save original
    const tc=document.createElement('canvas');tc.width=W;tc.height=H;
    tc.getContext('2d').drawImage(img,0,0,W,H);
    origData=tc.getContext('2d').getImageData(0,0,W,H);

    // Prepare blob
    const blob=await new Promise(r=>tc.toBlob(r,'image/png'));

    step(2,'Removing Background...','AI is separating foreground from background',45);

    const result=await removeBgFn(blob,{
      output:{format:'image/png',quality:1},
      progress:(key,cur,tot)=>{
        if(tot>0){
          const p=cur/tot;
          if(key.includes('fetch')||key.includes('load')){
            const pct=Math.round(10+p*25);
            prog(pct);
            E('pD').textContent='Downloading model: '+Math.round(p*100)+'%';
          }else if(key.includes('compute')||key.includes('inference')){
            const pct=Math.round(45+p*50);
            prog(pct);
            if(p>0.5)step(3,'Almost Done...','Finalizing transparent image',pct);
          }
        }
      }
    });

    step(3,'Finalizing...',  'Preparing result',95);
    prog(95);

    // Draw result
    const rImg=new Image();
    const rUrl=URL.createObjectURL(result);
    await new Promise((res,rej)=>{rImg.onload=res;rImg.onerror=rej;rImg.src=rUrl});

    RC.width=W;RC.height=H;
    RX.clearRect(0,0,W,H);
    RX.drawImage(rImg,0,0,W,H);
    URL.revokeObjectURL(rUrl);

    E('oImg').src=origUrl;
    E('bInfo').innerHTML=`<b>${W}√ó${H}</b>`;
    E('navB').style.display='flex';

    hist=[];hI=-1;saveH();
    prog(100);

    setTimeout(()=>{
      scr(3);
      zFit();
      updSlider(50);
      setT('view');
      toast('‚úì Background removed successfully!');
    },300);

  }catch(err){
    console.error(err);
    scr(1);
    toast('Failed: '+err.message+'. Please try again.',1);
  }
}

// ========== PROCESSING UI ==========
function step(n,title,desc,pct){
  E('pT').textContent=title;
  E('pD').textContent=desc;
  if(pct!==undefined)prog(pct);
  for(let i=1;i<=3;i++){
    const d=E('d'+i);d.classList.remove('act','done');
    if(i<n){d.classList.add('done');d.textContent='‚úì'}
    else if(i===n){d.classList.add('act');d.textContent=i}
    else d.textContent=i;
  }
  E('l1').classList.toggle('done',n>1);
  E('l2').classList.toggle('done',n>2);
}
function prog(p){E('pF').style.width=p+'%';E('pP').textContent=p+'%'}

// ========== SCREENS ==========
function scr(n){for(let i=1;i<=3;i++)E('s'+i).classList.toggle('on',i===n)}
function goHome(){scr(1);E('navB').style.display='none';origImg=null;origData=null;hist=[];hI=-1;
  if(origUrl)URL.revokeObjectURL(origUrl);origUrl=null;setBG('ck',document.querySelector('.bg.ck'));setT('view')}

// ========== TOOLS ==========
function setT(t){
  tool=t;
  ['View','Wand','Erase','Restore'].forEach(n=>E('b'+n).classList.remove('on'));
  E('b'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('on');
  const cv=t==='view';
  E('ov').style.display=cv?'':'none';
  E('sLine').style.display=cv?'':'none';
  document.querySelectorAll('.slbl').forEach(l=>l.style.display=cv?'':'none');
  RC.style.cursor=t==='erase'||t==='restore'?'none':t==='wand'?'crosshair':'default';
  E('bcur').style.display='none';
}

function showB(e){
  if(tool!=='erase'&&tool!=='restore')return;
  const c=E('bcur'),sz=parseInt(E('rBr').value)*zoom/100;
  c.style.display='block';c.style.width=sz+'px';c.style.height=sz+'px';
  c.style.left=(e.clientX-sz/2)+'px';c.style.top=(e.clientY-sz/2)+'px';
  c.style.border=`2px solid ${tool==='erase'?'#e74c3c':'#1d9c73'}`;
  c.style.background=tool==='erase'?'rgba(231,76,60,.06)':'rgba(29,156,115,.06)';
}

// ========== POINTER ==========
function pD(pt){
  if(tool==='wand'){wandAt(pt);return}
  painting=true;lastP=pt;bAt(pt);
}
function pM(pt){if(!painting)return;if(tool==='erase'||tool==='restore'){bLine(lastP,pt);lastP=pt}}
function pU(){if(painting){painting=false;lastP=null;saveH()}}

function wandAt(pt){
  if(pt.x<0||pt.x>=W||pt.y<0||pt.y>=H)return;
  const tol=parseInt(E('rTol').value),data=RX.getImageData(0,0,W,H),d=data.data;
  const si=(pt.y*W+pt.x)*4,sr=d[si],sg=d[si+1],sb=d[si+2],tolSq=tol*tol*3;
  if(d[si+3]===0){toast('Already transparent');return}
  const vis=new Uint8Array(W*H),rem=[],q=[pt.y*W+pt.x];
  while(q.length){
    const idx=q.pop();if(vis[idx])continue;vis[idx]=1;
    const pi=idx*4;if(d[pi+3]===0)continue;
    const dr=d[pi]-sr,dg=d[pi+1]-sg,db=d[pi+2]-sb;
    if(dr*dr+dg*dg+db*db>tolSq)continue;
    rem.push(idx);
    const x=idx%W,y=(idx/W)|0;
    if(x>0&&!vis[idx-1])q.push(idx-1);
    if(x<W-1&&!vis[idx+1])q.push(idx+1);
    if(y>0&&!vis[idx-W])q.push(idx-W);
    if(y<H-1&&!vis[idx+W])q.push(idx+W);
  }
  rem.forEach(i=>{d[i*4+3]=0});
  RX.putImageData(data,0,0);saveH();
  toast(`‚úì Removed ${rem.toLocaleString().length>3?rem.length.toLocaleString():rem.length} px`);
}

function bAt(pt){
  const sz=parseInt(E('rBr').value),r=sz/2;
  if(tool==='erase'){
    RX.save();RX.globalCompositeOperation='destination-out';
    RX.beginPath();RX.arc(pt.x,pt.y,r,0,Math.PI*2);RX.fill();RX.restore();
  }else if(tool==='restore'&&origData){
    const x0=Math.max(0,pt.x-r|0),y0=Math.max(0,pt.y-r|0);
    const x1=Math.min(W,Math.ceil(pt.x+r)),y1=Math.min(H,Math.ceil(pt.y+r));
    const data=RX.getImageData(x0,y0,x1-x0,y1-y0);
    const dd=data.data,od=origData.data;
    for(let y=y0;y<y1;y++)for(let x=x0;x<x1;x++){
      const dx=x-pt.x,dy=y-pt.y;
      if(dx*dx+dy*dy<=r*r){
        const di=((y-y0)*(x1-x0)+(x-x0))*4,oi=(y*W+x)*4;
        dd[di]=od[oi];dd[di+1]=od[oi+1];dd[di+2]=od[oi+2];dd[di+3]=od[oi+3];
      }
    }
    RX.putImageData(data,x0,y0);
  }
}

function bLine(a,b){
  const dx=b.x-a.x,dy=b.y-a.y,dist=Math.sqrt(dx*dx+dy*dy);
  const n=Math.max(1,dist/2|0);
  for(let i=0;i<=n;i++){const t=i/n;bAt({x:Math.round(a.x+dx*t),y:Math.round(a.y+dy*t)})}
}

// ========== HISTORY ==========
function saveH(){hI++;hist=hist.slice(0,hI);hist.push(RX.getImageData(0,0,W,H));if(hist.length>20){hist.shift();hI--}}
function undo(){if(hI<=0)return;hI--;RX.putImageData(hist[hI],0,0);toast('‚Ü© Undo')}
function redo(){if(hI>=hist.length-1)return;hI++;RX.putImageData(hist[hI],0,0);toast('‚Ü™ Redo')}
function reRun(){if(!origImg)return;go_reprocess()}

async function go_reprocess(){
  if(!removeBgFn||!origData)return;
  scr(2);step(2,'Re-processing...','Running AI again',40);
  E('pTip').textContent='üß† Re-analyzing image...';
  try{
    const tc=document.createElement('canvas');tc.width=W;tc.height=H;
    tc.getContext('2d').putImageData(origData,0,0);
    const blob=await new Promise(r=>tc.toBlob(r,'image/png'));
    const result=await removeBgFn(blob,{
      output:{format:'image/png',quality:1},
      progress:(key,cur,tot)=>{if(tot>0){const p=Math.round(40+cur/tot*55);prog(p)}}
    });
    const rImg=new Image();
    const rUrl=URL.createObjectURL(result);
    await new Promise((res,rej)=>{rImg.onload=res;rImg.onerror=rej;rImg.src=rUrl});
    RC.width=W;RC.height=H;RX.clearRect(0,0,W,H);RX.drawImage(rImg,0,0,W,H);
    URL.revokeObjectURL(rUrl);
    hist=[];hI=-1;saveH();prog(100);
    setTimeout(()=>{scr(3);zFit();updSlider(50);toast('‚úì Re-processed!')},200);
  }catch(err){scr(3);toast('Re-process failed',1)}
}

// ========== SLIDER ==========
function initSlider(){
  const box=E('cvBox');let drag=false;
  function pos(e){const r=box.getBoundingClientRect();const cx=e.touches?e.touches[0].clientX:e.clientX;return Math.max(0,Math.min(100,((cx-r.left)/r.width)*100))}
  box.addEventListener('mousedown',e=>{if(tool==='view'){drag=true;updSlider(pos(e))}});
  window.addEventListener('mousemove',e=>{if(drag){e.preventDefault();updSlider(pos(e))}});
  window.addEventListener('mouseup',()=>drag=false);
  box.addEventListener('touchstart',e=>{if(tool==='view'){drag=true;updSlider(pos(e))}},{passive:true});
  window.addEventListener('touchmove',e=>{if(drag)updSlider(pos(e))},{passive:true});
  window.addEventListener('touchend',()=>drag=false);
}
function updSlider(p){E('ov').style.clipPath=`inset(0 ${100-p}% 0 0)`;E('sLine').style.left=p+'%'}

// ========== ZOOM ==========
function zm(d){zoom=Math.max(20,Math.min(400,zoom+d));apZ()}
function zFit(){const a=E('cvA');zoom=Math.round(Math.min((a.clientWidth-24)/W,(a.clientHeight-24)/H)*100);zoom=Math.max(20,Math.min(400,zoom));apZ()}
function apZ(){const b=E('cvBox');b.style.width=Math.round(W*zoom/100)+'px';b.style.height=Math.round(H*zoom/100)+'px';RC.style.width='100%';RC.style.height='100%';E('zL').textContent=zoom+'%'}

// ========== BG ==========
function setBG(bg,el){
  document.querySelectorAll('.bg,.bg-cc').forEach(b=>b.classList.remove('on'));
  if(el)el.classList.add('on');curBG=bg;
  E('cvCk').style.display=bg==='ck'?'block':'none';
  E('cvClr').style.display=bg==='ck'?'none':'block';
  if(bg!=='ck')E('cvClr').style.backgroundColor=bg;
}

// ========== DOWNLOAD ==========
function dlPng(){
  if(!origImg)return;
  const c=document.createElement('canvas');c.width=W;c.height=H;
  const cx=c.getContext('2d');
  if(curBG!=='ck'){cx.fillStyle=curBG;cx.fillRect(0,0,W,H)}
  cx.drawImage(RC,0,0);
  c.toBlob(b=>{
    const u=URL.createObjectURL(b),a=document.createElement('a');
    a.href=u;a.download='no-background.png';document.body.appendChild(a);a.click();
    document.body.removeChild(a);URL.revokeObjectURL(u);toast('‚§ì Downloaded!')
  },'image/png');
}

function toast(m,e){const t=E('toastEl');t.textContent=m;t.className='toast'+(e?' er':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
