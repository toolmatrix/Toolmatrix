<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Remove Background - Fast & Free</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;height:100vh}

nav{background:#fff;padding:11px 18px;display:flex;align-items:center;border-bottom:1px solid #e0ece5;box-shadow:0 1px 3px rgba(0,0,0,.03);z-index:100;min-height:48px}
.nt{font-weight:700;font-size:1rem;color:#1d9c73}
.nr{margin-left:auto;display:flex;gap:6px}
.nb{padding:7px 14px;border:none;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:4px;white-space:nowrap}
.nb.sec{background:#f0f5f2;color:#555}
.nb.sec:hover{background:#e0ece5}
.nb.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;box-shadow:0 2px 8px rgba(29,156,115,.18)}
.nb.pri:hover{box-shadow:0 4px 12px rgba(29,156,115,.28);transform:translateY(-1px)}

/* UPLOAD */
#uploadScreen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;background:linear-gradient(180deg,#e8f6ef 0%,#f5f7fa 100%)}
#uploadScreen.hidden{display:none}
.ut{font-size:1.6rem;font-weight:800;color:#222;margin-bottom:6px;text-align:center}
.ut span{color:#1d9c73}
.ud{color:#888;font-size:.88rem;margin-bottom:24px;text-align:center;max-width:480px;line-height:1.5}
#dropZone{width:100%;max-width:560px;padding:44px 24px;border:2.5px dashed #b8dfc9;border-radius:16px;background:#fff;text-align:center;cursor:pointer;transition:all .25s}
#dropZone:hover,#dropZone.dragover{border-color:#1d9c73;background:#f0faf5;transform:translateY(-2px);box-shadow:0 8px 25px rgba(29,156,115,.07)}
.dzi{font-size:2.8rem;margin-bottom:10px;opacity:.5}
.dzt{font-size:.95rem;color:#666;font-weight:500;margin-bottom:3px}
.dzh{font-size:.8rem;color:#bbb;margin-bottom:14px}
.dzb{padding:11px 30px;background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;border:none;border-radius:28px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.2)}
.dzb:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.28)}
.dzf{font-size:.7rem;color:#ccc;margin-top:12px}
#fileInput{display:none}

/* EDITOR */
#editor{display:none;flex:1;flex-direction:column;overflow:hidden}
#editor.active{display:flex}

/* TOOLBAR */
.tbar{background:#fff;border-bottom:1px solid #e0ece5;padding:8px 12px;display:flex;align-items:center;gap:6px;overflow-x:auto;min-height:46px;flex-shrink:0}
.tbar::-webkit-scrollbar{height:0}
.tbtn{padding:6px 12px;border:1.5px solid #e0ece5;border-radius:8px;background:#fff;color:#555;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.tbtn:hover{border-color:#1d9c73;color:#1d9c73}
.tbtn.active{background:#eef9f3;border-color:#1d9c73;color:#1d9c73}
.tbtn.danger{border-color:#fde2e2;color:#e74c3c}
.tbtn.danger:hover{background:#fdf2f2}
.tsep{width:1px;height:24px;background:#e0ece5;flex-shrink:0}
.tslider{display:flex;align-items:center;gap:5px;white-space:nowrap}
.tslider label{font-size:.7rem;font-weight:600;color:#888}
.tslider input[type="range"]{width:80px;-webkit-appearance:none;height:4px;border-radius:2px;background:#d4ede2;outline:none;cursor:pointer}
.tslider input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#1d9c73;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.tslider span{font-size:.68rem;color:#1d9c73;font-weight:700;min-width:24px}

/* CANVAS AREA */
.canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;
  background:#e8ecf0;
  background-image:linear-gradient(45deg,#dfe3e8 25%,transparent 25%),linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#dfe3e8 75%),linear-gradient(-45deg,transparent 75%,#dfe3e8 75%);
  background-size:16px 16px;background-position:0 0,0 8px,8px -8px,-8px 0}
.canvas-inner{position:relative;display:inline-block;box-shadow:0 4px 30px rgba(0,0,0,.1)}
#mainCanvas{display:block;cursor:crosshair}
.cursor-preview{position:fixed;pointer-events:none;border:2px solid #1d9c73;border-radius:50%;z-index:200;display:none}

/* ZOOM */
.zbar{position:absolute;bottom:10px;right:10px;display:flex;gap:3px;background:#fff;border-radius:8px;padding:3px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid #e5e7eb;z-index:20}
.zb{width:28px;height:28px;border:none;border-radius:6px;background:#f5f5f5;color:#555;cursor:pointer;font-size:.78rem;display:flex;align-items:center;justify-content:center;transition:all .1s}
.zb:hover{background:#1d9c73;color:#fff}
.zi{display:flex;align-items:center;padding:0 6px;font-size:.7rem;color:#888;font-weight:700}

/* BOTTOM BAR */
.bbar{background:#fff;border-top:1px solid #e0ece5;padding:8px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex-shrink:0;min-height:44px}
.bbar-label{font-size:.72rem;font-weight:600;color:#888}
.bg-opts{display:flex;gap:4px;align-items:center}
.bgo{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid #e0ece5;transition:all .1s;flex-shrink:0}
.bgo:hover{border-color:#1d9c73;transform:scale(1.1)}
.bgo.active{border-color:#1d9c73;box-shadow:0 0 0 1.5px rgba(29,156,115,.2)}
.bgo.ck{background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:6px 6px;background-position:0 0,0 3px,3px -3px,-3px 0}
.bbar-right{margin-left:auto;display:flex;gap:6px;align-items:center}
.bbar-info{font-size:.7rem;color:#aaa}
.bbar-info span{color:#1d9c73;font-weight:600}

.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(80px);background:#fff;color:#333;padding:10px 20px;border-radius:10px;font-size:.82rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);z-index:300;transition:transform .3s;border-left:4px solid #1d9c73}
.toast.err{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

.lov{position:fixed;inset:0;background:rgba(255,255,255,.88);display:none;align-items:center;justify-content:center;z-index:400;flex-direction:column;gap:10px}
.lov.active{display:flex}
.spn{width:40px;height:40px;border:4px solid #e0ece5;border-top-color:#1d9c73;border-radius:50%;animation:sp .6s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.lov-t{color:#888;font-size:.85rem;font-weight:500}

@media(max-width:768px){
  .nb span.txt{display:none}
  .tbar{gap:4px;padding:6px 8px}
  .tbtn{padding:5px 9px;font-size:.68rem}
  .tslider input[type="range"]{width:60px}
  .bbar{padding:6px 10px}
}
@media(max-width:480px){
  .ut{font-size:1.2rem}
  #dropZone{padding:30px 16px}
  .dzi{font-size:2.2rem}
  .tbtn{padding:5px 7px;font-size:.65rem;gap:2px}
  .tsep{display:none}
}
</style>
</head>
<body>

<nav>
  <span class="nt">Remove Background</span>
  <div class="nr" id="navBtns" style="display:none">
    <button class="nb sec" onclick="newImage()">+ <span class="txt">New</span></button>
    <button class="nb pri" onclick="downloadPNG()">‚§ì <span class="txt">Download PNG</span></button>
  </div>
</nav>

<!-- UPLOAD -->
<div id="uploadScreen">
  <div class="ut">Remove <span>Background</span> Instantly</div>
  <div class="ud">Remove backgrounds from images in seconds. No AI download needed ‚Äî works 100% in your browser, fast and private.</div>
  <div id="dropZone">
    <div class="dzi">üñºÔ∏è</div>
    <div class="dzt">Drag & drop your image here</div>
    <div class="dzh">or</div>
    <button class="dzb" onclick="document.getElementById('fileInput').click()">Select Image</button>
    <div class="dzf">JPG, PNG, WEBP ‚Äî Up to 20MB</div>
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- EDITOR -->
<div id="editor">
  <!-- TOOLBAR -->
  <div class="tbar">
    <button class="tbtn active" id="btnAuto" onclick="setTool('auto')">‚ö° Auto Remove</button>
    <button class="tbtn" id="btnWand" onclick="setTool('wand')">ü™Ñ Magic Wand</button>
    <button class="tbtn" id="btnErase" onclick="setTool('erase')">üßπ Erase Brush</button>
    <button class="tbtn" id="btnRestore" onclick="setTool('restore')">‚úèÔ∏è Restore Brush</button>
    <div class="tsep"></div>
    <div class="tslider">
      <label>Tolerance:</label>
      <input type="range" min="5" max="80" value="30" id="tolerance">
      <span id="tolVal">30</span>
    </div>
    <div class="tslider">
      <label>Brush:</label>
      <input type="range" min="5" max="80" value="20" id="brushSize">
      <span id="brVal">20</span>
    </div>
    <div class="tslider">
      <label>Edge:</label>
      <input type="range" min="0" max="10" value="2" id="edgeSmooth">
      <span id="edVal">2</span>
    </div>
    <div class="tsep"></div>
    <button class="tbtn" onclick="undo()">‚Ü© Undo</button>
    <button class="tbtn" onclick="redo()">‚Ü™ Redo</button>
    <button class="tbtn danger" onclick="resetImage()">‚Ü∫ Reset</button>
  </div>

  <!-- CANVAS -->
  <div class="canvas-wrap" id="canvasWrap">
    <div class="canvas-inner" id="canvasInner">
      <canvas id="mainCanvas"></canvas>
    </div>
    <div class="zbar">
      <button class="zb" onclick="doZoom(-10)">‚àí</button>
      <div class="zi" id="zLbl">100%</div>
      <button class="zb" onclick="doZoom(10)">+</button>
      <button class="zb" onclick="fitZoom()">‚ä°</button>
    </div>
  </div>

  <!-- BOTTOM -->
  <div class="bbar">
    <span class="bbar-label">BG:</span>
    <div class="bg-opts">
      <div class="bgo ck active" onclick="setPreviewBg('checker',this)" title="Transparent"></div>
      <div class="bgo" style="background:#fff" onclick="setPreviewBg('#fff',this)" title="White"></div>
      <div class="bgo" style="background:#000" onclick="setPreviewBg('#000',this)" title="Black"></div>
      <div class="bgo" style="background:#f44336" onclick="setPreviewBg('#f44336',this)" title="Red"></div>
      <div class="bgo" style="background:#2196f3" onclick="setPreviewBg('#2196f3',this)" title="Blue"></div>
      <div class="bgo" style="background:#4caf50" onclick="setPreviewBg('#4caf50',this)" title="Green"></div>
    </div>
    <div class="bbar-right">
      <span class="bbar-info" id="imgInfoTxt"></span>
      <button class="nb sec" onclick="newImage()">+ New</button>
      <button class="nb pri" onclick="downloadPNG()">‚§ì Download</button>
    </div>
  </div>
</div>

<!-- CURSOR -->
<div class="cursor-preview" id="cursorPrev"></div>

<!-- LOADING -->
<div class="lov" id="loading"><div class="spn"></div><div class="lov-t" id="loadTxt">Processing...</div></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let C,X,origImg=null,origData=null;
let imgW=0,imgH=0,zoom=100;
let tool='auto';
let painting=false,lastPt=null;
let history=[],hIdx=-1;
let previewBg='checker';

const $ = id => document.getElementById(id);

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
  C=$('mainCanvas');
  X=C.getContext('2d',{willReadFrequently:true});

  const fi=$('fileInput'),dz=$('dropZone');
  fi.addEventListener('change',e=>{if(e.target.files[0])loadFile(e.target.files[0]);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])});
  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items;if(!items)return;
    for(let i of items)if(i.type.startsWith('image/')){e.preventDefault();loadFile(i.getAsFile());break}
  });

  // Canvas events
  C.addEventListener('mousedown',e=>pDown(getP(e)));
  C.addEventListener('mousemove',e=>{pMove(getP(e));showCursor(e)});
  C.addEventListener('mouseup',()=>pUp());
  C.addEventListener('mouseleave',()=>{pUp();$('cursorPrev').style.display='none'});
  C.addEventListener('touchstart',e=>{e.preventDefault();pDown(getTP(e))},{passive:false});
  C.addEventListener('touchmove',e=>{e.preventDefault();pMove(getTP(e))},{passive:false});
  C.addEventListener('touchend',e=>{e.preventDefault();pUp()},{passive:false});

  $('tolerance').oninput=function(){$('tolVal').textContent=this.value};
  $('brushSize').oninput=function(){$('brVal').textContent=this.value};
  $('edgeSmooth').oninput=function(){$('edVal').textContent=this.value};

  window.addEventListener('resize',()=>{if(origImg)fitZoom()});
});

function getP(e){
  const r=C.getBoundingClientRect();
  return{x:Math.round((e.clientX-r.left)*(C.width/r.width)),y:Math.round((e.clientY-r.top)*(C.height/r.height))}
}
function getTP(e){
  const t=e.touches[0];const r=C.getBoundingClientRect();
  return{x:Math.round((t.clientX-r.left)*(C.width/r.width)),y:Math.round((t.clientY-r.top)*(C.height/r.height))}
}

// ===== LOAD =====
function loadFile(file){
  if(!file.type.startsWith('image/')){toast('Select an image file',true);return}
  if(file.size>20*1024*1024){toast('Max 20MB',true);return}
  showLoad('Loading image...');
  const img=new Image();
  img.onload=()=>{
    origImg=img;
    imgW=img.naturalWidth;imgH=img.naturalHeight;
    // Limit for performance
    const MAX=2400;
    if(imgW>MAX||imgH>MAX){
      const s=Math.min(MAX/imgW,MAX/imgH);
      imgW=Math.round(imgW*s);imgH=Math.round(imgH*s);
    }
    C.width=imgW;C.height=imgH;
    X.drawImage(img,0,0,imgW,imgH);
    origData=X.getImageData(0,0,imgW,imgH);
    $('uploadScreen').classList.add('hidden');
    $('editor').classList.add('active');
    $('navBtns').style.display='flex';
    $('imgInfoTxt').innerHTML=`${imgW}√ó${imgH}`;
    history=[];hIdx=-1;saveHist();
    fitZoom();hideLoad();
    toast('‚úì Image loaded ‚Äî choose a tool to remove background');
  };
  img.onerror=()=>{hideLoad();toast('Failed to load image',true)};
  img.src=URL.createObjectURL(file);
}

// ===== TOOLS =====
function setTool(t){
  tool=t;
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('active'));
  if(t==='auto')$('btnAuto').classList.add('active');
  if(t==='wand')$('btnWand').classList.add('active');
  if(t==='erase')$('btnErase').classList.add('active');
  if(t==='restore')$('btnRestore').classList.add('active');
  C.style.cursor=(t==='erase'||t==='restore')?'none':'crosshair';
  $('cursorPrev').style.display='none';
}

function showCursor(e){
  if(tool!=='erase'&&tool!=='restore')return;
  const cp=$('cursorPrev');
  const sz=parseInt($('brushSize').value)*zoom/100;
  cp.style.display='block';
  cp.style.width=sz+'px';cp.style.height=sz+'px';
  cp.style.left=(e.clientX-sz/2)+'px';cp.style.top=(e.clientY-sz/2)+'px';
  cp.style.borderColor=tool==='erase'?'#e74c3c':'#1d9c73';
}

// ===== POINTER =====
function pDown(pt){
  if(tool==='auto'){autoRemove(pt);return}
  if(tool==='wand'){wandRemove(pt);return}
  painting=true;lastPt=pt;
  brushAt(pt);
}
function pMove(pt){
  if(!painting)return;
  if(tool==='erase'||tool==='restore'){
    brushLine(lastPt,pt);
    lastPt=pt;
  }
}
function pUp(){
  if(painting){painting=false;lastPt=null;saveHist()}
}

// ===== AUTO REMOVE =====
function autoRemove(pt){
  showLoad('Removing background...');
  setTimeout(()=>{
    const tol=parseInt($('tolerance').value);
    const edge=parseInt($('edgeSmooth').value);
    const data=X.getImageData(0,0,imgW,imgH);
    const d=data.data;

    // Sample corners + edges for background color
    const samples=[];
    const samplePoints=[
      [0,0],[imgW-1,0],[0,imgH-1],[imgW-1,imgH-1],
      [Math.floor(imgW/2),0],[0,Math.floor(imgH/2)],
      [imgW-1,Math.floor(imgH/2)],[Math.floor(imgW/2),imgH-1]
    ];
    // Also sample along edges
    for(let i=0;i<imgW;i+=Math.max(1,Math.floor(imgW/20))){
      samples.push(getPixel(d,i,0));
      samples.push(getPixel(d,i,imgH-1));
    }
    for(let i=0;i<imgH;i+=Math.max(1,Math.floor(imgH/20))){
      samples.push(getPixel(d,0,i));
      samples.push(getPixel(d,imgW-1,i));
    }
    samplePoints.forEach(([x,y])=>samples.push(getPixel(d,x,y)));

    // Find most common color cluster
    const bgColor=findDominantColor(samples);

    // Create mask
    const mask=new Uint8Array(imgW*imgH);
    const tolSq=tol*tol*3;

    for(let y=0;y<imgH;y++){
      for(let x=0;x<imgW;x++){
        const idx=(y*imgW+x)*4;
        const dr=d[idx]-bgColor[0];
        const dg=d[idx+1]-bgColor[1];
        const db=d[idx+2]-bgColor[2];
        const dist=dr*dr+dg*dg+db*db;
        if(dist<tolSq){
          mask[y*imgW+x]=1;// background
        }
      }
    }

    // Flood fill from edges to ensure only connected bg removed
    const visited=new Uint8Array(imgW*imgH);
    const queue=[];

    // Add edge pixels that are background
    for(let x=0;x<imgW;x++){
      if(mask[x])queue.push(x);
      const bi=(imgH-1)*imgW+x;
      if(mask[bi])queue.push(bi);
    }
    for(let y=0;y<imgH;y++){
      const li=y*imgW;
      if(mask[li])queue.push(li);
      const ri=y*imgW+imgW-1;
      if(mask[ri])queue.push(ri);
    }

    const finalMask=new Uint8Array(imgW*imgH);
    while(queue.length>0){
      const idx=queue.pop();
      if(visited[idx])continue;
      visited[idx]=1;
      if(!mask[idx])continue;
      finalMask[idx]=1;
      const x=idx%imgW,y=Math.floor(idx/imgW);
      if(x>0&&!visited[idx-1])queue.push(idx-1);
      if(x<imgW-1&&!visited[idx+1])queue.push(idx+1);
      if(y>0&&!visited[idx-imgW])queue.push(idx-imgW);
      if(y<imgH-1&&!visited[idx+imgW])queue.push(idx+imgW);
    }

    // Apply edge smoothing
    if(edge>0){
      smoothEdges(finalMask,imgW,imgH,edge);
    }

    // Apply mask
    for(let i=0;i<finalMask.length;i++){
      if(finalMask[i]){
        const a=finalMask[i]===1?0:Math.round((1-finalMask[i])*255);
        d[i*4+3]=a;
      }
    }

    X.putImageData(data,0,0);
    saveHist();hideLoad();
    toast('‚úì Background removed!');
  },50);
}

function getPixel(d,x,y){
  const i=(y*imgW+x)*4;
  return[d[i],d[i+1],d[i+2]];
}

function findDominantColor(samples){
  // Simple averaging of most similar colors
  if(samples.length===0)return[255,255,255];
  let bestR=0,bestG=0,bestB=0,bestCount=0;

  for(let i=0;i<samples.length;i++){
    let count=0;
    let sr=0,sg=0,sb=0;
    for(let j=0;j<samples.length;j++){
      const dr=samples[i][0]-samples[j][0];
      const dg=samples[i][1]-samples[j][1];
      const db=samples[i][2]-samples[j][2];
      if(dr*dr+dg*dg+db*db<2500){
        count++;sr+=samples[j][0];sg+=samples[j][1];sb+=samples[j][2];
      }
    }
    if(count>bestCount){
      bestCount=count;
      bestR=Math.round(sr/count);bestG=Math.round(sg/count);bestB=Math.round(sb/count);
    }
  }
  return[bestR,bestG,bestB];
}

function smoothEdges(mask,w,h,radius){
  const temp=new Float32Array(mask.length);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx=y*w+x;
      if(mask[idx]===0)continue;
      // Check if near edge
      let nearFG=false;
      for(let dy=-radius;dy<=radius&&!nearFG;dy++){
        for(let dx=-radius;dx<=radius&&!nearFG;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<w&&ny>=0&&ny<h){
            if(mask[ny*w+nx]===0)nearFG=true;
          }
        }
      }
      if(nearFG){
        // Calculate smooth alpha
        let bgCount=0,total=0;
        for(let dy=-radius;dy<=radius;dy++){
          for(let dx=-radius;dx<=radius;dx++){
            const nx=x+dx,ny=y+dy;
            if(nx>=0&&nx<w&&ny>=0&&ny<h){
              total++;
              if(mask[ny*w+nx])bgCount++;
            }
          }
        }
        temp[idx]=bgCount/total;
      }else{
        temp[idx]=1;
      }
    }
  }
  for(let i=0;i<mask.length;i++){
    if(temp[i]>0)mask[i]=temp[i];
  }
}

// ===== MAGIC WAND =====
function wandRemove(pt){
  if(pt.x<0||pt.x>=imgW||pt.y<0||pt.y>=imgH)return;
  showLoad('Magic wand...');
  setTimeout(()=>{
    const tol=parseInt($('tolerance').value);
    const edge=parseInt($('edgeSmooth').value);
    const data=X.getImageData(0,0,imgW,imgH);
    const d=data.data;
    const si=(pt.y*imgW+pt.x)*4;
    const sr=d[si],sg=d[si+1],sb=d[si+2];
    const tolSq=tol*tol*3;

    const visited=new Uint8Array(imgW*imgH);
    const toRemove=[];
    const queue=[pt.y*imgW+pt.x];

    while(queue.length>0){
      const idx=queue.pop();
      if(visited[idx])continue;
      visited[idx]=1;
      const pi=idx*4;
      const dr=d[pi]-sr,dg=d[pi+1]-sg,db=d[pi+2]-sb;
      if(dr*dr+dg*dg+db*db>tolSq)continue;
      toRemove.push(idx);
      const x=idx%imgW,y=Math.floor(idx/imgW);
      if(x>0&&!visited[idx-1])queue.push(idx-1);
      if(x<imgW-1&&!visited[idx+1])queue.push(idx+1);
      if(y>0&&!visited[idx-imgW])queue.push(idx-imgW);
      if(y<imgH-1&&!visited[idx+imgW])queue.push(idx+imgW);
    }

    // Create mask for smoothing
    const mask=new Uint8Array(imgW*imgH);
    toRemove.forEach(idx=>mask[idx]=1);

    if(edge>0)smoothEdges(mask,imgW,imgH,edge);

    for(let i=0;i<mask.length;i++){
      if(mask[i]){
        const a=mask[i]===1?0:Math.round((1-mask[i])*255);
        d[i*4+3]=Math.min(d[i*4+3],a);
      }
    }

    X.putImageData(data,0,0);
    saveHist();hideLoad();
    toast(`‚úì Removed ${toRemove.length.toLocaleString()} pixels`);
  },30);
}

// ===== BRUSH =====
function brushAt(pt){
  const sz=parseInt($('brushSize').value);
  const r=sz/2;
  if(tool==='erase'){
    X.save();
    X.globalCompositeOperation='destination-out';
    X.beginPath();
    X.arc(pt.x,pt.y,r,0,Math.PI*2);
    X.fill();
    X.restore();
  }else if(tool==='restore'){
    // Restore from original
    if(!origData)return;
    const x0=Math.max(0,Math.floor(pt.x-r));
    const y0=Math.max(0,Math.floor(pt.y-r));
    const x1=Math.min(imgW,Math.ceil(pt.x+r));
    const y1=Math.min(imgH,Math.ceil(pt.y+r));
    const data=X.getImageData(x0,y0,x1-x0,y1-y0);
    const d=data.data;
    const od=origData.data;
    for(let y=y0;y<y1;y++){
      for(let x=x0;x<x1;x++){
        const dx=x-pt.x,dy=y-pt.y;
        if(dx*dx+dy*dy<=r*r){
          const di=((y-y0)*(x1-x0)+(x-x0))*4;
          const oi=(y*imgW+x)*4;
          d[di]=od[oi];d[di+1]=od[oi+1];d[di+2]=od[oi+2];d[di+3]=od[oi+3];
        }
      }
    }
    X.putImageData(data,x0,y0);
  }
}

function brushLine(p1,p2){
  const dx=p2.x-p1.x,dy=p2.y-p1.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const steps=Math.max(1,Math.floor(dist/2));
  for(let i=0;i<=steps;i++){
    const t=i/steps;
    brushAt({x:Math.round(p1.x+dx*t),y:Math.round(p1.y+dy*t)});
  }
}

// ===== HISTORY =====
function saveHist(){
  hIdx++;
  history=history.slice(0,hIdx);
  history.push(X.getImageData(0,0,imgW,imgH));
  if(history.length>25){history.shift();hIdx--}
}
function undo(){
  if(hIdx<=0)return;
  hIdx--;X.putImageData(history[hIdx],0,0);toast('‚Ü© Undo')
}
function redo(){
  if(hIdx>=history.length-1)return;
  hIdx++;X.putImageData(history[hIdx],0,0);toast('‚Ü™ Redo')
}

// ===== RESET =====
function resetImage(){
  if(!origData)return;
  X.putImageData(origData,0,0);
  history=[];hIdx=-1;saveHist();
  toast('‚Ü∫ Reset to original');
}

// ===== ZOOM =====
function doZoom(d){zoom=Math.max(20,Math.min(400,zoom+d));applyZoom()}
function fitZoom(){
  const w=$('canvasWrap');
  zoom=Math.round(Math.min((w.clientWidth-30)/imgW,(w.clientHeight-30)/imgH)*100);
  zoom=Math.max(20,Math.min(400,zoom));applyZoom();
}
function applyZoom(){
  const s=zoom/100;
  const ci=$('canvasInner');
  ci.style.width=Math.round(imgW*s)+'px';
  ci.style.height=Math.round(imgH*s)+'px';
  C.style.width='100%';C.style.height='100%';
  $('zLbl').textContent=zoom+'%';
}

// ===== PREVIEW BG =====
function setPreviewBg(bg,el){
  document.querySelectorAll('.bgo').forEach(b=>b.classList.remove('active'));
  if(el)el.classList.add('active');
  previewBg=bg;
  const wrap=$('canvasWrap');
  if(bg==='checker'){
    wrap.style.background='';
    wrap.style.backgroundColor='';
    wrap.style.backgroundImage='linear-gradient(45deg,#dfe3e8 25%,transparent 25%),linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#dfe3e8 75%),linear-gradient(-45deg,transparent 75%,#dfe3e8 75%)';
    wrap.style.backgroundSize='16px 16px';
    wrap.style.backgroundPosition='0 0,0 8px,8px -8px,-8px 0';
  }else{
    wrap.style.backgroundImage='none';
    wrap.style.backgroundColor=bg;
  }
}

// ===== DOWNLOAD =====
function downloadPNG(){
  if(!origImg)return;
  C.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='removed-background.png';
    document.body.appendChild(a);a.click();
    document.body.removeChild(a);URL.revokeObjectURL(url);
    toast('‚§ì Downloaded as PNG!');
  },'image/png');
}

// ===== NEW =====
function newImage(){
  $('editor').classList.remove('active');
  $('uploadScreen').classList.remove('hidden');
  $('navBtns').style.display='none';
  origImg=null;origData=null;history=[];hIdx=-1;
  setPreviewBg('checker',document.querySelector('.bgo.ck'));
}

// ===== UTILS =====
function showLoad(t){$('loadTxt').textContent=t||'Processing...';$('loading').classList.add('active')}
function hideLoad(){$('loading').classList.remove('active')}
function toast(m,e){const t=$('toast');t.textContent=m;t.className='toast'+(e?' err':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}
</script>
</body>
</html>
