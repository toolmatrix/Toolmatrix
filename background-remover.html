<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Remove Background - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;height:100vh}

/* NAV */
nav{background:#fff;padding:12px 20px;display:flex;align-items:center;border-bottom:1px solid #e0ece5;box-shadow:0 1px 3px rgba(0,0,0,.03);z-index:100;flex-shrink:0}
.nt{font-weight:700;font-size:1.05rem;color:#1d9c73}
.ns{color:#b0b0b0;font-size:.74rem;margin-left:8px;font-weight:500}
.nr{margin-left:auto;display:flex;gap:6px}
.nb{padding:7px 16px;border:none;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nb.sec{background:#eef5f0;color:#555}
.nb.sec:hover{background:#ddeee3}
.nb.pri{background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;box-shadow:0 2px 8px rgba(29,156,115,.18)}
.nb.pri:hover{box-shadow:0 4px 14px rgba(29,156,115,.28);transform:translateY(-1px)}

/* ===== SCREEN 1: UPLOAD ===== */
#screen1{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;background:linear-gradient(180deg,#e8f6ef 0%,#f5f7fa 100%)}
#screen1.hidden{display:none}
.hero-t{font-size:1.65rem;font-weight:800;color:#222;margin-bottom:6px;text-align:center}
.hero-t span{color:#1d9c73}
.hero-d{color:#999;font-size:.88rem;margin-bottom:28px;text-align:center;max-width:500px;line-height:1.5}

#dropZone{width:100%;max-width:560px;padding:46px 24px;border:2.5px dashed #b8dfc9;border-radius:16px;background:#fff;text-align:center;cursor:pointer;transition:all .25s}
#dropZone:hover,#dropZone.dragover{border-color:#1d9c73;background:#f0faf5;transform:translateY(-2px);box-shadow:0 8px 24px rgba(29,156,115,.06)}
.dz-i{font-size:2.8rem;margin-bottom:10px;opacity:.5}
.dz-t{font-size:.95rem;color:#666;font-weight:500;margin-bottom:3px}
.dz-h{font-size:.78rem;color:#c0c0c0;margin-bottom:14px}
.dz-b{padding:11px 32px;background:linear-gradient(135deg,#1d9c73,#27ae60);color:#fff;border:none;border-radius:28px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(29,156,115,.2)}
.dz-b:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(29,156,115,.28)}
.dz-f{font-size:.68rem;color:#d0d0d0;margin-top:12px}
#fileInput{display:none}

/* ===== SCREEN 2: PROCESSING ===== */
#screen2{display:none;flex:1;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;background:#fff}
#screen2.active{display:flex}
.proc-card{text-align:center;max-width:440px;width:100%}
.proc-preview{width:160px;height:160px;border-radius:16px;background:#f0f5f2;margin:0 auto 20px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center}
.proc-preview img{width:100%;height:100%;object-fit:cover}
.proc-spinner{width:50px;height:50px;border:4px solid #e0ece5;border-top-color:#1d9c73;border-radius:50%;animation:spn .7s linear infinite;margin:0 auto 18px}
@keyframes spn{to{transform:rotate(360deg)}}
.proc-t{font-size:1.1rem;font-weight:700;color:#333;margin-bottom:6px}
.proc-d{font-size:.82rem;color:#999;margin-bottom:16px}
.proc-bar{width:100%;height:6px;background:#e0ece5;border-radius:3px;overflow:hidden;margin-bottom:6px}
.proc-fill{height:100%;background:linear-gradient(90deg,#1d9c73,#27ae60);border-radius:3px;transition:width .3s;width:0}
.proc-pct{font-size:.75rem;color:#1d9c73;font-weight:700}

/* ===== SCREEN 3: RESULT ===== */
#screen3{display:none;flex:1;flex-direction:column;overflow:hidden}
#screen3.active{display:flex}

/* TOP TOOLS */
.top-tools{background:#fff;border-bottom:1px solid #e0ece5;padding:8px 14px;display:flex;align-items:center;gap:6px;overflow-x:auto;flex-shrink:0}
.top-tools::-webkit-scrollbar{height:0}
.tt{padding:6px 13px;border:1.5px solid #e0ece5;border-radius:8px;background:#fff;color:#555;font-size:.73rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.tt:hover{border-color:#1d9c73;color:#1d9c73}
.tt.act{background:#eef9f3;border-color:#1d9c73;color:#1d9c73}
.tt.red{border-color:#fde2e2;color:#e74c3c}
.tt.red:hover{background:#fdf2f2}
.t-sep{width:1px;height:22px;background:#e0ece5;flex-shrink:0}
.t-range{display:flex;align-items:center;gap:4px}
.t-range label{font-size:.68rem;font-weight:600;color:#aaa}
.t-range input[type=range]{width:70px;-webkit-appearance:none;height:4px;border-radius:2px;background:#d4ede2;outline:none;cursor:pointer}
.t-range input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#1d9c73;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.t-range span{font-size:.66rem;color:#1d9c73;font-weight:700;min-width:18px;text-align:right}

/* COMPARE AREA */
.compare-area{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
  background:#e8ecf0;
  background-image:linear-gradient(45deg,#dfe3e8 25%,transparent 25%),linear-gradient(-45deg,#dfe3e8 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#dfe3e8 75%),linear-gradient(-45deg,transparent 75%,#dfe3e8 75%);
  background-size:16px 16px;background-position:0 0,0 8px,8px -8px,-8px 0}

.compare-container{position:relative;display:inline-block;box-shadow:0 3px 24px rgba(0,0,0,.1);max-width:92%;max-height:78vh}

/* Result Canvas */
.result-wrap{position:relative;display:block}
.result-checker{position:absolute;inset:0;
  background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);
  background-size:12px 12px;background-position:0 0,0 6px,6px -6px,-6px 0;z-index:0;border-radius:3px}
.result-color-bg{position:absolute;inset:0;z-index:0;border-radius:3px;display:none}
#resultCanvas{position:relative;display:block;z-index:1}

/* Original overlay */
.orig-overlay{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:5}
.orig-overlay img{display:block;width:100%;height:100%;object-fit:contain}

/* Slider line */
.slider-line{position:absolute;top:0;bottom:0;width:3px;background:#fff;z-index:10;cursor:ew-resize;box-shadow:-1px 0 4px rgba(0,0,0,.15),1px 0 4px rgba(0,0,0,.15)}
.slider-knob{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:34px;height:34px;background:#fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;cursor:ew-resize}
.slider-knob::after{content:'‚ü® ‚ü©';font-size:.55rem;color:#1d9c73;font-weight:900;letter-spacing:1px}
.s-label{position:absolute;top:10px;padding:4px 10px;border-radius:6px;font-size:.65rem;font-weight:700;pointer-events:none;z-index:12}
.s-label.before{left:10px;background:rgba(0,0,0,.5);color:#fff}
.s-label.after{right:10px;background:rgba(29,156,115,.8);color:#fff}

/* Zoom */
.z-bar{position:absolute;bottom:10px;right:10px;display:flex;gap:3px;background:#fff;border-radius:8px;padding:3px;box-shadow:0 2px 8px rgba(0,0,0,.07);border:1px solid #e5e7eb;z-index:20}
.z-btn{width:28px;height:28px;border:none;border-radius:6px;background:#f5f5f5;color:#555;cursor:pointer;font-size:.78rem;display:flex;align-items:center;justify-content:center;transition:all .1s}
.z-btn:hover{background:#1d9c73;color:#fff}
.z-i{display:flex;align-items:center;padding:0 6px;font-size:.7rem;color:#888;font-weight:700}

/* Bottom bar */
.bot-bar{background:#fff;border-top:1px solid #e0ece5;padding:10px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex-shrink:0}
.bot-label{font-size:.72rem;font-weight:600;color:#aaa}
.bg-row{display:flex;gap:5px;align-items:center}
.bgd{width:26px;height:26px;border-radius:7px;cursor:pointer;border:2.5px solid #e0ece5;transition:all .12s;flex-shrink:0}
.bgd:hover{border-color:#1d9c73;transform:scale(1.08)}
.bgd.act{border-color:#1d9c73;box-shadow:0 0 0 2px rgba(29,156,115,.15)}
.bgd.ck{background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:6px 6px;background-position:0 0,0 3px,3px -3px,-3px 0}
.bgd-custom{padding:0;border:2.5px solid #e0ece5;overflow:hidden;display:flex;align-items:center;justify-content:center}
.bgd-custom input{width:100%;height:100%;border:none;cursor:pointer;padding:0;background:none}
.bot-right{margin-left:auto;display:flex;gap:6px;align-items:center}
.bot-info{font-size:.68rem;color:#bbb}
.bot-info b{color:#1d9c73}

/* BRUSH CURSOR */
.brush-cursor{position:fixed;pointer-events:none;border-radius:50%;z-index:200;display:none;border:2px solid #1d9c73;background:rgba(29,156,115,.08)}
.brush-cursor.erasing{border-color:#e74c3c;background:rgba(231,76,60,.08)}

/* TOAST */
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(80px);background:#fff;color:#333;padding:10px 20px;border-radius:10px;font-size:.82rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);z-index:300;transition:transform .3s;border-left:4px solid #1d9c73;max-width:90vw}
.toast.err{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

footer{text-align:center;padding:10px;color:#c0c0c0;font-size:.68rem;border-top:1px solid #eef0f3;background:#fff;flex-shrink:0}
footer b{color:#1d9c73}

@media(max-width:768px){
  .nb span.tx{display:none}
  .nb{padding:7px 10px}
  .ns{display:none}
  .compare-container{max-width:96%;max-height:68vh}
  .top-tools{padding:6px 8px;gap:4px}
  .tt{padding:5px 9px;font-size:.68rem}
  .t-range input[type=range]{width:56px}
  .bot-bar{padding:8px 10px}
  .bot-info{display:none}
}
@media(max-width:480px){
  .hero-t{font-size:1.2rem}
  #dropZone{padding:30px 16px}
  .dz-i{font-size:2.2rem}
  .tt{padding:4px 7px;font-size:.63rem;gap:2px}
  .t-sep{display:none}
  .t-range label{display:none}
  .slider-knob{width:28px;height:28px}
  .bgd{width:22px;height:22px;border-radius:5px}
}
</style>
</head>
<body>

<nav>
  <span class="nt">Remove Background</span>
  <span class="ns">Free Online Tool</span>
  <div class="nr" id="navBtns" style="display:none">
    <button class="nb sec" onclick="goUpload()">+ <span class="tx">New Image</span></button>
    <button class="nb pri" onclick="download()">‚§ì <span class="tx">Download PNG</span></button>
  </div>
</nav>

<!-- SCREEN 1: UPLOAD -->
<div id="screen1">
  <div class="hero-t">Remove Image <span>Background</span></div>
  <div class="hero-d">Remove backgrounds instantly. 100% free, no sign-up, works right in your browser ‚Äî your images stay private.</div>
  <div id="dropZone">
    <div class="dz-i">üñºÔ∏è</div>
    <div class="dz-t">Drag & drop your image here</div>
    <div class="dz-h">or</div>
    <button class="dz-b" onclick="$('fileInput').click()">Select Image</button>
    <div class="dz-f">JPG, PNG, WEBP ‚Äî Up to 20MB</div>
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- SCREEN 2: PROCESSING -->
<div id="screen2">
  <div class="proc-card">
    <div class="proc-preview" id="procPreview"></div>
    <div class="proc-spinner"></div>
    <div class="proc-t" id="procT">Removing Background...</div>
    <div class="proc-d" id="procD">Analyzing image colors and edges</div>
    <div class="proc-bar"><div class="proc-fill" id="procFill"></div></div>
    <div class="proc-pct" id="procPct">0%</div>
  </div>
</div>

<!-- SCREEN 3: RESULT -->
<div id="screen3">
  <div class="top-tools">
    <button class="tt act" id="tView" onclick="setTool('view')">üëÅ Compare</button>
    <button class="tt" id="tWand" onclick="setTool('wand')">ü™Ñ Wand</button>
    <button class="tt" id="tErase" onclick="setTool('erase')">üßπ Erase</button>
    <button class="tt" id="tRestore" onclick="setTool('restore')">‚úèÔ∏è Restore</button>
    <div class="t-sep"></div>
    <div class="t-range">
      <label>Tolerance</label>
      <input type="range" min="5" max="80" value="32" id="tolR" oninput="$('tolV').textContent=this.value">
      <span id="tolV">32</span>
    </div>
    <div class="t-range">
      <label>Brush</label>
      <input type="range" min="4" max="80" value="22" id="brR" oninput="$('brV').textContent=this.value">
      <span id="brV">22</span>
    </div>
    <div class="t-range">
      <label>Edge</label>
      <input type="range" min="0" max="8" value="2" id="edR" oninput="$('edV').textContent=this.value">
      <span id="edV">2</span>
    </div>
    <div class="t-sep"></div>
    <button class="tt" onclick="undo()">‚Ü© Undo</button>
    <button class="tt" onclick="redo()">‚Ü™ Redo</button>
    <button class="tt red" onclick="resetImg()">‚Ü∫ Reset</button>
  </div>

  <div class="compare-area" id="compareArea">
    <div class="compare-container" id="compBox">
      <div class="result-wrap" id="resWrap">
        <div class="result-checker" id="resCk"></div>
        <div class="result-color-bg" id="resClr"></div>
        <canvas id="resultCanvas"></canvas>
      </div>
      <div class="orig-overlay" id="origOv">
        <img id="origImg" src="" alt="Original">
      </div>
      <div class="slider-line" id="sliderLine">
        <div class="slider-knob"></div>
      </div>
      <div class="s-label before">ORIGINAL</div>
      <div class="s-label after">REMOVED</div>
    </div>
    <div class="z-bar">
      <button class="z-btn" onclick="doZoom(-10)">‚àí</button>
      <div class="z-i" id="zL">100%</div>
      <button class="z-btn" onclick="doZoom(10)">+</button>
      <button class="z-btn" onclick="fitZ()">‚ä°</button>
    </div>
  </div>

  <div class="bot-bar">
    <span class="bot-label">BG:</span>
    <div class="bg-row">
      <div class="bgd ck act" onclick="setBg('ck',this)" title="Transparent"></div>
      <div class="bgd" style="background:#fff" onclick="setBg('#fff',this)"></div>
      <div class="bgd" style="background:#000" onclick="setBg('#000',this)"></div>
      <div class="bgd" style="background:#e53935" onclick="setBg('#e53935',this)"></div>
      <div class="bgd" style="background:#1e88e5" onclick="setBg('#1e88e5',this)"></div>
      <div class="bgd" style="background:#43a047" onclick="setBg('#43a047',this)"></div>
      <div class="bgd" style="background:#fb8c00" onclick="setBg('#fb8c00',this)"></div>
      <div class="bgd-custom"><input type="color" value="#e0e0e0" onchange="setBg(this.value,this.parentElement)" title="Custom"></div>
    </div>
    <div class="bot-right">
      <span class="bot-info" id="botInfo"></span>
      <button class="nb sec" onclick="goUpload()">+ New</button>
      <button class="nb pri" onclick="download()">‚§ì Download</button>
    </div>
  </div>
</div>

<div class="brush-cursor" id="bCur"></div>
<footer><b>Remove Background</b> ‚Äî Free & private. Images never leave your browser.</footer>
<div class="toast" id="toast"></div>

<!-- HIDDEN CANVASES -->
<canvas id="workCanvas" style="display:none"></canvas>

<script>
const $=id=>document.getElementById(id);

let origImgObj=null,origData=null,origUrl=null;
let RC,RX,WC,WX; // Result canvas, Work canvas
let imgW=0,imgH=0,zoom=100;
let tool='view',painting=false,lastPt=null;
let hist=[],hIdx=-1;
let curBg='ck';

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
  RC=$('resultCanvas');RX=RC.getContext('2d',{willReadFrequently:true});
  WC=$('workCanvas');WX=WC.getContext('2d',{willReadFrequently:true});

  const fi=$('fileInput'),dz=$('dropZone');
  fi.addEventListener('change',e=>{if(e.target.files[0])loadFile(e.target.files[0]);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])});
  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items;if(!items)return;
    for(let i of items)if(i.type.startsWith('image/')){e.preventDefault();loadFile(i.getAsFile());break}
  });

  // Canvas events
  RC.addEventListener('mousedown',e=>{if(tool!=='view')pDown(gP(e))});
  RC.addEventListener('mousemove',e=>{pMove(gP(e));showBrush(e)});
  RC.addEventListener('mouseup',()=>pUp());
  RC.addEventListener('mouseleave',()=>{pUp();$('bCur').style.display='none'});
  RC.addEventListener('touchstart',e=>{if(tool!=='view'){e.preventDefault();pDown(gTP(e))}},{passive:false});
  RC.addEventListener('touchmove',e=>{if(tool!=='view'){e.preventDefault();pMove(gTP(e))}},{passive:false});
  RC.addEventListener('touchend',e=>{if(tool!=='view'){e.preventDefault();pUp()}},{passive:false});

  // Slider
  setupSlider();

  window.addEventListener('resize',()=>{if(origImgObj)fitZ()});
});

function gP(e){const r=RC.getBoundingClientRect();return{x:Math.round((e.clientX-r.left)*(imgW/r.width)),y:Math.round((e.clientY-r.top)*(imgH/r.height))}}
function gTP(e){const t=e.touches[0];const r=RC.getBoundingClientRect();return{x:Math.round((t.clientX-r.left)*(imgW/r.width)),y:Math.round((t.clientY-r.top)*(imgH/r.height))}}

// ===== LOAD FILE =====
function loadFile(file){
  if(!file.type.startsWith('image/')){toast('Select an image',true);return}
  if(file.size>20*1024*1024){toast('Max 20MB',true);return}

  origUrl=URL.createObjectURL(file);
  $('procPreview').innerHTML=`<img src="${origUrl}" alt="">`;
  showScreen(2);
  setProc('Loading image...',10);

  const img=new Image();
  img.onload=()=>{
    origImgObj=img;
    imgW=img.naturalWidth;imgH=img.naturalHeight;
    const MX=2200;
    if(imgW>MX||imgH>MX){const s=Math.min(MX/imgW,MX/imgH);imgW=Math.round(imgW*s);imgH=Math.round(imgH*s)}

    // Setup canvases
    RC.width=imgW;RC.height=imgH;
    WC.width=imgW;WC.height=imgH;
    WX.drawImage(img,0,0,imgW,imgH);
    origData=WX.getImageData(0,0,imgW,imgH);

    // Start auto removal
    setProc('Analyzing background...',25);
    setTimeout(()=>{
      autoRemoveBg(()=>{
        $('origImg').src=origUrl;
        $('botInfo').innerHTML=`<b>${imgW}√ó${imgH}</b>`;
        $('navBtns').style.display='flex';
        hist=[];hIdx=-1;saveH();
        showScreen(3);
        fitZ();
        updateSlider(50);
        toast('‚úì Background removed! Fine-tune with tools if needed.');
      });
    },100);
  };
  img.onerror=()=>{toast('Failed to load',true);showScreen(1)};
  img.src=origUrl;
}

// ===== AUTO REMOVE BG =====
function autoRemoveBg(cb){
  setProc('Detecting background color...',35);
  const d=new Uint8ClampedArray(origData.data);
  const len=imgW*imgH;

  // Sample edges for bg color
  const samples=[];
  for(let x=0;x<imgW;x+=Math.max(1,Math.floor(imgW/30))){
    samples.push(px(d,x,0));samples.push(px(d,x,imgH-1));
  }
  for(let y=0;y<imgH;y+=Math.max(1,Math.floor(imgH/30))){
    samples.push(px(d,0,y));samples.push(px(d,imgW-1,y));
  }
  // Corners
  [[0,0],[imgW-1,0],[0,imgH-1],[imgW-1,imgH-1],
   [Math.floor(imgW*.25),0],[Math.floor(imgW*.75),0],
   [0,Math.floor(imgH*.25)],[0,Math.floor(imgH*.75)]
  ].forEach(([x,y])=>samples.push(px(d,x,y)));

  const bgC=dominantColor(samples);
  const tol=parseInt($('tolR').value);
  const edge=parseInt($('edR').value);
  const tolSq=tol*tol*3;

  setProc('Creating background mask...',50);

  setTimeout(()=>{
    // Color distance mask
    const mask=new Uint8Array(len);
    for(let i=0;i<len;i++){
      const idx=i*4;
      const dr=d[idx]-bgC[0],dg=d[idx+1]-bgC[1],db=d[idx+2]-bgC[2];
      if(dr*dr+dg*dg+db*db<tolSq)mask[i]=1;
    }

    setProc('Flood filling from edges...',65);
    setTimeout(()=>{
      // Flood fill from edges
      const vis=new Uint8Array(len);
      const q=[];
      for(let x=0;x<imgW;x++){if(mask[x])q.push(x);const b=(imgH-1)*imgW+x;if(mask[b])q.push(b)}
      for(let y=1;y<imgH-1;y++){const l=y*imgW;if(mask[l])q.push(l);const r=l+imgW-1;if(mask[r])q.push(r)}

      const final=new Float32Array(len);
      let head=0;
      while(head<q.length){
        const idx=q[head++];
        if(vis[idx])continue;vis[idx]=1;
        if(!mask[idx])continue;
        final[idx]=1;
        const x=idx%imgW,y=(idx/imgW)|0;
        if(x>0&&!vis[idx-1])q.push(idx-1);
        if(x<imgW-1&&!vis[idx+1])q.push(idx+1);
        if(y>0&&!vis[idx-imgW])q.push(idx-imgW);
        if(y<imgH-1&&!vis[idx+imgW])q.push(idx+imgW);
      }

      setProc('Smoothing edges...',80);
      setTimeout(()=>{
        // Edge smooth
        if(edge>0)smoothEdge(final,edge);

        setProc('Applying transparency...',90);
        setTimeout(()=>{
          // Apply
          const out=new ImageData(new Uint8ClampedArray(d),imgW,imgH);
          for(let i=0;i<len;i++){
            if(final[i]>0){
              out.data[i*4+3]=final[i]>=1?0:Math.round((1-final[i])*255);
            }
          }
          RX.putImageData(out,0,0);
          setProc('Done!',100);
          setTimeout(cb,200);
        },30);
      },30);
    },30);
  },30);
}

function px(d,x,y){const i=(y*imgW+x)*4;return[d[i],d[i+1],d[i+2]]}

function dominantColor(samples){
  let br=0,bg=0,bb=0,best=0;
  for(let i=0;i<samples.length;i++){
    let cnt=0,sr=0,sgg=0,sb=0;
    for(let j=0;j<samples.length;j++){
      const dr=samples[i][0]-samples[j][0],dg=samples[i][1]-samples[j][1],db=samples[i][2]-samples[j][2];
      if(dr*dr+dg*dg+db*db<3000){cnt++;sr+=samples[j][0];sgg+=samples[j][1];sb+=samples[j][2]}
    }
    if(cnt>best){best=cnt;br=Math.round(sr/cnt);bg=Math.round(sgg/cnt);bb=Math.round(sb/cnt)}
  }
  return[br,bg,bb];
}

function smoothEdge(mask,r){
  const temp=new Float32Array(mask.length);
  for(let y=0;y<imgH;y++){
    for(let x=0;x<imgW;x++){
      const idx=y*imgW+x;
      if(!mask[idx])continue;
      let edge=false;
      outer:for(let dy=-r;dy<=r;dy++){
        for(let dx=-r;dx<=r;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<imgW&&ny>=0&&ny<imgH&&!mask[ny*imgW+nx]){edge=true;break outer}
        }
      }
      if(edge){
        let bg=0,tot=0;
        for(let dy=-r;dy<=r;dy++){
          for(let dx=-r;dx<=r;dx++){
            const nx=x+dx,ny=y+dy;
            if(nx>=0&&nx<imgW&&ny>=0&&ny<imgH){tot++;if(mask[ny*imgW+nx])bg++}
          }
        }
        temp[idx]=bg/tot;
      }else{temp[idx]=1}
    }
  }
  for(let i=0;i<mask.length;i++)if(temp[i]>0)mask[i]=temp[i];
}

// ===== TOOLS =====
function setTool(t){
  tool=t;
  document.querySelectorAll('.tt').forEach(b=>b.classList.remove('act'));
  $('t'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('act');

  const isCompare=t==='view';
  $('origOv').style.display=isCompare?'':'none';
  $('sliderLine').style.display=isCompare?'':'none';
  document.querySelectorAll('.s-label').forEach(l=>l.style.display=isCompare?'':'none');

  RC.style.cursor=(t==='erase'||t==='restore')?'none':t==='wand'?'crosshair':'default';
  $('bCur').style.display='none';
}

function showBrush(e){
  if(tool!=='erase'&&tool!=='restore')return;
  const bc=$('bCur');
  const sz=parseInt($('brR').value)*zoom/100;
  bc.style.display='block';
  bc.style.width=sz+'px';bc.style.height=sz+'px';
  bc.style.left=(e.clientX-sz/2)+'px';bc.style.top=(e.clientY-sz/2)+'px';
  bc.className='brush-cursor'+(tool==='erase'?' erasing':'');
}

// ===== POINTER =====
function pDown(pt){
  if(tool==='wand'){wandAt(pt);return}
  painting=true;lastPt=pt;
  brushAt(pt);
}
function pMove(pt){if(!painting)return;if(tool==='erase'||tool==='restore'){brushLine(lastPt,pt);lastPt=pt}}
function pUp(){if(painting){painting=false;lastPt=null;saveH()}}

// Magic Wand
function wandAt(pt){
  if(pt.x<0||pt.x>=imgW||pt.y<0||pt.y>=imgH)return;
  const tol=parseInt($('tolR').value);
  const edge=parseInt($('edR').value);
  const data=RX.getImageData(0,0,imgW,imgH);
  const d=data.data;
  const si=(pt.y*imgW+pt.x)*4;
  const sr=d[si],sg=d[si+1],sb=d[si+2];
  const tolSq=tol*tol*3;

  const vis=new Uint8Array(imgW*imgH);
  const rem=[];
  const q=[pt.y*imgW+pt.x];

  while(q.length){
    const idx=q.pop();
    if(vis[idx])continue;vis[idx]=1;
    const pi=idx*4;
    if(d[pi+3]===0)continue;
    const dr=d[pi]-sr,dg=d[pi+1]-sg,db=d[pi+2]-sb;
    if(dr*dr+dg*dg+db*db>tolSq)continue;
    rem.push(idx);
    const x=idx%imgW,y=(idx/imgW)|0;
    if(x>0&&!vis[idx-1])q.push(idx-1);
    if(x<imgW-1&&!vis[idx+1])q.push(idx+1);
    if(y>0&&!vis[idx-imgW])q.push(idx-imgW);
    if(y<imgH-1&&!vis[idx+imgW])q.push(idx+imgW);
  }

  const mask=new Float32Array(imgW*imgH);
  rem.forEach(i=>mask[i]=1);
  if(edge>0)smoothEdge(mask,edge);

  for(let i=0;i<mask.length;i++){
    if(mask[i]>0){
      d[i*4+3]=mask[i]>=1?0:Math.min(d[i*4+3],Math.round((1-mask[i])*255));
    }
  }
  RX.putImageData(data,0,0);
  saveH();
  toast(`‚úì Removed ${rem.length.toLocaleString()} pixels`);
}

// Brush
function brushAt(pt){
  const sz=parseInt($('brR').value),r=sz/2;
  if(tool==='erase'){
    RX.save();
    RX.globalCompositeOperation='destination-out';
    RX.beginPath();RX.arc(pt.x,pt.y,r,0,Math.PI*2);RX.fill();
    RX.restore();
  }else if(tool==='restore'&&origData){
    const x0=Math.max(0,Math.floor(pt.x-r)),y0=Math.max(0,Math.floor(pt.y-r));
    const x1=Math.min(imgW,Math.ceil(pt.x+r)),y1=Math.min(imgH,Math.ceil(pt.y+r));
    const data=RX.getImageData(x0,y0,x1-x0,y1-y0);
    const dd=data.data,od=origData.data;
    for(let y=y0;y<y1;y++){
      for(let x=x0;x<x1;x++){
        const dx=x-pt.x,dy=y-pt.y;
        if(dx*dx+dy*dy<=r*r){
          const di=((y-y0)*(x1-x0)+(x-x0))*4;
          const oi=(y*imgW+x)*4;
          dd[di]=od[oi];dd[di+1]=od[oi+1];dd[di+2]=od[oi+2];dd[di+3]=od[oi+3];
        }
      }
    }
    RX.putImageData(data,x0,y0);
  }
}

function brushLine(a,b){
  const dx=b.x-a.x,dy=b.y-a.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const steps=Math.max(1,Math.floor(dist/2));
  for(let i=0;i<=steps;i++){const t=i/steps;brushAt({x:Math.round(a.x+dx*t),y:Math.round(a.y+dy*t)})}
}

// ===== HISTORY =====
function saveH(){hIdx++;hist=hist.slice(0,hIdx);hist.push(RX.getImageData(0,0,imgW,imgH));if(hist.length>20){hist.shift();hIdx--}}
function undo(){if(hIdx<=0)return;hIdx--;RX.putImageData(hist[hIdx],0,0);toast('‚Ü© Undo')}
function redo(){if(hIdx>=hist.length-1)return;hIdx++;RX.putImageData(hist[hIdx],0,0);toast('‚Ü™ Redo')}
function resetImg(){if(!origData)return;RX.putImageData(new ImageData(new Uint8ClampedArray(origData.data),imgW,imgH),0,0);
  // Re-run auto remove
  autoRemoveBg(()=>{hist=[];hIdx=-1;saveH();toast('‚Ü∫ Reset & re-processed')})
}

// ===== COMPARISON SLIDER =====
function setupSlider(){
  const box=$('compBox');
  let dragging=false;
  function pos(e){const r=box.getBoundingClientRect();const cx=e.touches?e.touches[0].clientX:e.clientX;return Math.max(0,Math.min(100,((cx-r.left)/r.width)*100))}
  function start(e){if(tool!=='view')return;dragging=true;updateSlider(pos(e))}
  function move(e){if(!dragging)return;e.preventDefault();updateSlider(pos(e))}
  function end(){dragging=false}
  box.addEventListener('mousedown',start);
  window.addEventListener('mousemove',move);
  window.addEventListener('mouseup',end);
  box.addEventListener('touchstart',e=>{if(tool==='view'){dragging=true;updateSlider(pos(e))}},{passive:true});
  window.addEventListener('touchmove',e=>{if(dragging)updateSlider(pos(e))},{passive:true});
  window.addEventListener('touchend',end);
}

function updateSlider(pct){
  $('origOv').style.clipPath=`inset(0 ${100-pct}% 0 0)`;
  $('sliderLine').style.left=pct+'%';
}

// ===== ZOOM =====
function doZoom(d){zoom=Math.max(20,Math.min(400,zoom+d));applyZ()}
function fitZ(){
  const a=$('compareArea');
  zoom=Math.round(Math.min((a.clientWidth-30)/imgW,(a.clientHeight-30)/imgH)*100);
  zoom=Math.max(20,Math.min(400,zoom));applyZ();
}
function applyZ(){
  const s=zoom/100;
  const box=$('compBox');
  box.style.width=Math.round(imgW*s)+'px';
  box.style.height=Math.round(imgH*s)+'px';
  RC.style.width='100%';RC.style.height='100%';
  $('zL').textContent=zoom+'%';
}

// ===== BACKGROUND PREVIEW =====
function setBg(bg,el){
  document.querySelectorAll('.bgd,.bgd-custom').forEach(b=>b.classList.remove('act'));
  if(el)el.classList.add('act');
  curBg=bg;
  const ck=$('resCk'),clr=$('resClr');
  if(bg==='ck'){ck.style.display='block';clr.style.display='none'}
  else{ck.style.display='none';clr.style.display='block';clr.style.backgroundColor=bg}
}

// ===== DOWNLOAD =====
function download(){
  if(!origImgObj)return;
  const c=document.createElement('canvas');c.width=imgW;c.height=imgH;
  const cx=c.getContext('2d');
  if(curBg!=='ck'){cx.fillStyle=curBg;cx.fillRect(0,0,imgW,imgH)}
  cx.drawImage(RC,0,0);
  c.toBlob(blob=>{
    const u=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=u;a.download='no-background.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(u);
    toast('‚§ì Downloaded!');
  },'image/png');
}

// ===== SCREENS =====
function showScreen(n){
  $('screen1').className=n===1?'':'hidden';
  $('screen2').className=n===2?'active':'';
  $('screen3').className=n===3?'active':'';
}

function goUpload(){
  showScreen(1);
  $('navBtns').style.display='none';
  origImgObj=null;origData=null;hist=[];hIdx=-1;
  if(origUrl)URL.revokeObjectURL(origUrl);origUrl=null;
  curBg='ck';
  setBg('ck',document.querySelector('.bgd.ck'));
  setTool('view');
}

function setProc(t,p){
  $('procT').textContent=t;
  $('procFill').style.width=p+'%';
  $('procPct').textContent=p+'%';
}

// ===== UTILS =====
function toast(m,e){const t=$('toast');t.textContent=m;t.className='toast'+(e?' err':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
