<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JPG Converter - Free Online Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column
}

nav{
  background:#fff;padding:13px 24px;display:flex;align-items:center;
  border-bottom:1px solid #e8ecf0;box-shadow:0 1px 3px rgba(0,0,0,.04);
  position:sticky;top:0;z-index:100
}
.nav-t{font-weight:700;font-size:1.08rem;color:#e67e22}
.nav-s{color:#aaa;font-size:.76rem;margin-left:8px;font-weight:500}
.nav-r{margin-left:auto;display:flex;gap:8px}
.nb{
  padding:8px 18px;border:none;border-radius:8px;font-size:.82rem;
  font-weight:600;cursor:pointer;transition:all .15s;display:flex;
  align-items:center;gap:5px;white-space:nowrap
}
.nb.sec{background:#f0f2f5;color:#666}
.nb.sec:hover{background:#e4e6e9}
.nb.pri{background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;
  box-shadow:0 2px 8px rgba(230,126,34,.2)}
.nb.pri:hover{box-shadow:0 4px 14px rgba(230,126,34,.3);transform:translateY(-1px)}
.nb.red{color:#e74c3c;background:#fdf2f2}
.nb.red:hover{background:#fce4e4}

/* UPLOAD */
.upload-area{
  display:flex;flex-direction:column;align-items:center;
  padding:44px 20px 36px;
  background:linear-gradient(180deg,#fef5ec 0%,#f5f7fa 100%)
}
.upload-area.mini{padding:16px 20px}
.upload-area h1{font-size:1.8rem;font-weight:800;color:#222;margin-bottom:8px;text-align:center}
.upload-area h1 span{color:#e67e22}
.upload-area>p{color:#888;font-size:.92rem;margin-bottom:26px;text-align:center;max-width:520px;line-height:1.5}
.upload-area.mini h1,.upload-area.mini>p{display:none}

/* DIRECTION SWITCH */
.dir-switch{
  display:flex;gap:0;margin-bottom:24px;background:#fff;border-radius:12px;
  border:1.5px solid #eee;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04)
}
.dir-btn{
  padding:14px 28px;border:none;background:#fff;cursor:pointer;
  font-size:.88rem;font-weight:700;color:#888;transition:all .15s;
  display:flex;align-items:center;gap:6px;white-space:nowrap
}
.dir-btn:first-child{border-right:1.5px solid #eee}
.dir-btn:hover{color:#e67e22;background:#fef9f3}
.dir-btn.active{background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff}
.upload-area.mini .dir-switch{display:none}

#dropZone{
  width:100%;max-width:600px;padding:48px 28px;border:2.5px dashed #f5d5b0;
  border-radius:16px;background:#fff;text-align:center;cursor:pointer;
  transition:all .25s
}
#dropZone:hover,#dropZone.dragover{
  border-color:#e67e22;background:#fef9f3;transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(230,126,34,.07)
}
.upload-area.mini #dropZone{padding:16px 20px;max-width:100%}
.dz-icon{font-size:3rem;margin-bottom:10px;opacity:.55}
.dz-text{font-size:1rem;color:#666;font-weight:500;margin-bottom:3px}
.dz-hint{font-size:.82rem;color:#bbb;margin-bottom:16px}
.dz-btn{
  display:inline-block;padding:12px 34px;
  background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;border:none;
  border-radius:30px;font-size:.95rem;font-weight:700;cursor:pointer;
  transition:all .2s;box-shadow:0 4px 14px rgba(230,126,34,.25)
}
.dz-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(230,126,34,.3)}
.dz-fmt{font-size:.72rem;color:#ccc;margin-top:14px}
.upload-area.mini .dz-icon,.upload-area.mini .dz-hint,.upload-area.mini .dz-fmt{display:none}
.upload-area.mini .dz-text{margin-bottom:0}
.upload-area.mini .dz-btn{padding:8px 22px;font-size:.82rem}
#fileInput{display:none}

/* SETTINGS */
.settings-wrap{display:none;max-width:820px;width:100%;margin:0 auto;padding:0 20px}
.settings-wrap.show{display:block}
.settings-card{
  background:#fff;border-radius:14px;border:1px solid #eef0f3;
  padding:20px 24px;margin-top:16px;box-shadow:0 1px 4px rgba(0,0,0,.03)
}
.settings-title{font-size:.88rem;font-weight:700;color:#333;margin-bottom:14px}

/* FORMAT SELECT */
.fmt-label{font-size:.8rem;font-weight:600;color:#888;margin-bottom:8px}
.fmt-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.fmt-btn{
  padding:10px 20px;border:2px solid #eef0f3;border-radius:10px;
  background:#fff;cursor:pointer;text-align:center;transition:all .15s;
  min-width:80px
}
.fmt-btn:hover{border-color:#e67e22}
.fmt-btn.active{border-color:#e67e22;background:#fef5ec}
.fmt-btn .fmt-name{font-size:.85rem;font-weight:700;color:#333}
.fmt-btn .fmt-desc{font-size:.65rem;color:#aaa;margin-top:2px}

/* QUALITY */
.q-row{display:none;flex-direction:column;gap:6px;margin-bottom:10px}
.q-row.show{display:flex}
.sl-label{display:flex;justify-content:space-between;font-size:.8rem;color:#666}
.sl-label span:last-child{color:#e67e22;font-weight:700;min-width:40px;text-align:right}
input[type="range"]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:#e0e0e0;outline:none;cursor:pointer
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:#e67e22;cursor:pointer;border:3px solid #fff;
  box-shadow:0 1px 5px rgba(0,0,0,.2)
}

/* BG COLOR for JPG */
.bg-row{display:none;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.bg-row.show{display:flex}
.bg-row label{font-size:.8rem;font-weight:600;color:#666}
input[type="color"]{
  width:36px;height:30px;border:1.5px solid #ddd;border-radius:6px;
  cursor:pointer;background:#fff;padding:2px
}
.bg-presets{display:flex;gap:4px}
.bg-dot{
  width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid #eee;
  transition:all .12s
}
.bg-dot:hover{border-color:#e67e22;transform:scale(1.1)}
.bg-dot.active{border-color:#e67e22}

/* FILES */
.files-wrap{display:none;max-width:820px;width:100%;margin:0 auto;padding:16px 20px 0}
.files-wrap.show{display:block}
.files-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.files-header h3{font-size:.95rem;font-weight:700;color:#333}
.fc{font-size:.78rem;color:#999;font-weight:500}

.file-list{display:flex;flex-direction:column;gap:8px}
.file-item{
  background:#fff;border-radius:12px;border:1px solid #eef0f3;
  padding:14px 16px;display:flex;align-items:center;gap:12px;
  transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.02)
}
.file-item:hover{box-shadow:0 2px 8px rgba(0,0,0,.04)}
.f-thumb{
  width:48px;height:48px;border-radius:8px;background:#f5f7fa;
  overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center
}
.f-thumb img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.f-info{flex:1;min-width:0}
.f-name{font-size:.84rem;font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.f-meta{font-size:.73rem;color:#aaa;margin-top:3px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.f-convert{display:flex;align-items:center;gap:4px;font-size:.75rem}
.f-from{padding:2px 8px;border-radius:4px;font-weight:700;text-transform:uppercase}
.f-from.jpg{background:#fff3e0;color:#e67e22}
.f-from.png{background:#e8f5e9;color:#27ae60}
.f-from.webp{background:#e3f2fd;color:#2196f3}
.f-from.gif{background:#fce4ec;color:#e91e63}
.f-from.bmp{background:#f3e5f5;color:#9c27b0}
.f-from.ico{background:#e0f7fa;color:#00bcd4}
.f-arrow{color:#ccc;font-weight:700}
.f-sizes{font-size:.73rem;color:#999}
.f-saved{font-size:.68rem;font-weight:700;padding:2px 6px;border-radius:8px}
.f-saved.green{background:#e8f8f0;color:#1d9c73}

.f-status{flex-shrink:0;display:flex;align-items:center;gap:6px}
.badge{padding:5px 12px;border-radius:16px;font-size:.72rem;font-weight:600;display:inline-flex;align-items:center;gap:4px}
.badge.wait{background:#f0f2f5;color:#999}
.badge.prog{background:#fff8e1;color:#e67e22}
.badge.done{background:#e8f8f0;color:#1d9c73}
.badge.err{background:#fde8e8;color:#e74c3c}
.mini-spin{width:13px;height:13px;border:2px solid #f0d78c;border-top-color:#e67e22;border-radius:50%;animation:sp .6s linear infinite;display:inline-block}
@keyframes sp{to{transform:rotate(360deg)}}

.f-dl{padding:6px 14px;border:none;border-radius:8px;background:#e67e22;color:#fff;font-size:.76rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap}
.f-dl:hover{background:#f39c12}
.f-rm{width:28px;height:28px;border:none;border-radius:6px;background:#f5f5f5;color:#bbb;cursor:pointer;font-size:.8rem;display:flex;align-items:center;justify-content:center;transition:all .12s}
.f-rm:hover{background:#fde8e8;color:#e74c3c}

/* PROGRESS */
.file-prog{width:100%;height:4px;background:#e8ecf0;border-radius:2px;margin-top:6px;overflow:hidden}
.file-prog .bar{height:100%;background:linear-gradient(90deg,#e67e22,#f39c12);border-radius:2px;transition:width .3s;width:0}

/* SUMMARY */
.sum-wrap{display:none;max-width:820px;width:100%;margin:16px auto 0;padding:0 20px}
.sum-wrap.show{display:block}
.summary{
  background:#fff;border-radius:14px;border:1px solid #eef0f3;
  padding:20px 24px;box-shadow:0 1px 4px rgba(0,0,0,.03);
  display:flex;align-items:center;gap:20px;flex-wrap:wrap
}
.sum-item{text-align:center;flex:1;min-width:90px}
.sum-val{font-size:1.3rem;font-weight:800;color:#e67e22}
.sum-lbl{font-size:.72rem;color:#999;font-weight:500;margin-top:2px}
.sum-sep{width:1px;height:36px;background:#eef0f3;flex-shrink:0}

/* ACTIONS */
.action-bar{display:none;max-width:820px;width:100%;margin:0 auto;padding:16px 20px 36px;justify-content:center;gap:10px;flex-wrap:wrap}
.action-bar.show{display:flex}
.act-btn{
  padding:13px 32px;border:none;border-radius:10px;font-size:.92rem;
  font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;
  align-items:center;gap:8px
}
.act-btn.convert{background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;box-shadow:0 4px 16px rgba(230,126,34,.25)}
.act-btn.convert:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(230,126,34,.35)}
.act-btn.convert:disabled{opacity:.5;cursor:default;transform:none}
.act-btn.dlall{background:#fff;color:#e67e22;border:2px solid #e67e22}
.act-btn.dlall:hover{background:#fef5ec}
.act-btn .btn-spin{width:16px;height:16px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite}
.add-more{padding:13px 24px;border:2px dashed #ccc;border-radius:10px;background:#fff;color:#999;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .15s}
.add-more:hover{border-color:#e67e22;color:#e67e22;background:#fef9f3}

/* TOAST */
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#fff;color:#333;padding:12px 22px;border-radius:10px;
  font-size:.85rem;font-weight:500;box-shadow:0 4px 18px rgba(0,0,0,.1);
  z-index:300;transition:transform .3s;border-left:4px solid #e67e22
}
.toast.err{border-left-color:#e74c3c}
.toast.show{transform:translateX(-50%) translateY(0)}

footer{
  margin-top:auto;text-align:center;padding:16px;color:#bbb;
  font-size:.74rem;border-top:1px solid #eef0f3;background:#fff
}
footer span{color:#e67e22;font-weight:600}

@media(max-width:768px){
  .upload-area{padding:30px 16px 24px}
  .upload-area h1{font-size:1.4rem}
  #dropZone{padding:34px 20px}
  .nb span.txt{display:none}
  .nb{padding:8px 12px}
  .nav-s{display:none}
  .file-item{padding:10px 12px;gap:10px}
  .f-thumb{width:42px;height:42px}
  .summary{gap:12px;padding:16px}
  .sum-sep{display:none}
  .dir-btn{padding:10px 18px;font-size:.8rem}
  .fmt-btn{padding:8px 14px;min-width:65px}
}
@media(max-width:480px){
  .upload-area h1{font-size:1.15rem}
  #dropZone{padding:28px 14px}
  .dz-icon{font-size:2.2rem}
  .dir-btn{padding:9px 14px;font-size:.75rem}
  .fmt-btn{min-width:55px}
  .fmt-btn .fmt-name{font-size:.78rem}
  .fmt-btn .fmt-desc{display:none}
  .f-convert{flex-wrap:wrap}
  .settings-card{padding:14px 16px}
  .act-btn{padding:11px 22px;font-size:.85rem}
}
</style>
</head>
<body>

<nav>
  <span class="nav-t">JPG Converter</span>
  <span class="nav-s">Free Online Tool</span>
  <div class="nav-r" id="navBtns" style="display:none">
    <button class="nb red" onclick="clearAll()">‚úï <span class="txt">Clear</span></button>
    <button class="nb sec" onclick="document.getElementById('fileInput').click()">+ <span class="txt">Add</span></button>
  </div>
</nav>

<!-- UPLOAD -->
<div class="upload-area" id="uploadArea">
  <h1>Convert <span>JPG</span> Images</h1>
  <p>Convert JPG to PNG, WEBP, GIF, BMP or convert any image format to JPG. Fast, free and private.</p>

  <div class="dir-switch" id="dirSwitch">
    <button class="dir-btn active" onclick="setDir('from',this)">üì§ Convert FROM JPG</button>
    <button class="dir-btn" onclick="setDir('to',this)">üì• Convert TO JPG</button>
  </div>

  <div id="dropZone">
    <div class="dz-icon">üìÅ</div>
    <div class="dz-text" id="dzText">Drag & drop JPG images here</div>
    <div class="dz-hint">or</div>
    <button class="dz-btn" onclick="document.getElementById('fileInput').click()">Select Images</button>
    <div class="dz-fmt" id="dzFmt">JPG, JPEG files ‚Äî Up to 50MB each</div>
  </div>
  <input type="file" id="fileInput" accept="image/*" multiple>
</div>

<!-- SETTINGS -->
<div class="settings-wrap" id="settingsWrap">
  <div class="settings-card">
    <div class="settings-title">‚öô Output Settings</div>

    <div class="fmt-label" id="fmtLabel">Convert to:</div>
    <div class="fmt-grid" id="fmtGrid"></div>

    <div class="q-row" id="qRow">
      <div class="sl-label"><span>Quality</span><span id="qVal">92%</span></div>
      <input type="range" min="10" max="100" value="92" id="qSlider" oninput="document.getElementById('qVal').textContent=this.value+'%'">
    </div>

    <div class="bg-row" id="bgRow">
      <label>Background:</label>
      <input type="color" id="bgColor" value="#ffffff">
      <div class="bg-presets">
        <div class="bg-dot active" style="background:#fff" onclick="setBg('#ffffff',this)"></div>
        <div class="bg-dot" style="background:#000" onclick="setBg('#000000',this)"></div>
        <div class="bg-dot" style="background:#f5f5f5" onclick="setBg('#f5f5f5',this)"></div>
        <div class="bg-dot" style="background:#e74c3c" onclick="setBg('#e74c3c',this)"></div>
        <div class="bg-dot" style="background:#3498db" onclick="setBg('#3498db',this)"></div>
        <div class="bg-dot" style="background:#2ecc71" onclick="setBg('#2ecc71',this)"></div>
      </div>
    </div>
  </div>
</div>

<!-- FILES -->
<div class="files-wrap" id="filesWrap">
  <div class="files-header">
    <div>
      <h3>Images</h3>
      <span class="fc" id="fileCount">0 images</span>
    </div>
  </div>
  <div class="file-list" id="fileList"></div>
</div>

<!-- SUMMARY -->
<div class="sum-wrap" id="sumWrap">
  <div class="summary">
    <div class="sum-item"><div class="sum-val" id="sumTotal">0</div><div class="sum-lbl">Total</div></div>
    <div class="sum-sep"></div>
    <div class="sum-item"><div class="sum-val" id="sumDone">0</div><div class="sum-lbl">Converted</div></div>
    <div class="sum-sep"></div>
    <div class="sum-item"><div class="sum-val" id="sumFrom">JPG</div><div class="sum-lbl">From</div></div>
    <div class="sum-sep"></div>
    <div class="sum-item"><div class="sum-val" id="sumTo">PNG</div><div class="sum-lbl">To</div></div>
  </div>
</div>

<!-- ACTIONS -->
<div class="action-bar" id="actionBar">
  <button class="add-more" onclick="document.getElementById('fileInput').click()">+ Add More</button>
  <button class="act-btn convert" id="convertBtn" onclick="convertAll()">üîÑ Convert All</button>
  <button class="act-btn dlall" id="dlAllBtn" onclick="downloadAll()" style="display:none">‚§ì Download All</button>
</div>

<footer><span>JPG Converter</span> ‚Äî 100% browser-based. Your images never leave your device.</footer>

<div class="toast" id="toast"></div>

<script>
let files=[];
let direction='from'; // 'from' = JPG‚Üíother, 'to' = other‚ÜíJPG
let targetFormat='png';
let isConverting=false;

const FROM_FORMATS=[
  {id:'png',name:'PNG',desc:'Lossless'},
  {id:'webp',name:'WEBP',desc:'Modern'},
  {id:'gif',name:'GIF',desc:'Animated'},
  {id:'bmp',name:'BMP',desc:'Bitmap'},
  {id:'ico',name:'ICO',desc:'Icon'},
];
const TO_FORMATS=[
  {id:'jpeg',name:'JPG',desc:'Compressed'},
];

document.addEventListener('DOMContentLoaded',()=>{
  const fi=document.getElementById('fileInput');
  const dz=document.getElementById('dropZone');

  fi.addEventListener('change',e=>{handleFiles(e.target.files);fi.value=''});
  dz.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')fi.click()});
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop',e=>{handleFiles(e.dataTransfer.files)});
  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items;if(!items)return;
    const arr=[];for(let i of items)if(i.type.startsWith('image/'))arr.push(i.getAsFile());
    if(arr.length){e.preventDefault();handleFiles(arr)}
  });

  buildFormats();
});

function setDir(d,btn){
  direction=d;
  document.querySelectorAll('.dir-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  if(d==='from'){
    document.getElementById('dzText').textContent='Drag & drop JPG images here';
    document.getElementById('dzFmt').textContent='JPG, JPEG files ‚Äî Up to 50MB each';
    targetFormat='png';
  }else{
    document.getElementById('dzText').textContent='Drag & drop images here (PNG, WEBP, GIF, BMP)';
    document.getElementById('dzFmt').textContent='PNG, WEBP, GIF, BMP files ‚Äî Up to 50MB each';
    targetFormat='jpeg';
  }
  buildFormats();
}

function buildFormats(){
  const grid=document.getElementById('fmtGrid');
  grid.innerHTML='';
  const list=direction==='from'?FROM_FORMATS:TO_FORMATS;

  if(direction==='to'){
    // Only JPG option
    targetFormat='jpeg';
    const d=document.createElement('div');
    d.className='fmt-btn active';
    d.innerHTML='<div class="fmt-name">JPG</div><div class="fmt-desc">Compressed</div>';
    grid.appendChild(d);
    document.getElementById('fmtLabel').textContent='Output format:';
    document.getElementById('qRow').classList.add('show');
    document.getElementById('bgRow').classList.add('show');
  }else{
    document.getElementById('fmtLabel').textContent='Convert JPG to:';
    list.forEach((f,i)=>{
      const d=document.createElement('div');
      d.className='fmt-btn'+(i===0?' active':'');
      d.innerHTML=`<div class="fmt-name">${f.name}</div><div class="fmt-desc">${f.desc}</div>`;
      d.onclick=()=>{
        document.querySelectorAll('.fmt-btn').forEach(b=>b.classList.remove('active'));
        d.classList.add('active');
        targetFormat=f.id;
        updateQualityVisibility();
      };
      grid.appendChild(d);
    });
    if(list.length>0)targetFormat=list[0].id;
    updateQualityVisibility();
  }
}

function updateQualityVisibility(){
  const needsQ=targetFormat==='jpeg'||targetFormat==='webp';
  document.getElementById('qRow').classList.toggle('show',needsQ);
  document.getElementById('bgRow').classList.toggle('show',targetFormat==='jpeg');
}

function setBg(color,dot){
  document.getElementById('bgColor').value=color;
  document.querySelectorAll('.bg-dot').forEach(d=>d.classList.remove('active'));
  if(dot)dot.classList.add('active');
}

function handleFiles(fl){
  let added=0;
  for(let f of fl){
    if(!f.type.startsWith('image/')){continue}
    if(f.size>50*1024*1024){toast(f.name+' too large',true);continue}

    // Validate based on direction
    if(direction==='from'){
      if(f.type!=='image/jpeg'&&!f.name.toLowerCase().match(/\.jpe?g$/)){
        toast(f.name+' is not a JPG file',true);continue;
      }
    }else{
      if(f.type==='image/jpeg'||f.name.toLowerCase().match(/\.jpe?g$/)){
        toast(f.name+' is already a JPG',true);continue;
      }
    }

    const url=URL.createObjectURL(f);
    files.push({
      file:f,name:f.name,size:f.size,type:f.type,
      thumbUrl:url,status:'waiting',
      outBlob:null,outUrl:null,outSize:0,outExt:'',
      width:0,height:0
    });
    added++;
    const idx=files.length-1;
    const img=new Image();
    img.onload=()=>{files[idx].width=img.naturalWidth;files[idx].height=img.naturalHeight;renderFiles()};
    img.src=url;
  }
  if(added===0&&fl.length>0)return;
  if(added>0){
    toast('‚úì '+added+' image'+(added>1?'s':'')+' added');
    showUI();renderFiles();
  }
}

function showUI(){
  document.getElementById('uploadArea').classList.add('mini');
  document.getElementById('settingsWrap').classList.add('show');
  document.getElementById('filesWrap').classList.add('show');
  document.getElementById('actionBar').classList.add('show');
  document.getElementById('navBtns').style.display='flex';
  const allDone=files.length>0&&files.every(f=>f.status==='done');
  document.getElementById('dlAllBtn').style.display=allDone?'inline-flex':'none';
  document.getElementById('convertBtn').style.display=allDone?'none':'inline-flex';
}

function getExt(type){
  if(type.includes('jpeg'))return'jpg';
  if(type.includes('png'))return'png';
  if(type.includes('webp'))return'webp';
  if(type.includes('gif'))return'gif';
  if(type.includes('bmp'))return'bmp';
  if(type.includes('icon')||type.includes('ico'))return'ico';
  return'img';
}

function renderFiles(){
  const list=document.getElementById('fileList');
  list.innerHTML='';
  document.getElementById('fileCount').textContent=files.length+' image'+(files.length!==1?'s':'');

  const outFmtName=targetFormat==='jpeg'?'JPG':targetFormat.toUpperCase();

  files.forEach((f,i)=>{
    const item=document.createElement('div');
    item.className='file-item';
    const fromExt=getExt(f.type);
    const toExt=f.outExt||outFmtName.toLowerCase();

    let statusHTML='',sizeHTML='';

    if(f.status==='waiting'){
      statusHTML='<span class="badge wait">Waiting</span>';
    }else if(f.status==='converting'){
      statusHTML='<span class="badge prog"><span class="mini-spin"></span> Converting</span>';
    }else if(f.status==='done'){
      statusHTML=`<span class="badge done">‚úì Done</span><button class="f-dl" onclick="dlOne(${i})">‚§ì ${toExt.toUpperCase()}</button>`;
      sizeHTML=`<span class="f-sizes">${fmtSize(f.size)} ‚Üí ${fmtSize(f.outSize)}</span>`;
    }else{
      statusHTML='<span class="badge err">‚úï Error</span>';
    }

    const dims=f.width&&f.height?`${f.width}√ó${f.height}`:'';

    item.innerHTML=`
      <div class="f-thumb"><img src="${f.thumbUrl}" alt=""></div>
      <div class="f-info">
        <div class="f-name">${esc(f.name)}</div>
        <div class="f-meta">
          <div class="f-convert">
            <span class="f-from ${fromExt}">${fromExt.toUpperCase()}</span>
            <span class="f-arrow">‚Üí</span>
            <span class="f-from ${toExt}">${toExt.toUpperCase()}</span>
          </div>
          ${dims?`<span>${dims}</span>`:''}
          ${sizeHTML}
        </div>
        ${f.status==='converting'?'<div class="file-prog"><div class="bar" style="width:60%"></div></div>':''}
      </div>
      <div class="f-status">
        ${statusHTML}
        <button class="f-rm" onclick="removeFile(${i})" title="Remove">‚úï</button>
      </div>
    `;
    list.appendChild(item);
  });
  updateSummary();
}

function updateSummary(){
  const done=files.filter(f=>f.status==='done');
  if(done.length===0){document.getElementById('sumWrap').classList.remove('show');return}
  document.getElementById('sumWrap').classList.add('show');
  const fromExt=direction==='from'?'JPG':files.length?getExt(files[0].type).toUpperCase():'‚Äî';
  const toFmt=targetFormat==='jpeg'?'JPG':targetFormat.toUpperCase();
  document.getElementById('sumTotal').textContent=files.length;
  document.getElementById('sumDone').textContent=done.length;
  document.getElementById('sumFrom').textContent=fromExt;
  document.getElementById('sumTo').textContent=toFmt;
}

function removeFile(idx){
  if(files[idx].thumbUrl)URL.revokeObjectURL(files[idx].thumbUrl);
  if(files[idx].outUrl)URL.revokeObjectURL(files[idx].outUrl);
  files.splice(idx,1);
  if(files.length===0){clearAll();return}
  renderFiles();showUI();
}

// CONVERT
async function convertAll(){
  if(isConverting||files.length===0)return;
  isConverting=true;
  const btn=document.getElementById('convertBtn');
  btn.disabled=true;btn.innerHTML='<span class="btn-spin"></span> Converting...';

  const quality=(parseInt(document.getElementById('qSlider').value)||92)/100;
  const bgColor=document.getElementById('bgColor').value;

  for(let i=0;i<files.length;i++){
    if(files[i].status==='done')continue;
    files[i].status='converting';
    renderFiles();

    try{
      const result=await convertImage(files[i],quality,bgColor);
      files[i].outBlob=result.blob;
      files[i].outUrl=URL.createObjectURL(result.blob);
      files[i].outSize=result.blob.size;
      files[i].outExt=result.ext;
      files[i].status='done';
    }catch(err){
      console.error(err);
      files[i].status='error';
    }
    renderFiles();
  }

  isConverting=false;
  btn.disabled=false;btn.innerHTML='üîÑ Convert All';

  const allDone=files.every(f=>f.status==='done');
  if(allDone){
    toast('‚úì All images converted!');
    document.getElementById('dlAllBtn').style.display='inline-flex';
    document.getElementById('convertBtn').style.display='none';
  }else{
    toast('Some conversions failed',true);
    document.getElementById('dlAllBtn').style.display='inline-flex';
  }
}

function convertImage(fileObj,quality,bgColor){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const w=img.naturalWidth,h=img.naturalHeight;
      const canvas=document.createElement('canvas');
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');

      // For JPEG: fill background (no transparency)
      if(targetFormat==='jpeg'||targetFormat==='bmp'){
        ctx.fillStyle=bgColor||'#ffffff';
        ctx.fillRect(0,0,w,h);
      }

      ctx.imageSmoothingEnabled=true;
      ctx.imageSmoothingQuality='high';
      ctx.drawImage(img,0,0);

      let mime,ext;
      switch(targetFormat){
        case'png':mime='image/png';ext='png';break;
        case'jpeg':mime='image/jpeg';ext='jpg';break;
        case'webp':mime='image/webp';ext='webp';break;
        case'gif':mime='image/gif';ext='gif';break;
        case'bmp':mime='image/bmp';ext='bmp';break;
        case'ico':mime='image/png';ext='ico';break;
        default:mime='image/png';ext='png';
      }

      // ICO: resize to 256x256
      if(targetFormat==='ico'){
        const icoCanvas=document.createElement('canvas');
        const icoSize=256;
        icoCanvas.width=icoSize;icoCanvas.height=icoSize;
        const ictx=icoCanvas.getContext('2d');
        ictx.imageSmoothingEnabled=true;
        ictx.imageSmoothingQuality='high';
        // Fit
        const scale=Math.min(icoSize/w,icoSize/h);
        const nw=w*scale,nh=h*scale;
        ictx.drawImage(canvas,(icoSize-nw)/2,(icoSize-nh)/2,nw,nh);
        icoCanvas.toBlob(blob=>{
          if(!blob)reject('ICO failed');
          else resolve({blob,ext:'ico'});
        },'image/png');
        return;
      }

      const needsQ=mime==='image/jpeg'||mime==='image/webp';

      canvas.toBlob(blob=>{
        if(!blob){reject('Conversion failed');return}
        resolve({blob,ext});
      },mime,needsQ?quality:undefined);
    };
    img.onerror=()=>reject('Load failed');
    img.src=URL.createObjectURL(fileObj.file);
  });
}

// DOWNLOAD
function dlOne(idx){
  const f=files[idx];
  if(!f.outBlob)return;
  const a=document.createElement('a');
  a.href=f.outUrl||URL.createObjectURL(f.outBlob);
  const baseName=f.name.replace(/\.[^.]+$/,'');
  a.download=baseName+'.'+f.outExt;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function downloadAll(){
  const done=files.filter(f=>f.status==='done');
  if(done.length===0)return;
  if(done.length===1){dlOne(files.indexOf(done[0]));return}
  done.forEach((f,i)=>{setTimeout(()=>dlOne(files.indexOf(f)),i*400)});
  toast('‚§ì Downloading '+done.length+' images...');
}

function clearAll(){
  files.forEach(f=>{
    if(f.thumbUrl)URL.revokeObjectURL(f.thumbUrl);
    if(f.outUrl)URL.revokeObjectURL(f.outUrl);
  });
  files=[];
  document.getElementById('fileList').innerHTML='';
  document.getElementById('uploadArea').classList.remove('mini');
  document.getElementById('settingsWrap').classList.remove('show');
  document.getElementById('filesWrap').classList.remove('show');
  document.getElementById('actionBar').classList.remove('show');
  document.getElementById('sumWrap').classList.remove('show');
  document.getElementById('navBtns').style.display='none';
  document.getElementById('dlAllBtn').style.display='none';
  document.getElementById('convertBtn').style.display='inline-flex';
  document.getElementById('convertBtn').innerHTML='üîÑ Convert All';
  toast('Cleared');
}

function fmtSize(b){
  if(b<1024)return b+' B';
  if(b<1048576)return(b/1024).toFixed(1)+' KB';
  return(b/1048576).toFixed(2)+' MB';
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toast(m,e){
  const t=document.getElementById('toast');
  t.textContent=m;t.className='toast'+(e?' err':'');
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
